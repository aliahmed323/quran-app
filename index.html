<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منارة الحفظ - الرئيسية</title> <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Somar:wght@400;700&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style.css">

    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

    <style>
        /* Add some basic styles here if needed for immediate structure */
        /* Example: Hide plan setup initially */
        #plan-setup-section { display: none; }
    </style>
</head>
<body>

    <header class="header-container">
        <div class="site-branding">
            <div class="logo-container">
                <img src="images/logo-placeholder.png" alt="شعار منارة الحفظ" style="height: 50px;">
            </div>
            <span class="site-name">منارة الحفظ</span> </div>

        <nav class="main-navigation">
            <ul>
                <li><a href="index.html">الرئيسية</a></li>
                <li>
                    <a href="#about-site">التعريف بالموقع</a> </li>
                <li>
                    <a href="#">خطط الحفظ</a>
                    <ul class="dropdown">
                        <li><a href="#">خطة صفحة يومياً</a></li>
                        <li><a href="#">خطة صفحتين يومياً</a></li>
                        <li><a href="#">خطة 3 صفحات يومياً</a></li>
                        <li><a href="#">خطة 4 صفحات يومياً</a></li>
                    </ul>
                </li>
                <li>
                    <a href="#">الدورات والبرامج</a>
                    <ul class="dropdown">
                        <li><a href="#">دورات التجويد</a></li>
                        <li><a href="#">برامج المراجعة</a></li>
                    </ul>
                </li>
                <li>
                    <a href="#">الخرائط الذهنية</a>
                    <ul class="dropdown">
                        <li><a href="#">خرائط السور</a></li>
                        <li><a href="#">خرائط المتشابهات</a></li>
                    </ul>
                </li>
                 <li>
                    <a href="#">المسابقات</a> <ul class="dropdown">
                         <li><a href="#">مسابقة رمضان</a></li>
                         <li><a href="#">المسابقة الشهرية</a></li>
                    </ul>
                </li>
                <li>
                    <a href="#">التسجيل</a>
                    <ul class="dropdown">
                        <li><a href="plangen2.html">تسجيل طالب (بدء الخطة)</a></li>
                        <li><a href="#">تسجيل معلم</a></li>
                         </ul>
                </li>
                 </ul>
        </nav>

        <div class="auth-area">
            <button id="google-signin-btn" class="google-signin-btn" style="display: inline-block;">
                تسجيل الدخول بحساب Google
            </button>
            <div id="user-profile-area" style="display: none; align-items: center; gap: 10px;">
                <img id="user-photo" src="placeholder.png" alt="صورة المستخدم">
                <span id="user-name">أهلاً بك</span>
                <span id="student-level-title" style="display: none;"></span>
                <button id="logout-button">تسجيل الخروج</button>
            </div>
        </div>
    </header>

    <main>

        <section class="hero-section">
            <div class="hero-content">
                <div class="hero-text">
                    <h1>أهلاً بك في منارة الحفظ</h1>
                    <h2>منصة إلكترونية لتعليم وحفظ القرآن الكريم وعلومه</h2>
                    <p>والإبداع في غرس قيمه...</p>
                    <a href="#plan-setup-section" class="cta-button">ابدأ خطتك الآن</a>
                </div>
                <div class="hero-image">
                    <img src="images/hero-illustration-placeholder.png" alt="رسم توضيحي لحفظ القرآن">
                </div>
            </div>
        </section>

        <section id="about-site" class="content-section">
            <h2>التعريف بالموقع</h2>
            <p>
                منارة الحفظ هي منصة إلكترونية تطوعية تهدف لتيسير حفظ القرآن الكريم وعلومه ومراجعته للمسلمين حول العالم عبر خطط تفاعلية وأدوات متابعة حديثة. نسعى لتوفير بيئة محفزة ومنظمة تساعدك على الالتزام والمداومة على وردك القرآني.
                </p>
            </section>

        <section class="services-section content-section">
            <h2>خدماتنا ومميزاتنا</h2>
            <div class="services-grid">
                <div class="service-item">
                    <div class="service-icon">
                        <span>📅</span> </div>
                    <h3>خطط حفظ تفاعلية</h3>
                    <p>خطط يومية تلقائية للحفظ والمراجعة والربط تناسب مستواك.</p>
                </div>
                <div class="service-item">
                    <div class="service-icon">
                        <span>📊</span> </div>
                    <h3>متابعة دقيقة للتقدم</h3>
                    <p>إحصائيات وتقويم مرئي لمتابعة إنجازك وصفحاتك المحفوظة.</p>
                </div>
                <div class="service-item">
                     <div class="service-icon">
                         <span>✨</span> </div>
                    <h3>تحفيز وتشجيع</h3>
                    <p>نظام ألقاب ومستويات وتتبع للإنجاز المتتالي لزيادة حماسك.</p>
                 </div>
                 <div class="service-item">
                     <div class="service-icon">
                        <span>🧠</span> </div>
                    <h3>أدوات مساعدة</h3>
                     <p>إمكانية إضافة خرائط ذهنية ومسابقات وروابط مفيدة (حسب الإضافات المستقبلية).</p>
                </div>
                </div>
        </section>

        <section class="features-section content-section alt-background"> <h2>لماذا منارة الحفظ؟</h2>
            <div class="features-grid">
                <div class="feature-item">
                    <div class="feature-icon-circle">
                        <span>🎯</span> </div>
                    <h3>التركيز والمنهجية</h3>
                    <p>نوفر لك خطة واضحة ومنظمة تساعدك على التركيز في حفظك ومراجعتك.</p>
                </div>
                <div class="feature-item">
                     <div class="feature-icon-circle">
                        <span>🤝</span> </div>
                    <h3>المرونة</h3>
                    <p>تستطيع تسجيل الأعذار وتتأقلم الخطة تلقائياً مع ظروفك.</p>
                </div>
                 <div class="feature-item">
                     <div class="feature-icon-circle">
                        <span>💖</span> </div>
                     <h3>التحفيز الذاتي</h3>
                     <p>نظام المستويات والألقاب يساعدك على مراقبة تطورك والاحتفاء بإنجازك.</p>
                </div>
                 <div class="feature-item">
                     <div class="feature-icon-circle">
                        <span>⏳</span> </div>
                     <h3>توفير الوقت</h3>
                     <p>لا حاجة لحساب الصفحات أو المراجعات، المنصة تقوم بذلك نيابة عنك.</p>
                </div>
                 </div>
        </section>

        <section id="plan-setup-section">
             <h2>إعداد خطتك لأول مرة</h2>
            <p>يرجى اختيار الخطة المناسبة وتحديد تاريخ البدء.</p>
             <div class="plan-selection-area">
                 <div class="plans-container">
                     <div class="plan-card" data-plan-type="2"> <h3>خطة حفظ صفحتين يوميًا</h3>
                         <p>الخطة الأساسية والموصى بها.</p>
                         <span class="plan-link">اختر هذه الخطة</span>
                     </div>
                     </div>
             </div>
             <div class="plan-setup-inputs">
                <div>
                    <label for="planStartDate">تاريخ البدء:</label>
                    <input type="date" id="planStartDate" required>
                 </div>
                 <div>
                     <label for="planRepetitionMax">عدد التكرارات المفضل:</label>
                    <select id="planRepetitionMax">
                        <option value="20" selected>20</option>
                        <option value="30">30</option>
                        <option value="40">40</option>
                    </select>
                 </div>
             </div>
             <button id="confirmPlanBtn" disabled>تأكيد الخطة والبدء</button>
        </section>

        <section class="stats-section content-section">
             <h2>منارة الحفظ بالأرقام</h2>
             <div class="stats-grid">
                 <div class="stat-item">
                     <span class="stat-icon">📊</span> <span class="stat-number">1000+</span> <span class="stat-title">خطة تم إنشاؤها</span>
                 </div>
                 <div class="stat-item">
                    <span class="stat-icon">🧑‍🎓</span> <span class="stat-number">500+</span> <span class="stat-title">طالب ملتزم</span>
                 </div>
                 <div class="stat-item">
                     <span class="stat-icon">📄</span> <span class="stat-number">5000+</span> <span class="stat-title">صفحة تم حفظها</span>
                 </div>
                 <div class="stat-item">
                    <span class="stat-icon">🌟</span> <span class="stat-number">100+</span> <span class="stat-title">مستوى تم بلوغه</span>
                </div>
             </div>
         </section>

        <div id="dashboard-link-container" style="text-align: center; padding: 20px;"></div>

        </main>

    <footer class="main-footer">
        <p>&copy; <span id="current-year">2025</span> منارة الحفظ. جميع الحقوق محفوظة.</p>
        </footer>

    <script>
         // --- Firebase Configuration ---
         const firebaseConfig = { /* ... بياناتك ... */ apiKey: "AIzaSyDuUebu7Qzz3JnTfa-58EIPZjOcrkmdGHU", authDomain: "quranplan2.firebaseapp.com", projectId: "quranplan2", storageBucket: "quranplan2.appspot.com", messagingSenderId: "1098692856811", appId: "1:1098692856811:web:923bca3a54fd78b1b267ae" };
        try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Init Error:", e); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM Elements ---
        const loginBtn = document.getElementById('google-signin-btn');
        const planSetupSection = document.getElementById('plan-setup-section');
        const planCards = planSetupSection?.querySelectorAll('.plan-card');
        const planStartDateInput = document.getElementById('planStartDate');
        const planRepetitionMaxSelect = document.getElementById('planRepetitionMax');
        const confirmPlanBtn = document.getElementById('confirmPlanBtn');
        const userProfileArea = document.getElementById('user-profile-area');
        const userNameSpan = document.getElementById('user-name');
        const userPhoto = document.getElementById('user-photo');
        const logoutButton = document.getElementById('logout-button');
        const studentLevelTitleSpan = document.getElementById('student-level-title');
        const currentYearSpan = document.getElementById('current-year');
        const dashboardLinkContainer = document.getElementById('dashboard-link-container'); // Get the container

        // --- Global State ---
        let currentUser = null;
        let selectedPlanType = null;
        let hasExistingPlan = false;
        const initialTotalRows = 320;

        // --- Helper Functions ---
        function formatDate(date) { if (!(date instanceof Date)) { date = new Date(date); } if (isNaN(date.getTime())) { return ""; } const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
        async function checkIfPlanExists(uid) { if (!uid) return false; const planRef = db.collection("quranPlans").doc(uid); try { const doc = await planRef.get(); console.log(`Index: Plan check for ${uid}: Exists = ${doc.exists}`); return doc.exists; } catch (error) { console.error("Error checking plan existence:", error); return false; } }

        // --- Level/Title Calculation & Display ---
         const levelTitles = ["ابدأ رحلتك!", "🌱 غرسة الإيمان", "✨ بادرة أمل", "🏃 ساعٍ للعلا", "⭐ نجم صاعد", "💪 مثابر مجتهد", "🧭 على الدرب", "💯 صاحب السبعين", "🚀 انطلاقة قوية", "💎 جوهرة مصقولة", "👑 صاحب المئة يوم", "📖 رفيق القرآن", "🕯️ منارة هدى", "🏔️ قمة شامخة", "🌳 شجرة طيبة", "⏳ عابر منتصف الطريق", "🎯 دقة والتزام", "🌊 بحر زاخر", "🌟 كوكب دري", "🧭 بوصلة الحق", "💯💯 المئتان لا تقفان!", "🤲 قلب خاشع", "🕊️ روح مطمئنة", "💖 محب للرحمن", "🙏 عبد شكور", "💡 بصيرة نافذة", "🕌 معمّر بيوت الله", "🌙 هلال الكمال", "✨ نور على نور", "🏁 قاب قوسين أو أدنى", "🏆 فارس الثلاثمائة", "🎉 مقترب من الختام", "🎊 خاتم مبارك"];
         const levelIcons = { 10: '👑', 20: '💯', 30: '🏆', 32: '🎊' }; // Example icons

         function calculateLevelTitle(tableRows) {
            if (!tableRows || tableRows.length === 0) return { title: levelTitles[0], icon: '' };
            const sortedRows = [...tableRows].sort((a, b) => new Date(a.displayDate) - new Date(b.displayDate));
            let currentStreak = 0;
            let streakBroken = false;
            const todayStr = formatDate(new Date());
             let tempCurrentStreak = 0; // Use temporary variable inside loop

             for (let i = sortedRows.length - 1; i >= 0; i--) {
                 const row = sortedRows[i];
                 if (row.displayDate > todayStr) continue; // Skip future dates
                 if (row.type === 'plan' && row.state?.completed) {
                     if (!streakBroken) {
                        tempCurrentStreak++;
                     }
                 } else if (row.type === 'excuse') {
                     // Excuses maintain the streak, so continue without incrementing or breaking
                     continue;
                 } else {
                    // If it's today and not completed, or any past day not completed/excused
                     streakBroken = true;
                     // If today's task exists and is not complete, streak resets to 0 *for today*
                    if (row.displayDate === todayStr) {
                        tempCurrentStreak = 0;
                    }
                     break; // Stop counting streak
                 }
             }
             currentStreak = tempCurrentStreak; // Assign calculated streak

            const levelIndex = Math.min(Math.floor(currentStreak / 10), levelTitles.length - 1);
            const title = levelTitles[levelIndex] || levelTitles[0];
            const icon = levelIcons[levelIndex] || '';
            return { title: title, icon: icon };
        }

        async function displayStudentLevel(uid) {
            if (!studentLevelTitleSpan) return;
            try {
                const planRef = db.collection("quranPlans").doc(uid);
                const doc = await planRef.get();
                if (doc.exists) {
                    const planData = doc.data();
                    if (planData.tableRows) {
                        const levelInfo = calculateLevelTitle(planData.tableRows);
                        studentLevelTitleSpan.textContent = `(لقبك: ${levelInfo.title} ${levelInfo.icon})`.trim();
                        studentLevelTitleSpan.style.display = 'inline';
                    } else { studentLevelTitleSpan.style.display = 'none'; }
                } else { studentLevelTitleSpan.style.display = 'none'; }
            } catch (error) { console.error("Error fetching plan data for level title:", error); studentLevelTitleSpan.style.display = 'none'; }
        }

        // --- UI Update Function ---
         function updateUIBasedOnLoginAndPlanState() {
             if (dashboardLinkContainer) dashboardLinkContainer.innerHTML = '';

             if (currentUser) {
                 if(loginBtn) loginBtn.style.display = 'none';
                 if(userProfileArea) {
                     userProfileArea.style.display = 'flex';
                     if(userNameSpan) userNameSpan.textContent = currentUser.displayName || 'مستخدم';
                     if(userPhoto) userPhoto.src = currentUser.photoURL || 'images/avatar_placeholder.png'; // Placeholder avatar
                 }
                 displayStudentLevel(currentUser.uid); // Display level

                 if (hasExistingPlan) {
                     console.log("UI Update: User has plan.");
                     if(planSetupSection) planSetupSection.style.display = 'none';
                     if (dashboardLinkContainer) { // Add the dashboard link
                         dashboardLinkContainer.innerHTML = `<a href="dashboard.html" class="cta-button" style="background-color: #1e8449; display: inline-block; margin-top: 15px; color:white; padding: 10px 25px; border-radius: 5px; text-decoration: none;">الذهاب إلى لوحة المتابعة</a>`;
                     }
                 } else {
                     console.log("UI Update: User needs to set up plan.");
                     if(planSetupSection) planSetupSection.style.display = 'block';
                     if (dashboardLinkContainer) dashboardLinkContainer.innerHTML = '';
                     if (planStartDateInput && !planStartDateInput.value) planStartDateInput.value = formatDate(new Date());
                     updateConfirmButtonState();
                 }
             } else {
                 // Logged Out
                 if(loginBtn) loginBtn.style.display = 'inline-block';
                 if(userProfileArea) userProfileArea.style.display = 'none';
                 if(planSetupSection) planSetupSection.style.display = 'none';
                 if (studentLevelTitleSpan) studentLevelTitleSpan.style.display = 'none';
                 if (dashboardLinkContainer) dashboardLinkContainer.innerHTML = '';
             }
         }


        // --- Other Functions (Confirm Button State, Save Initial Data) ---
         function updateConfirmButtonState() { if (!confirmPlanBtn) return; confirmPlanBtn.disabled = !(selectedPlanType && planStartDateInput?.value); }
        async function saveInitialPlanData() { /* ... نفس الدالة من الرد السابق ... */ if (!currentUser || !selectedPlanType || !planStartDateInput || !planStartDateInput.value || !planRepetitionMaxSelect) { alert("يرجى اختيار خطة وتحديد تاريخ البدء وعدد التكرارات."); return; } const selectedStartDate = new Date(planStartDateInput.value + 'T00:00:00Z'); if (isNaN(selectedStartDate.getTime())) { alert('تاريخ البدء المحدد غير صالح.'); return; } if(confirmPlanBtn) { confirmPlanBtn.disabled = true; confirmPlanBtn.textContent = "جاري الحفظ..."; } const uid = currentUser.uid; const planRef = db.collection("quranPlans").doc(uid); const initialTableRows = []; let currentDate = new Date(selectedStartDate); for (let i = 0; i < initialTotalRows; i++) { const rowData = { type: 'plan', originalSequence: i, displaySeq: i + 1, displayDate: formatDate(currentDate), state: { yestRep: 0, listen: 0, interp: false, record: 0, rep: 0, linked: false, reviewed: false, completed: false } }; initialTableRows.push(rowData); if (i < initialTotalRows - 1) { currentDate.setUTCDate(currentDate.getUTCDate() + 1); } } const planDataToSave = { studentName: currentUser.displayName || "طالب علم", email: currentUser.email, startDate: planStartDateInput.value, planType: selectedPlanType, repetitionMax: parseInt(planRepetitionMaxSelect.value), excuseDates: [], tableRows: initialTableRows, createdAt: firebase.firestore.FieldValue.serverTimestamp(), lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }; console.log("Saving initial plan data (including tableRows):", planDataToSave); try { await planRef.set(planDataToSave); console.log("Initial plan data saved!"); hasExistingPlan = true; window.location.href = 'dashboard.html'; } catch (error) { console.error("Error saving initial plan data: ", error); alert("حدث خطأ أثناء حفظ بيانات الخطة. حاول مرة أخرى."); if(confirmPlanBtn) { confirmPlanBtn.disabled = false; confirmPlanBtn.textContent = "تأكيد الخطة والبدء"; } } }


        // --- Authentication Listener ---
         auth.onAuthStateChanged(async (user) => {
             currentUser = user;
             if (user) {
                 console.log("Index: Auth state changed: User logged in.");
                 hasExistingPlan = await checkIfPlanExists(user.uid);
                 updateUIBasedOnLoginAndPlanState();
             } else {
                 console.log("Index: Auth state changed: User logged out.");
                 hasExistingPlan = false;
                 updateUIBasedOnLoginAndPlanState();
             }
         });

        // --- Event Listeners ---
        if (loginBtn) { loginBtn.addEventListener('click', () => { const provider = new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(provider).catch(err => { console.error("Sign-in error:", err); alert("حدث خطأ أثناء تسجيل الدخول: " + err.message); }); }); } // Simplified error handling
        if (logoutButton) { logoutButton.addEventListener('click', () => { auth.signOut().catch((error) => { console.error('Sign out error:', error); }); }); }
        if(planCards) { planCards.forEach(card => { card.addEventListener('click', () => { if(planCards) planCards.forEach(c => c.classList.remove('selected')); card.classList.add('selected'); selectedPlanType = parseInt(card.getAttribute('data-plan-type')); updateConfirmButtonState(); }); }); }
        if (planStartDateInput) { planStartDateInput.addEventListener('change', updateConfirmButtonState); }
        if (confirmPlanBtn) { confirmPlanBtn.addEventListener('click', saveInitialPlanData); }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initial UI state handled by auth listener
            if(currentYearSpan) { currentYearSpan.textContent = new Date().getFullYear(); }
        });

     </script>

</body>
</html>