<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منارة الحفظ - الرئيسية</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Somar:wght@400;700&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style.css">

    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

</head>
<body>

    <header class="header-container">
        <div class="site-branding">
            <div class="logo-container">
                <img src="https://lh3.googleusercontent.com/d/1atLb1rloGmQVKXmQgfwTVMne8RMRWGvf" alt="شعار منارة الحفظ">
            </div>
            <div class="site-name">
                <span>منارة</span>
                <span>الحفظ</span>
            </div>
        </div>

        <nav class="main-navigation" id="main-nav">
            <ul>
                <li><a href="index.html">الرئيسية</a></li>
                <li class="menu-item-has-children"><a href="#about-site">التعريف بالموقع</a></li>
                <li class="menu-item-has-children">
                    <a href="#">خطط الحفظ</a>
                    <ul class="dropdown">
                        <li><a href="#">خطة صفحة يومياً</a></li>
                        <li><a href="#">خطة صفحتين يومياً</a></li>
                        <li><a href="#">خطة 3 صفحات يومياً</a></li>
                        <li><a href="#">خطة 4 صفحات يومياً</a></li>
                    </ul>
                </li>
                <li class="menu-item-has-children">
                    <a href="#">الدورات والبرامج</a>
                    <ul class="dropdown">
                        <li><a href="#">دورات التجويد</a></li>
                        <li><a href="#">برامج المراجعة</a></li>
                    </ul>
                </li>
                <li class="menu-item-has-children">
                    <a href="#">الخرائط الذهنية</a>
                    <ul class="dropdown">
                        <li><a href="#">خرائط السور</a></li>
                        <li><a href="#">خرائط المتشابهات</a></li>
                    </ul>
                </li>
                 <li class="menu-item-has-children">
                    <a href="#">المسابقات</a>
                     <ul class="dropdown">
                         <li><a href="#">مسابقة رمضان</a></li>
                         <li><a href="#">المسابقة الشهرية</a></li>
                    </ul>
                </li>
                <li class="menu-item-has-children">
                    <a href="#">التسجيل</a>
                    <ul class="dropdown">
                        <li><a href="plangen2.html">تسجيل طالب (بدء الخطة)</a></li>
                        <li><a href="#">تسجيل معلم</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <div class="header-right-controls">
            <div class="auth-area">
                <button id="google-signin-btn" class="google-signin-btn" style="display: inline-block;">
                    تسجيل الدخول
                </button>
                <div id="user-profile-area" style="display: none;">
                    <button type="button" id="user-profile-trigger" aria-expanded="false" aria-controls="profile-dropdown">
                        <img id="user-photo" src="images/avatar_placeholder.png" alt="صورة المستخدم"> <div class="user-info">
                            <span id="user-name">أهلاً بك</span>
                            <span id="student-level-title" style="display: none;"></span>
                        </div>
                        <span class="profile-arrow">▼</span>
                    </button>
                    <div id="profile-dropdown" class="profile-dropdown-menu">
                        <ul>
                            <li><button id="logout-button" type="button">تسجيل الخروج</button></li>
                        </ul>
                    </div>
                </div>
            </div>
            <button class="mobile-menu-toggle" aria-label="فتح القائمة" aria-expanded="false" aria-controls="main-nav">
                ☰
            </button>
        </div>
    </header>

    <main>
        <section class="hero-section">
             <div class="hero-content">
                 <div class="hero-text">
                     <h1>أهلاً بك في منارة الحفظ</h1>
                     <h2>منصة إلكترونية لتعليم وحفظ القرآن الكريم وعلومه</h2>
                     <p>والإبداع في غرس قيمه...</p>
                     <div id="cta-button-container" style="margin-top: 30px;">
                         </div>
                 </div>
                 <div class="hero-image">
                     <img src="https://drive.google.com/file/d/1oXe50xPZmXcDR0VJimINUiOJTUKEoke4/view?usp=sharing" alt="رسم توضيحي لحفظ القرآن">
                 </div>
             </div>
        </section>

        <section id="about-site" class="content-section">
             <h2>التعريف بالموقع</h2>
             <p> منارة الحفظ هي منصة إلكترونية تطوعية تهدف لتيسير حفظ القرآن الكريم وعلومه ومراجعته للمسلمين حول العالم عبر خطط تفاعلية وأدوات متابعة حديثة. نسعى لتوفير بيئة محفزة ومنظمة تساعدك على الالتزام والمداومة على وردك القرآني. </p>
        </section>

        <section class="services-section content-section">
             <h2>خدماتنا</h2>
             <div class="services-grid">
                 <div class="service-item"><div class="service-icon"><span>📅</span></div><h3>خطط حفظ تفاعلية</h3><p>خطط يومية تلقائية للحفظ والمراجعة والربط تناسب مستواك.</p></div>
                 <div class="service-item"><div class="service-icon"><span>📊</span></div><h3>متابعة دقيقة للتقدم</h3><p>إحصائيات وتقويم مرئي لمتابعة إنجازك وصفحاتك المحفوظة.</p></div>
                 <div class="service-item"><div class="service-icon"><span>✨</span></div><h3>تحفيز وتشجيع</h3><p>نظام ألقاب ومستويات وتتبع للإنجاز المتتالي لزيادة حماسك.</p></div>
                 <div class="service-item"><div class="service-icon"><span>🧠</span></div><h3>أدوات مساعدة</h3><p>إمكانية إضافة خرائط ذهنية ومسابقات وروابط مفيدة.</p></div>
             </div>
        </section>

        <section class="features-section content-section alt-background">
              <h2>مميزات الموقع</h2>
              <div class="features-grid">
                  <div class="feature-item"><div class="feature-icon-circle"><span>🎯</span></div><h3>التركيز والمنهجية</h3><p>نوفر لك خطة واضحة ومنظمة تساعدك على التركيز في حفظك ومراجعتك.</p></div>
                  <div class="feature-item"><div class="feature-icon-circle"><span>🤝</span></div><h3>المرونة</h3><p>تستطيع تسجيل الأعذار وتتأقلم الخطة تلقائياً مع ظروفك.</p></div>
                  <div class="feature-item"><div class="feature-icon-circle"><span>💖</span></div><h3>التحفيز الذاتي</h3><p>نظام المستويات والألقاب يساعدك على مراقبة تطورك والاحتفاء بإنجازك.</p></div>
                  <div class="feature-item"><div class="feature-icon-circle"><span>⏳</span></div><h3>توفير الوقت</h3><p>لا حاجة لحساب الصفحات أو المراجعات، المنصة تقوم بذلك نيابة عنك.</p></div>
              </div>
        </section>

        <section id="plan-setup-section">
             <h2>إعداد خطتك لأول مرة</h2>
             <p>يرجى اختيار الخطة المناسبة وتحديد تاريخ البدء.</p>
             <div class="plan-selection-area"> <div class="plans-container"> <div class="plan-card" data-plan-type="2"><h3>خطة صفحتين</h3><p>وصف...</p><span class="plan-link">اختر</span></div> </div> </div>
             <div class="plan-setup-inputs"> <div><label for="planStartDate">تاريخ البدء:</label><input type="date" id="planStartDate" required></div><div><label for="planRepetitionMax">التكرارات:</label><select id="planRepetitionMax"><option value="20" selected>20</option><option value="30">30</option><option value="40">40</option></select></div></div>
             <button id="confirmPlanBtn" disabled>تأكيد الخطة والبدء</button>
             </section>

        <section class="stats-section content-section">
              <h2>منارة الحفظ بالأرقام</h2>
              <div class="stats-grid">
                  <div class="stat-item"><span class="stat-icon">📊</span><span class="stat-number">1000+</span><span class="stat-title">خطة تم إنشاؤها</span></div>
                  <div class="stat-item"><span class="stat-icon">🧑‍🎓</span><span class="stat-number">500+</span><span class="stat-title">طالب ملتزم</span></div>
                  <div class="stat-item"><span class="stat-icon">📄</span><span class="stat-number">5000+</span><span class="stat-title">صفحة تم حفظها</span></div>
                  <div class="stat-item"><span class="stat-icon">🌟</span><span class="stat-number">100+</span><span class="stat-title">مستوى تم بلوغه</span></div>
              </div>
          </section>

        <div id="dashboard-link-container" style="text-align: center; padding: 20px 0;"></div>

    </main>

    <footer class="main-footer">
        <p>&copy; <span id="current-year">2025</span> منارة الحفظ. جميع الحقوق محفوظة.</p>
    </footer>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = { apiKey: "AIzaSyDuUebu7Qzz3JnTfa-58EIPZjOcrkmdGHU", authDomain: "quranplan2.firebaseapp.com", projectId: "quranplan2", storageBucket: "quranplan2.appspot.com", messagingSenderId: "1098692856811", appId: "1:1098692856811:web:923bca3a54fd78b1b267ae" };
        try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Init Error:", e); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM Element References ---
        const loginBtn = document.getElementById('google-signin-btn');
        const planSetupSection = document.getElementById('plan-setup-section');
        const planCards = planSetupSection?.querySelectorAll('.plan-card');
        const planStartDateInput = document.getElementById('planStartDate');
        const planRepetitionMaxSelect = document.getElementById('planRepetitionMax');
        const confirmPlanBtn = document.getElementById('confirmPlanBtn');
        const userProfileArea = document.getElementById('user-profile-area');
        const userNameSpan = document.getElementById('user-name');
        const userPhoto = document.getElementById('user-photo');
        const studentLevelTitleSpan = document.getElementById('student-level-title');
        const currentYearSpan = document.getElementById('current-year');
        const dashboardLinkContainer = document.getElementById('dashboard-link-container');
        const ctaContainer = document.getElementById('cta-button-container');
        const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
        const mainNav = document.querySelector('nav.main-navigation');
        const profileTrigger = document.getElementById('user-profile-trigger');
        const profileDropdown = document.getElementById('profile-dropdown');

        // --- Global State ---
        let currentUser = null;
        let selectedPlanType = null;
        let hasExistingPlan = false;
        const initialTotalRows = 320;

        // --- Helper Functions ---
        function formatDate(date) { if (!(date instanceof Date)) { date = new Date(date); } if (isNaN(date.getTime())) { return ""; } const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
        async function checkIfPlanExists(uid) { if (!uid) return false; const planRef = db.collection("quranPlans").doc(uid); try { const doc = await planRef.get(); console.log(`Index: Plan check for ${uid}: Exists = ${doc.exists}`); return doc.exists; } catch (error) { console.error("Error checking plan existence:", error); return false; } }

        // --- Level/Title Calculation & Display ---
        const levelTitles = ["ابدأ رحلتك!", "🌱 غرسة الإيمان", "✨ بادرة أمل", "🏃 ساعٍ للعلا", "⭐ نجم صاعد", "💪 مثابر مجتهد", "🧭 على الدرب", "💯 صاحب السبعين", "🚀 انطلاقة قوية", "💎 جوهرة مصقولة", "👑 صاحب المئة يوم", "📖 رفيق القرآن", "🕯️ منارة هدى", "🏔️ قمة شامخة", "🌳 شجرة طيبة", "⏳ عابر منتصف الطريق", "🎯 دقة والتزام", "🌊 بحر زاخر", "🌟 كوكب دري", "🧭 بوصلة الحق", "💯💯 المئتان لا تقفان!", "🤲 قلب خاشع", "🕊️ روح مطمئنة", "💖 محب للرحمن", "🙏 عبد شكور", "💡 بصيرة نافذة", "🕌 معمّر بيوت الله", "🌙 هلال الكمال", "✨ نور على نور", "🏁 قاب قوسين أو أدنى", "🏆 فارس الثلاثمائة", "🎉 مقترب من الختام", "🎊 خاتم مبارك"];
        const levelIcons = { 10: '👑', 20: '💯', 30: '🏆', 32: '🎊' };
        function calculateLevelTitle(tableRows) { /* ... Same calculation logic ... */ if (!tableRows || tableRows.length === 0) return { title: levelTitles[0], icon: '' }; const sortedRows = [...tableRows].sort((a, b) => new Date(a.displayDate) - new Date(b.displayDate)); let currentStreak = 0; let streakBroken = false; const todayStr = formatDate(new Date()); let tempCurrentStreak = 0; for (let i = sortedRows.length - 1; i >= 0; i--) { const row = sortedRows[i]; if (row.displayDate > todayStr) continue; if (row.type === 'plan' && row.state?.completed) { if (!streakBroken) { tempCurrentStreak++; } } else if (row.type === 'excuse') { continue; } else { streakBroken = true; if (row.displayDate === todayStr) { tempCurrentStreak = 0; } break; } } currentStreak = tempCurrentStreak; const levelIndex = Math.min(Math.floor(currentStreak / 10), levelTitles.length - 1); const title = levelTitles[levelIndex] || levelTitles[0]; const icon = levelIcons[levelIndex] || ''; return { title: title, icon: icon }; }
        async function displayStudentLevel(uid) { /* ... Same display logic ... */ if (!studentLevelTitleSpan) return; studentLevelTitleSpan.style.display = 'none'; try { const planRef = db.collection("quranPlans").doc(uid); const doc = await planRef.get(); if (doc.exists) { const planData = doc.data(); if (planData.tableRows) { const levelInfo = calculateLevelTitle(planData.tableRows); if (levelInfo && levelInfo.title) { studentLevelTitleSpan.textContent = `(${levelInfo.title} ${levelInfo.icon})`.trim(); studentLevelTitleSpan.style.display = 'block'; } } } } catch (error) { console.error("Error fetching plan data for level title:", error); } }

        // --- UI Update Function (Handles Conditional Button & Profile) ---
        function updateUIBasedOnLoginAndPlanState() { /* ... Same logic as before ... */ if (ctaContainer) ctaContainer.innerHTML = ''; if (dashboardLinkContainer) dashboardLinkContainer.innerHTML = ''; if (currentUser) { if(loginBtn) loginBtn.style.display = 'none'; if(userProfileArea) userProfileArea.style.display = 'block'; if(profileTrigger){ if(userNameSpan) userNameSpan.textContent = currentUser.displayName || 'مستخدم'; if(userPhoto) userPhoto.src = currentUser.photoURL || 'images/avatar_placeholder.png'; } displayStudentLevel(currentUser.uid); if (hasExistingPlan) { if(planSetupSection) planSetupSection.style.display = 'none'; if (ctaContainer) { ctaContainer.innerHTML = `<a href="dashboard.html" class="cta-button">الذهاب إلى لوحة المتابعة</a>`; } } else { if(planSetupSection) planSetupSection.style.display = 'block'; if (ctaContainer) { ctaContainer.innerHTML = `<a href="#plan-setup-section" class="cta-button">اختر خطتك الآن</a>`; } if (planStartDateInput && !planStartDateInput.value) planStartDateInput.value = formatDate(new Date()); updateConfirmButtonState(); } } else { if(loginBtn) loginBtn.style.display = 'inline-block'; if(userProfileArea) userProfileArea.style.display = 'none'; if(planSetupSection) planSetupSection.style.display = 'none'; if (studentLevelTitleSpan) studentLevelTitleSpan.style.display = 'none'; if (dashboardLinkContainer) dashboardLinkContainer.innerHTML = ''; if (ctaContainer) { const loginPromptButtonHTML = `<button id="hero-login-btn" class="cta-button">سجل الدخول للبدء</button>`; ctaContainer.innerHTML = loginPromptButtonHTML; const heroLoginBtn = document.getElementById('hero-login-btn'); if (heroLoginBtn) { heroLoginBtn.addEventListener('click', () => { const provider = new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(provider).catch(err => { console.error("Sign-in error:", err); alert("حدث خطأ أثناء تسجيل الدخول: " + err.message); }); }); } } } }

        // --- Other Functions (Confirm Button State, Save Initial Data) ---
        function updateConfirmButtonState() { if (!confirmPlanBtn) return; confirmPlanBtn.disabled = !(selectedPlanType && planStartDateInput?.value); }
        async function saveInitialPlanData() { /* ... Same logic as before ... */ if (!currentUser || !selectedPlanType || !planStartDateInput || !planStartDateInput.value || !planRepetitionMaxSelect) { alert("يرجى اختيار خطة وتحديد تاريخ البدء وعدد التكرارات."); return; } const selectedStartDate = new Date(planStartDateInput.value + 'T00:00:00Z'); if (isNaN(selectedStartDate.getTime())) { alert('تاريخ البدء المحدد غير صالح.'); return; } if(confirmPlanBtn) { confirmPlanBtn.disabled = true; confirmPlanBtn.textContent = "جاري الحفظ..."; } const uid = currentUser.uid; const planRef = db.collection("quranPlans").doc(uid); const initialTableRows = []; let currentDate = new Date(selectedStartDate); for (let i = 0; i < initialTotalRows; i++) { const rowData = { type: 'plan', originalSequence: i, displaySeq: i + 1, displayDate: formatDate(currentDate), state: { yestRep: 0, listen: 0, interp: false, record: 0, rep: 0, linked: false, reviewed: false, completed: false } }; initialTableRows.push(rowData); if (i < initialTotalRows - 1) { currentDate.setUTCDate(currentDate.getUTCDate() + 1); } } const planDataToSave = { studentName: currentUser.displayName || "طالب علم", email: currentUser.email, startDate: planStartDateInput.value, planType: selectedPlanType, repetitionMax: parseInt(planRepetitionMaxSelect.value), excuseDates: [], tableRows: initialTableRows, createdAt: firebase.firestore.FieldValue.serverTimestamp(), lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }; console.log("Saving initial plan data (including tableRows):", planDataToSave); try { await planRef.set(planDataToSave); console.log("Initial plan data saved!"); hasExistingPlan = true; window.location.href = 'dashboard.html'; } catch (error) { console.error("Error saving initial plan data: ", error); alert("حدث خطأ أثناء حفظ بيانات الخطة. حاول مرة أخرى."); if(confirmPlanBtn) { confirmPlanBtn.disabled = false; confirmPlanBtn.textContent = "تأكيد الخطة والبدء"; } } }

        // --- Authentication State Listener ---
        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            if (user) { hasExistingPlan = await checkIfPlanExists(user.uid); }
            else { hasExistingPlan = false; }
            updateUIBasedOnLoginAndPlanState();
        });

        // --- Event Listeners ---
        // Google Sign-in (Header Button)
        if (loginBtn) { loginBtn.addEventListener('click', () => { const provider = new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(provider).catch(err => { console.error("Sign-in error:", err); alert("حدث خطأ أثناء تسجيل الدخول: " + err.message); }); }); }
        // Plan Card Selection
        if(planCards) { planCards.forEach(card => { card.addEventListener('click', () => { if(planCards) planCards.forEach(c => c.classList.remove('selected')); card.classList.add('selected'); selectedPlanType = parseInt(card.getAttribute('data-plan-type')); updateConfirmButtonState(); }); }); }
        // Date Input Change
        if (planStartDateInput) { planStartDateInput.addEventListener('change', updateConfirmButtonState); }
        // Confirm Plan Button
        if (confirmPlanBtn) { confirmPlanBtn.addEventListener('click', saveInitialPlanData); }

        // --- Mobile Menu Toggle Functionality ---
        if (mobileMenuToggle && mainNav) {
            mobileMenuToggle.addEventListener('click', () => {
                const isOpen = mainNav.classList.toggle('mobile-menu-open');
                mobileMenuToggle.setAttribute('aria-expanded', isOpen);
                mobileMenuToggle.innerHTML = isOpen ? '✕' : '☰';
            });
            document.addEventListener('click', (event) => { /* Close on outside click */ if (mainNav.classList.contains('mobile-menu-open') && !mainNav.contains(event.target) && !mobileMenuToggle.contains(event.target)) { mainNav.classList.remove('mobile-menu-open'); mobileMenuToggle.setAttribute('aria-expanded', 'false'); mobileMenuToggle.innerHTML = '☰'; } });

             // === Mobile Submenu Toggle (Updated for better closing behavior) ===
             const menuItemsWithChildren = mainNav.querySelectorAll('li.menu-item-has-children');
             menuItemsWithChildren.forEach(item => {
                 let subToggle = item.querySelector('.submenu-toggle');
                 if (!subToggle) {
                     subToggle = document.createElement('span'); subToggle.classList.add('submenu-toggle'); subToggle.innerHTML = '<span class="arrow">▼</span>';
                     // Append directly to the li, so it's easier to manage layout with flex
                     item.appendChild(subToggle);

                     subToggle.addEventListener('click', (event) => {
                         event.stopPropagation();
                         const parentLi = item;
                         const currentlyOpen = parentLi.classList.contains('submenu-open');

                         // Close ALL other submenus first
                         mainNav.querySelectorAll('li.menu-item-has-children.submenu-open').forEach(otherItem => {
                             if (otherItem !== parentLi) { // Don't close the one we might be opening
                                 otherItem.classList.remove('submenu-open');
                                 const otherArrow = otherItem.querySelector('.submenu-toggle .arrow');
                                 if (otherArrow) otherArrow.innerHTML = '▼';
                             }
                         });

                         // Toggle the current submenu
                         parentLi.classList.toggle('submenu-open');
                         const arrow = subToggle.querySelector('.arrow');
                         if (arrow) arrow.innerHTML = parentLi.classList.contains('submenu-open') ? '▲' : '▼';
                     });

                      // Also allow clicking the main link text to toggle the submenu on mobile
                      const link = item.querySelector('a');
                      if(link && subToggle){
                           link.addEventListener('click', (e) => {
                               if(window.innerWidth <= 1024 && item.querySelector('.dropdown')) { // Check if it has a dropdown
                                   e.preventDefault(); // Prevent link navigation
                                   subToggle.click(); // Trigger the toggle click
                               }
                           });
                      }
                 }
             });
        }

        // --- Profile Dropdown Toggle ---
        if (profileTrigger && profileDropdown) {
            const logoutBtn = profileDropdown.querySelector('#logout-button');
            profileTrigger.addEventListener('click', (event) => { event.stopPropagation(); const isOpen = profileDropdown.classList.toggle('open'); profileTrigger.setAttribute('aria-expanded', isOpen); /* CSS handles display */ });
            if(logoutBtn) { logoutBtn.addEventListener('click', () => { auth.signOut().catch((error) => { console.error('Sign out error:', error); }); }); }
            document.addEventListener('click', (event) => { if (!profileTrigger?.contains(event.target) && !profileDropdown?.contains(event.target) && profileDropdown?.classList.contains('open')) { profileDropdown.classList.remove('open'); profileTrigger.setAttribute('aria-expanded', 'false'); } });
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            if(currentYearSpan) { currentYearSpan.textContent = new Date().getFullYear(); }
        });

    </script>

</body>
</html>