<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ููุงุฑุฉ ุงูุญูุธ - ุงูุฑุฆูุณูุฉ</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style.css">

    <style>
        /* --- CSS ูุคูุช ููุชูุถูุญ --- */
        /* ุณูุญุชุงุฌ ูุชุทููุฑ ูุฐุง ุจุดูู ูุจูุฑ ูุงุญูุงู */
        body { font-family: 'Tajawal', sans-serif; margin: 0; background-color: #f9f9f9; }
        .header-container { display: flex; justify-content: space-between; align-items: center; padding: 10px 25px; background-color: #eaf2f8; border-bottom: 2px solid #aed6f1; }
        .logo-container img { max-height: 50px; /* ูุซุงู */ }
        .site-branding { display: flex; align-items: center; gap: 15px; }
        .site-name { font-size: 1.5em; font-weight: bold; color: #1a5276; }
        nav ul { list-style: none; padding: 0; margin: 0; display: flex; gap: 15px; }
        nav ul li { position: relative; } /* ููููุงุฆู ุงูููุณุฏูุฉ */
        nav ul li a { text-decoration: none; color: #333; padding: 10px 5px; display: block; }
        nav ul li a:hover { color: #2980b9; }
        /* ุฅุฎูุงุก ุงูููุงุฆู ุงูููุณุฏูุฉ ูุจุฏุฆูุงู */
        nav ul li .dropdown { display: none; position: absolute; background-color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 0; min-width: 180px; z-index: 100; border: 1px solid #eee; border-radius: 4px; }
        nav ul li:hover .dropdown { display: block; }
        nav ul li .dropdown li { width: 100%; }
        nav ul li .dropdown li a { padding: 10px 15px; white-space: nowrap; }
        nav ul li .dropdown li a:hover { background-color: #f1f1f1; }

        .auth-area { display: flex; align-items: center; gap: 15px; }
        #user-profile-area img { width: 40px; height: 40px; border-radius: 50%; border: 1px solid #ccc; }
        #user-profile-area button { /* ุชูุณูู ุฒุฑ ุงูุฎุฑูุฌ */ padding: 5px 10px; cursor: pointer; }
        .google-signin-btn { /* ุชูุณูู ุฒุฑ ุงูุฏุฎูู */ padding: 8px 15px; cursor: pointer; background-color: #4285F4; color: white; border: none; border-radius: 4px; }
        #student-level-title { font-weight: bold; color: #1e8449; font-size: 0.9em; }

        main { padding: 20px; }
        footer { text-align: center; padding: 20px; margin-top: 40px; background-color: #2c3e50; color: #ecf0f1; font-size: 0.9em; }
        footer a { color: #3498db; }

        /* ุชูุณูู ูุจุฏุฆู ููุณู ุฅุนุฏุงุฏ ุงูุฎุทุฉ - ูููู ุชุญุณููู */
        #plan-setup-section { background-color: #fff; padding: 30px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee; text-align: center; }
        #plan-setup-section h2 { color: #1a5276; }
        /* ... (ูุฏ ุชุญุชุงุฌ ูุฅุถุงูุฉ ุชูุณููุงุช ุฃุฎุฑู ูู ูููู ุงูุฃุตูู ุฅุฐุง ุฃุฑุฏุช) ... */

    </style>
</head>
<body>

    <header class="header-container">
        <div class="site-branding">
            <div class="logo-container">
                <img src="images/logo-placeholder.png" alt="ุดุนุงุฑ ููุงุฑุฉ ุงูุญูุธ" style="height: 50px;">
            </div>
            <span class="site-name">ููุงุฑุฉ ุงูุญูุธ</span>
        </div>

        <nav>
            <ul>
                <li><a href="index.html">ุงูุฑุฆูุณูุฉ</a></li>
                <li>
                    <a href="#about">ุนู ููุงุฑุฉ ุงูุญูุธ</a>
                    </li>
                 <li>
                    <a href="#">ุฎุทุท ุงูุญูุธ</a>
                    <ul class="dropdown">
                        <li><a href="#">ุฎุทุฉ ุตูุญุฉ ููููุงู</a></li>
                        <li><a href="#">ุฎุทุฉ ุตูุญุชูู ููููุงู</a></li>
                        <li><a href="#">ุฎุทุฉ 3 ุตูุญุงุช ููููุงู</a></li>
                         <li><a href="#">ุฎุทุฉ 4 ุตูุญุงุช ููููุงู</a></li>
                        </ul>
                </li>
                 <li>
                    <a href="#">ุงูุฏูุฑุงุช ูุงูุจุฑุงูุฌ</a>
                     <ul class="dropdown">
                        <li><a href="#">ุฏูุฑุงุช ุงูุชุฌููุฏ</a></li>
                        <li><a href="#">ุจุฑุงูุฌ ุงููุฑุงุฌุนุฉ ุงูููุซูุฉ</a></li>
                        </ul>
                </li>
                 <li>
                    <a href="#">ุงูุฎุฑุงุฆุท ุงูุฐูููุฉ</a>
                     <ul class="dropdown">
                        <li><a href="#">ุฎุฑุงุฆุท ุงูุณูุฑ</a></li>
                        <li><a href="#">ุฎุฑุงุฆุท ุงููุชุดุงุจูุงุช</a></li>
                         </ul>
                </li>
                <li>
                    <a href="#">ุงูุชุณุฌูู</a>
                     <ul class="dropdown">
                        <li><a href="#">ุชุณุฌูู ุทุงูุจ</a></li>
                        <li><a href="#">ุชุณุฌูู ูุนูู</a></li>
                        <li><a href="#">ุชุณุฌูู ูุดุฑู</a></li>
                        </ul>
                </li>
                 </ul>
        </nav>

        <div class="auth-area">
            <button id="google-signin-btn" class="google-signin-btn" style="display: inline-block;">
                ุชุณุฌูู ุงูุฏุฎูู ุจุญุณุงุจ Google
            </button>
            <div id="user-profile-area" style="display: none; align-items: center; gap: 10px;">
                <img id="user-photo" src="placeholder.png" alt="ุตูุฑุฉ ุงููุณุชุฎุฏู">
                <span id="user-name">ุฃููุงู ุจู</span>
                <span id="student-level-title" style="display: none; margin-right: 10px;"></span>
                <button id="logout-button">ุชุณุฌูู ุงูุฎุฑูุฌ</button>
            </div>
            <p id="welcome-message" style="display: none;">ุฃููุงู ุจู!</p>
        </div>
    </header>

    <main>
        <section class="hero-section" style="text-align: center; padding: 50px 20px; background-color: #d6eaf8;">
             <h2>ูุฑุญุจุงู ุจู ูู ููุงุฑุฉ ุงูุญูุธ</h2>
            <p>ุญูุซ ุงูุชููุฒ ูู ุชุนููู ุงููุฑุขู ูุชุฌููุฏู ูุญูุธูุ ูุงูุฅุจุฏุงุน ูู ุบุฑุณ ูููููู.</p>
             <div style="padding: 50px; background-color: #ccc; margin: 20px auto; max-width: 400px;">(ุตูุฑุฉ ุฃู ุฑุณู ุชูุถูุญู)</div>
        </section>

        <section id="about" style="padding: 40px 20px;">
            <h2 style="text-align: center;">ุชุนุฑูู ุจููุงุฑุฉ ุงูุญูุธ</h2>
            <p style="max-width: 800px; margin: 0 auto; text-align: center;">
                ููุงุฑุฉ ุงูุญูุธ ูู ููุตุฉ ุฅููุชุฑูููุฉ ุชุทูุนูุฉ ุชูุฏู ูุชูุณูุฑ ุญูุธ ุงููุฑุขู ุงููุฑูู ูุนูููู ููุฑุงุฌุนุชู ูููุณูููู ุญูู ุงูุนุงูู ุนุจุฑ ุฎุทุท ุชูุงุนููุฉ ูุฃุฏูุงุช ูุชุงุจุนุฉ ุญุฏูุซุฉ... (ุฃููู ุงููุต ููุง)
            </p>
            </section>

        <section class="features-section" style="padding: 40px 20px; background-color: #eaf2f8;">
            <h2 style="text-align: center;">ุฎุฏูุงุชูุง ููููุฒุงุชูุง</h2>
            <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px; text-align: center;">
                <div class="feature-item" style="flex-basis: 200px; padding: 15px; background-color: #fff; border-radius: 5px;">
                     <div class="icon" style="font-size: 2em; margin-bottom: 10px;">๐</div>
                    <h3>ุฎุทุท ุญูุธ ุชูุงุนููุฉ</h3>
                    <p>ุฎุทุท ููููุฉ ุชููุงุฆูุฉ ููุญูุธ ูุงููุฑุงุฌุนุฉ ูุงูุฑุจุท.</p>
                </div>
                <div class="feature-item" style="flex-basis: 200px; padding: 15px; background-color: #fff; border-radius: 5px;">
                     <div class="icon" style="font-size: 2em; margin-bottom: 10px;">๐</div>
                    <h3>ูุชุงุจุนุฉ ุงูุชูุฏู</h3>
                    <p>ุฅุญุตุงุฆูุงุช ูุชูููู ูุฑุฆู ููุชุงุจุนุฉ ุฅูุฌุงุฒู.</p>
                 </div>
                <div class="feature-item" style="flex-basis: 200px; padding: 15px; background-color: #fff; border-radius: 5px;">
                    <div class="icon" style="font-size: 2em; margin-bottom: 10px;">โจ</div>
                   <h3>ุชุญููุฒ ูุณุชูุฑ</h3>
                   <p>ูุธุงู ุฃููุงุจ ููุณุชููุงุช ูุชุชุจุน ููุฅูุฌุงุฒ ุงููุชุชุงูู.</p>
               </div>
                <div class="feature-item" style="flex-basis: 200px; padding: 15px; background-color: #fff; border-radius: 5px;">
                    <div class="icon" style="font-size: 2em; margin-bottom: 10px;">๐ค</div>
                   <h3>ูุฌุชูุน ุฏุงุนู</h3>
                   <p>(ุงุฎุชูุงุฑู) ุฅููุงููุฉ ุฅุถุงูุฉ ุฃูุณุงู ููุชูุงุนู ุฃู ุงูููุงูุณุฉ.</p>
               </div>
                </div>
        </section>

         <section id="plan-setup-section" style="display: none;">
             <h2>ุฅุนุฏุงุฏ ุฎุทุชู ูุฃูู ูุฑุฉ</h2>
            <p>ูุฑุฌู ุงุฎุชูุงุฑ ุงูุฎุทุฉ ุงูููุงุณุจุฉ ูุชุญุฏูุฏ ุชุงุฑูุฎ ุงูุจุฏุก.</p>
            <div class="plan-selection-area">
                <div class="plans-container" style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px;">
                     <div class="plan-card" data-plan-type="2" style="border: 1px solid #ddd; padding: 20px; flex-basis: 200px; cursor: pointer;">
                        <h3>ุฎุทุฉ ุญูุธ ุตูุญุชูู ูููููุง</h3>
                         <p>ุงูุฎุทุฉ ุงูุฃุณุงุณูุฉ ูุงูููุตู ุจูุง.</p>
                         <span class="plan-link" style="color: #2980b9; font-weight: bold; margin-top: 10px; display: block;">ุงุฎุชุฑ ูุฐู ุงูุฎุทุฉ</span>
                    </div>
                     </div>
             </div>
            <div class="plan-setup-inputs" style="margin-top: 20px;">
                 <label for="planStartDate">ุชุงุฑูุฎ ุงูุจุฏุก:</label>
                 <input type="date" id="planStartDate" required>
                <label for="planRepetitionMax">ุงูุชูุฑุงุฑุงุช:</label>
                 <select id="planRepetitionMax">
                    <option value="20" selected>20</option>
                    <option value="30">30</option>
                    <option value="40">40</option>
                 </select>
             </div>
            <button id="confirmPlanBtn" disabled style="margin-top: 20px; padding: 10px 20px; cursor: pointer;">ุชุฃููุฏ ุงูุฎุทุฉ ูุงูุจุฏุก</button>
         </section>

         </main>

    <footer class="main-footer">
        <p>&copy; <span id="current-year">2025</span> ููุงุฑุฉ ุงูุญูุธ. ุฌููุน ุงูุญููู ูุญููุธุฉ.</p>
        </footer>

    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

    <script>
        // --- Firebase Configuration ---
        // ูุฌุจ ุฃู ูููู ููุณ ุงูููุฌูุฏ ูู ูููู ุงูุฃุตูู
        const firebaseConfig = {
         apiKey: "AIzaSyDuUebu7Qzz3JnTfa-58EIPZjOcrkmdGHU",
         authDomain: "quranplan2.firebaseapp.com",
         projectId: "quranplan2",
         storageBucket: "quranplan2.appspot.com",
         messagingSenderId: "1098692856811",
         appId: "1:1098692856811:web:923bca3a54fd78b1b267ae"
        };

        // --- Initialize Firebase ---
         try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Init Error:", e); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Get DOM Elements ---
        // (ูุฌุจ ููู ูู ุชุนุฑููุงุช ุงูุนูุงุตุฑ ูู ูููู ุงูุฃุตูู ูุงูุชุฃูุฏ ูู ูุทุงุจูุชูุง ูููููู ุงูุฌุฏูุฏ)
        const loginBtn = document.getElementById('google-signin-btn');
        const welcomeMessage = document.getElementById('welcome-message'); // ูุฏ ูุง ูุณุชุฎุฏููุง ุจููุณ ุงูุทุฑููุฉ
        const planSetupSection = document.getElementById('plan-setup-section');
        const planCards = planSetupSection?.querySelectorAll('.plan-card'); // ุงุณุชุฎุฏุงู '?' ููุฃูุงู
        const planStartDateInput = document.getElementById('planStartDate');
        const planRepetitionMaxSelect = document.getElementById('planRepetitionMax');
        const confirmPlanBtn = document.getElementById('confirmPlanBtn');
        const userProfileArea = document.getElementById('user-profile-area');
        const userNameSpan = document.getElementById('user-name');
        const userPhoto = document.getElementById('user-photo');
        const logoutButton = document.getElementById('logout-button');
        const studentLevelTitleSpan = document.getElementById('student-level-title'); // ุนูุตุฑ ุงูููุจ ุงูุฌุฏูุฏ
        const currentYearSpan = document.getElementById('current-year'); // ููููุชุฑ

        // --- Global State ---
        let currentUser = null;
        let selectedPlanType = null;
        let hasExistingPlan = false;

        // --- Constants ---
        const initialTotalRows = 320; // Consistent with plangen2.html structure

        // --- Helper Functions ---
        function formatDate(date) { /* ... ููุณ ุงูุฏุงูุฉ ูู ูููู ุงูุฃุตูู ... */ if (!(date instanceof Date)) { date = new Date(date); } if (isNaN(date.getTime())) { return ""; } const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }

        // --- Firestore Check ---
        async function checkIfPlanExists(uid) { /* ... ููุณ ุงูุฏุงูุฉ ูู ูููู ุงูุฃุตูู ... */ if (!uid) return false; const planRef = db.collection("quranPlans").doc(uid); try { const doc = await planRef.get(); console.log(`Index: Plan check for ${uid}: Exists = ${doc.exists}`); return doc.exists; } catch (error) { console.error("Error checking plan existence:", error); return false; } }

        // --- *** START: ุฏุงูุฉ ุฌูุจ ุงูููุจ (ุฌุฏูุฏุฉ) *** ---
        const levelTitles = ["ุงุจุฏุฃ ุฑุญูุชู!", "๐ฑ ุบุฑุณุฉ ุงูุฅููุงู", "โจ ุจุงุฏุฑุฉ ุฃูู", "๐ ุณุงุนู ููุนูุง", "โญ ูุฌู ุตุงุนุฏ", "๐ช ูุซุงุจุฑ ูุฌุชูุฏ", "๐งญ ุนูู ุงูุฏุฑุจ", "๐ฏ ุตุงุญุจ ุงูุณุจุนูู", "๐ ุงูุทูุงูุฉ ูููุฉ", "๐ ุฌููุฑุฉ ูุตูููุฉ", "๐ ุตุงุญุจ ุงููุฆุฉ ููู", "๐ ุฑููู ุงููุฑุขู", "๐ฏ๏ธ ููุงุฑุฉ ูุฏู", "๐๏ธ ููุฉ ุดุงูุฎุฉ", "๐ณ ุดุฌุฑุฉ ุทูุจุฉ", "โณ ุนุงุจุฑ ููุชุตู ุงูุทุฑูู", "๐ฏ ุฏูุฉ ูุงูุชุฒุงู", "๐ ุจุญุฑ ุฒุงุฎุฑ", "๐ ูููุจ ุฏุฑู", "๐งญ ุจูุตูุฉ ุงูุญู", "๐ฏ๐ฏ ุงููุฆุชุงู ูุง ุชููุงู!", "๐คฒ ููุจ ุฎุงุดุน", "๐๏ธ ุฑูุญ ูุทูุฆูุฉ", "๐ ูุญุจ ููุฑุญูู", "๐ ุนุจุฏ ุดููุฑ", "๐ก ุจุตูุฑุฉ ูุงูุฐุฉ", "๐ ูุนููุฑ ุจููุช ุงููู", "๐ ููุงู ุงูููุงู", "โจ ููุฑ ุนูู ููุฑ", "๐ ูุงุจ ููุณูู ุฃู ุฃุฏูู", "๐ ูุงุฑุณ ุงูุซูุงุซูุงุฆุฉ", "๐ ููุชุฑุจ ูู ุงูุฎุชุงู", "๐ ุฎุงุชู ูุจุงุฑู"];
        const levelIcons = { 10: '๐', 20: '๐ฏ', 30: '๐', 32: '๐' }; // Example icons

        function calculateLevelTitle(tableRows) {
            // (ูุฐู ูุณุฎุฉ ูุจุณุทุฉ ูู ุฏุงูุฉ ุญุณุงุจ ุงูุฅูุฌุงุฒ ุงููุชุชุงูู ูู dashboard.html)
            if (!tableRows || tableRows.length === 0) return levelTitles[0]; // ุงูููุจ ุงูุงูุชุฑุงุถู
            const sortedRows = [...tableRows].sort((a, b) => new Date(a.displayDate) - new Date(b.displayDate));
            let currentStreak = 0;
            let streakBroken = false;
            const todayStr = formatDate(new Date());
            for (let i = sortedRows.length - 1; i >= 0; i--) {
                const row = sortedRows[i];
                if (row.displayDate > todayStr) continue;
                if (row.type === 'plan' && row.state?.completed) {
                    if (!streakBroken) tempCurrentStreak++;
                } else if (row.type === 'excuse') {
                    continue; // Skip excuses for streak count
                } else {
                    streakBroken = true;
                    // If today's task exists and is not complete, streak is 0 for today
                    if (row.displayDate === todayStr) tempCurrentStreak = 0;
                    break; // Stop counting streak
                }
            }
             currentStreak = tempCurrentStreak;
            const levelIndex = Math.min(Math.floor(currentStreak / 10), levelTitles.length - 1);
            const title = levelTitles[levelIndex] || levelTitles[0];
            const icon = levelIcons[levelIndex] || '';
            return `${title} ${icon}`.trim(); // Return title with icon
        }

        async function displayStudentLevel(uid) {
            if (!studentLevelTitleSpan) return;
            try {
                const planRef = db.collection("quranPlans").doc(uid);
                const doc = await planRef.get();
                if (doc.exists) {
                    const planData = doc.data();
                    if (planData.tableRows) {
                        const title = calculateLevelTitle(planData.tableRows);
                        studentLevelTitleSpan.textContent = `(ููุจู: ${title})`;
                        studentLevelTitleSpan.style.display = 'inline'; // ุฃู 'block' ุญุณุจ ุงูุชูุณูู
                    } else {
                         studentLevelTitleSpan.style.display = 'none';
                    }
                } else {
                     studentLevelTitleSpan.style.display = 'none';
                }
            } catch (error) {
                console.error("Error fetching plan data for level title:", error);
                studentLevelTitleSpan.style.display = 'none';
            }
        }
         // --- *** END: ุฏุงูุฉ ุฌูุจ ุงูููุจ (ุฌุฏูุฏุฉ) *** ---

        // --- UI Update Functions ---
        function updateUIBasedOnLoginAndPlanState() {
            // (ููุณ ุงูุฏุงูุฉ ูู ูููู ุงูุฃุตูู ูุน ุชุนุฏูู ุฅุฎูุงุก ูุฅุธูุงุฑ ุงูุนูุงุตุฑ ุญุณุจ ุงููููู ุงูุฌุฏูุฏ)
             const dashboardLinkContainer = document.getElementById('dashboard-link-container'); // ุณูุญุชุงุฌ ูุฅุถุงูุฉ ูุฐุง ุงูุนูุตุฑ
             if (dashboardLinkContainer) dashboardLinkContainer.innerHTML = ''; // Clear previous link/button

            if (currentUser) {
                 if(loginBtn) loginBtn.style.display = 'none';
                 // welcomeMessage ูุง ูุณุชุฎุฏููุง ุจููุณ ุงูุทุฑููุฉ
                 if(userProfileArea) {
                      userProfileArea.style.display = 'flex'; // ุชุฃูุฏ ูู ุงุณุชุฎุฏุงู flex ุฃู block ุญุณุจ ุงูุชุตููู
                      if(userNameSpan) userNameSpan.textContent = currentUser.displayName || 'ูุณุชุฎุฏู';
                      if(userPhoto) userPhoto.src = currentUser.photoURL || 'placeholder.png';
                 }
                  // ุฌูุจ ูุนุฑุถ ุงูููุจ
                 displayStudentLevel(currentUser.uid);

                 if (hasExistingPlan) {
                     console.log("UI Update: User has plan. Hiding setup, showing dashboard link.");
                     if(planSetupSection) planSetupSection.style.display = 'none';

                     // ุฅูุดุงุก ูุนุฑุถ ุฑุงุจุท ููุญุฉ ุงููุชุงุจุนุฉ (ูููู ูุถุนู ูู ููุงู ุขุฎุฑ ุฅุฐุง ุฃุฑุฏุช)
                    if (!dashboardLinkContainer) { // ุฅูุดุงุก ุงูุญุงููุฉ ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ
                         const newDiv = document.createElement('div');
                         newDiv.id = 'dashboard-link-container';
                         newDiv.style.textAlign = 'center';
                         newDiv.style.padding = '20px';
                         // ุฅูุญุงูู ุจููุงู ููุงุณุจุ ูุซูุงู ุฏุงุฎู main
                         document.querySelector('main')?.appendChild(newDiv);
                    }
                     document.getElementById('dashboard-link-container').innerHTML = `<a href="dashboard.html" class="google-signin-btn" style="background-color: #1e8449; display: inline-block; margin-top: 15px;">ุงูุฐูุงุจ ุฅูู ููุญุฉ ุงููุชุงุจุนุฉ ุงูุฎุงุตุฉ ุจู</a>`;

                 } else {
                     console.log("UI Update: User needs to set up plan. Showing setup section.");
                     if(planSetupSection) planSetupSection.style.display = 'block'; // ุฅุธูุงุฑ ูุณู ุงูุฅุนุฏุงุฏ
                     if (dashboardLinkContainer) { // ุฅุฎูุงุก ุฑุงุจุท ููุญุฉ ุงููุชุงุจุนุฉ
                           dashboardLinkContainer.innerHTML = '';
                     }
                     // ุชุญุฏูุฏ ุชุงุฑูุฎ ุงูููู ููููุฉ ุงูุชุฑุงุถูุฉ ูุญูู ุงูุจุฏุก
                     if (planStartDateInput && !planStartDateInput.value) {
                          planStartDateInput.value = formatDate(new Date());
                     }
                     updateConfirmButtonState(); // ุชุญุฏูุซ ุญุงูุฉ ุฒุฑ ุงูุชุฃููุฏ
                 }
            } else {
                 // Logged Out
                 if(loginBtn) loginBtn.style.display = 'inline-block'; // ุฅุธูุงุฑ ุฒุฑ ุงูุฏุฎูู
                 if(userProfileArea) userProfileArea.style.display = 'none'; // ุฅุฎูุงุก ููุทูุฉ ุงููุณุชุฎุฏู
                 if(planSetupSection) planSetupSection.style.display = 'none'; // ุฅุฎูุงุก ูุณู ุงูุฅุนุฏุงุฏ
                 if (studentLevelTitleSpan) studentLevelTitleSpan.style.display = 'none'; // ุฅุฎูุงุก ุงูููุจ
                 if (dashboardLinkContainer) { // ุฅุฎูุงุก ุฑุงุจุท ููุญุฉ ุงููุชุงุจุนุฉ
                      dashboardLinkContainer.innerHTML = '';
                 }
            }
        }

        // Enable/disable confirm button based on selection
        function updateConfirmButtonState() { /* ... ููุณ ุงูุฏุงูุฉ ูู ูููู ุงูุฃุตูู ... */ if (!confirmPlanBtn) return; if (selectedPlanType && planStartDateInput && planStartDateInput.value) { confirmPlanBtn.disabled = false; } else { confirmPlanBtn.disabled = true; } }

        // --- Save Initial Plan Data ---
        async function saveInitialPlanData() { /* ... ููุณ ุงูุฏุงูุฉ ูู ูููู ุงูุฃุตูู ... */ if (!currentUser || !selectedPlanType || !planStartDateInput || !planStartDateInput.value || !planRepetitionMaxSelect) { alert("ูุฑุฌู ุงุฎุชูุงุฑ ุฎุทุฉ ูุชุญุฏูุฏ ุชุงุฑูุฎ ุงูุจุฏุก ูุนุฏุฏ ุงูุชูุฑุงุฑุงุช."); return; } const selectedStartDate = new Date(planStartDateInput.value + 'T00:00:00Z'); if (isNaN(selectedStartDate.getTime())) { alert('ุชุงุฑูุฎ ุงูุจุฏุก ุงููุญุฏุฏ ุบูุฑ ุตุงูุญ.'); return; } if(confirmPlanBtn) { confirmPlanBtn.disabled = true; confirmPlanBtn.textContent = "ุฌุงุฑู ุงูุญูุธ..."; } const uid = currentUser.uid; const planRef = db.collection("quranPlans").doc(uid); const initialTableRows = []; let currentDate = new Date(selectedStartDate); for (let i = 0; i < initialTotalRows; i++) { const rowData = { type: 'plan', originalSequence: i, displaySeq: i + 1, displayDate: formatDate(currentDate), state: { yestRep: 0, listen: 0, interp: false, record: 0, rep: 0, linked: false, reviewed: false, completed: false } }; initialTableRows.push(rowData); if (i < initialTotalRows - 1) { currentDate.setUTCDate(currentDate.getUTCDate() + 1); } } const planDataToSave = { studentName: currentUser.displayName || "ุทุงูุจ ุนูู", email: currentUser.email, startDate: planStartDateInput.value, planType: selectedPlanType, repetitionMax: parseInt(planRepetitionMaxSelect.value), excuseDates: [], tableRows: initialTableRows, createdAt: firebase.firestore.FieldValue.serverTimestamp(), lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }; console.log("Saving initial plan data (including tableRows):", planDataToSave); try { await planRef.set(planDataToSave); console.log("Initial plan data saved!"); hasExistingPlan = true; window.location.href = 'dashboard.html'; } catch (error) { console.error("Error saving initial plan data: ", error); alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุจูุงูุงุช ุงูุฎุทุฉ. ุญุงูู ูุฑุฉ ุฃุฎุฑู."); if(confirmPlanBtn) { confirmPlanBtn.disabled = false; confirmPlanBtn.textContent = "ุชุฃููุฏ ุงูุฎุทุฉ ูุงูุจุฏุก"; } } }

        // --- Authentication State Observer ---
        // (ููุณ ุงูููุฏ ูู ูููู ุงูุฃุตููุ ุณุฃููู ุจุชุนุฏููู ููุดูู ุงุณุชุฏุนุงุก ุนุฑุถ ุงูููุจ)
         auth.onAuthStateChanged(async (user) => {
             currentUser = user;
             if (user) {
                 console.log("Index: Auth state changed: User logged in.");
                 // ุงูุชุญูู ูู ูุฌูุฏ ุฎุทุฉ ุฃููุงู
                 hasExistingPlan = await checkIfPlanExists(user.uid);
                 // ุซู ุชุญุฏูุซ ุงููุงุฌูุฉ ุจูุงุกู ุนูู ุญุงูุฉ ุชุณุฌูู ุงูุฏุฎูู ููุฌูุฏ ุงูุฎุทุฉ
                 updateUIBasedOnLoginAndPlanState(); // ูุฐู ุงูุฏุงูุฉ ุณุชุณุชุฏุนู displayStudentLevel ุฏุงุฎููุงู
             } else {
                 console.log("Index: Auth state changed: User logged out.");
                 hasExistingPlan = false;
                 updateUIBasedOnLoginAndPlanState();
             }
         });


        // --- Event Listeners ---
        // Sign-in Button
        if (loginBtn) { loginBtn.addEventListener('click', () => { /* ... ููุณ ุงูููุฏ ูู ูููู ุงูุฃุตูู ... */ console.log("Login button clicked"); const provider = new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(provider).then(result => { const user = result.user; console.log("Sign-in successful:", user.displayName); const userRef = db.collection("students").doc(user.uid); userRef.get().then((doc) => { const userData = { name: user.displayName, email: user.email, photo: user.photoURL, lastLogin: firebase.firestore.FieldValue.serverTimestamp() }; if (!doc.exists) { userData.joinedAt = firebase.firestore.FieldValue.serverTimestamp(); userRef.set(userData).catch(err => console.error("Error saving new user:", err)); } else { userRef.update(userData).catch(err => console.error("Error updating user:", err)); } }).catch(err => console.error("Error checking user existence:", err)); }).catch(err => { console.error("Sign-in error:", err); alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุณุฌูู ุงูุฏุฎูู. ุฑูุฒ ุงูุฎุทุฃ: " + err.code); }); }); }
        // Logout Button
        if (logoutButton) { logoutButton.addEventListener('click', () => { auth.signOut().catch((error) => { console.error('Sign out error:', error); }); }); }
        // Plan Card Selection in Setup Section
        // ุชุฃูุฏ ูู ุฃู planCards ุชู ุชุนุฑููู ุจุดูู ุตุญูุญ ููุดูุฑ ููุนูุงุตุฑ ุงูุฌุฏูุฏุฉ ุฅุฐุง ุชุบูุฑุช ุงูู classes
        if(planCards) {
            planCards.forEach(card => { card.addEventListener('click', () => { if(planCards) planCards.forEach(c => c.classList.remove('selected')); card.classList.add('selected'); selectedPlanType = parseInt(card.getAttribute('data-plan-type')); console.log("Selected Plan Type:", selectedPlanType); updateConfirmButtonState(); }); });
        }
        // Input fields change listener (for enabling confirm button)
        if (planStartDateInput) { planStartDateInput.addEventListener('change', updateConfirmButtonState); }
        // Confirm Plan Button
        if (confirmPlanBtn) { confirmPlanBtn.addEventListener('click', saveInitialPlanData); }

        // --- Initial Load ---
         document.addEventListener('DOMContentLoaded', () => {
            // ุฅุฎูุงุก ุงูุนูุงุตุฑ ุงูุชู ุชุนุชูุฏ ุนูู ุญุงูุฉ ุชุณุฌูู ุงูุฏุฎูู ูุจุฏุฆูุงู
             if(userProfileArea) userProfileArea.style.display = 'none';
             if(planSetupSection) planSetupSection.style.display = 'none';
             if(loginBtn) loginBtn.style.display = 'inline-block'; // ุฅุธูุงุฑ ุฒุฑ ุงูุฏุฎูู ูุจุฏุฆูุงู
             if (studentLevelTitleSpan) studentLevelTitleSpan.style.display = 'none';

             if(currentYearSpan) { currentYearSpan.textContent = new Date().getFullYear(); }
             // Auth listener will handle UI updates after checking login status
         });

    </script>

</body>
</html>