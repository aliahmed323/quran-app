<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†Ø§Ø±Ø© Ø§Ù„Ø­ÙØ¸ - Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title> <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Somar:wght@400;700&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style.css">

    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

    <style>
        /* Add some basic styles here if needed for immediate structure */
        /* Example: Hide plan setup initially */
        #plan-setup-section { display: none; }
    </style>
</head>
<body>

    <header class="header-container">
        <div class="site-branding">
            <div class="logo-container">
                <img src="images/logo-placeholder.png" alt="Ø´Ø¹Ø§Ø± Ù…Ù†Ø§Ø±Ø© Ø§Ù„Ø­ÙØ¸" style="height: 50px;">
            </div>
            <span class="site-name">Ù…Ù†Ø§Ø±Ø© Ø§Ù„Ø­ÙØ¸</span> </div>

        <nav class="main-navigation">
            <ul>
                <li><a href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                <li>
                    <a href="#about-site">Ø§Ù„ØªØ¹Ø±ÙŠÙ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹</a> </li>
                <li>
                    <a href="#">Ø®Ø·Ø· Ø§Ù„Ø­ÙØ¸</a>
                    <ul class="dropdown">
                        <li><a href="#">Ø®Ø·Ø© ØµÙØ­Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹</a></li>
                        <li><a href="#">Ø®Ø·Ø© ØµÙØ­ØªÙŠÙ† ÙŠÙˆÙ…ÙŠØ§Ù‹</a></li>
                        <li><a href="#">Ø®Ø·Ø© 3 ØµÙØ­Ø§Øª ÙŠÙˆÙ…ÙŠØ§Ù‹</a></li>
                        <li><a href="#">Ø®Ø·Ø© 4 ØµÙØ­Ø§Øª ÙŠÙˆÙ…ÙŠØ§Ù‹</a></li>
                    </ul>
                </li>
                <li>
                    <a href="#">Ø§Ù„Ø¯ÙˆØ±Ø§Øª ÙˆØ§Ù„Ø¨Ø±Ø§Ù…Ø¬</a>
                    <ul class="dropdown">
                        <li><a href="#">Ø¯ÙˆØ±Ø§Øª Ø§Ù„ØªØ¬ÙˆÙŠØ¯</a></li>
                        <li><a href="#">Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</a></li>
                    </ul>
                </li>
                <li>
                    <a href="#">Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ø°Ù‡Ù†ÙŠØ©</a>
                    <ul class="dropdown">
                        <li><a href="#">Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ø³ÙˆØ±</a></li>
                        <li><a href="#">Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø§Øª</a></li>
                    </ul>
                </li>
                 <li>
                    <a href="#">Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</a> <ul class="dropdown">
                         <li><a href="#">Ù…Ø³Ø§Ø¨Ù‚Ø© Ø±Ù…Ø¶Ø§Ù†</a></li>
                         <li><a href="#">Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</a></li>
                    </ul>
                </li>
                <li>
                    <a href="#">Ø§Ù„ØªØ³Ø¬ÙŠÙ„</a>
                    <ul class="dropdown">
                        <li><a href="plangen2.html">ØªØ³Ø¬ÙŠÙ„ Ø·Ø§Ù„Ø¨ (Ø¨Ø¯Ø¡ Ø§Ù„Ø®Ø·Ø©)</a></li>
                        <li><a href="#">ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ù„Ù…</a></li>
                         </ul>
                </li>
                 </ul>
        </nav>

        <div class="auth-area">
            <button id="google-signin-btn" class="google-signin-btn" style="display: inline-block;">
                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google
            </button>
            <div id="user-profile-area" style="display: none; align-items: center; gap: 10px;">
                <img id="user-photo" src="placeholder.png" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                <span id="user-name">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ</span>
                <span id="student-level-title" style="display: none;"></span>
                <button id="logout-button">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </header>

    <main>

        <section class="hero-section">
            <div class="hero-content">
                <div class="hero-text">
                    <h1>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…Ù†Ø§Ø±Ø© Ø§Ù„Ø­ÙØ¸</h1>
                    <h2>Ù…Ù†ØµØ© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… ÙˆØ¹Ù„ÙˆÙ…Ù‡</h2>
                    <p>ÙˆØ§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ ÙÙŠ ØºØ±Ø³ Ù‚ÙŠÙ…Ù‡...</p>
                    <a href="#plan-setup-section" class="cta-button">Ø§Ø¨Ø¯Ø£ Ø®Ø·ØªÙƒ Ø§Ù„Ø¢Ù†</a>
                </div>
                <div class="hero-image">
                    <img src="images/hero-illustration-placeholder.png" alt="Ø±Ø³Ù… ØªÙˆØ¶ÙŠØ­ÙŠ Ù„Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù†">
                </div>
            </div>
        </section>

        <section id="about-site" class="content-section">
            <h2>Ø§Ù„ØªØ¹Ø±ÙŠÙ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹</h2>
            <p>
                Ù…Ù†Ø§Ø±Ø© Ø§Ù„Ø­ÙØ¸ Ù‡ÙŠ Ù…Ù†ØµØ© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© ØªØ·ÙˆØ¹ÙŠØ© ØªÙ‡Ø¯Ù Ù„ØªÙŠØ³ÙŠØ± Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… ÙˆØ¹Ù„ÙˆÙ…Ù‡ ÙˆÙ…Ø±Ø§Ø¬Ø¹ØªÙ‡ Ù„Ù„Ù…Ø³Ù„Ù…ÙŠÙ† Ø­ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù„Ù… Ø¹Ø¨Ø± Ø®Ø·Ø· ØªÙØ§Ø¹Ù„ÙŠØ© ÙˆØ£Ø¯ÙˆØ§Øª Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø¯ÙŠØ«Ø©. Ù†Ø³Ø¹Ù‰ Ù„ØªÙˆÙÙŠØ± Ø¨ÙŠØ¦Ø© Ù…Ø­ÙØ²Ø© ÙˆÙ…Ù†Ø¸Ù…Ø© ØªØ³Ø§Ø¹Ø¯Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… ÙˆØ§Ù„Ù…Ø¯Ø§ÙˆÙ…Ø© Ø¹Ù„Ù‰ ÙˆØ±Ø¯Ùƒ Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠ.
                </p>
            </section>

        <section class="services-section content-section">
            <h2>Ø®Ø¯Ù…Ø§ØªÙ†Ø§ ÙˆÙ…Ù…ÙŠØ²Ø§ØªÙ†Ø§</h2>
            <div class="services-grid">
                <div class="service-item">
                    <div class="service-icon">
                        <span>ğŸ“…</span> </div>
                    <h3>Ø®Ø·Ø· Ø­ÙØ¸ ØªÙØ§Ø¹Ù„ÙŠØ©</h3>
                    <p>Ø®Ø·Ø· ÙŠÙˆÙ…ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ§Ù„Ø±Ø¨Ø· ØªÙ†Ø§Ø³Ø¨ Ù…Ø³ØªÙˆØ§Ùƒ.</p>
                </div>
                <div class="service-item">
                    <div class="service-icon">
                        <span>ğŸ“Š</span> </div>
                    <h3>Ù…ØªØ§Ø¨Ø¹Ø© Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù„ØªÙ‚Ø¯Ù…</h3>
                    <p>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØªÙ‚ÙˆÙŠÙ… Ù…Ø±Ø¦ÙŠ Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù†Ø¬Ø§Ø²Ùƒ ÙˆØµÙØ­Ø§ØªÙƒ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©.</p>
                </div>
                <div class="service-item">
                     <div class="service-icon">
                         <span>âœ¨</span> </div>
                    <h3>ØªØ­ÙÙŠØ² ÙˆØªØ´Ø¬ÙŠØ¹</h3>
                    <p>Ù†Ø¸Ø§Ù… Ø£Ù„Ù‚Ø§Ø¨ ÙˆÙ…Ø³ØªÙˆÙŠØ§Øª ÙˆØªØªØ¨Ø¹ Ù„Ù„Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…ØªØªØ§Ù„ÙŠ Ù„Ø²ÙŠØ§Ø¯Ø© Ø­Ù…Ø§Ø³Ùƒ.</p>
                 </div>
                 <div class="service-item">
                     <div class="service-icon">
                        <span>ğŸ§ </span> </div>
                    <h3>Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø©</h3>
                     <p>Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ø®Ø±Ø§Ø¦Ø· Ø°Ù‡Ù†ÙŠØ© ÙˆÙ…Ø³Ø§Ø¨Ù‚Ø§Øª ÙˆØ±ÙˆØ§Ø¨Ø· Ù…ÙÙŠØ¯Ø© (Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©).</p>
                </div>
                </div>
        </section>

        <section class="features-section content-section alt-background"> <h2>Ù„Ù…Ø§Ø°Ø§ Ù…Ù†Ø§Ø±Ø© Ø§Ù„Ø­ÙØ¸ØŸ</h2>
            <div class="features-grid">
                <div class="feature-item">
                    <div class="feature-icon-circle">
                        <span>ğŸ¯</span> </div>
                    <h3>Ø§Ù„ØªØ±ÙƒÙŠØ² ÙˆØ§Ù„Ù…Ù†Ù‡Ø¬ÙŠØ©</h3>
                    <p>Ù†ÙˆÙØ± Ù„Ùƒ Ø®Ø·Ø© ÙˆØ§Ø¶Ø­Ø© ÙˆÙ…Ù†Ø¸Ù…Ø© ØªØ³Ø§Ø¹Ø¯Ùƒ Ø¹Ù„Ù‰ Ø§Ù„ØªØ±ÙƒÙŠØ² ÙÙŠ Ø­ÙØ¸Ùƒ ÙˆÙ…Ø±Ø§Ø¬Ø¹ØªÙƒ.</p>
                </div>
                <div class="feature-item">
                     <div class="feature-icon-circle">
                        <span>ğŸ¤</span> </div>
                    <h3>Ø§Ù„Ù…Ø±ÙˆÙ†Ø©</h3>
                    <p>ØªØ³ØªØ·ÙŠØ¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø°Ø§Ø± ÙˆØªØªØ£Ù‚Ù„Ù… Ø§Ù„Ø®Ø·Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø¹ Ø¸Ø±ÙˆÙÙƒ.</p>
                </div>
                 <div class="feature-item">
                     <div class="feature-icon-circle">
                        <span>ğŸ’–</span> </div>
                     <h3>Ø§Ù„ØªØ­ÙÙŠØ² Ø§Ù„Ø°Ø§ØªÙŠ</h3>
                     <p>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª ÙˆØ§Ù„Ø£Ù„Ù‚Ø§Ø¨ ÙŠØ³Ø§Ø¹Ø¯Ùƒ Ø¹Ù„Ù‰ Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØ·ÙˆØ±Ùƒ ÙˆØ§Ù„Ø§Ø­ØªÙØ§Ø¡ Ø¨Ø¥Ù†Ø¬Ø§Ø²Ùƒ.</p>
                </div>
                 <div class="feature-item">
                     <div class="feature-icon-circle">
                        <span>â³</span> </div>
                     <h3>ØªÙˆÙÙŠØ± Ø§Ù„ÙˆÙ‚Øª</h3>
                     <p>Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØµÙØ­Ø§Øª Ø£Ùˆ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§ØªØŒ Ø§Ù„Ù…Ù†ØµØ© ØªÙ‚ÙˆÙ… Ø¨Ø°Ù„Ùƒ Ù†ÙŠØ§Ø¨Ø© Ø¹Ù†Ùƒ.</p>
                </div>
                 </div>
        </section>

        <section id="plan-setup-section">
             <h2>Ø¥Ø¹Ø¯Ø§Ø¯ Ø®Ø·ØªÙƒ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©</h2>
            <p>ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© ÙˆØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡.</p>
             <div class="plan-selection-area">
                 <div class="plans-container">
                     <div class="plan-card" data-plan-type="2"> <h3>Ø®Ø·Ø© Ø­ÙØ¸ ØµÙØ­ØªÙŠÙ† ÙŠÙˆÙ…ÙŠÙ‹Ø§</h3>
                         <p>Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡Ø§.</p>
                         <span class="plan-link">Ø§Ø®ØªØ± Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·Ø©</span>
                     </div>
                     </div>
             </div>
             <div class="plan-setup-inputs">
                <div>
                    <label for="planStartDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡:</label>
                    <input type="date" id="planStartDate" required>
                 </div>
                 <div>
                     <label for="planRepetitionMax">Ø¹Ø¯Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙØ¶Ù„:</label>
                    <select id="planRepetitionMax">
                        <option value="20" selected>20</option>
                        <option value="30">30</option>
                        <option value="40">40</option>
                    </select>
                 </div>
             </div>
             <button id="confirmPlanBtn" disabled>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø®Ø·Ø© ÙˆØ§Ù„Ø¨Ø¯Ø¡</button>
        </section>

        <section class="stats-section content-section">
             <h2>Ù…Ù†Ø§Ø±Ø© Ø§Ù„Ø­ÙØ¸ Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù…</h2>
             <div class="stats-grid">
                 <div class="stat-item">
                     <span class="stat-icon">ğŸ“Š</span> <span class="stat-number">1000+</span> <span class="stat-title">Ø®Ø·Ø© ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§</span>
                 </div>
                 <div class="stat-item">
                    <span class="stat-icon">ğŸ§‘â€ğŸ“</span> <span class="stat-number">500+</span> <span class="stat-title">Ø·Ø§Ù„Ø¨ Ù…Ù„ØªØ²Ù…</span>
                 </div>
                 <div class="stat-item">
                     <span class="stat-icon">ğŸ“„</span> <span class="stat-number">5000+</span> <span class="stat-title">ØµÙØ­Ø© ØªÙ… Ø­ÙØ¸Ù‡Ø§</span>
                 </div>
                 <div class="stat-item">
                    <span class="stat-icon">ğŸŒŸ</span> <span class="stat-number">100+</span> <span class="stat-title">Ù…Ø³ØªÙˆÙ‰ ØªÙ… Ø¨Ù„ÙˆØºÙ‡</span>
                </div>
             </div>
         </section>

        <div id="dashboard-link-container" style="text-align: center; padding: 20px;"></div>

        </main>

    <footer class="main-footer">
        <p>&copy; <span id="current-year">2025</span> Ù…Ù†Ø§Ø±Ø© Ø§Ù„Ø­ÙØ¸. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
        </footer>

    <script>
         // --- Firebase Configuration ---
         const firebaseConfig = { /* ... Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ... */ apiKey: "AIzaSyDuUebu7Qzz3JnTfa-58EIPZjOcrkmdGHU", authDomain: "quranplan2.firebaseapp.com", projectId: "quranplan2", storageBucket: "quranplan2.appspot.com", messagingSenderId: "1098692856811", appId: "1:1098692856811:web:923bca3a54fd78b1b267ae" };
        try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Init Error:", e); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM Elements ---
        const loginBtn = document.getElementById('google-signin-btn');
        const planSetupSection = document.getElementById('plan-setup-section');
        const planCards = planSetupSection?.querySelectorAll('.plan-card');
        const planStartDateInput = document.getElementById('planStartDate');
        const planRepetitionMaxSelect = document.getElementById('planRepetitionMax');
        const confirmPlanBtn = document.getElementById('confirmPlanBtn');
        const userProfileArea = document.getElementById('user-profile-area');
        const userNameSpan = document.getElementById('user-name');
        const userPhoto = document.getElementById('user-photo');
        const logoutButton = document.getElementById('logout-button');
        const studentLevelTitleSpan = document.getElementById('student-level-title');
        const currentYearSpan = document.getElementById('current-year');
        const dashboardLinkContainer = document.getElementById('dashboard-link-container'); // Get the container

        // --- Global State ---
        let currentUser = null;
        let selectedPlanType = null;
        let hasExistingPlan = false;
        const initialTotalRows = 320;

        // --- Helper Functions ---
        function formatDate(date) { if (!(date instanceof Date)) { date = new Date(date); } if (isNaN(date.getTime())) { return ""; } const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
        async function checkIfPlanExists(uid) { if (!uid) return false; const planRef = db.collection("quranPlans").doc(uid); try { const doc = await planRef.get(); console.log(`Index: Plan check for ${uid}: Exists = ${doc.exists}`); return doc.exists; } catch (error) { console.error("Error checking plan existence:", error); return false; } }

        // --- Level/Title Calculation & Display ---
         const levelTitles = ["Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ!", "ğŸŒ± ØºØ±Ø³Ø© Ø§Ù„Ø¥ÙŠÙ…Ø§Ù†", "âœ¨ Ø¨Ø§Ø¯Ø±Ø© Ø£Ù…Ù„", "ğŸƒ Ø³Ø§Ø¹Ù Ù„Ù„Ø¹Ù„Ø§", "â­ Ù†Ø¬Ù… ØµØ§Ø¹Ø¯", "ğŸ’ª Ù…Ø«Ø§Ø¨Ø± Ù…Ø¬ØªÙ‡Ø¯", "ğŸ§­ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø¨", "ğŸ’¯ ØµØ§Ø­Ø¨ Ø§Ù„Ø³Ø¨Ø¹ÙŠÙ†", "ğŸš€ Ø§Ù†Ø·Ù„Ø§Ù‚Ø© Ù‚ÙˆÙŠØ©", "ğŸ’ Ø¬ÙˆÙ‡Ø±Ø© Ù…ØµÙ‚ÙˆÙ„Ø©", "ğŸ‘‘ ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ø¦Ø© ÙŠÙˆÙ…", "ğŸ“– Ø±ÙÙŠÙ‚ Ø§Ù„Ù‚Ø±Ø¢Ù†", "ğŸ•¯ï¸ Ù…Ù†Ø§Ø±Ø© Ù‡Ø¯Ù‰", "ğŸ”ï¸ Ù‚Ù…Ø© Ø´Ø§Ù…Ø®Ø©", "ğŸŒ³ Ø´Ø¬Ø±Ø© Ø·ÙŠØ¨Ø©", "â³ Ø¹Ø§Ø¨Ø± Ù…Ù†ØªØµÙ Ø§Ù„Ø·Ø±ÙŠÙ‚", "ğŸ¯ Ø¯Ù‚Ø© ÙˆØ§Ù„ØªØ²Ø§Ù…", "ğŸŒŠ Ø¨Ø­Ø± Ø²Ø§Ø®Ø±", "ğŸŒŸ ÙƒÙˆÙƒØ¨ Ø¯Ø±ÙŠ", "ğŸ§­ Ø¨ÙˆØµÙ„Ø© Ø§Ù„Ø­Ù‚", "ğŸ’¯ğŸ’¯ Ø§Ù„Ù…Ø¦ØªØ§Ù† Ù„Ø§ ØªÙ‚ÙØ§Ù†!", "ğŸ¤² Ù‚Ù„Ø¨ Ø®Ø§Ø´Ø¹", "ğŸ•Šï¸ Ø±ÙˆØ­ Ù…Ø·Ù…Ø¦Ù†Ø©", "ğŸ’– Ù…Ø­Ø¨ Ù„Ù„Ø±Ø­Ù…Ù†", "ğŸ™ Ø¹Ø¨Ø¯ Ø´ÙƒÙˆØ±", "ğŸ’¡ Ø¨ØµÙŠØ±Ø© Ù†Ø§ÙØ°Ø©", "ğŸ•Œ Ù…Ø¹Ù…Ù‘Ø± Ø¨ÙŠÙˆØª Ø§Ù„Ù„Ù‡", "ğŸŒ™ Ù‡Ù„Ø§Ù„ Ø§Ù„ÙƒÙ…Ø§Ù„", "âœ¨ Ù†ÙˆØ± Ø¹Ù„Ù‰ Ù†ÙˆØ±", "ğŸ Ù‚Ø§Ø¨ Ù‚ÙˆØ³ÙŠÙ† Ø£Ùˆ Ø£Ø¯Ù†Ù‰", "ğŸ† ÙØ§Ø±Ø³ Ø§Ù„Ø«Ù„Ø§Ø«Ù…Ø§Ø¦Ø©", "ğŸ‰ Ù…Ù‚ØªØ±Ø¨ Ù…Ù† Ø§Ù„Ø®ØªØ§Ù…", "ğŸŠ Ø®Ø§ØªÙ… Ù…Ø¨Ø§Ø±Ùƒ"];
         const levelIcons = { 10: 'ğŸ‘‘', 20: 'ğŸ’¯', 30: 'ğŸ†', 32: 'ğŸŠ' }; // Example icons

         function calculateLevelTitle(tableRows) {
            if (!tableRows || tableRows.length === 0) return { title: levelTitles[0], icon: '' };
            const sortedRows = [...tableRows].sort((a, b) => new Date(a.displayDate) - new Date(b.displayDate));
            let currentStreak = 0;
            let streakBroken = false;
            const todayStr = formatDate(new Date());
             let tempCurrentStreak = 0; // Use temporary variable inside loop

             for (let i = sortedRows.length - 1; i >= 0; i--) {
                 const row = sortedRows[i];
                 if (row.displayDate > todayStr) continue; // Skip future dates
                 if (row.type === 'plan' && row.state?.completed) {
                     if (!streakBroken) {
                        tempCurrentStreak++;
                     }
                 } else if (row.type === 'excuse') {
                     // Excuses maintain the streak, so continue without incrementing or breaking
                     continue;
                 } else {
                    // If it's today and not completed, or any past day not completed/excused
                     streakBroken = true;
                     // If today's task exists and is not complete, streak resets to 0 *for today*
                    if (row.displayDate === todayStr) {
                        tempCurrentStreak = 0;
                    }
                     break; // Stop counting streak
                 }
             }
             currentStreak = tempCurrentStreak; // Assign calculated streak

            const levelIndex = Math.min(Math.floor(currentStreak / 10), levelTitles.length - 1);
            const title = levelTitles[levelIndex] || levelTitles[0];
            const icon = levelIcons[levelIndex] || '';
            return { title: title, icon: icon };
        }

        async function displayStudentLevel(uid) {
            if (!studentLevelTitleSpan) return;
            try {
                const planRef = db.collection("quranPlans").doc(uid);
                const doc = await planRef.get();
                if (doc.exists) {
                    const planData = doc.data();
                    if (planData.tableRows) {
                        const levelInfo = calculateLevelTitle(planData.tableRows);
                        studentLevelTitleSpan.textContent = `(Ù„Ù‚Ø¨Ùƒ: ${levelInfo.title} ${levelInfo.icon})`.trim();
                        studentLevelTitleSpan.style.display = 'inline';
                    } else { studentLevelTitleSpan.style.display = 'none'; }
                } else { studentLevelTitleSpan.style.display = 'none'; }
            } catch (error) { console.error("Error fetching plan data for level title:", error); studentLevelTitleSpan.style.display = 'none'; }
        }

        // --- UI Update Function ---
         function updateUIBasedOnLoginAndPlanState() {
             if (dashboardLinkContainer) dashboardLinkContainer.innerHTML = '';

             if (currentUser) {
                 if(loginBtn) loginBtn.style.display = 'none';
                 if(userProfileArea) {
                     userProfileArea.style.display = 'flex';
                     if(userNameSpan) userNameSpan.textContent = currentUser.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…';
                     if(userPhoto) userPhoto.src = currentUser.photoURL || 'images/avatar_placeholder.png'; // Placeholder avatar
                 }
                 displayStudentLevel(currentUser.uid); // Display level

                 if (hasExistingPlan) {
                     console.log("UI Update: User has plan.");
                     if(planSetupSection) planSetupSection.style.display = 'none';
                     if (dashboardLinkContainer) { // Add the dashboard link
                         dashboardLinkContainer.innerHTML = `<a href="dashboard.html" class="cta-button" style="background-color: #1e8449; display: inline-block; margin-top: 15px; color:white; padding: 10px 25px; border-radius: 5px; text-decoration: none;">Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</a>`;
                     }
                 } else {
                     console.log("UI Update: User needs to set up plan.");
                     if(planSetupSection) planSetupSection.style.display = 'block';
                     if (dashboardLinkContainer) dashboardLinkContainer.innerHTML = '';
                     if (planStartDateInput && !planStartDateInput.value) planStartDateInput.value = formatDate(new Date());
                     updateConfirmButtonState();
                 }
             } else {
                 // Logged Out
                 if(loginBtn) loginBtn.style.display = 'inline-block';
                 if(userProfileArea) userProfileArea.style.display = 'none';
                 if(planSetupSection) planSetupSection.style.display = 'none';
                 if (studentLevelTitleSpan) studentLevelTitleSpan.style.display = 'none';
                 if (dashboardLinkContainer) dashboardLinkContainer.innerHTML = '';
             }
         }


        // --- Other Functions (Confirm Button State, Save Initial Data) ---
         function updateConfirmButtonState() { if (!confirmPlanBtn) return; confirmPlanBtn.disabled = !(selectedPlanType && planStartDateInput?.value); }
        async function saveInitialPlanData() { /* ... Ù†ÙØ³ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø±Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ ... */ if (!currentUser || !selectedPlanType || !planStartDateInput || !planStartDateInput.value || !planRepetitionMaxSelect) { alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø®Ø·Ø© ÙˆØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ ÙˆØ¹Ø¯Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª."); return; } const selectedStartDate = new Date(planStartDateInput.value + 'T00:00:00Z'); if (isNaN(selectedStartDate.getTime())) { alert('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø¯Ø¯ ØºÙŠØ± ØµØ§Ù„Ø­.'); return; } if(confirmPlanBtn) { confirmPlanBtn.disabled = true; confirmPlanBtn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..."; } const uid = currentUser.uid; const planRef = db.collection("quranPlans").doc(uid); const initialTableRows = []; let currentDate = new Date(selectedStartDate); for (let i = 0; i < initialTotalRows; i++) { const rowData = { type: 'plan', originalSequence: i, displaySeq: i + 1, displayDate: formatDate(currentDate), state: { yestRep: 0, listen: 0, interp: false, record: 0, rep: 0, linked: false, reviewed: false, completed: false } }; initialTableRows.push(rowData); if (i < initialTotalRows - 1) { currentDate.setUTCDate(currentDate.getUTCDate() + 1); } } const planDataToSave = { studentName: currentUser.displayName || "Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù…", email: currentUser.email, startDate: planStartDateInput.value, planType: selectedPlanType, repetitionMax: parseInt(planRepetitionMaxSelect.value), excuseDates: [], tableRows: initialTableRows, createdAt: firebase.firestore.FieldValue.serverTimestamp(), lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }; console.log("Saving initial plan data (including tableRows):", planDataToSave); try { await planRef.set(planDataToSave); console.log("Initial plan data saved!"); hasExistingPlan = true; window.location.href = 'dashboard.html'; } catch (error) { console.error("Error saving initial plan data: ", error); alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø·Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."); if(confirmPlanBtn) { confirmPlanBtn.disabled = false; confirmPlanBtn.textContent = "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø®Ø·Ø© ÙˆØ§Ù„Ø¨Ø¯Ø¡"; } } }


        // --- Authentication Listener ---
         auth.onAuthStateChanged(async (user) => {
             currentUser = user;
             if (user) {
                 console.log("Index: Auth state changed: User logged in.");
                 hasExistingPlan = await checkIfPlanExists(user.uid);
                 updateUIBasedOnLoginAndPlanState();
             } else {
                 console.log("Index: Auth state changed: User logged out.");
                 hasExistingPlan = false;
                 updateUIBasedOnLoginAndPlanState();
             }
         });

        // --- Event Listeners ---
        if (loginBtn) { loginBtn.addEventListener('click', () => { const provider = new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(provider).catch(err => { console.error("Sign-in error:", err); alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + err.message); }); }); } // Simplified error handling
        if (logoutButton) { logoutButton.addEventListener('click', () => { auth.signOut().catch((error) => { console.error('Sign out error:', error); }); }); }
        if(planCards) { planCards.forEach(card => { card.addEventListener('click', () => { if(planCards) planCards.forEach(c => c.classList.remove('selected')); card.classList.add('selected'); selectedPlanType = parseInt(card.getAttribute('data-plan-type')); updateConfirmButtonState(); }); }); }
        if (planStartDateInput) { planStartDateInput.addEventListener('change', updateConfirmButtonState); }
        if (confirmPlanBtn) { confirmPlanBtn.addEventListener('click', saveInitialPlanData); }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initial UI state handled by auth listener
            if(currentYearSpan) { currentYearSpan.textContent = new Date().getFullYear(); }
        });

     </script>

</body>
</html>