<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة خطة حفظ القرآن الكريم</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Basic Reset & Body --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; line-height: 1.6; color: #333; background-color: #f9f9f9; direction: rtl; }
        .container { max-width: 1100px; margin: 20px auto; padding: 0 20px; }
        h1, h2, h3 { color: #1a5276; margin-bottom: 10px; }
        p { margin-bottom: 15px; color: #555; }
        a { text-decoration: none; color: #2980b9; }
        img { max-width: 100%; height: auto; }

        /* --- Header Section --- */
        .main-header { text-align: center; padding: 40px 0 20px 0; background-color: #eaf2f8; border-bottom: 2px solid #aed6f1; }
        .main-header h1 { font-size: 2.5em; margin-bottom: 5px; }
        .main-header .tagline { font-size: 1.1em; color: #5a6a7a; }

        /* --- Sign-in Section --- */
        .signin-section { text-align: center; padding: 30px 0; min-height: 60px; /* Reserve space */ }
        .google-signin-btn { display: inline-block; background-color: #4285F4; color: white; padding: 12px 25px; border-radius: 5px; font-size: 1.1em; font-weight: bold; border: none; cursor: pointer; transition: background-color 0.3s, opacity 0.3s, transform 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .google-signin-btn:hover { background-color: #357ae8; }
        /* Welcome message */
        #welcome-message { display: none; font-weight: bold; color: #1e8449; margin-top: 5px; font-size: 1.1em;}
         /* User profile elements in header */
         #user-profile-area { display: none; align-items: center; gap: 15px; justify-content: center; margin-top: 10px; }
         #user-profile-area img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #aed6f1; object-fit: cover; }
         #user-profile-area span { font-weight: bold; }
         #user-profile-area button { background: #eaf2f8; color: #1a5276; border: 1px solid #aed6f1; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.9em; transition: background-color 0.3s; font-family: 'Tajawal', sans-serif; }
         #user-profile-area button:hover { background-color: #d6eaf8; }

        /* --- About Section --- */
        .about-section { background-color: #fff; padding: 30px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .about-section h2 { text-align: center; border-bottom: 2px solid #1e8449; display: inline-block; padding-bottom: 5px; margin-bottom: 20px; }

        /* --- Plan Setup Section (NEW - Initially hidden) --- */
        #plan-setup-section {
            display: none; /* Hide initially */
            background-color: #fff; padding: 30px; margin: 20px 0; border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee;
            text-align: center;
        }
         #plan-setup-section h2 { margin-bottom: 15px; }
         #plan-setup-section p { color: #2980b9; font-weight: bold; margin-bottom: 25px; }
         .plan-selection-area { margin-bottom: 25px; } /* Container for cards */
         .plan-card.selected { /* Style for selected card */
             border-color: #1e8449;
             box-shadow: 0 4px 10px rgba(30, 132, 73, 0.2);
             transform: translateY(-3px);
         }
         .plan-setup-inputs { display: flex; flex-wrap: wrap; justify-content: center; align-items: baseline; gap: 15px; margin-bottom: 25px; }
         .plan-setup-inputs label { font-weight: bold; color: #21618c; }
         .plan-setup-inputs input[type="date"], .plan-setup-inputs select { border: 1px solid #aed6f1; padding: 8px 12px; border-radius: 4px; font-size: 14px; font-family: 'Tajawal', sans-serif; min-width: 160px; }
         #confirmPlanBtn {
             display: block; margin: 0 auto; background-color: #1e8449; color: white; padding: 12px 30px;
             border: none; border-radius: 5px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: background-color 0.3s;
         }
         #confirmPlanBtn:hover { background-color: #239b56; }
         #confirmPlanBtn:disabled { background-color: #aaa; cursor: not-allowed;}


        /* --- Plans Section (Cards Only) --- */
        .plans-section { padding: 30px 0; text-align: center; }
        /* .plans-section h2 { margin-bottom: 25px; } */ /* Title moved to setup section */
        .plans-container { display: flex; justify-content: space-around; align-items: stretch; flex-wrap: wrap; gap: 20px; }
        .plan-card { background-color: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 25px 20px; flex-basis: calc(25% - 20px); min-width: 220px; box-shadow: 0 2px 5px rgba(0,0,0,0.07); transition: transform 0.3s, box-shadow 0.3s, border-color 0.3s; display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; /* Make card clickable */ }
        .plan-card:hover { transform: translateY(-5px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .plan-card h3 { font-size: 1.2em; color: #1e8449; margin-bottom: 15px; }
        .plan-card .plan-link { /* Style as text, click handled by card */ color: #2980b9; font-weight: bold; margin-top: 15px; pointer-events: none; /* Prevent link click */ }


        /* --- Video Section Placeholder --- */
        .video-section { padding: 30px 0; text-align: center; background-color: #f0f4f8; margin: 20px 0; border-radius: 8px; }
        .video-placeholder { background-color: #ccc; width: 80%; max-width: 560px; height: 315px; margin: 20px auto; display: flex; justify-content: center; align-items: center; color: #666; font-style: italic; border-radius: 5px; }

        /* --- Features Section --- */
        .features-section { padding: 40px 0; }
        .features-section h2 { text-align: center; margin-bottom: 30px; }
        .features-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 25px; text-align: center; }
        .feature-item { background-color: #fff; padding: 20px; border-radius: 5px; border: 1px solid #eee; }
        .feature-item .icon { font-size: 2.5em; margin-bottom: 10px; color: #1abc9c; }
        .feature-item h3 { font-size: 1.1em; margin-bottom: 5px; color: #333; }

        /* --- Footer --- */
        .main-footer { text-align: center; padding: 20px; margin-top: 40px; background-color: #2c3e50; color: #ecf0f1; font-size: 0.9em; }
        .main-footer a { color: #3498db; }

        /* --- Responsive Adjustments --- */
        @media (max-width: 992px) { .plan-card { flex-basis: calc(50% - 15px); } }
        @media (max-width: 768px) { .main-header h1 { font-size: 2em; } .main-header .tagline { font-size: 1em; } .features-grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); } .video-placeholder { width: 95%; height: auto; aspect-ratio: 16 / 9; } }
        @media (max-width: 576px) { .plan-card { flex-basis: 80%; max-width: 400px; } .features-grid { grid-template-columns: 1fr; } }
        @media (max-width: 480px) { .main-header h1 { font-size: 1.8em; } .google-signin-btn { font-size: 1em; padding: 10px 20px; } .container { padding: 0 15px; } .about-section, .plan-card { padding: 20px 15px; } .plan-card { flex-basis: 95%; } }

    </style>
</head>
<body>
<!-- Navbar -->
<div style="background-color: #f0f0f0; padding: 10px;">
  <a href="dashboard.html" style="text-decoration: none; color: #333; font-weight: bold; margin-right: 15px;">
    Dashboard
  </a>
</div>
    <div class="container">

        <header class="main-header">
            <h1>منصة خطة حفظ القرآن الكريم</h1>
            <p class="tagline">ابدأ رحلتك في حفظ كتاب الله بطريقة منظمة ومرنة</p>
        </header>

        <section class="signin-section">
            <button id="google-signin-btn" class="google-signin-btn">
                تسجيل الدخول بحساب Google
            </button>
            <div id="user-profile-area" style="display: none;">
                <img id="user-photo" src="placeholder.png" alt="صورة المستخدم">
                <span id="user-name">أهلاً بك</span>
                <button id="logout-button">تسجيل الخروج</button>
            </div>
            <p id="welcome-message">أهلاً بك!</p>
        </section>

        <section id="plan-setup-section">
            <h2>إعداد خطتك لأول مرة</h2>
            <p>يرجى اختيار الخطة المناسبة وتحديد تاريخ البدء.</p>
            <div class="plan-selection-area">
                <div class="plans-container">
                    <div class="plan-card" data-plan-type="1">
                        <div> <h3>خطة حفظ صفحة واحدة يوميًا</h3> <p>خطة ميسرة للمبتدئين أو أصحاب الوقت المحدود.</p> </div>
                        <span class="plan-link">اختر هذه الخطة</span> </div>
                    <div class="plan-card" data-plan-type="2">
                        <div> <h3>خطة حفظ صفحتين يوميًا</h3> <p>الخطة الأساسية والموصى بها، توازن بين الحفظ والمراجعة.</p> </div>
                         <span class="plan-link">اختر هذه الخطة</span>
                    </div>
                    <div class="plan-card" data-plan-type="3">
                         <div> <h3>خطة حفظ 3 صفحات</h3> <p>لأصحاب الهمم العالية والوقت المتوفر، تقدم أسرع.</p> </div>
                        <span class="plan-link">اختر هذه الخطة</span>
                    </div>
                    <div class="plan-card" data-plan-type="4">
                        <div> <h3>خطة حفظ 4 صفحات</h3> <p>تحدي كبير للمتمكنين الراغبين في إنجاز أسرع.</p> </div>
                         <span class="plan-link">اختر هذه الخطة</span>
                    </div>
                </div>
            </div>
            <div class="plan-setup-inputs">
                <div>
                    <label for="planStartDate">تاريخ البدء:</label>
                    <input type="date" id="planStartDate" required>
                </div>
                <div>
                    <label for="planRepetitionMax">عدد التكرارات المفضل:</label>
                    <select id="planRepetitionMax">
                        <option value="20" selected>20</option>
                        <option value="30">30</option>
                        <option value="40">40</option>
                    </select>
                </div>
            </div>
            <button id="confirmPlanBtn" disabled>تأكيد الخطة والبدء</button>
        </section>

        <section class="about-section">
            <h2>عن المنصة</h2>
            <p>
                منصة إلكترونية تساعدك على حفظ القرآن الكريم من خلال خطط يومية تلقائية، تتابع تقدمك وتحفزك للاستمرار. نوفر لك الأدوات اللازمة لتنظيم وردك اليومي ومراجعاتك بطريقة سهلة وميسرة.
            </p>
        </section>

        <section class="plans-section" id="original-plans-section" style="display: none;">
            <h2>الخطط المتاحة</h2>
            <div class="plans-container">...</div>
        </section>

        <section class="video-section">
            <h2>شرح مبسط للمنصة</h2>
            <div class="video-placeholder">(سيتم إضافة فيديو شرح هنا لاحقًا)</div>
        </section>

        <section class="features-section">
            <h2>مميزات المنصة</h2>
            <div class="features-grid">
                <div class="feature-item"> <div class="icon">📅</div> <h3>تتابع تقدمك تلقائيًا</h3> <p>تعرف بسهولة عدد الصفحات المحفوظة والمتقنة والمتبقية.</p> </div>
                <div class="feature-item"> <div class="icon">🎯</div> <h3>واجبات يومية</h3> <p>خطة واضحة للحفظ الجديد والربط والمراجعة لكل يوم.</p> </div>
                <div class="feature-item"> <div class="icon">🔔</div> <h3>تنبيهات عند التأخر</h3> <p>مؤشرات تساعدك على معرفة مدى التزامك بالخطة.</p> </div>
                 <div class="feature-item"> <div class="icon">🔗</div> <h3>عرض للمراجعة والربط</h3> <p>تحديد دقيق لصفحات المراجعة والربط المطلوبة يومياً.</p> </div>
            </div>
        </section>

    </div><footer class="main-footer">
        <p>&copy; 2025 منصة خطة حفظ القرآن الكريم. جميع الحقوق محفوظة.</p>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

// --- Firebase SDK Script tags remain above this ---

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyDuUebu7Qzz3JnTfa-58EIPZjOcrkmdGHU", // استخدم بياناتك الفعلية
          authDomain: "quranplan2.firebaseapp.com",
          projectId: "quranplan2",
          storageBucket: "quranplan2.appspot.com",
          messagingSenderId: "1098692856811",
          appId: "1:1098692856811:web:923bca3a54fd78b1b267ae"
        };

        // --- Initialize Firebase ---
        try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Init Error:", e); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Get DOM Elements ---
        const loginBtn = document.getElementById('google-signin-btn');
        const welcomeMessage = document.getElementById('welcome-message');
        const planSetupSection = document.getElementById('plan-setup-section');
        const planCards = planSetupSection.querySelectorAll('.plan-card');
        const planStartDateInput = document.getElementById('planStartDate');
        const planRepetitionMaxSelect = document.getElementById('planRepetitionMax');
        const confirmPlanBtn = document.getElementById('confirmPlanBtn');
        // const originalPlansSection = document.getElementById('original-plans-section'); // Keep hidden or remove HTML
        const userProfileArea = document.getElementById('user-profile-area');
        const userNameSpan = document.getElementById('user-name');
        const userPhoto = document.getElementById('user-photo');
        const logoutButton = document.getElementById('logout-button');
        const goToDashboardLinkContainer = document.createElement('div'); // Create a container for the link/button
        goToDashboardLinkContainer.style.marginTop = '20px'; // Add some space
        goToDashboardLinkContainer.style.textAlign = 'center'; // Center the button/link

        // --- Global State ---
        let currentUser = null;
        let selectedPlanType = null; // Store the chosen plan type (1, 2, 3, 4)
        let hasExistingPlan = false; // Flag to check if plan exists in Firestore

        // --- Helper Functions ---
        function formatDate(date) { if (!(date instanceof Date)) { date = new Date(date); } if (isNaN(date.getTime())) { return ""; } const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }

        // --- Firestore Check ---
        async function checkIfPlanExists(uid) {
            if (!uid) return false;
            const planRef = db.collection("quranPlans").doc(uid);
            try {
                const doc = await planRef.get();
                console.log(`Index: Plan check for ${uid}: Exists = ${doc.exists}`); // Debug log
                return doc.exists;
            } catch (error) {
                console.error("Error checking plan existence:", error);
                return false; // Assume no plan on error
            }
        }

        // --- UI Update Functions ---
        function updateUIBasedOnLoginAndPlanState() {
            // Clear previous dynamic elements first
            goToDashboardLinkContainer.innerHTML = ''; // Clear dashboard link/button

            if (currentUser) {
                 // Logged In
                 if(loginBtn) loginBtn.style.display = 'none';
                 if(welcomeMessage) welcomeMessage.style.display = 'none'; // Hide generic welcome
                 if(userProfileArea) {
                     userProfileArea.style.display = 'flex'; // Show user profile area
                     if(userNameSpan) userNameSpan.textContent = currentUser.displayName || 'مستخدم';
                     if(userPhoto) userPhoto.src = currentUser.photoURL || 'placeholder.png';
                 }


                 if (hasExistingPlan) {
                      // Logged In + Has Plan -> Show "Go to Dashboard" link, hide setup
                      console.log("UI Update: User has plan. Hiding setup, showing dashboard link.");
                      if(planSetupSection) planSetupSection.style.display = 'none';

                      // Create and Append the "Go to Dashboard" button/link
                      goToDashboardLinkContainer.innerHTML = `<a href="dashboard.html" class="google-signin-btn" style="background-color: #1e8449; display: inline-block; margin-top: 15px;">الذهاب إلى لوحة المتابعة الخاصة بك</a>`;
                       // Append it after the welcome message / user profile area (within signin-section)
                       const signInSection = document.querySelector('.signin-section');
                       if (signInSection && !signInSection.contains(goToDashboardLinkContainer)) { // Check if not already appended
                            signInSection.appendChild(goToDashboardLinkContainer);
                       }

                 } else {
                      // Logged In + NO Plan -> Show Setup Section
                      console.log("UI Update: User needs to set up plan. Showing setup section.");
                      if(planSetupSection) planSetupSection.style.display = 'block'; // Show setup section

                      // Remove the "Go to dashboard" link if it exists
                      if (goToDashboardLinkContainer.parentNode) {
                           goToDashboardLinkContainer.parentNode.removeChild(goToDashboardLinkContainer);
                      }

                       // Set default start date to today if not set
                       if (planStartDateInput && !planStartDateInput.value) {
                            planStartDateInput.value = formatDate(new Date());
                       }
                        // Ensure confirm button state is correct initially
                        updateConfirmButtonState();
                 }
            } else {
                 // Logged Out
                 if(loginBtn) loginBtn.style.display = 'inline-block';
                 if(welcomeMessage) welcomeMessage.style.display = 'none';
                 if(userProfileArea) userProfileArea.style.display = 'none';
                 if(planSetupSection) planSetupSection.style.display = 'none'; // Hide setup section
                  // Remove dashboard link container if it exists
                  if (goToDashboardLinkContainer.parentNode) {
                       goToDashboardLinkContainer.parentNode.removeChild(goToDashboardLinkContainer);
                  }
            }
        }

        // Enable/disable confirm button based on selection
        function updateConfirmButtonState() {
             if (!confirmPlanBtn) return; // Exit if button doesn't exist
             if (selectedPlanType && planStartDateInput && planStartDateInput.value) {
                  confirmPlanBtn.disabled = false;
             } else {
                  confirmPlanBtn.disabled = true;
             }
        }

        // --- Save Initial Plan Data ---
        async function saveInitialPlanData() {
             if (!currentUser || !selectedPlanType || !planStartDateInput || !planStartDateInput.value || !planRepetitionMaxSelect) {
                 alert("يرجى اختيار خطة وتحديد تاريخ البدء وعدد التكرارات.");
                 return;
             }
              // Validate Start Date further if needed
             const startDate = new Date(planStartDateInput.value + 'T00:00:00Z');
             if (isNaN(startDate.getTime())) {
                  alert('تاريخ البدء المحدد غير صالح.');
                  return;
             }


             if(confirmPlanBtn) {
                 confirmPlanBtn.disabled = true;
                 confirmPlanBtn.textContent = "جاري الحفظ...";
             }

             const uid = currentUser.uid;
             const planRef = db.collection("quranPlans").doc(uid);

             const planDataToSave = {
                 studentName: currentUser.displayName || "طالب علم",
                 email: currentUser.email,
                 startDate: planStartDateInput.value, // Saved as "YYYY-MM-DD" string
                 planType: selectedPlanType,
                 repetitionMax: parseInt(planRepetitionMaxSelect.value),
                 excuseDates: [], // Initialize empty array
                 // Do NOT save tableRows here for initial save
                 createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                 lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
             };
             console.log("Saving initial plan data:", planDataToSave); // Debug log

             try {
                 await planRef.set(planDataToSave); // Use set() for initial creation/overwrite
                 console.log("Initial plan data saved!");
                 hasExistingPlan = true; // Update flag
                 window.location.href = 'dashboard.html'; // Redirect to dashboard on success
             } catch (error) {
                 console.error("Error saving initial plan data: ", error);
                 alert("حدث خطأ أثناء حفظ بيانات الخطة. حاول مرة أخرى. تأكد من تفعيل Firestore ووضع قواعد الأمان الصحيحة.");
                 if(confirmPlanBtn) {
                     confirmPlanBtn.disabled = false; // Re-enable button on error
                     confirmPlanBtn.textContent = "تأكيد الخطة والبدء";
                 }
             }
        }


        // --- Authentication State Observer ---
        auth.onAuthStateChanged(async (user) => { // Make observer async
          currentUser = user;
          if (user) {
            console.log("Index: Auth state changed: User logged in.");
            // Check if plan exists AFTER knowing user is logged in
            hasExistingPlan = await checkIfPlanExists(user.uid);
            updateUIBasedOnLoginAndPlanState(); // Update UI based on both states
          } else {
            console.log("Index: Auth state changed: User logged out.");
            hasExistingPlan = false; // Reset flag
            updateUIBasedOnLoginAndPlanState(); // Update UI for logged-out state
          }
        });

        // --- Event Listeners ---

        // Sign-in Button
        if (loginBtn) { loginBtn.addEventListener('click', () => { console.log("Login button clicked"); const provider = new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(provider).then(result => { const user = result.user; console.log("Sign-in successful:", user.displayName); const userRef = db.collection("students").doc(user.uid); userRef.get().then((doc) => { const userData = { name: user.displayName, email: user.email, photo: user.photoURL, lastLogin: firebase.firestore.FieldValue.serverTimestamp() }; if (!doc.exists) { userData.joinedAt = firebase.firestore.FieldValue.serverTimestamp(); userRef.set(userData).catch(err => console.error("Error saving new user:", err)); } else { userRef.update(userData).catch(err => console.error("Error updating user:", err)); } }).catch(err => console.error("Error checking user existence:", err)); }).catch(err => { console.error("Sign-in error:", err); alert("حدث خطأ أثناء تسجيل الدخول. رمز الخطأ: " + err.code); }); }); }
        // Logout Button
        if (logoutButton) { logoutButton.addEventListener('click', () => { auth.signOut().catch((error) => { console.error('Sign out error:', error); }); }); }
        // Plan Card Selection in Setup Section
        planCards.forEach(card => { card.addEventListener('click', () => { planCards.forEach(c => c.classList.remove('selected')); card.classList.add('selected'); selectedPlanType = parseInt(card.getAttribute('data-plan-type')); console.log("Selected Plan Type:", selectedPlanType); updateConfirmButtonState(); }); });
        // Input fields change listener (for enabling confirm button)
        if (planStartDateInput) { planStartDateInput.addEventListener('change', updateConfirmButtonState); }
        // Confirm Plan Button
        if (confirmPlanBtn) { confirmPlanBtn.addEventListener('click', saveInitialPlanData); }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Hide sections initially, let Auth check control UI
            if(planSetupSection) planSetupSection.style.display = 'none';
            if(userProfileArea) userProfileArea.style.display = 'none';
            if(welcomeMessage) welcomeMessage.style.display = 'none';
            // Auth listener (onAuthStateChanged) will handle the rest
        });
    </script>

    </script>
</body>
</html>