<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†Ø§Ø±Ø© Ø§Ù„Ø­ÙØ¸ - Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Somar:wght@400;700&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style.css">

    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

</head>
<body>

    <header class="header-container">
        <div class="site-branding">
            <div class="logo-container">
                <img src="https://lh3.googleusercontent.com/d/1atLb1rloGmQVKXmQgfwTVMne8RMRWGvf" alt="Ø´Ø¹Ø§Ø± Ù…Ù†Ø§Ø±Ø© Ø§Ù„Ø­ÙØ¸">
            </div>
            <div class="site-name">
                <span>Ù…Ù†Ø§Ø±Ø©</span>
                <span>Ø§Ù„Ø­ÙØ¸</span>
            </div>
        </div>

        <nav class="main-navigation" id="main-nav">
            <ul>
                <li><a href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                <li class="menu-item-has-children"><a href="#about-site">Ø§Ù„ØªØ¹Ø±ÙŠÙ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹</a></li>
                <li class="menu-item-has-children">
                    <a href="#">Ø®Ø·Ø· Ø§Ù„Ø­ÙØ¸</a>
                    <ul class="dropdown">
                        <li><a href="#">Ø®Ø·Ø© ØµÙØ­Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹</a></li>
                        <li><a href="#">Ø®Ø·Ø© ØµÙØ­ØªÙŠÙ† ÙŠÙˆÙ…ÙŠØ§Ù‹</a></li>
                        <li><a href="#">Ø®Ø·Ø© 3 ØµÙØ­Ø§Øª ÙŠÙˆÙ…ÙŠØ§Ù‹</a></li>
                        <li><a href="#">Ø®Ø·Ø© 4 ØµÙØ­Ø§Øª ÙŠÙˆÙ…ÙŠØ§Ù‹</a></li>
                    </ul>
                </li>
                <li class="menu-item-has-children">
                    <a href="#">Ø§Ù„Ø¯ÙˆØ±Ø§Øª ÙˆØ§Ù„Ø¨Ø±Ø§Ù…Ø¬</a>
                    <ul class="dropdown">
                        <li><a href="#">Ø¯ÙˆØ±Ø§Øª Ø§Ù„ØªØ¬ÙˆÙŠØ¯</a></li>
                        <li><a href="#">Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</a></li>
                    </ul>
                </li>
                <li class="menu-item-has-children">
                    <a href="#">Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ø°Ù‡Ù†ÙŠØ©</a>
                    <ul class="dropdown">
                        <li><a href="#">Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ø³ÙˆØ±</a></li>
                        <li><a href="#">Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø§Øª</a></li>
                    </ul>
                </li>
                 <li class="menu-item-has-children">
                    <a href="#">Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</a>
                     <ul class="dropdown">
                         <li><a href="#">Ù…Ø³Ø§Ø¨Ù‚Ø© Ø±Ù…Ø¶Ø§Ù†</a></li>
                         <li><a href="#">Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</a></li>
                    </ul>
                </li>
                <li class="menu-item-has-children">
                    <a href="#">Ø§Ù„ØªØ³Ø¬ÙŠÙ„</a>
                    <ul class="dropdown">
                        <li><a href="plangen2.html">ØªØ³Ø¬ÙŠÙ„ Ø·Ø§Ù„Ø¨ (Ø¨Ø¯Ø¡ Ø§Ù„Ø®Ø·Ø©)</a></li>
                        <li><a href="#">ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ù„Ù…</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <div class="header-right-controls">
            <div class="auth-area">
                <button id="google-signin-btn" class="google-signin-btn" style="display: inline-block;">
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                </button>
                <div id="user-profile-area" style="display: none;">
                    <button type="button" id="user-profile-trigger" aria-expanded="false" aria-controls="profile-dropdown">
                        <img id="user-photo" src="images/avatar_placeholder.png" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"> <div class="user-info">
                            <span id="user-name">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ</span>
                            <span id="student-level-title" style="display: none;"></span>
                        </div>
                        <span class="profile-arrow">â–¼</span>
                    </button>
                    <div id="profile-dropdown" class="profile-dropdown-menu">
                        <ul>
                            <li><button id="logout-button" type="button">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button></li>
                        </ul>
                    </div>
                </div>
            </div>
            <button class="mobile-menu-toggle" aria-label="ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©" aria-expanded="false" aria-controls="main-nav">
                â˜°
            </button>
        </div>
    </header>

    <main>
        <section class="hero-section">
             <div class="hero-content">
                 <div class="hero-text">
                     <h1>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…Ù†Ø§Ø±Ø© Ø§Ù„Ø­ÙØ¸</h1>
                     <h2>Ù…Ù†ØµØ© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… ÙˆØ¹Ù„ÙˆÙ…Ù‡</h2>
                     <p>ÙˆØ§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ ÙÙŠ ØºØ±Ø³ Ù‚ÙŠÙ…Ù‡...</p>
                     <div id="cta-button-container" style="margin-top: 30px;">
                         </div>
                 </div>
                 <div class="hero-image">
                     <img src="https://drive.google.com/file/d/1oXe50xPZmXcDR0VJimINUiOJTUKEoke4/view?usp=sharing" alt="Ø±Ø³Ù… ØªÙˆØ¶ÙŠØ­ÙŠ Ù„Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù†">
                 </div>
             </div>
        </section>

        <section id="about-site" class="content-section">
             <h2>Ø§Ù„ØªØ¹Ø±ÙŠÙ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹</h2>
             <p> Ù…Ù†Ø§Ø±Ø© Ø§Ù„Ø­ÙØ¸ Ù‡ÙŠ Ù…Ù†ØµØ© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© ØªØ·ÙˆØ¹ÙŠØ© ØªÙ‡Ø¯Ù Ù„ØªÙŠØ³ÙŠØ± Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… ÙˆØ¹Ù„ÙˆÙ…Ù‡ ÙˆÙ…Ø±Ø§Ø¬Ø¹ØªÙ‡ Ù„Ù„Ù…Ø³Ù„Ù…ÙŠÙ† Ø­ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù„Ù… Ø¹Ø¨Ø± Ø®Ø·Ø· ØªÙØ§Ø¹Ù„ÙŠØ© ÙˆØ£Ø¯ÙˆØ§Øª Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø¯ÙŠØ«Ø©. Ù†Ø³Ø¹Ù‰ Ù„ØªÙˆÙÙŠØ± Ø¨ÙŠØ¦Ø© Ù…Ø­ÙØ²Ø© ÙˆÙ…Ù†Ø¸Ù…Ø© ØªØ³Ø§Ø¹Ø¯Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… ÙˆØ§Ù„Ù…Ø¯Ø§ÙˆÙ…Ø© Ø¹Ù„Ù‰ ÙˆØ±Ø¯Ùƒ Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠ. </p>
        </section>

        <section class="services-section content-section">
             <h2>Ø®Ø¯Ù…Ø§ØªÙ†Ø§</h2>
             <div class="services-grid">
                 <div class="service-item"><div class="service-icon"><span>ğŸ“…</span></div><h3>Ø®Ø·Ø· Ø­ÙØ¸ ØªÙØ§Ø¹Ù„ÙŠØ©</h3><p>Ø®Ø·Ø· ÙŠÙˆÙ…ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ§Ù„Ø±Ø¨Ø· ØªÙ†Ø§Ø³Ø¨ Ù…Ø³ØªÙˆØ§Ùƒ.</p></div>
                 <div class="service-item"><div class="service-icon"><span>ğŸ“Š</span></div><h3>Ù…ØªØ§Ø¨Ø¹Ø© Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù„ØªÙ‚Ø¯Ù…</h3><p>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØªÙ‚ÙˆÙŠÙ… Ù…Ø±Ø¦ÙŠ Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù†Ø¬Ø§Ø²Ùƒ ÙˆØµÙØ­Ø§ØªÙƒ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©.</p></div>
                 <div class="service-item"><div class="service-icon"><span>âœ¨</span></div><h3>ØªØ­ÙÙŠØ² ÙˆØªØ´Ø¬ÙŠØ¹</h3><p>Ù†Ø¸Ø§Ù… Ø£Ù„Ù‚Ø§Ø¨ ÙˆÙ…Ø³ØªÙˆÙŠØ§Øª ÙˆØªØªØ¨Ø¹ Ù„Ù„Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…ØªØªØ§Ù„ÙŠ Ù„Ø²ÙŠØ§Ø¯Ø© Ø­Ù…Ø§Ø³Ùƒ.</p></div>
                 <div class="service-item"><div class="service-icon"><span>ğŸ§ </span></div><h3>Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø©</h3><p>Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ø®Ø±Ø§Ø¦Ø· Ø°Ù‡Ù†ÙŠØ© ÙˆÙ…Ø³Ø§Ø¨Ù‚Ø§Øª ÙˆØ±ÙˆØ§Ø¨Ø· Ù…ÙÙŠØ¯Ø©.</p></div>
             </div>
        </section>

        <section class="features-section content-section alt-background">
              <h2>Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹</h2>
              <div class="features-grid">
                  <div class="feature-item"><div class="feature-icon-circle"><span>ğŸ¯</span></div><h3>Ø§Ù„ØªØ±ÙƒÙŠØ² ÙˆØ§Ù„Ù…Ù†Ù‡Ø¬ÙŠØ©</h3><p>Ù†ÙˆÙØ± Ù„Ùƒ Ø®Ø·Ø© ÙˆØ§Ø¶Ø­Ø© ÙˆÙ…Ù†Ø¸Ù…Ø© ØªØ³Ø§Ø¹Ø¯Ùƒ Ø¹Ù„Ù‰ Ø§Ù„ØªØ±ÙƒÙŠØ² ÙÙŠ Ø­ÙØ¸Ùƒ ÙˆÙ…Ø±Ø§Ø¬Ø¹ØªÙƒ.</p></div>
                  <div class="feature-item"><div class="feature-icon-circle"><span>ğŸ¤</span></div><h3>Ø§Ù„Ù…Ø±ÙˆÙ†Ø©</h3><p>ØªØ³ØªØ·ÙŠØ¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø°Ø§Ø± ÙˆØªØªØ£Ù‚Ù„Ù… Ø§Ù„Ø®Ø·Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø¹ Ø¸Ø±ÙˆÙÙƒ.</p></div>
                  <div class="feature-item"><div class="feature-icon-circle"><span>ğŸ’–</span></div><h3>Ø§Ù„ØªØ­ÙÙŠØ² Ø§Ù„Ø°Ø§ØªÙŠ</h3><p>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª ÙˆØ§Ù„Ø£Ù„Ù‚Ø§Ø¨ ÙŠØ³Ø§Ø¹Ø¯Ùƒ Ø¹Ù„Ù‰ Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØ·ÙˆØ±Ùƒ ÙˆØ§Ù„Ø§Ø­ØªÙØ§Ø¡ Ø¨Ø¥Ù†Ø¬Ø§Ø²Ùƒ.</p></div>
                  <div class="feature-item"><div class="feature-icon-circle"><span>â³</span></div><h3>ØªÙˆÙÙŠØ± Ø§Ù„ÙˆÙ‚Øª</h3><p>Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØµÙØ­Ø§Øª Ø£Ùˆ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§ØªØŒ Ø§Ù„Ù…Ù†ØµØ© ØªÙ‚ÙˆÙ… Ø¨Ø°Ù„Ùƒ Ù†ÙŠØ§Ø¨Ø© Ø¹Ù†Ùƒ.</p></div>
              </div>
        </section>

        <section id="plan-setup-section">
             <h2>Ø¥Ø¹Ø¯Ø§Ø¯ Ø®Ø·ØªÙƒ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©</h2>
             <p>ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© ÙˆØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡.</p>
             <div class="plan-selection-area"> <div class="plans-container"> <div class="plan-card" data-plan-type="2"><h3>Ø®Ø·Ø© ØµÙØ­ØªÙŠÙ†</h3><p>ÙˆØµÙ...</p><span class="plan-link">Ø§Ø®ØªØ±</span></div> </div> </div>
             <div class="plan-setup-inputs"> <div><label for="planStartDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡:</label><input type="date" id="planStartDate" required></div><div><label for="planRepetitionMax">Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª:</label><select id="planRepetitionMax"><option value="20" selected>20</option><option value="30">30</option><option value="40">40</option></select></div></div>
             <button id="confirmPlanBtn" disabled>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø®Ø·Ø© ÙˆØ§Ù„Ø¨Ø¯Ø¡</button>
             </section>

        <section class="stats-section content-section">
              <h2>Ù…Ù†Ø§Ø±Ø© Ø§Ù„Ø­ÙØ¸ Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù…</h2>
              <div class="stats-grid">
                  <div class="stat-item"><span class="stat-icon">ğŸ“Š</span><span class="stat-number">1000+</span><span class="stat-title">Ø®Ø·Ø© ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§</span></div>
                  <div class="stat-item"><span class="stat-icon">ğŸ§‘â€ğŸ“</span><span class="stat-number">500+</span><span class="stat-title">Ø·Ø§Ù„Ø¨ Ù…Ù„ØªØ²Ù…</span></div>
                  <div class="stat-item"><span class="stat-icon">ğŸ“„</span><span class="stat-number">5000+</span><span class="stat-title">ØµÙØ­Ø© ØªÙ… Ø­ÙØ¸Ù‡Ø§</span></div>
                  <div class="stat-item"><span class="stat-icon">ğŸŒŸ</span><span class="stat-number">100+</span><span class="stat-title">Ù…Ø³ØªÙˆÙ‰ ØªÙ… Ø¨Ù„ÙˆØºÙ‡</span></div>
              </div>
          </section>

        <div id="dashboard-link-container" style="text-align: center; padding: 20px 0;"></div>

    </main>

    <footer class="main-footer">
        <p>&copy; <span id="current-year">2025</span> Ù…Ù†Ø§Ø±Ø© Ø§Ù„Ø­ÙØ¸. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
    </footer>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = { apiKey: "AIzaSyDuUebu7Qzz3JnTfa-58EIPZjOcrkmdGHU", authDomain: "quranplan2.firebaseapp.com", projectId: "quranplan2", storageBucket: "quranplan2.appspot.com", messagingSenderId: "1098692856811", appId: "1:1098692856811:web:923bca3a54fd78b1b267ae" };
        try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Init Error:", e); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM Element References ---
        const loginBtn = document.getElementById('google-signin-btn');
        const planSetupSection = document.getElementById('plan-setup-section');
        const planCards = planSetupSection?.querySelectorAll('.plan-card');
        const planStartDateInput = document.getElementById('planStartDate');
        const planRepetitionMaxSelect = document.getElementById('planRepetitionMax');
        const confirmPlanBtn = document.getElementById('confirmPlanBtn');
        const userProfileArea = document.getElementById('user-profile-area');
        const userNameSpan = document.getElementById('user-name');
        const userPhoto = document.getElementById('user-photo');
        const studentLevelTitleSpan = document.getElementById('student-level-title');
        const currentYearSpan = document.getElementById('current-year');
        const dashboardLinkContainer = document.getElementById('dashboard-link-container');
        const ctaContainer = document.getElementById('cta-button-container');
        const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
        const mainNav = document.querySelector('nav.main-navigation');
        const profileTrigger = document.getElementById('user-profile-trigger');
        const profileDropdown = document.getElementById('profile-dropdown');

        // --- Global State ---
        let currentUser = null;
        let selectedPlanType = null;
        let hasExistingPlan = false;
        const initialTotalRows = 320;

        // --- Helper Functions ---
        function formatDate(date) { if (!(date instanceof Date)) { date = new Date(date); } if (isNaN(date.getTime())) { return ""; } const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
        async function checkIfPlanExists(uid) { if (!uid) return false; const planRef = db.collection("quranPlans").doc(uid); try { const doc = await planRef.get(); console.log(`Index: Plan check for ${uid}: Exists = ${doc.exists}`); return doc.exists; } catch (error) { console.error("Error checking plan existence:", error); return false; } }

        // --- Level/Title Calculation & Display ---
        const levelTitles = ["Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ!", "ğŸŒ± ØºØ±Ø³Ø© Ø§Ù„Ø¥ÙŠÙ…Ø§Ù†", "âœ¨ Ø¨Ø§Ø¯Ø±Ø© Ø£Ù…Ù„", "ğŸƒ Ø³Ø§Ø¹Ù Ù„Ù„Ø¹Ù„Ø§", "â­ Ù†Ø¬Ù… ØµØ§Ø¹Ø¯", "ğŸ’ª Ù…Ø«Ø§Ø¨Ø± Ù…Ø¬ØªÙ‡Ø¯", "ğŸ§­ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø¨", "ğŸ’¯ ØµØ§Ø­Ø¨ Ø§Ù„Ø³Ø¨Ø¹ÙŠÙ†", "ğŸš€ Ø§Ù†Ø·Ù„Ø§Ù‚Ø© Ù‚ÙˆÙŠØ©", "ğŸ’ Ø¬ÙˆÙ‡Ø±Ø© Ù…ØµÙ‚ÙˆÙ„Ø©", "ğŸ‘‘ ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ø¦Ø© ÙŠÙˆÙ…", "ğŸ“– Ø±ÙÙŠÙ‚ Ø§Ù„Ù‚Ø±Ø¢Ù†", "ğŸ•¯ï¸ Ù…Ù†Ø§Ø±Ø© Ù‡Ø¯Ù‰", "ğŸ”ï¸ Ù‚Ù…Ø© Ø´Ø§Ù…Ø®Ø©", "ğŸŒ³ Ø´Ø¬Ø±Ø© Ø·ÙŠØ¨Ø©", "â³ Ø¹Ø§Ø¨Ø± Ù…Ù†ØªØµÙ Ø§Ù„Ø·Ø±ÙŠÙ‚", "ğŸ¯ Ø¯Ù‚Ø© ÙˆØ§Ù„ØªØ²Ø§Ù…", "ğŸŒŠ Ø¨Ø­Ø± Ø²Ø§Ø®Ø±", "ğŸŒŸ ÙƒÙˆÙƒØ¨ Ø¯Ø±ÙŠ", "ğŸ§­ Ø¨ÙˆØµÙ„Ø© Ø§Ù„Ø­Ù‚", "ğŸ’¯ğŸ’¯ Ø§Ù„Ù…Ø¦ØªØ§Ù† Ù„Ø§ ØªÙ‚ÙØ§Ù†!", "ğŸ¤² Ù‚Ù„Ø¨ Ø®Ø§Ø´Ø¹", "ğŸ•Šï¸ Ø±ÙˆØ­ Ù…Ø·Ù…Ø¦Ù†Ø©", "ğŸ’– Ù…Ø­Ø¨ Ù„Ù„Ø±Ø­Ù…Ù†", "ğŸ™ Ø¹Ø¨Ø¯ Ø´ÙƒÙˆØ±", "ğŸ’¡ Ø¨ØµÙŠØ±Ø© Ù†Ø§ÙØ°Ø©", "ğŸ•Œ Ù…Ø¹Ù…Ù‘Ø± Ø¨ÙŠÙˆØª Ø§Ù„Ù„Ù‡", "ğŸŒ™ Ù‡Ù„Ø§Ù„ Ø§Ù„ÙƒÙ…Ø§Ù„", "âœ¨ Ù†ÙˆØ± Ø¹Ù„Ù‰ Ù†ÙˆØ±", "ğŸ Ù‚Ø§Ø¨ Ù‚ÙˆØ³ÙŠÙ† Ø£Ùˆ Ø£Ø¯Ù†Ù‰", "ğŸ† ÙØ§Ø±Ø³ Ø§Ù„Ø«Ù„Ø§Ø«Ù…Ø§Ø¦Ø©", "ğŸ‰ Ù…Ù‚ØªØ±Ø¨ Ù…Ù† Ø§Ù„Ø®ØªØ§Ù…", "ğŸŠ Ø®Ø§ØªÙ… Ù…Ø¨Ø§Ø±Ùƒ"];
        const levelIcons = { 10: 'ğŸ‘‘', 20: 'ğŸ’¯', 30: 'ğŸ†', 32: 'ğŸŠ' };
        function calculateLevelTitle(tableRows) { /* ... Same calculation logic ... */ if (!tableRows || tableRows.length === 0) return { title: levelTitles[0], icon: '' }; const sortedRows = [...tableRows].sort((a, b) => new Date(a.displayDate) - new Date(b.displayDate)); let currentStreak = 0; let streakBroken = false; const todayStr = formatDate(new Date()); let tempCurrentStreak = 0; for (let i = sortedRows.length - 1; i >= 0; i--) { const row = sortedRows[i]; if (row.displayDate > todayStr) continue; if (row.type === 'plan' && row.state?.completed) { if (!streakBroken) { tempCurrentStreak++; } } else if (row.type === 'excuse') { continue; } else { streakBroken = true; if (row.displayDate === todayStr) { tempCurrentStreak = 0; } break; } } currentStreak = tempCurrentStreak; const levelIndex = Math.min(Math.floor(currentStreak / 10), levelTitles.length - 1); const title = levelTitles[levelIndex] || levelTitles[0]; const icon = levelIcons[levelIndex] || ''; return { title: title, icon: icon }; }
        async function displayStudentLevel(uid) { /* ... Same display logic ... */ if (!studentLevelTitleSpan) return; studentLevelTitleSpan.style.display = 'none'; try { const planRef = db.collection("quranPlans").doc(uid); const doc = await planRef.get(); if (doc.exists) { const planData = doc.data(); if (planData.tableRows) { const levelInfo = calculateLevelTitle(planData.tableRows); if (levelInfo && levelInfo.title) { studentLevelTitleSpan.textContent = `(${levelInfo.title} ${levelInfo.icon})`.trim(); studentLevelTitleSpan.style.display = 'block'; } } } } catch (error) { console.error("Error fetching plan data for level title:", error); } }

        // --- UI Update Function (Handles Conditional Button & Profile) ---
        function updateUIBasedOnLoginAndPlanState() { /* ... Same logic as before ... */ if (ctaContainer) ctaContainer.innerHTML = ''; if (dashboardLinkContainer) dashboardLinkContainer.innerHTML = ''; if (currentUser) { if(loginBtn) loginBtn.style.display = 'none'; if(userProfileArea) userProfileArea.style.display = 'block'; if(profileTrigger){ if(userNameSpan) userNameSpan.textContent = currentUser.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…'; if(userPhoto) userPhoto.src = currentUser.photoURL || 'images/avatar_placeholder.png'; } displayStudentLevel(currentUser.uid); if (hasExistingPlan) { if(planSetupSection) planSetupSection.style.display = 'none'; if (ctaContainer) { ctaContainer.innerHTML = `<a href="dashboard.html" class="cta-button">Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</a>`; } } else { if(planSetupSection) planSetupSection.style.display = 'block'; if (ctaContainer) { ctaContainer.innerHTML = `<a href="#plan-setup-section" class="cta-button">Ø§Ø®ØªØ± Ø®Ø·ØªÙƒ Ø§Ù„Ø¢Ù†</a>`; } if (planStartDateInput && !planStartDateInput.value) planStartDateInput.value = formatDate(new Date()); updateConfirmButtonState(); } } else { if(loginBtn) loginBtn.style.display = 'inline-block'; if(userProfileArea) userProfileArea.style.display = 'none'; if(planSetupSection) planSetupSection.style.display = 'none'; if (studentLevelTitleSpan) studentLevelTitleSpan.style.display = 'none'; if (dashboardLinkContainer) dashboardLinkContainer.innerHTML = ''; if (ctaContainer) { const loginPromptButtonHTML = `<button id="hero-login-btn" class="cta-button">Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¨Ø¯Ø¡</button>`; ctaContainer.innerHTML = loginPromptButtonHTML; const heroLoginBtn = document.getElementById('hero-login-btn'); if (heroLoginBtn) { heroLoginBtn.addEventListener('click', () => { const provider = new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(provider).catch(err => { console.error("Sign-in error:", err); alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + err.message); }); }); } } } }

        // --- Other Functions (Confirm Button State, Save Initial Data) ---
        function updateConfirmButtonState() { if (!confirmPlanBtn) return; confirmPlanBtn.disabled = !(selectedPlanType && planStartDateInput?.value); }
        async function saveInitialPlanData() { /* ... Same logic as before ... */ if (!currentUser || !selectedPlanType || !planStartDateInput || !planStartDateInput.value || !planRepetitionMaxSelect) { alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø®Ø·Ø© ÙˆØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ ÙˆØ¹Ø¯Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª."); return; } const selectedStartDate = new Date(planStartDateInput.value + 'T00:00:00Z'); if (isNaN(selectedStartDate.getTime())) { alert('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø¯Ø¯ ØºÙŠØ± ØµØ§Ù„Ø­.'); return; } if(confirmPlanBtn) { confirmPlanBtn.disabled = true; confirmPlanBtn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..."; } const uid = currentUser.uid; const planRef = db.collection("quranPlans").doc(uid); const initialTableRows = []; let currentDate = new Date(selectedStartDate); for (let i = 0; i < initialTotalRows; i++) { const rowData = { type: 'plan', originalSequence: i, displaySeq: i + 1, displayDate: formatDate(currentDate), state: { yestRep: 0, listen: 0, interp: false, record: 0, rep: 0, linked: false, reviewed: false, completed: false } }; initialTableRows.push(rowData); if (i < initialTotalRows - 1) { currentDate.setUTCDate(currentDate.getUTCDate() + 1); } } const planDataToSave = { studentName: currentUser.displayName || "Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù…", email: currentUser.email, startDate: planStartDateInput.value, planType: selectedPlanType, repetitionMax: parseInt(planRepetitionMaxSelect.value), excuseDates: [], tableRows: initialTableRows, createdAt: firebase.firestore.FieldValue.serverTimestamp(), lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }; console.log("Saving initial plan data (including tableRows):", planDataToSave); try { await planRef.set(planDataToSave); console.log("Initial plan data saved!"); hasExistingPlan = true; window.location.href = 'dashboard.html'; } catch (error) { console.error("Error saving initial plan data: ", error); alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø·Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."); if(confirmPlanBtn) { confirmPlanBtn.disabled = false; confirmPlanBtn.textContent = "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø®Ø·Ø© ÙˆØ§Ù„Ø¨Ø¯Ø¡"; } } }

        // --- Authentication State Listener ---
        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            if (user) { hasExistingPlan = await checkIfPlanExists(user.uid); }
            else { hasExistingPlan = false; }
            updateUIBasedOnLoginAndPlanState();
        });

        // --- Event Listeners ---
        // Google Sign-in (Header Button)
        if (loginBtn) { loginBtn.addEventListener('click', () => { const provider = new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(provider).catch(err => { console.error("Sign-in error:", err); alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + err.message); }); }); }
        // Plan Card Selection
        if(planCards) { planCards.forEach(card => { card.addEventListener('click', () => { if(planCards) planCards.forEach(c => c.classList.remove('selected')); card.classList.add('selected'); selectedPlanType = parseInt(card.getAttribute('data-plan-type')); updateConfirmButtonState(); }); }); }
        // Date Input Change
        if (planStartDateInput) { planStartDateInput.addEventListener('change', updateConfirmButtonState); }
        // Confirm Plan Button
        if (confirmPlanBtn) { confirmPlanBtn.addEventListener('click', saveInitialPlanData); }

        // --- Mobile Menu Toggle Functionality ---
        if (mobileMenuToggle && mainNav) {
            mobileMenuToggle.addEventListener('click', () => {
                const isOpen = mainNav.classList.toggle('mobile-menu-open');
                mobileMenuToggle.setAttribute('aria-expanded', isOpen);
                mobileMenuToggle.innerHTML = isOpen ? 'âœ•' : 'â˜°';
            });
            document.addEventListener('click', (event) => { /* Close on outside click */ if (mainNav.classList.contains('mobile-menu-open') && !mainNav.contains(event.target) && !mobileMenuToggle.contains(event.target)) { mainNav.classList.remove('mobile-menu-open'); mobileMenuToggle.setAttribute('aria-expanded', 'false'); mobileMenuToggle.innerHTML = 'â˜°'; } });

             // === Mobile Submenu Toggle (Updated for better closing behavior) ===
             const menuItemsWithChildren = mainNav.querySelectorAll('li.menu-item-has-children');
             menuItemsWithChildren.forEach(item => {
                 let subToggle = item.querySelector('.submenu-toggle');
                 if (!subToggle) {
                     subToggle = document.createElement('span'); subToggle.classList.add('submenu-toggle'); subToggle.innerHTML = '<span class="arrow">â–¼</span>';
                     // Append directly to the li, so it's easier to manage layout with flex
                     item.appendChild(subToggle);

                     subToggle.addEventListener('click', (event) => {
                         event.stopPropagation();
                         const parentLi = item;
                         const currentlyOpen = parentLi.classList.contains('submenu-open');

                         // Close ALL other submenus first
                         mainNav.querySelectorAll('li.menu-item-has-children.submenu-open').forEach(otherItem => {
                             if (otherItem !== parentLi) { // Don't close the one we might be opening
                                 otherItem.classList.remove('submenu-open');
                                 const otherArrow = otherItem.querySelector('.submenu-toggle .arrow');
                                 if (otherArrow) otherArrow.innerHTML = 'â–¼';
                             }
                         });

                         // Toggle the current submenu
                         parentLi.classList.toggle('submenu-open');
                         const arrow = subToggle.querySelector('.arrow');
                         if (arrow) arrow.innerHTML = parentLi.classList.contains('submenu-open') ? 'â–²' : 'â–¼';
                     });

                      // Also allow clicking the main link text to toggle the submenu on mobile
                      const link = item.querySelector('a');
                      if(link && subToggle){
                           link.addEventListener('click', (e) => {
                               if(window.innerWidth <= 1024 && item.querySelector('.dropdown')) { // Check if it has a dropdown
                                   e.preventDefault(); // Prevent link navigation
                                   subToggle.click(); // Trigger the toggle click
                               }
                           });
                      }
                 }
             });
        }

        // --- Profile Dropdown Toggle ---
        if (profileTrigger && profileDropdown) {
            const logoutBtn = profileDropdown.querySelector('#logout-button');
            profileTrigger.addEventListener('click', (event) => { event.stopPropagation(); const isOpen = profileDropdown.classList.toggle('open'); profileTrigger.setAttribute('aria-expanded', isOpen); /* CSS handles display */ });
            if(logoutBtn) { logoutBtn.addEventListener('click', () => { auth.signOut().catch((error) => { console.error('Sign out error:', error); }); }); }
            document.addEventListener('click', (event) => { if (!profileTrigger?.contains(event.target) && !profileDropdown?.contains(event.target) && profileDropdown?.classList.contains('open')) { profileDropdown.classList.remove('open'); profileTrigger.setAttribute('aria-expanded', 'false'); } });
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            if(currentYearSpan) { currentYearSpan.textContent = new Date().getFullYear(); }
        });

    </script>

</body>
</html>