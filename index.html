<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†Ø§Ø±Ø© Ø§Ù„Ø­ÙØ¸ - Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style.css">

    <style>
        /* --- CSS Ù…Ø¤Ù‚Øª Ù„Ù„ØªÙˆØ¶ÙŠØ­ --- */
        /* Ø³Ù†Ø­ØªØ§Ø¬ Ù„ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø¨Ø´ÙƒÙ„ ÙƒØ¨ÙŠØ± Ù„Ø§Ø­Ù‚Ø§Ù‹ */
        body { font-family: 'Tajawal', sans-serif; margin: 0; background-color: #f9f9f9; }
        .header-container { display: flex; justify-content: space-between; align-items: center; padding: 10px 25px; background-color: #eaf2f8; border-bottom: 2px solid #aed6f1; }
        .logo-container img { max-height: 50px; /* Ù…Ø«Ø§Ù„ */ }
        .site-branding { display: flex; align-items: center; gap: 15px; }
        .site-name { font-size: 1.5em; font-weight: bold; color: #1a5276; }
        nav ul { list-style: none; padding: 0; margin: 0; display: flex; gap: 15px; }
        nav ul li { position: relative; } /* Ù„Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© */
        nav ul li a { text-decoration: none; color: #333; padding: 10px 5px; display: block; }
        nav ul li a:hover { color: #2980b9; }
        /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹ */
        nav ul li .dropdown { display: none; position: absolute; background-color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 0; min-width: 180px; z-index: 100; border: 1px solid #eee; border-radius: 4px; }
        nav ul li:hover .dropdown { display: block; }
        nav ul li .dropdown li { width: 100%; }
        nav ul li .dropdown li a { padding: 10px 15px; white-space: nowrap; }
        nav ul li .dropdown li a:hover { background-color: #f1f1f1; }

        .auth-area { display: flex; align-items: center; gap: 15px; }
        #user-profile-area img { width: 40px; height: 40px; border-radius: 50%; border: 1px solid #ccc; }
        #user-profile-area button { /* ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ */ padding: 5px 10px; cursor: pointer; }
        .google-signin-btn { /* ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ */ padding: 8px 15px; cursor: pointer; background-color: #4285F4; color: white; border: none; border-radius: 4px; }
        #student-level-title { font-weight: bold; color: #1e8449; font-size: 0.9em; }

        main { padding: 20px; }
        footer { text-align: center; padding: 20px; margin-top: 40px; background-color: #2c3e50; color: #ecf0f1; font-size: 0.9em; }
        footer a { color: #3498db; }

        /* ØªÙ†Ø³ÙŠÙ‚ Ù…Ø¨Ø¯Ø¦ÙŠ Ù„Ù‚Ø³Ù… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø·Ø© - ÙŠÙ…ÙƒÙ† ØªØ­Ø³ÙŠÙ†Ù‡ */
        #plan-setup-section { background-color: #fff; padding: 30px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee; text-align: center; }
        #plan-setup-section h2 { color: #1a5276; }
        /* ... (Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ù„Ø¥Ø¶Ø§ÙØ© ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø£Ø®Ø±Ù‰ Ù…Ù† Ù…Ù„ÙÙƒ Ø§Ù„Ø£ØµÙ„ÙŠ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª) ... */

    </style>
</head>
<body>

    <header class="header-container">
        <div class="site-branding">
            <div class="logo-container">
                <img src="images/logo-placeholder.png" alt="Ø´Ø¹Ø§Ø± Ù…Ù†Ø§Ø±Ø© Ø§Ù„Ø­ÙØ¸" style="height: 50px;">
            </div>
            <span class="site-name">Ù…Ù†Ø§Ø±Ø© Ø§Ù„Ø­ÙØ¸</span>
        </div>

        <nav>
            <ul>
                <li><a href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                <li>
                    <a href="#about">Ø¹Ù† Ù…Ù†Ø§Ø±Ø© Ø§Ù„Ø­ÙØ¸</a>
                    </li>
                 <li>
                    <a href="#">Ø®Ø·Ø· Ø§Ù„Ø­ÙØ¸</a>
                    <ul class="dropdown">
                        <li><a href="#">Ø®Ø·Ø© ØµÙØ­Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹</a></li>
                        <li><a href="#">Ø®Ø·Ø© ØµÙØ­ØªÙŠÙ† ÙŠÙˆÙ…ÙŠØ§Ù‹</a></li>
                        <li><a href="#">Ø®Ø·Ø© 3 ØµÙØ­Ø§Øª ÙŠÙˆÙ…ÙŠØ§Ù‹</a></li>
                         <li><a href="#">Ø®Ø·Ø© 4 ØµÙØ­Ø§Øª ÙŠÙˆÙ…ÙŠØ§Ù‹</a></li>
                        </ul>
                </li>
                 <li>
                    <a href="#">Ø§Ù„Ø¯ÙˆØ±Ø§Øª ÙˆØ§Ù„Ø¨Ø±Ø§Ù…Ø¬</a>
                     <ul class="dropdown">
                        <li><a href="#">Ø¯ÙˆØ±Ø§Øª Ø§Ù„ØªØ¬ÙˆÙŠØ¯</a></li>
                        <li><a href="#">Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…ÙƒØ«ÙØ©</a></li>
                        </ul>
                </li>
                 <li>
                    <a href="#">Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ø°Ù‡Ù†ÙŠØ©</a>
                     <ul class="dropdown">
                        <li><a href="#">Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ø³ÙˆØ±</a></li>
                        <li><a href="#">Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø§Øª</a></li>
                         </ul>
                </li>
                <li>
                    <a href="#">Ø§Ù„ØªØ³Ø¬ÙŠÙ„</a>
                     <ul class="dropdown">
                        <li><a href="#">ØªØ³Ø¬ÙŠÙ„ Ø·Ø§Ù„Ø¨</a></li>
                        <li><a href="#">ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ù„Ù…</a></li>
                        <li><a href="#">ØªØ³Ø¬ÙŠÙ„ Ù…Ø´Ø±Ù</a></li>
                        </ul>
                </li>
                 </ul>
        </nav>

        <div class="auth-area">
            <button id="google-signin-btn" class="google-signin-btn" style="display: inline-block;">
                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google
            </button>
            <div id="user-profile-area" style="display: none; align-items: center; gap: 10px;">
                <img id="user-photo" src="placeholder.png" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                <span id="user-name">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ</span>
                <span id="student-level-title" style="display: none; margin-right: 10px;"></span>
                <button id="logout-button">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
            <p id="welcome-message" style="display: none;">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ!</p>
        </div>
    </header>

    <main>
        <section class="hero-section" style="text-align: center; padding: 50px 20px; background-color: #d6eaf8;">
             <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…Ù†Ø§Ø±Ø© Ø§Ù„Ø­ÙØ¸</h2>
            <p>Ø­ÙŠØ« Ø§Ù„ØªÙ…ÙŠØ² ÙÙŠ ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ù‚Ø±Ø¢Ù† ÙˆØªØ¬ÙˆÙŠØ¯Ù‡ ÙˆØ­ÙØ¸Ù‡ØŒ ÙˆØ§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ ÙÙŠ ØºØ±Ø³ Ù‚ÙÙŠÙÙ…Ù‡.</p>
             <div style="padding: 50px; background-color: #ccc; margin: 20px auto; max-width: 400px;">(ØµÙˆØ±Ø© Ø£Ùˆ Ø±Ø³Ù… ØªÙˆØ¶ÙŠØ­ÙŠ)</div>
        </section>

        <section id="about" style="padding: 40px 20px;">
            <h2 style="text-align: center;">ØªØ¹Ø±ÙŠÙ Ø¨Ù…Ù†Ø§Ø±Ø© Ø§Ù„Ø­ÙØ¸</h2>
            <p style="max-width: 800px; margin: 0 auto; text-align: center;">
                Ù…Ù†Ø§Ø±Ø© Ø§Ù„Ø­ÙØ¸ Ù‡ÙŠ Ù…Ù†ØµØ© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© ØªØ·ÙˆØ¹ÙŠØ© ØªÙ‡Ø¯Ù Ù„ØªÙŠØ³ÙŠØ± Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… ÙˆØ¹Ù„ÙˆÙ…Ù‡ ÙˆÙ…Ø±Ø§Ø¬Ø¹ØªÙ‡ Ù„Ù„Ù…Ø³Ù„Ù…ÙŠÙ† Ø­ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù„Ù… Ø¹Ø¨Ø± Ø®Ø·Ø· ØªÙØ§Ø¹Ù„ÙŠØ© ÙˆØ£Ø¯ÙˆØ§Øª Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø¯ÙŠØ«Ø©... (Ø£ÙƒÙ…Ù„ Ø§Ù„Ù†Øµ Ù‡Ù†Ø§)
            </p>
            </section>

        <section class="features-section" style="padding: 40px 20px; background-color: #eaf2f8;">
            <h2 style="text-align: center;">Ø®Ø¯Ù…Ø§ØªÙ†Ø§ ÙˆÙ…Ù…ÙŠØ²Ø§ØªÙ†Ø§</h2>
            <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px; text-align: center;">
                <div class="feature-item" style="flex-basis: 200px; padding: 15px; background-color: #fff; border-radius: 5px;">
                     <div class="icon" style="font-size: 2em; margin-bottom: 10px;">ğŸ“…</div>
                    <h3>Ø®Ø·Ø· Ø­ÙØ¸ ØªÙØ§Ø¹Ù„ÙŠØ©</h3>
                    <p>Ø®Ø·Ø· ÙŠÙˆÙ…ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ§Ù„Ø±Ø¨Ø·.</p>
                </div>
                <div class="feature-item" style="flex-basis: 200px; padding: 15px; background-color: #fff; border-radius: 5px;">
                     <div class="icon" style="font-size: 2em; margin-bottom: 10px;">ğŸ“Š</div>
                    <h3>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙ‚Ø¯Ù…</h3>
                    <p>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØªÙ‚ÙˆÙŠÙ… Ù…Ø±Ø¦ÙŠ Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù†Ø¬Ø§Ø²Ùƒ.</p>
                 </div>
                <div class="feature-item" style="flex-basis: 200px; padding: 15px; background-color: #fff; border-radius: 5px;">
                    <div class="icon" style="font-size: 2em; margin-bottom: 10px;">âœ¨</div>
                   <h3>ØªØ­ÙÙŠØ² Ù…Ø³ØªÙ…Ø±</h3>
                   <p>Ù†Ø¸Ø§Ù… Ø£Ù„Ù‚Ø§Ø¨ ÙˆÙ…Ø³ØªÙˆÙŠØ§Øª ÙˆØªØªØ¨Ø¹ Ù„Ù„Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…ØªØªØ§Ù„ÙŠ.</p>
               </div>
                <div class="feature-item" style="flex-basis: 200px; padding: 15px; background-color: #fff; border-radius: 5px;">
                    <div class="icon" style="font-size: 2em; margin-bottom: 10px;">ğŸ¤</div>
                   <h3>Ù…Ø¬ØªÙ…Ø¹ Ø¯Ø§Ø¹Ù…</h3>
                   <p>(Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ø£Ù‚Ø³Ø§Ù… Ù„Ù„ØªÙØ§Ø¹Ù„ Ø£Ùˆ Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©.</p>
               </div>
                </div>
        </section>

         <section id="plan-setup-section" style="display: none;">
             <h2>Ø¥Ø¹Ø¯Ø§Ø¯ Ø®Ø·ØªÙƒ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©</h2>
            <p>ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© ÙˆØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡.</p>
            <div class="plan-selection-area">
                <div class="plans-container" style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px;">
                     <div class="plan-card" data-plan-type="2" style="border: 1px solid #ddd; padding: 20px; flex-basis: 200px; cursor: pointer;">
                        <h3>Ø®Ø·Ø© Ø­ÙØ¸ ØµÙØ­ØªÙŠÙ† ÙŠÙˆÙ…ÙŠÙ‹Ø§</h3>
                         <p>Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡Ø§.</p>
                         <span class="plan-link" style="color: #2980b9; font-weight: bold; margin-top: 10px; display: block;">Ø§Ø®ØªØ± Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·Ø©</span>
                    </div>
                     </div>
             </div>
            <div class="plan-setup-inputs" style="margin-top: 20px;">
                 <label for="planStartDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡:</label>
                 <input type="date" id="planStartDate" required>
                <label for="planRepetitionMax">Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª:</label>
                 <select id="planRepetitionMax">
                    <option value="20" selected>20</option>
                    <option value="30">30</option>
                    <option value="40">40</option>
                 </select>
             </div>
            <button id="confirmPlanBtn" disabled style="margin-top: 20px; padding: 10px 20px; cursor: pointer;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø®Ø·Ø© ÙˆØ§Ù„Ø¨Ø¯Ø¡</button>
         </section>

         </main>

    <footer class="main-footer">
        <p>&copy; <span id="current-year">2025</span> Ù…Ù†Ø§Ø±Ø© Ø§Ù„Ø­ÙØ¸. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
        </footer>

    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

    <script>
        // --- Firebase Configuration ---
        // ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù†ÙØ³ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù…Ù„ÙÙƒ Ø§Ù„Ø£ØµÙ„ÙŠ
        const firebaseConfig = {
         apiKey: "AIzaSyDuUebu7Qzz3JnTfa-58EIPZjOcrkmdGHU",
         authDomain: "quranplan2.firebaseapp.com",
         projectId: "quranplan2",
         storageBucket: "quranplan2.appspot.com",
         messagingSenderId: "1098692856811",
         appId: "1:1098692856811:web:923bca3a54fd78b1b267ae"
        };

        // --- Initialize Firebase ---
         try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Init Error:", e); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Get DOM Elements ---
        // (ÙŠØ¬Ø¨ Ù†Ù‚Ù„ ÙƒÙ„ ØªØ¹Ø±ÙŠÙØ§Øª Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…Ù† Ù…Ù„ÙÙƒ Ø§Ù„Ø£ØµÙ„ÙŠ ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø·Ø§Ø¨Ù‚ØªÙ‡Ø§ Ù„Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯)
        const loginBtn = document.getElementById('google-signin-btn');
        const welcomeMessage = document.getElementById('welcome-message'); // Ù‚Ø¯ Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ø¨Ù†ÙØ³ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©
        const planSetupSection = document.getElementById('plan-setup-section');
        const planCards = planSetupSection?.querySelectorAll('.plan-card'); // Ø§Ø³ØªØ®Ø¯Ø§Ù… '?' Ù„Ù„Ø£Ù…Ø§Ù†
        const planStartDateInput = document.getElementById('planStartDate');
        const planRepetitionMaxSelect = document.getElementById('planRepetitionMax');
        const confirmPlanBtn = document.getElementById('confirmPlanBtn');
        const userProfileArea = document.getElementById('user-profile-area');
        const userNameSpan = document.getElementById('user-name');
        const userPhoto = document.getElementById('user-photo');
        const logoutButton = document.getElementById('logout-button');
        const studentLevelTitleSpan = document.getElementById('student-level-title'); // Ø¹Ù†ØµØ± Ø§Ù„Ù„Ù‚Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const currentYearSpan = document.getElementById('current-year'); // Ù„Ù„ÙÙˆØªØ±

        // --- Global State ---
        let currentUser = null;
        let selectedPlanType = null;
        let hasExistingPlan = false;

        // --- Constants ---
        const initialTotalRows = 320; // Consistent with plangen2.html structure

        // --- Helper Functions ---
        function formatDate(date) { /* ... Ù†ÙØ³ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…Ù† Ù…Ù„ÙÙƒ Ø§Ù„Ø£ØµÙ„ÙŠ ... */ if (!(date instanceof Date)) { date = new Date(date); } if (isNaN(date.getTime())) { return ""; } const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }

        // --- Firestore Check ---
        async function checkIfPlanExists(uid) { /* ... Ù†ÙØ³ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…Ù† Ù…Ù„ÙÙƒ Ø§Ù„Ø£ØµÙ„ÙŠ ... */ if (!uid) return false; const planRef = db.collection("quranPlans").doc(uid); try { const doc = await planRef.get(); console.log(`Index: Plan check for ${uid}: Exists = ${doc.exists}`); return doc.exists; } catch (error) { console.error("Error checking plan existence:", error); return false; } }

        // --- *** START: Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù„Ù‚Ø¨ (Ø¬Ø¯ÙŠØ¯Ø©) *** ---
        const levelTitles = ["Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ!", "ğŸŒ± ØºØ±Ø³Ø© Ø§Ù„Ø¥ÙŠÙ…Ø§Ù†", "âœ¨ Ø¨Ø§Ø¯Ø±Ø© Ø£Ù…Ù„", "ğŸƒ Ø³Ø§Ø¹Ù Ù„Ù„Ø¹Ù„Ø§", "â­ Ù†Ø¬Ù… ØµØ§Ø¹Ø¯", "ğŸ’ª Ù…Ø«Ø§Ø¨Ø± Ù…Ø¬ØªÙ‡Ø¯", "ğŸ§­ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø¨", "ğŸ’¯ ØµØ§Ø­Ø¨ Ø§Ù„Ø³Ø¨Ø¹ÙŠÙ†", "ğŸš€ Ø§Ù†Ø·Ù„Ø§Ù‚Ø© Ù‚ÙˆÙŠØ©", "ğŸ’ Ø¬ÙˆÙ‡Ø±Ø© Ù…ØµÙ‚ÙˆÙ„Ø©", "ğŸ‘‘ ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ø¦Ø© ÙŠÙˆÙ…", "ğŸ“– Ø±ÙÙŠÙ‚ Ø§Ù„Ù‚Ø±Ø¢Ù†", "ğŸ•¯ï¸ Ù…Ù†Ø§Ø±Ø© Ù‡Ø¯Ù‰", "ğŸ”ï¸ Ù‚Ù…Ø© Ø´Ø§Ù…Ø®Ø©", "ğŸŒ³ Ø´Ø¬Ø±Ø© Ø·ÙŠØ¨Ø©", "â³ Ø¹Ø§Ø¨Ø± Ù…Ù†ØªØµÙ Ø§Ù„Ø·Ø±ÙŠÙ‚", "ğŸ¯ Ø¯Ù‚Ø© ÙˆØ§Ù„ØªØ²Ø§Ù…", "ğŸŒŠ Ø¨Ø­Ø± Ø²Ø§Ø®Ø±", "ğŸŒŸ ÙƒÙˆÙƒØ¨ Ø¯Ø±ÙŠ", "ğŸ§­ Ø¨ÙˆØµÙ„Ø© Ø§Ù„Ø­Ù‚", "ğŸ’¯ğŸ’¯ Ø§Ù„Ù…Ø¦ØªØ§Ù† Ù„Ø§ ØªÙ‚ÙØ§Ù†!", "ğŸ¤² Ù‚Ù„Ø¨ Ø®Ø§Ø´Ø¹", "ğŸ•Šï¸ Ø±ÙˆØ­ Ù…Ø·Ù…Ø¦Ù†Ø©", "ğŸ’– Ù…Ø­Ø¨ Ù„Ù„Ø±Ø­Ù…Ù†", "ğŸ™ Ø¹Ø¨Ø¯ Ø´ÙƒÙˆØ±", "ğŸ’¡ Ø¨ØµÙŠØ±Ø© Ù†Ø§ÙØ°Ø©", "ğŸ•Œ Ù…Ø¹Ù…Ù‘Ø± Ø¨ÙŠÙˆØª Ø§Ù„Ù„Ù‡", "ğŸŒ™ Ù‡Ù„Ø§Ù„ Ø§Ù„ÙƒÙ…Ø§Ù„", "âœ¨ Ù†ÙˆØ± Ø¹Ù„Ù‰ Ù†ÙˆØ±", "ğŸ Ù‚Ø§Ø¨ Ù‚ÙˆØ³ÙŠÙ† Ø£Ùˆ Ø£Ø¯Ù†Ù‰", "ğŸ† ÙØ§Ø±Ø³ Ø§Ù„Ø«Ù„Ø§Ø«Ù…Ø§Ø¦Ø©", "ğŸ‰ Ù…Ù‚ØªØ±Ø¨ Ù…Ù† Ø§Ù„Ø®ØªØ§Ù…", "ğŸŠ Ø®Ø§ØªÙ… Ù…Ø¨Ø§Ø±Ùƒ"];
        const levelIcons = { 10: 'ğŸ‘‘', 20: 'ğŸ’¯', 30: 'ğŸ†', 32: 'ğŸŠ' }; // Example icons

        function calculateLevelTitle(tableRows) {
            // (Ù‡Ø°Ù‡ Ù†Ø³Ø®Ø© Ù…Ø¨Ø³Ø·Ø© Ù…Ù† Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…ØªØªØ§Ù„ÙŠ Ù…Ù† dashboard.html)
            if (!tableRows || tableRows.length === 0) return levelTitles[0]; // Ø§Ù„Ù„Ù‚Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
            const sortedRows = [...tableRows].sort((a, b) => new Date(a.displayDate) - new Date(b.displayDate));
            let currentStreak = 0;
            let streakBroken = false;
            const todayStr = formatDate(new Date());
            for (let i = sortedRows.length - 1; i >= 0; i--) {
                const row = sortedRows[i];
                if (row.displayDate > todayStr) continue;
                if (row.type === 'plan' && row.state?.completed) {
                    if (!streakBroken) tempCurrentStreak++;
                } else if (row.type === 'excuse') {
                    continue; // Skip excuses for streak count
                } else {
                    streakBroken = true;
                    // If today's task exists and is not complete, streak is 0 for today
                    if (row.displayDate === todayStr) tempCurrentStreak = 0;
                    break; // Stop counting streak
                }
            }
             currentStreak = tempCurrentStreak;
            const levelIndex = Math.min(Math.floor(currentStreak / 10), levelTitles.length - 1);
            const title = levelTitles[levelIndex] || levelTitles[0];
            const icon = levelIcons[levelIndex] || '';
            return `${title} ${icon}`.trim(); // Return title with icon
        }

        async function displayStudentLevel(uid) {
            if (!studentLevelTitleSpan) return;
            try {
                const planRef = db.collection("quranPlans").doc(uid);
                const doc = await planRef.get();
                if (doc.exists) {
                    const planData = doc.data();
                    if (planData.tableRows) {
                        const title = calculateLevelTitle(planData.tableRows);
                        studentLevelTitleSpan.textContent = `(Ù„Ù‚Ø¨Ùƒ: ${title})`;
                        studentLevelTitleSpan.style.display = 'inline'; // Ø£Ùˆ 'block' Ø­Ø³Ø¨ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚
                    } else {
                         studentLevelTitleSpan.style.display = 'none';
                    }
                } else {
                     studentLevelTitleSpan.style.display = 'none';
                }
            } catch (error) {
                console.error("Error fetching plan data for level title:", error);
                studentLevelTitleSpan.style.display = 'none';
            }
        }
         // --- *** END: Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù„Ù‚Ø¨ (Ø¬Ø¯ÙŠØ¯Ø©) *** ---

        // --- UI Update Functions ---
        function updateUIBasedOnLoginAndPlanState() {
            // (Ù†ÙØ³ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…Ù† Ù…Ù„ÙÙƒ Ø§Ù„Ø£ØµÙ„ÙŠ Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø®ÙØ§Ø¡ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø­Ø³Ø¨ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯)
             const dashboardLinkContainer = document.getElementById('dashboard-link-container'); // Ø³Ù†Ø­ØªØ§Ø¬ Ù„Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±
             if (dashboardLinkContainer) dashboardLinkContainer.innerHTML = ''; // Clear previous link/button

            if (currentUser) {
                 if(loginBtn) loginBtn.style.display = 'none';
                 // welcomeMessage Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ø¨Ù†ÙØ³ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©
                 if(userProfileArea) {
                      userProfileArea.style.display = 'flex'; // ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… flex Ø£Ùˆ block Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ…ÙŠÙ…
                      if(userNameSpan) userNameSpan.textContent = currentUser.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…';
                      if(userPhoto) userPhoto.src = currentUser.photoURL || 'placeholder.png';
                 }
                  // Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù„Ù‚Ø¨
                 displayStudentLevel(currentUser.uid);

                 if (hasExistingPlan) {
                     console.log("UI Update: User has plan. Hiding setup, showing dashboard link.");
                     if(planSetupSection) planSetupSection.style.display = 'none';

                     // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¹Ø±Ø¶ Ø±Ø§Ø¨Ø· Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© (ÙŠÙ…ÙƒÙ† ÙˆØ¶Ø¹Ù‡ ÙÙŠ Ù…ÙƒØ§Ù† Ø¢Ø®Ø± Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª)
                    if (!dashboardLinkContainer) { // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
                         const newDiv = document.createElement('div');
                         newDiv.id = 'dashboard-link-container';
                         newDiv.style.textAlign = 'center';
                         newDiv.style.padding = '20px';
                         // Ø¥Ù„Ø­Ø§Ù‚Ù‡ Ø¨Ù…ÙƒØ§Ù† Ù…Ù†Ø§Ø³Ø¨ØŒ Ù…Ø«Ù„Ø§Ù‹ Ø¯Ø§Ø®Ù„ main
                         document.querySelector('main')?.appendChild(newDiv);
                    }
                     document.getElementById('dashboard-link-container').innerHTML = `<a href="dashboard.html" class="google-signin-btn" style="background-color: #1e8449; display: inline-block; margin-top: 15px;">Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ</a>`;

                 } else {
                     console.log("UI Update: User needs to set up plan. Showing setup section.");
                     if(planSetupSection) planSetupSection.style.display = 'block'; // Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯
                     if (dashboardLinkContainer) { // Ø¥Ø®ÙØ§Ø¡ Ø±Ø§Ø¨Ø· Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
                           dashboardLinkContainer.innerHTML = '';
                     }
                     // ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… ÙƒÙ‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø¯Ø¡
                     if (planStartDateInput && !planStartDateInput.value) {
                          planStartDateInput.value = formatDate(new Date());
                     }
                     updateConfirmButtonState(); // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯
                 }
            } else {
                 // Logged Out
                 if(loginBtn) loginBtn.style.display = 'inline-block'; // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„
                 if(userProfileArea) userProfileArea.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                 if(planSetupSection) planSetupSection.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯
                 if (studentLevelTitleSpan) studentLevelTitleSpan.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù„Ù‚Ø¨
                 if (dashboardLinkContainer) { // Ø¥Ø®ÙØ§Ø¡ Ø±Ø§Ø¨Ø· Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
                      dashboardLinkContainer.innerHTML = '';
                 }
            }
        }

        // Enable/disable confirm button based on selection
        function updateConfirmButtonState() { /* ... Ù†ÙØ³ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…Ù† Ù…Ù„ÙÙƒ Ø§Ù„Ø£ØµÙ„ÙŠ ... */ if (!confirmPlanBtn) return; if (selectedPlanType && planStartDateInput && planStartDateInput.value) { confirmPlanBtn.disabled = false; } else { confirmPlanBtn.disabled = true; } }

        // --- Save Initial Plan Data ---
        async function saveInitialPlanData() { /* ... Ù†ÙØ³ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…Ù† Ù…Ù„ÙÙƒ Ø§Ù„Ø£ØµÙ„ÙŠ ... */ if (!currentUser || !selectedPlanType || !planStartDateInput || !planStartDateInput.value || !planRepetitionMaxSelect) { alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø®Ø·Ø© ÙˆØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ ÙˆØ¹Ø¯Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª."); return; } const selectedStartDate = new Date(planStartDateInput.value + 'T00:00:00Z'); if (isNaN(selectedStartDate.getTime())) { alert('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø¯Ø¯ ØºÙŠØ± ØµØ§Ù„Ø­.'); return; } if(confirmPlanBtn) { confirmPlanBtn.disabled = true; confirmPlanBtn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..."; } const uid = currentUser.uid; const planRef = db.collection("quranPlans").doc(uid); const initialTableRows = []; let currentDate = new Date(selectedStartDate); for (let i = 0; i < initialTotalRows; i++) { const rowData = { type: 'plan', originalSequence: i, displaySeq: i + 1, displayDate: formatDate(currentDate), state: { yestRep: 0, listen: 0, interp: false, record: 0, rep: 0, linked: false, reviewed: false, completed: false } }; initialTableRows.push(rowData); if (i < initialTotalRows - 1) { currentDate.setUTCDate(currentDate.getUTCDate() + 1); } } const planDataToSave = { studentName: currentUser.displayName || "Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù…", email: currentUser.email, startDate: planStartDateInput.value, planType: selectedPlanType, repetitionMax: parseInt(planRepetitionMaxSelect.value), excuseDates: [], tableRows: initialTableRows, createdAt: firebase.firestore.FieldValue.serverTimestamp(), lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }; console.log("Saving initial plan data (including tableRows):", planDataToSave); try { await planRef.set(planDataToSave); console.log("Initial plan data saved!"); hasExistingPlan = true; window.location.href = 'dashboard.html'; } catch (error) { console.error("Error saving initial plan data: ", error); alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø·Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."); if(confirmPlanBtn) { confirmPlanBtn.disabled = false; confirmPlanBtn.textContent = "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø®Ø·Ø© ÙˆØ§Ù„Ø¨Ø¯Ø¡"; } } }

        // --- Authentication State Observer ---
        // (Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ù…Ù„ÙÙƒ Ø§Ù„Ø£ØµÙ„ÙŠØŒ Ø³Ø£Ù‚ÙˆÙ… Ø¨ØªØ¹Ø¯ÙŠÙ„Ù‡ Ù„ÙŠØ´Ù…Ù„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¹Ø±Ø¶ Ø§Ù„Ù„Ù‚Ø¨)
         auth.onAuthStateChanged(async (user) => {
             currentUser = user;
             if (user) {
                 console.log("Index: Auth state changed: User logged in.");
                 // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø®Ø·Ø© Ø£ÙˆÙ„Ø§Ù‹
                 hasExistingPlan = await checkIfPlanExists(user.uid);
                 // Ø«Ù… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆÙˆØ¬ÙˆØ¯ Ø§Ù„Ø®Ø·Ø©
                 updateUIBasedOnLoginAndPlanState(); // Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø³ØªØ³ØªØ¯Ø¹ÙŠ displayStudentLevel Ø¯Ø§Ø®Ù„ÙŠØ§Ù‹
             } else {
                 console.log("Index: Auth state changed: User logged out.");
                 hasExistingPlan = false;
                 updateUIBasedOnLoginAndPlanState();
             }
         });


        // --- Event Listeners ---
        // Sign-in Button
        if (loginBtn) { loginBtn.addEventListener('click', () => { /* ... Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ù…Ù„ÙÙƒ Ø§Ù„Ø£ØµÙ„ÙŠ ... */ console.log("Login button clicked"); const provider = new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(provider).then(result => { const user = result.user; console.log("Sign-in successful:", user.displayName); const userRef = db.collection("students").doc(user.uid); userRef.get().then((doc) => { const userData = { name: user.displayName, email: user.email, photo: user.photoURL, lastLogin: firebase.firestore.FieldValue.serverTimestamp() }; if (!doc.exists) { userData.joinedAt = firebase.firestore.FieldValue.serverTimestamp(); userRef.set(userData).catch(err => console.error("Error saving new user:", err)); } else { userRef.update(userData).catch(err => console.error("Error updating user:", err)); } }).catch(err => console.error("Error checking user existence:", err)); }).catch(err => { console.error("Sign-in error:", err); alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. Ø±Ù…Ø² Ø§Ù„Ø®Ø·Ø£: " + err.code); }); }); }
        // Logout Button
        if (logoutButton) { logoutButton.addEventListener('click', () => { auth.signOut().catch((error) => { console.error('Sign out error:', error); }); }); }
        // Plan Card Selection in Setup Section
        // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† planCards ØªÙ… ØªØ¹Ø±ÙŠÙÙ‡ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ ÙˆÙŠØ´ÙŠØ± Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ø°Ø§ ØªØºÙŠØ±Øª Ø§Ù„Ù€ classes
        if(planCards) {
            planCards.forEach(card => { card.addEventListener('click', () => { if(planCards) planCards.forEach(c => c.classList.remove('selected')); card.classList.add('selected'); selectedPlanType = parseInt(card.getAttribute('data-plan-type')); console.log("Selected Plan Type:", selectedPlanType); updateConfirmButtonState(); }); });
        }
        // Input fields change listener (for enabling confirm button)
        if (planStartDateInput) { planStartDateInput.addEventListener('change', updateConfirmButtonState); }
        // Confirm Plan Button
        if (confirmPlanBtn) { confirmPlanBtn.addEventListener('click', saveInitialPlanData); }

        // --- Initial Load ---
         document.addEventListener('DOMContentLoaded', () => {
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªÙŠ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹
             if(userProfileArea) userProfileArea.style.display = 'none';
             if(planSetupSection) planSetupSection.style.display = 'none';
             if(loginBtn) loginBtn.style.display = 'inline-block'; // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹
             if (studentLevelTitleSpan) studentLevelTitleSpan.style.display = 'none';

             if(currentYearSpan) { currentYearSpan.textContent = new Date().getFullYear(); }
             // Auth listener will handle UI updates after checking login status
         });

    </script>

</body>
</html>