// --- Firebase SDK Script tags remain above this ---

    <script>
        // --- Global Variables & Config ---
        const initialTotalRows = 320; const initialTotalDays = 300; let pieChartInstance; const totalQuranPages = 604; let currentUser = null; let userPlanData = null; // Stores {startDate, planType, studentName, excuseDates: [] or count, etc.}

        // Firebase Config (From User)
        const firebaseConfig = {
          apiKey: "AIzaSyDuUebu7Qzz3JnTfa-58EIPZjOcrkmdGHU", // استخدم بياناتك الفعلية
          authDomain: "quranplan2.firebaseapp.com",
          projectId: "quranplan2",
          storageBucket: "quranplan2.appspot.com",
          messagingSenderId: "1098692856811",
          appId: "1:1098692856811:web:923bca3a54fd78b1b267ae"
        };

        // --- Initialize Firebase ---
         try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Firebase initialization error:", e); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM References ---
        const loadingIndicator = document.getElementById('loading-indicator');
        const dashboardContent = document.getElementById('dashboard-content');
        const actionButtonsContainer = document.querySelector('.action-buttons');
        const newPlanBtn = document.getElementById('new-plan-btn');
        const dailyTaskContent = document.getElementById('daily-task-content');
        const currentPlanNameSpan = document.getElementById('current-plan-name');
        const progressBarValue = document.getElementById('progress-bar-value');
        const completedPagesProgressSpan = document.getElementById('completed-pages-progress');
        const statMemorized = document.getElementById('stat-memorized');
        const statPerfected = document.getElementById('stat-perfected');
        const statLinked = document.getElementById('stat-linked');
        const statExcuses = document.getElementById('stat-excuses');
        const todayDateSpan = document.getElementById('today-date');

        // --- Data Arrays (Needed for getPlanData) ---
        const surahs = ['الفاتحة والبقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة وآل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء والمائدة', 'المائدة', 'المائدة', 'المائدة', 'المائدة', 'المائدة', 'المائدة', 'المائدة', 'المائدة', 'المائدة', 'المائدة', 'المائدة والأنعام', 'الأنعام', 'الأنعام', 'الأنعام', 'الأنعام', 'الأنعام', 'الأنعام', 'الأنعام', 'الأنعام', 'الأنعام', 'الأنعام', 'الأنعام', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأنفال', 'الأنفال', 'الأنفال', 'الأنفال', 'الأنفال', 'التوبة', 'التوبة', 'التوبة', 'التوبة', 'التوبة', 'التوبة', 'التوبة', 'التوبة', 'التوبة', 'التوبة', 'التوبة ويونس', 'يونس', 'يونس', 'يونس', 'يونس', 'يونس', 'يونس', 'يونس وهود', 'هود', 'هود', 'هود', 'هود', 'هود', 'هود', 'هود ويوسف', 'يوسف', 'يوسف', 'يوسف', 'يوسف', 'يوسف', 'يوسف', 'الرعد', 'الرعد', 'الرعد', 'إبراهيم', 'إبراهيم', 'إبراهيم', 'إبراهيم والحجر', 'الحجر', 'الحجر', 'الحجر والنحل', 'النحل', 'النحل', 'النحل', 'النحل', 'النحل', 'النحل', 'النحل والإسراء', 'الإسراء', 'الإسراء', 'الإسراء', 'الإسراء', 'الإسراء', 'الإسراء والكهف', 'الكهف', 'الكهف', 'الكهف', 'الكهف', 'الكهف', 'مريم', 'مريم', 'مريم', 'مريم وطه', 'طه', 'طه', 'طه', 'طه', 'طه والأنبياء', 'الأنبياء', 'الأنبياء', 'الأنبياء', 'الأنبياء', 'الأنبياء والحج', 'الحج', 'الحج', 'الحج', 'الحج', 'الحج والمؤمنون', 'المؤمنون', 'المؤمنون', 'المؤمنون', 'المؤمنون والنور', 'النور', 'النور', 'النور', 'النور', 'النور والفرقان', 'الفرقان', 'الفرقان', 'الفرقان', 'الشعراء', 'الشعراء', 'الشعراء', 'الشعراء', 'الشعراء', 'النمل', 'النمل', 'النمل', 'النمل', 'النمل والقصص', 'القصص', 'القصص', 'القصص', 'القصص', 'القصص والعنكبوت', 'العنكبوت', 'العنكبوت', 'العنكبوت', 'العنكبوت والروم', 'الروم', 'الروم', 'الروم', 'لقمان', 'لقمان', 'السجدة', 'السجدة والأحزاب', 'الأحزاب', 'الأحزاب', 'الأحزاب', 'الأحزاب', 'الأحزاب وسبأ', 'سبأ', 'سبأ', 'سبأ وفاطر', 'فاطر', 'فاطر', 'فاطر ويس', 'يس', 'يس', 'يس والصافات', 'الصافات', 'الصافات', 'الصافات', 'ص', 'ص', 'ص والزمر', 'الزمر', 'الزمر', 'الزمر', 'الزمر', 'غافر', 'غافر', 'غافر', 'غافر', 'غافر', 'فصلت', 'فصلت', 'فصلت', 'الشورى', 'الشورى', 'الشورى', 'الشورى والزخرف', 'الزخرف', 'الزخرف', 'الزخرف والدخان', 'الدخان', 'الجاثية', 'الجاثية والأحقاف', 'الأحقاف', 'الأحقاف', 'محمد', 'محمد', 'الفتح', 'الفتح', 'الفتح والحجرات', 'الحجرات و ق', 'ق', 'الذاريات', 'الذاريات والطور', 'الطور والنجم', 'النجم والقمر', 'القمر', 'القمر والرحمن', 'الرحمن والواقعة', 'الواقعة', 'الواقعة والحديد', 'الحديد', 'الحديد والمجادلة', 'المجادلة', 'المجادلة والحشر', 'الحشر', 'الممتحنة', 'الممتحنة والصف', 'الجمعة والمنافقون', 'المنافقون والتغابن', 'التغابن والطلاق', 'الطلاق والتحريم', 'التحريم والملك', 'الملك والقلم', 'القلم والحاقة', 'الحاقة والمعارج', 'المعارج ونوح', 'نوح والجن', 'الجن والمزمل', 'المزمل والمدثر', 'المدثر والقيامة والإنسان', 'الإنسان والمرسلات', 'المرسلات والنبأ', 'النبأ والنازعات', 'عبس والتكوير', 'الإنفطار والمطففين', 'الإنشقاق والبروج', 'الطارق والأعلى والغاشية', 'الفجر والبلد', 'الشمس والليل', 'الضحى إلى الناس', 'ختم القرآن'];
        const linkFromData = ['', '', 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, 13,13,13,13,13,13,25,25,25,25,25,25,37,37,37,37,37,37,49,49,49,49,49,49,61,61,61,61,61,61, 73,73,73,73,73,73,85,85,85,85,85,85,97,97,97,97,97,97,109,109,109,109,109,109,121,121,121,121,121,121, 133,133,133,133,133,133,145,145,145,145,145,145,157,157,157,157,157,157,169,169,169,169,169,169,181,181,181,181,181,181, 193,193,193,193,193,193,205,205,205,205,205,205,217,217,217,217,217,217,229,229,229,229,229,229,241,241,241,241,241,241, 253,253,253,253,253,253,265,265,265,265,265,265,277,277,277,277,277,277,289,289,289,289,289,289,301,301,301,301,301,301, 313,313,313,313,313,313,325,325,325,325,325,325,337,337,337,337,337,337,349,349,349,349,349,349,361,361,361,361,361,361, 373,373,373,373,373,373,385,385,385,385,385,385,397,397,397,397,397,397,409,409,409,409,409,409,421,421,421,421,421,421, 433,433,433,433,433,433,445,445,445,445,445,445,457,457,457,457,457,457,469,469,469,469,469,469,481,481,481,481,481,481, 493,493,493,493,493,493,505,505,505,505,505,505,517,517,517,517,517,517,529,529,529,529,529,529,541,541,541,541,541,541, 553,553,553,553,553,553,565,565,565,565,565,565,577,577,577,577,577,577];
        const linkToData = ['', '', 2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40,42,44,46,48,50,52,54,56,58,60, 62,64,66,68,70,72,74,76,78,80,82,84,86,88,90,92,94,96,98,100,102,104,106,108,110,112,114,116, 118,120,122,124,126,128,130,132,134,136,138,140,142,144,146,148,150,152,154,156,158,160,162,164,166,168, 170,172,174,176,178,180,182,184,186,188,190,192,194,196,198,200,202,204,206,208,210,212,214,216,218,220, 222,224,226,228,230,232,234,236,238,240,242,244,246,248,250,252,254,256,258,260,262,264,266,268,270,272, 274,276,278,280,282,284,286,288,290,292,294,296,298,300,302,304,306,308,310,312,314,316,318,320,322,324, 326,328,330,332,334,336,338,340,342,344,346,348,350,352,354,356,358,360,362,364,366,368,370,372,374,376, 378,380,382,384,386,388,390,392,394,396,398,400,402,404,406,408,410,412,414,416,418,420,422,424,426,428, 430,432,434,436,438,440,442,444,446,448,450,452,454,456,458,460,462,464,466,468,470,472,474,476,478,480, 482,484,486,488,490,492,494,496,498,500,502,504,506,508,510,512,514,516,518,520,522,524,526,528,530,532, 534,536,538,540,542,544,546,548,550,552,554,556,558,560,562,564,566,568,570,572,574,576,578,580,582,584, 586,588,590,592,594,597,600,604];
        const reviewFromData = [...Array(32).fill(''), 1,3,5,7,9,11,1,5,9,13,17,21,1,7,13,19,25,31,1,9,17,25,33,41, 1,11,21,31,41,51,1,13,25,37,49,61,1,15,29,43,57,71,1,17,33,49,65,81, 1,19,37,55,73,91,1,21,41,61,81,101,1,23,45,67,89,111,1,25,49,73,97,121, 1,27,53,79,105,131,1,29,57,85,113,141,1,31,61,91,121,151,1,33,65,97,129,161, 1,35,69,103,137,171,1,37,73,109,145,181,1,39,77,115,153,191,1,41,81,121,161,201, 1,43,85,127,169,211,1,45,89,133,177,221,1,47,93,139,185,231,1,49,97,145,193,241, 1,51,101,151,201,251,1,53,105,157,209,261,1,55,109,163,217,271,1,57,113,169,225,281, 1,59,117,175,233,291,1,61,121,181,241,301,1,63,125,187,249,311,1,65,129,193,257,321, 1,67,133,199,265,331,1,69,137,205,273,341,1,71,141,211,281,351,1,73,145,217,289,361, 1,75,149,223,297,371,1,77,153,229,305,381,1,79,157,235,313,391,1,81,161,241,321,401, 1,83,165,247,329,411,1,85,169,253,337,421,1,87,173,259,345,431,1,89,177,265,353,441, 1,91,181,271,361,451,1,93,185,277,369,461,1,95,189,283,377,471,1,97,193,289,385,481];
        const reviewToData = [...Array(32).fill(''), 2,4,6,8,10,12,4,8,12,16,20,24,6,12,18,24,30,36,8,16,24,32,40,48, 10,20,30,40,50,60,12,24,36,48,60,72,14,28,42,56,70,84,16,32,48,64,80,96, 18,36,54,72,90,108,20,40,60,80,100,120,22,44,66,88,110,132,24,48,72,96,120,144, 26,52,78,104,130,156,28,56,84,112,140,168,30,60,90,120,150,180,32,64,96,128,160,192, 34,68,102,136,170,204,36,72,108,144,180,216,38,76,114,152,190,228,40,80,120,160,200,240, 42,84,126,168,210,252,44,88,132,176,220,264,46,92,138,184,230,276,48,96,144,192,240,288, 50,100,150,200,250,300,52,104,156,208,260,312,54,108,162,216,270,324,56,112,168,224,280,336, 58,116,174,232,290,348,60,120,180,240,300,360,62,124,186,248,310,372,64,128,192,256,320,384, 66,132,198,264,330,396,68,136,204,272,340,408,70,140,210,280,350,420,72,144,216,288,360,432, 74,148,222,296,370,444,76,152,228,304,380,456,78,156,234,312,390,468,80,160,240,320,400,480, 82,164,246,328,410,492,84,168,252,336,420,504,86,172,258,344,430,516,88,176,264,352,440,528, 90,180,270,360,450,540,92,184,276,368,460,552,94,188,282,376,470,564,96,192,288,384,480,576];

        // --- Utility Functions ---
        function formatDate(date) { if (!(date instanceof Date)) { date = new Date(date); } if (isNaN(date.getTime())) { return ""; } const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
        function getPlanData(originalIndex) { const index = parseInt(originalIndex); if (isNaN(index) || index < 0 || index >= initialTotalDays) { /* Check against initial plan days */ return null; } return { surah: surahs[index] || '', linkFrom: linkFromData[index] ?? '', linkTo: linkToData[index] ?? '', reviewFrom: reviewFromData[index] ?? '', reviewTo: reviewToData[index] ?? '', round: calculateRoundNumber(index), fromPage: (index < 299) ? (index * 2 + 1) : (index === 299 ? 601 : ''), toPage: (index < 299) ? (index * 2 + 2) : (index === 299 ? 604 : '') }; }
        function calculateRoundNumber(originalIndex) { if (originalIndex < 32 || reviewFromData[originalIndex] == null || reviewFromData[originalIndex] === '') { return ''; } let reviewDataStartIndex = 32; let reviewCounter = 0; for(let i = reviewDataStartIndex; i <= originalIndex; i++){ if(reviewFromData[i] != null && reviewFromData[i] !== '') reviewCounter++; } if (reviewCounter === 0) return ''; return Math.ceil(reviewCounter / 6); }

        // --- UI Update Functions ---
        function showLoading(message = "جاري التحميل...") { if (loadingIndicator) { loadingIndicator.textContent = message; loadingIndicator.style.display = 'block'; } if (dashboardContent) dashboardContent.style.display = 'none'; if (actionButtonsContainer) actionButtonsContainer.style.display = 'none'; /*if (userProfileArea) userProfileArea.style.display = 'none'; if (loginPrompt) loginPrompt.style.display = 'none';*/ } // Removed profile/login prompt refs
        function hideLoading() { if (loadingIndicator) loadingIndicator.style.display = 'none'; }
        function displayDashboard() { hideLoading(); if (dashboardContent) dashboardContent.style.display = 'block'; if (actionButtonsContainer) actionButtonsContainer.style.display = 'block'; }
        // Removed updateUserInfoUI

        // --- Functions to Update Dashboard Sections ---
        function displayDailyTask() {
            if (!dailyTaskContent) return; // Exit if element doesn't exist
            if (!userPlanData || !userPlanData.startDate) { dailyTaskContent.innerHTML = '<p><i>يرجى <a href="index.html">اختيار خطة وبدءها</a> أولاً.</i></p>'; if (todayDateSpan) todayDateSpan.textContent = formatDate(new Date()); return; }

            const startDate = new Date(userPlanData.startDate + 'T00:00:00Z');
            const today = new Date(); today.setUTCHours(0, 0, 0, 0);
            if (todayDateSpan) todayDateSpan.textContent = formatDate(today);

            if (isNaN(startDate.getTime())) { dailyTaskContent.innerHTML = `<p style="color:red;">خطأ: تاريخ البدء المحفوظ (${userPlanData.startDate}) غير صالح.</p>`; return; }
            if (today < startDate) { dailyTaskContent.innerHTML = `<p>لم تبدأ خطتك بعد. تاريخ البدء: ${formatDate(startDate)}</p>`; return; }

            // Calculate effective days passed, accounting for excuses
            let effectiveDaysPassed = 0;
            let currentDate = new Date(startDate);
            const excuseDatesSet = new Set(userPlanData.excuseDates || []); // Assume excuseDates is an array of "YYYY-MM-DD" strings

            while(currentDate <= today) {
                 if (!excuseDatesSet.has(formatDate(currentDate))) {
                      effectiveDaysPassed++;
                 }
                 currentDate.setUTCDate(currentDate.getUTCDate() + 1); // Move to next day
                  // Safety break to prevent infinite loops
                  if (effectiveDaysPassed > initialTotalDays + 50) { // Allow some buffer
                       console.error("Loop exceeded expected plan length, breaking.");
                       break;
                  }
            }

            const currentDayIndex = effectiveDaysPassed - 1; // -1 because day 1 corresponds to index 0

            console.log("Calculated currentDayIndex:", currentDayIndex); // Debug

            if (currentDayIndex < 0 || currentDayIndex >= initialTotalDays) { dailyTaskContent.innerHTML = `<p>لا يوجد واجب محدد لهذا اليوم (قد تكون خطتك انتهت أو لم تبدأ بعد).</p>`; return; }

            const taskData = getPlanData(currentDayIndex);

            if (taskData) {
                 let taskHTML = `<p><strong>الحفظ الجديد:</strong> ${taskData.fromPage ? `صفحة ${taskData.fromPage} - ${taskData.toPage}` : 'لا يوجد'} (${taskData.surah || 'مراجعة'})</p>`;
                 taskHTML += `<p><strong>الربط:</strong> ${taskData.linkFrom ? `من ${taskData.linkFrom} إلى ${taskData.linkTo}` : 'لا يوجد'}</p>`;
                 taskHTML += `<p><strong>المراجعة:</strong> ${taskData.reviewFrom ? `من ${taskData.reviewFrom} إلى ${taskData.reviewTo}` : 'لا يوجد'} ${taskData.round ? `(الجولة ${taskData.round})` : ''}</p>`;
                 // TODO: Get completion status for this specific day from saved full state later
                 taskHTML += `<p><a href="plangen2.html#row-${currentDayIndex}" class="plan-link">الانتقال لهذا اليوم في الجدول التفصيلي &raquo;</a></p>`; // Link to specific row (optional)
                 dailyTaskContent.innerHTML = taskHTML;
            } else { dailyTaskContent.innerHTML = `<p>لم يتم العثور على تفاصيل واجب لهذا اليوم (الفهرس: ${currentDayIndex}).</p>`; }
        }

        function displayProgress() {
             // Requires loading full state (tableRows array) to calculate accurately
             const planType = userPlanData?.planType || 2;
             let savedPages = 0; // Placeholder
              if (userPlanData && Array.isArray(userPlanData.tableRows)) {
                   // Find the highest 'toPage' from completed 'plan' type rows
                   userPlanData.tableRows.forEach(row => {
                        if(row.type === 'plan' && row.state?.completed) {
                             const staticData = getPlanData(row.originalSequence);
                             if (staticData && staticData.toPage > savedPages) {
                                  savedPages = staticData.toPage;
                             }
                        }
                   });
              }
              savedPages = Math.min(savedPages, totalQuranPages);
             const progressPercent = totalQuranPages > 0 ? ((savedPages / totalQuranPages) * 100).toFixed(0) : 0; // Use integer percentage

             if(currentPlanNameSpan) currentPlanNameSpan.textContent = `خطة ${planType} صفحات`;
             if(progressBarValue) {
                  progressBarValue.style.width = `${progressPercent}%`;
                  progressBarValue.textContent = `${progressPercent}%`;
             }
             if(completedPagesProgressSpan) completedPagesProgressSpan.textContent = savedPages;
        }

        function displayStats() {
            const excuseCount = Array.isArray(userPlanData?.excuseDates) ? userPlanData.excuseDates.length : 0;
             let perfected = 0; // Placeholder - requires full state
             let linked = 0;    // Placeholder - requires full state
             let memorized = 0; // Placeholder - requires full state

              // Recalculate based on full state if available
              if (userPlanData && Array.isArray(userPlanData.tableRows)) {
                  userPlanData.tableRows.forEach(row => {
                       if (row.type === 'plan' && row.state) {
                            const planStaticData = getPlanData(row.originalSequence);
                            if (!planStaticData) return;
                            if(row.state.completed && planStaticData.toPage > memorized) memorized = planStaticData.toPage;
                            if(row.state.linked && planStaticData.linkTo > linked) linked = planStaticData.linkTo;
                            if(row.state.reviewed && planStaticData.reviewTo > perfected) perfected = planStaticData.reviewTo;
                       }
                  });
                  memorized = Math.min(memorized, totalQuranPages);
                  linked = Math.min(linked, totalQuranPages);
                  perfected = Math.min(perfected, totalQuranPages);
              }

            if(statMemorized) statMemorized.textContent = memorized;
            if(statPerfected) statPerfected.textContent = perfected;
            if(statLinked) statLinked.textContent = linked;
            if(statExcuses) statExcuses.textContent = excuseCount;
        }

        // --- Main Data Loading Function ---
        function loadDashboardData(user) {
            if (!user) return;
            const uid = user.uid;
            const planRef = db.collection("quranPlans").doc(uid);
            console.log("Dashboard: Checking Firestore for plan:", uid);
            showLoading("جاري تحميل بيانات خطتك...");

            planRef.get().then((doc) => {
                hideLoading();
                if (doc.exists) {
                    console.log("Dashboard: Plan data found.");
                    userPlanData = doc.data(); // Store fetched data

                    // Ensure excuseDates is an array if it exists, or create it
                    if (!Array.isArray(userPlanData.excuseDates)) {
                         userPlanData.excuseDates = [];
                    }

                    // Check for essential data
                    if (!userPlanData.startDate || !userPlanData.planType) {
                        console.warn("Loaded data missing startDate or planType.");
                         dashboardContent.style.display = 'block';
                         actionButtonsContainer.style.display = 'block'; // Show actions even with error
                         dailyTaskContent.innerHTML = '<p style="color:red; font-weight:bold;">خطأ: بيانات خطتك المحفوظة غير مكتملة (تاريخ البدء أو نوع الخطة مفقود). يرجى <a href="#" id="reset-link-error">إنشاء خطة جديدة</a>.</p>';
                         document.getElementById('reset-link-error')?.addEventListener('click', (e)=>{e.preventDefault(); handleNewPlanClick();});
                         // Hide sections requiring data
                          document.getElementById('plan-progress').style.display = 'none';
                          document.getElementById('quick-stats').style.display = 'none';
                          attachNewPlanListener(); // Allow deleting corrupted plan
                         return;
                    }

                    displayDailyTask();
                    displayProgress();
                    displayStats();
                    displayDashboard();
                    attachNewPlanListener();

                } else {
                    console.log("Dashboard: No plan data found for logged-in user.");
                    displayDashboard(); // Show dashboard container
                    dailyTaskContent.innerHTML = '<p style="color:orange; font-weight:bold;">لم تقم باختيار أو إنشاء خطة بعد!</p><p>اذهب إلى <a href="index.html">صفحة البداية</a> لاختيار خطتك.</p>';
                     document.getElementById('plan-progress').style.display = 'none';
                     document.getElementById('quick-stats').style.display = 'none';
                     document.getElementById('calendar-view').style.display = 'none';
                     document.getElementById('competition-section').style.display = 'none';
                     document.getElementById('badges-section').style.display = 'none';
                     if (actionButtonsContainer) actionButtonsContainer.style.display = 'none'; // Hide actions if no plan
                }
            }).catch((error) => {
                console.error("Error getting plan document:", error);
                hideLoading();
                displayDashboard(); // Show dashboard container even on error
                dailyTaskContent.innerHTML = '<p style="color:red; font-weight:bold;">حدث خطأ أثناء تحميل بيانات الخطة. يرجى المحاولة مرة أخرى أو التأكد من اتصالك بالإنترنت وقواعد الأمان في Firestore.</p><p><a href="index.html">العودة للرئيسية</a></p>';
                document.getElementById('plan-progress').style.display = 'none';
                document.getElementById('quick-stats').style.display = 'none';
                 if (actionButtonsContainer) actionButtonsContainer.style.display = 'none';
            });
        }

         // --- Function to delete plan data from Firestore ---
         async function deletePlanData() { /* ... (Same as before) ... */ if (!currentUser) { alert("يرجى تسجيل الدخول أولاً."); return; } const uid = currentUser.uid; const planRef = db.collection("quranPlans").doc(uid); try { await planRef.delete(); console.log("Plan data deleted for user:", uid); userPlanData = null; alert("تم حذف خطتك الحالية بنجاح. سيتم توجيهك لاختيار خطة جديدة."); window.location.href = 'index.html'; } catch (error) { console.error("Error deleting plan data:", error); alert("حدث خطأ أثناء حذف الجدول القديم."); } }
         function attachNewPlanListener() { /* ... (Same as before) ... */ if (newPlanBtn) { newPlanBtn.removeEventListener('click', handleNewPlanClick); newPlanBtn.addEventListener('click', handleNewPlanClick); } }
         function handleNewPlanClick() { /* ... (Same as before) ... */ if (confirm("هل أنت متأكد أنك تريد حذف الجدول الحالي وإنشاء جدول جديد؟ لن تتمكن من استعادة الجدول القديم.")) { deletePlanData(); } }

        // --- Authentication Listener ---
        auth.onAuthStateChanged(user => {
          hideLoading();
          currentUser = user;
          if (user) { console.log("Dashboard: Auth state OK. Loading data..."); loadDashboardData(user); }
          else { console.log("Dashboard: Not logged in. Redirecting..."); window.location.replace('index.html'); }
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => { showLoading("جاري التحقق من تسجيل الدخول..."); });

         // --- Print Function ---
         function printData() { console.log("Initiating browser print..."); window.print(); }

    </script>

</body>
</html>