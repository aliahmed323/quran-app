<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© - Ø®Ø·Ø© Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù†</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/vanilla-js-calendar@1.9.7/build/vanilla-js-calendar.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vanilla-js-calendar@1.9.7/build/vanilla-js-calendar.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

    <style>
        /* --- CSS Styles (ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ - ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£Ø®Ø¶Ø± Ù„Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; background-color: #f4f7f6; color: #333; line-height: 1.7; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        h1, h2, h3, h4 { color: #1a5276; margin-bottom: 0.75em; }
        p { margin-bottom: 1em; color: #555; font-size: 0.95em; }
        a { text-decoration: none; color: #2980b9; }
        .card { background-color: #fff; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 3px 6px rgba(0,0,0,0.05); border: 1px solid #e0e0e0; }

        /* --- Header --- */
        .dashboard-header { display: flex; justify-content: center; align-items: center; padding: 10px 20px; margin-bottom: 25px; border-bottom: 2px solid #aed6f1; background-color: #fff; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .dashboard-header .logo h1 { margin: 0; font-size: 1.8em; color: #1a5276; }

        /* --- Dashboard Layout --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: auto; gap: 25px; }
        #daily-task { grid-column: span 2; }
        /* --- Start: New Layout for Streak/Level --- */
        #plan-progress { grid-column: 1 / 2; grid-row: 2 / 3; }
        #quick-stats { grid-column: 1 / 2; grid-row: 3 / 4; }
        #streak-level { grid-column: 2 / 4; grid-row: 2 / 3; } /* Span 2 cols */
        #calendar-view { grid-column: 2 / 4; grid-row: 3 / 4; } /* Span 2 cols */
        /* #competition-section { grid-column: ?; grid-row: ?; } /* Adjust if needed */
        /* #badges-section { grid-column: span 3; grid-row: 4 / 5; } /* Adjust if needed */
        /* --- End: New Layout --- */

        /* --- Section Specific Styles --- */
        #daily-task h3 { color: #1e8449; font-size: 1.3em; border-bottom: 2px solid #aed6f1; padding-bottom: 8px;}
        #daily-task-content { min-height: 80px; padding-top: 10px;} /* Adjusted height */
        #daily-task-content p { margin-bottom: 0.6em; font-size: 1.05em; line-height: 1.8; }
        #daily-task-content strong { color: #1a5276; margin-left: 8px;}
        #daily-task .plan-link { margin-top: 15px; display: inline-block; font-size: 0.9em; background-color: #5dade2; color: white; padding: 5px 10px; border-radius: 4px; }
        #daily-task .plan-link:hover { background-color: #3498db; }

        #plan-progress h3, #quick-stats h3, #calendar-view h3, #competition-section h3, #badges-section h3, #streak-level h3 { font-size: 1.15em; }
        #plan-progress .progress-bar-container { background-color: #e9ecef; border-radius: 0.25rem; height: 25px; overflow: hidden; margin-top: 10px; border: 1px solid #ccc; }
        #plan-progress .progress-bar-value { background-color: #28a745; height: 100%; width: 0%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.9em; font-weight: bold; transition: width 0.6s ease-in-out; }
        #quick-stats ul { list-style: none; padding: 0; margin-top: 15px;}
        #quick-stats ul li { margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px dotted #eee; font-size: 0.95em;}
        #quick-stats ul li strong { margin-left: 5px; color: #1a5276; min-width: 110px; display: inline-block;}
        #quick-stats ul li span { color: #1e8449; font-weight: bold;}

        /* --- Streak & Level Styles --- */
        #streak-level .streak-info { display: flex; justify-content: space-around; text-align: center; margin: 15px 0; }
        #streak-level .streak-info div { background-color: #eaf2f8; padding: 10px 15px; border-radius: 6px; border: 1px solid #d4e6f1; }
        #streak-level .streak-info strong { display: block; font-size: 1.5em; color: #1e8449; }
        #streak-level .level-title-container { text-align: center; margin-top: 15px; }
        #streak-level #level-title { font-size: 1.2em; color: #2c3e50; font-weight: bold; }
        #streak-level #level-icon { font-size: 1.5em; margin-left: 10px; } /* Placeholder for icon */

        /* --- Calendar Styles --- */
        #calendar-view { min-height: 280px; } /* Ensure card is tall enough */
        #calendar-container { margin-top: 15px; direction: ltr; /* Calendar library might expect LTR */ }
        .vcal-header { background-color: #aed6f1 !important; } /* Customize header */
        .vcal-date--today { background-color: #aed6f1 !important; /* Blueish for today */ color: #1a5276 !important; border-radius: 50%; border: 1px solid #1a5276; }
        .day-completed .vcal-date__day { background-color: #abebc6; /* Light green */ color: #186a3b; border-radius: 50%; }
        .day-excused .vcal-date__day { background-color: #fadbd8; /* Light red */ color: #922b21; border-radius: 50%; }
        /* Ensure text stays visible on colored backgrounds */
        .vcal-date__day { color: #333; }
        .vcal-day__btn:hover .vcal-date__day { background-color: #e0e0e0; } /* Default hover */
        .day-completed:hover .vcal-date__day { background-color: #82e0aa; } /* Hover for completed */
        .day-excused:hover .vcal-date__day { background-color: #f5b7b1; } /* Hover for excused */
         /* Adjust font size if needed */
        .vcal-body, .vcal-header__label, .vcal-week span { font-size: 0.9em; }
        .vcal-date { height: 35px; /* Adjust height */ }
        .vcal-date__day { line-height: 35px; /* Center text vertically */ }

        /* Placeholder Styles */
        .placeholder-box { min-height: 150px; background-color: #f0f4f8; border: 1px dashed #ccc; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #777; border-radius: 5px; padding: 15px; text-align: center; }
        .placeholder-box .icon { font-size: 3em; margin-bottom: 10px; opacity: 0.5; }
        .placeholder-box .text { font-style: italic; font-size: 0.9em; }

        /* Footer */
        .main-footer { text-align: center; padding: 20px; margin-top: 40px; background-color: #2c3e50; color: #ecf0f1; font-size: 0.9em; }
        .main-footer a { color: #3498db; }

        /* Action Buttons Hidden */
        .action-buttons { display: none; }

        /* Loading Indicator */
        #loading-indicator { text-align: center; padding: 50px; font-size: 1.3em; color: #1a5276; display: block; }

        /* Responsive Adjustments */
        @media (max-width: 992px) {
             .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
             #daily-task { grid-column: span 2; }
             #plan-progress, #quick-stats { grid-column: span 1; grid-row: auto; } /* Reset grid position */
             #streak-level, #calendar-view { grid-column: span 1; grid-row: auto; } /* Reset grid position */
             /* #badges-section { grid-column: span 2; } */ /* Adjust if needed */
        }
        @media (max-width: 768px) { /* Further adjust for smaller screens */
             #streak-level .streak-info { flex-direction: column; gap: 10px; }
             #streak-level .streak-info div { width: 80%; margin: 0 auto; }
        }
        @media (max-width: 600px) {
             .dashboard-header .logo h1 { font-size: 1.5em;}
             .dashboard-grid { grid-template-columns: 1fr; }
             #daily-task, #plan-progress, #quick-stats, #calendar-view, #streak-level, #competition-section, #badges-section { grid-column: span 1; } /* All span 1 */
             .card { padding: 15px; }
             h2 { font-size: 1.4em; }
             h3 { font-size: 1.1em; }
        }
    </style>
</head>
<body>

    <div class="container">

        <header class="dashboard-header">
            <div class="logo"><h1>Ø®Ø·Ø© Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</h1></div>
        </header>

        <div id="loading-indicator">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

        <main id="dashboard-content" style="display: none;">

            <div class="dashboard-grid">

                <section id="daily-task" class="card">
                    <h3>ğŸŒŸ ÙˆØ§Ø¬Ø¨ Ø§Ù„ÙŠÙˆÙ… (<span id="today-date-display">...</span>)</h3>
                    <div id="daily-task-content">
                        <p><i>ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ§Ø¬Ø¨...</i></p>
                    </div>
                    <a href="plangen2.html" class="plan-link">Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªÙØµÙŠÙ„ÙŠ &raquo;</a>
                </section>

                <section id="plan-progress" class="card">
                    <h3>Ø§Ù„Ø®Ø·Ø© ÙˆØ§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¹Ø§Ù…</h3>
                    <p><strong>Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù†Ø´Ø·Ø©:</strong> <span id="current-plan-name">-</span></p>
                    <p><strong>Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„ÙƒÙ„ÙŠ:</strong></p>
                    <div class="progress-bar-container">
                        <div id="progress-bar-value" style="width: 0%; background-color: #28a745;">0%</div>
                    </div>
                    <p style="font-size: 0.9em; text-align: center; margin-top: 5px;">
                        <span id="completed-pages-progress">0</span> / 604 ØµÙØ­Ø©
                    </p>
                </section>

                <section id="quick-stats" class="card">
                    <h3>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©</h3>
                    <ul>
                         <li><strong>Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:</strong> <span id="stat-memorized">0</span></li>
                         <li><strong>Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…ØªÙ‚Ù†Ø©:</strong> <span id="stat-perfected">0</span></li>
                         <li><strong>Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø©:</strong> <span id="stat-linked">0</span></li>
                         <li><strong>Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø¹Ø°Ø§Ø±:</strong> <span id="stat-excuses">0</span></li>
                    </ul>
                </section>

                <section id="streak-level" class="card">
                     <h3>ğŸ… Ù‡Ù…Ø© Ù†Ø­Ùˆ Ø§Ù„Ù‚Ù…Ø©: Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…ØªØªØ§Ù„ÙŠ</h3>
                     <div class="streak-info">
                         <div>Ø£ÙŠØ§Ù… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø­Ø§Ù„ÙŠØ©<strong id="current-streak">0</strong></div>
                         <div>Ø£Ø·ÙˆÙ„ Ø³Ù„Ø³Ù„Ø© Ø£ÙŠØ§Ù…<strong id="longest-streak">0</strong></div>
                     </div>
                     <div class="level-title-container">
                         <h4>Ù„Ù‚Ø¨Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="level-title">Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ!</span> <span id="level-icon"></span></h4>
                     </div>
                </section>
                <section id="calendar-view" class="card">
                    <h3>Ø§Ù„ØªÙ‚ÙˆÙŠÙ… ÙˆØ§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø±Ø¦ÙŠ</h3>
                    <div id="calendar-container">
                        <p class="text" style="text-align: center; margin-top: 20px;">(Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…...)</p>
                    </div>
                </section>

                <section id="competition-section" class="card" style="display: none;"> <h3>Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©</h3>
                     <div class="placeholder-box">
                         <div class="icon">ğŸ†</div>
                         <div class="text">(Ù‚Ø±ÙŠØ¨Ø§Ù‹: Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©)</div>
                     </div>
                </section>
                <section id="badges-section" class="card" style="display: none;"> <h3>Ø§Ù„Ø£ÙˆØ³Ù…Ø©</h3>
                     <div class="placeholder-box">
                          <div class="icon">ğŸ…</div>
                          <div class="text">(Ù‚Ø±ÙŠØ¨Ø§Ù‹: Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆØ³Ù…Ø© ÙˆØ§Ù„Ø­ÙˆØ§ÙØ²)</div>
                     </div>
                </section>

            </div>
        </main>

        <footer class="main-footer">
             <p>&copy; 2025 Ø®Ø·Ø© Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
        </footer>

    </div>

   

    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDuUebu7Qzz3JnTfa-58EIPZjOcrkmdGHU", // WARNING: Exposing API keys client-side is risky. Consider security rules.
            authDomain: "quranplan2.firebaseapp.com",
            projectId: "quranplan2",
            storageBucket: "quranplan2.appspot.com",
            messagingSenderId: "1098692856811",
            appId: "1:1098692856811:web:923bca3a54fd78b1b267ae"
        };

        // --- Initialize Firebase ---
         try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Firebase initialization error:", e); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM References ---
        const loadingIndicator = document.getElementById('loading-indicator');
        const dashboardContent = document.getElementById('dashboard-content');
        const dailyTaskContent = document.getElementById('daily-task-content');
        const currentPlanNameSpan = document.getElementById('current-plan-name');
        const progressBarValue = document.getElementById('progress-bar-value');
        const completedPagesProgressSpan = document.getElementById('completed-pages-progress');
        const statMemorized = document.getElementById('stat-memorized');
        const statPerfected = document.getElementById('stat-perfected');
        const statLinked = document.getElementById('stat-linked');
        const statExcuses = document.getElementById('stat-excuses');
        const todayDateSpan = document.getElementById('today-date-display');
        // --- New DOM Refs ---
        const calendarContainer = document.getElementById('calendar-container');
        const currentStreakSpan = document.getElementById('current-streak');
        const longestStreakSpan = document.getElementById('longest-streak');
        const levelTitleSpan = document.getElementById('level-title');
        const levelIconSpan = document.getElementById('level-icon');

        // --- Constants ---
        const totalQuranPages = 604;
        const initialTotalRows = 320;

        // --- Global State ---
        let currentUser = null;
        let currentPlanData = null; // Stores the FULL plan data
        let calendarInstance = null; // To hold the calendar object

        // --- Data Arrays & Helper Functions (Keep as is) ---
        const surahs = ['Ø§Ù„ÙØ§ØªØ­Ø© ÙˆØ§Ù„Ø¨Ù‚Ø±Ø©', /* ... rest of surahs ... */ 'Ø®ØªÙ… Ø§Ù„Ù‚Ø±Ø¢Ù†'];
        const linkFromData = ['', '', 1, /* ... rest of data ... */ 577];
        const linkToData = ['', '', 2, /* ... rest of data ... */ 604];
        const reviewFromData = [...Array(32).fill(''), 1, /* ... rest of data ... */ 481];
        const reviewToData = [...Array(32).fill(''), 2, /* ... rest of data ... */ 576];

        function formatDate(date) { /* ... function remains the same ... */ if (!(date instanceof Date)) date = new Date(date); if (isNaN(date.getTime())) return ""; const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
        function getPlanData(originalIndex) { /* ... function remains the same ... */ const index = parseInt(originalIndex); if (isNaN(index) || index < 0 || index >= initialTotalRows) { return null; } let fromPage = '', toPage = ''; if (index < 299) { fromPage = index * 2 + 1; toPage = fromPage + 1; } else if (index === 299) { fromPage = 601; toPage = 604; } return { fromPage: fromPage, toPage: toPage, surah: surahs[index] || '', linkFrom: linkFromData[index] ?? '', linkTo: linkToData[index] ?? '', reviewFrom: reviewFromData[index] ?? '', reviewTo: reviewToData[index] ?? '', round: calculateRoundNumber(index) }; }
        function calculateRoundNumber(originalIndex) { /* ... function remains the same ... */ if (originalIndex < 32 || !reviewFromData || reviewFromData[originalIndex] == null || reviewFromData[originalIndex] === '') { return ''; } let reviewDataStartIndex = 32; let reviewCounter = 0; for(let i = reviewDataStartIndex; i <= originalIndex; i++){ if(reviewFromData[i] != null && reviewFromData[i] !== '') reviewCounter++; } if (reviewCounter === 0) return ''; return Math.ceil(reviewCounter / 6); }


        // --- UI Update Functions ---
        function showLoading(message = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...") { if(loadingIndicator){ loadingIndicator.textContent = message; loadingIndicator.style.display = 'block';} if(dashboardContent) dashboardContent.style.display = 'none'; }
        function hideLoading() { if(loadingIndicator) loadingIndicator.style.display = 'none'; }
        function displayDashboard() { hideLoading(); if(dashboardContent) dashboardContent.style.display = 'block'; }

        // --- Functions to Calculate Stats from tableRows (Keep as is) ---
        function calculateDashboardStats(tableRows) { /* ... function remains the same ... */
            let lastCompletedPage = 0; let linkedTasks = 0; let perfectedTasks = 0; let excuseCount = 0;
            if (!tableRows) return { memorizedPages: 0, linkedTasks: 0, perfectedTasks: 0, excuseCount: 0 };
            tableRows.forEach(row => {
                if (row.type === 'excuse') { excuseCount++; }
                else if (row.type === 'plan' && row.state && row.state.completed) {
                    const planInfo = getPlanData(row.originalSequence);
                    if (planInfo && planInfo.toPage) { const pageNum = parseInt(planInfo.toPage); if (!isNaN(pageNum)) { lastCompletedPage = Math.max(lastCompletedPage, pageNum); } }
                    if (planInfo && planInfo.linkTo !== '' && row.state.linked) { linkedTasks++; }
                    if (planInfo && planInfo.reviewTo !== '' && row.state.reviewed) { perfectedTasks++; }
                }
            });
            const memorizedPages = Math.min(lastCompletedPage, totalQuranPages);
            return { memorizedPages: memorizedPages, linkedTasks: linkedTasks, perfectedTasks: perfectedTasks, excuseCount: excuseCount };
        }

        // --- START: New Functions for Streak, Level, and Calendar ---

        // Level Titles (Customize these!)
        const levelTitles = [
             "Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ!", // Level 0 (0-9 days)
             "ğŸŒ± ØºØ±Ø³Ø© Ø§Ù„Ø¥ÙŠÙ…Ø§Ù†", // Level 1 (10-19 days)
             "âœ¨ Ø¨Ø§Ø¯Ø±Ø© Ø£Ù…Ù„", // Level 2 (20-29 days)
             "ğŸƒ Ø³Ø§Ø¹Ù Ù„Ù„Ø¹Ù„Ø§", // Level 3 (30-39 days)
             "â­ Ù†Ø¬Ù… ØµØ§Ø¹Ø¯", // Level 4 (40-49 days)
             "ğŸ’ª Ù…Ø«Ø§Ø¨Ø± Ù…Ø¬ØªÙ‡Ø¯", // Level 5 (50-59 days)
             "ğŸ§­ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø¨", // Level 6 (60-69 days)
             "ğŸ’¯ ØµØ§Ø­Ø¨ Ø§Ù„Ø³Ø¨Ø¹ÙŠÙ†", // Level 7 (70-79 days)
             "ğŸš€ Ø§Ù†Ø·Ù„Ø§Ù‚Ø© Ù‚ÙˆÙŠØ©", // Level 8 (80-89 days)
             "ğŸ’ Ø¬ÙˆÙ‡Ø±Ø© Ù…ØµÙ‚ÙˆÙ„Ø©", // Level 9 (90-99 days)
             "ğŸ‘‘ ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ø¦Ø© ÙŠÙˆÙ…", // Level 10 (100-109 days) - Add Icon?
             "ğŸ“– Ø±ÙÙŠÙ‚ Ø§Ù„Ù‚Ø±Ø¢Ù†", // Level 11 (110-119 days)
             "ğŸ•¯ï¸ Ù…Ù†Ø§Ø±Ø© Ù‡Ø¯Ù‰", // Level 12 (120-129 days)
             "ğŸ”ï¸ Ù‚Ù…Ø© Ø´Ø§Ù…Ø®Ø©", // Level 13 (130-139 days)
             "ğŸŒ³ Ø´Ø¬Ø±Ø© Ø·ÙŠØ¨Ø©", // Level 14 (140-149 days)
             "â³ Ø¹Ø§Ø¨Ø± Ù…Ù†ØªØµÙ Ø§Ù„Ø·Ø±ÙŠÙ‚", // Level 15 (150-159 days)
             "ğŸ¯ Ø¯Ù‚Ø© ÙˆØ§Ù„ØªØ²Ø§Ù…", // Level 16 (160-169 days)
             "ğŸŒŠ Ø¨Ø­Ø± Ø²Ø§Ø®Ø±", // Level 17 (170-179 days)
             "ğŸŒŸ ÙƒÙˆÙƒØ¨ Ø¯Ø±ÙŠ", // Level 18 (180-189 days)
             "ğŸ§­ Ø¨ÙˆØµÙ„Ø© Ø§Ù„Ø­Ù‚", // Level 19 (190-199 days)
             "ğŸ’¯ğŸ’¯ Ø§Ù„Ù…Ø¦ØªØ§Ù† Ù„Ø§ ØªÙ‚ÙØ§Ù†!", // Level 20 (200-209 days) - Add Icon?
             "ğŸ¤² Ù‚Ù„Ø¨ Ø®Ø§Ø´Ø¹", // Level 21 (210-219 days)
             "ğŸ•Šï¸ Ø±ÙˆØ­ Ù…Ø·Ù…Ø¦Ù†Ø©", // Level 22 (220-229 days)
             "ğŸ’– Ù…Ø­Ø¨ Ù„Ù„Ø±Ø­Ù…Ù†", // Level 23 (230-239 days)
             "ğŸ™ Ø¹Ø¨Ø¯ Ø´ÙƒÙˆØ±", // Level 24 (240-249 days)
             "ğŸ’¡ Ø¨ØµÙŠØ±Ø© Ù†Ø§ÙØ°Ø©", // Level 25 (250-259 days)
             "ğŸ•Œ Ù…Ø¹Ù…Ù‘Ø± Ø¨ÙŠÙˆØª Ø§Ù„Ù„Ù‡", // Level 26 (260-269 days)
             "ğŸŒ™ Ù‡Ù„Ø§Ù„ Ø§Ù„ÙƒÙ…Ø§Ù„", // Level 27 (270-279 days)
             "âœ¨ Ù†ÙˆØ± Ø¹Ù„Ù‰ Ù†ÙˆØ±", // Level 28 (280-289 days)
             "ğŸ Ù‚Ø§Ø¨ Ù‚ÙˆØ³ÙŠÙ† Ø£Ùˆ Ø£Ø¯Ù†Ù‰", // Level 29 (290-299 days)
             "ğŸ† ÙØ§Ø±Ø³ Ø§Ù„Ø«Ù„Ø§Ø«Ù…Ø§Ø¦Ø©", // Level 30 (300-309 days) - Add Icon?
             "ğŸ‰ Ù…Ù‚ØªØ±Ø¨ Ù…Ù† Ø§Ù„Ø®ØªØ§Ù…", // Level 31 (310-319 days)
             "ğŸŠ Ø®Ø§ØªÙ… Ù…Ø¨Ø§Ø±Ùƒ", // Level 32 (320+ days)
        ];

        // Level Icons (Example for levels 10, 20, 30)
        const levelIcons = {
            10: 'ğŸ‘‘',
            20: 'ğŸ’¯',
            30: 'ğŸ†',
            32: 'ğŸŠ'
        };


        function calculateStreaksAndLevel(tableRows) {
            if (!tableRows || tableRows.length === 0) {
                return { currentStreak: 0, longestStreak: 0, currentLevel: 0, currentTitle: levelTitles[0], currentIcon: '' };
            }

            // Sort rows by date just in case they aren't already
            const sortedRows = [...tableRows].sort((a, b) => new Date(a.displayDate) - new Date(b.displayDate));

            let currentStreak = 0;
            let longestStreak = 0;
            let currentRun = 0;
            const todayStr = formatDate(new Date());
            let isStreakActiveToday = false; // Flag to check if the streak includes today

            // Iterate up to today
            for (const row of sortedRows) {
                 // Stop if we go past today's date string
                 if (row.displayDate > todayStr) break;

                 if (row.type === 'plan' && row.state?.completed) {
                     currentRun++;
                      // Check if this completed day is today
                     if(row.displayDate === todayStr) {
                         isStreakActiveToday = true;
                     }
                 } else if (row.type === 'excuse') {
                     // Excuses pause the streak count but don't break the current run *for longest calculation*
                     // However, for the *current* streak ending now, an excuse today means the streak ended yesterday.
                     if (currentRun > longestStreak) {
                         longestStreak = currentRun;
                     }
                     // If excuse is today, the active streak ended yesterday
                     if(row.displayDate === todayStr){
                        isStreakActiveToday = false; // Mark streak as not active *today*
                     }
                     // Don't reset currentRun here, allows streak to continue if next day is completed
                 }
                 else { // Missed day (not completed, not excuse) OR other row type breaks streak
                     if (currentRun > longestStreak) {
                         longestStreak = currentRun;
                     }
                     currentRun = 0; // Reset streak run
                     isStreakActiveToday = false; // Streak broken before today
                 }
            }

             // Final check for the longest streak after the loop
            if (currentRun > longestStreak) {
                longestStreak = currentRun;
            }

             // Determine the CURRENT streak
             // If the streak was active today OR the last recorded day was completed:
             if (isStreakActiveToday || (sortedRows.length > 0 && sortedRows[sortedRows.length-1].type === 'plan' && sortedRows[sortedRows.length-1].state?.completed && sortedRows[sortedRows.length-1].displayDate < todayStr)) {
                 // If the loop ended naturally (processed up to today or last completed day), currentRun holds the current streak.
                 // We need to recalculate the current run from the *end* backwards until a break or excuse.
                 let tempCurrentStreak = 0;
                 for (let i = sortedRows.length - 1; i >= 0; i--) {
                     const row = sortedRows[i];
                     // Only count days up to today
                     if (row.displayDate > todayStr) continue;

                     if (row.type === 'plan' && row.state?.completed) {
                         tempCurrentStreak++;
                     } else if (row.type === 'excuse') {
                         continue; // Skip excuses when counting backwards for current streak
                     } else {
                         break; // Break on missed day or non-plan row
                     }
                 }
                  currentStreak = tempCurrentStreak;

             } else {
                 // If the loop broke due to a missed day or excuse today, the current streak is 0.
                 currentStreak = 0;
             }


            // Calculate Level based on CURRENT streak
            // Level index is floor(streak / 10), capped at the max level index
            const levelIndex = Math.min(Math.floor(currentStreak / 10), levelTitles.length - 1);
            const currentTitle = levelTitles[levelIndex] || levelTitles[0];
            const currentIcon = levelIcons[levelIndex] || ''; // Get icon if defined for this level

             // *** Level Loss Logic (Future Enhancement?) ***
             // The current implementation bases the title purely on the active current streak.
             // Implementing the "lose one level" requires storing the highest level achieved
             // or recalculating the longest streak and comparing.
             // For now, title directly reflects current achievement streak.


            return {
                currentStreak: currentStreak,
                longestStreak: longestStreak,
                currentLevel: levelIndex,
                currentTitle: currentTitle,
                currentIcon: currentIcon
            };
        }


      function initializeCalendar(tableRows) {
            if (!calendarContainer) return;

            // Prepare data for the calendar (highlighted days)
            const daysData = [];
            if (tableRows && Array.isArray(tableRows)) {
                tableRows.forEach(row => {
                    let cssClass = '';
                     // Use optional chaining for safety accessing state
                    if (row.type === 'plan' && row.state?.completed) {
                        cssClass = 'day-completed'; // Green
                    } else if (row.type === 'excuse') {
                        cssClass = 'day-excused'; // Red
                    }

                    if (cssClass) {
                        // Format expected by VanillaCalendar dates.dates array
                        daysData.push({
                            date: row.displayDate, // 'YYYY-MM-DD'
                            // 'modifier' seems to be the correct property name based on common patterns
                            // If this doesn't work, we might need to inspect library specifics again
                            modifier: cssClass
                        });
                    }
                });
            }

            const options = {
                type: 'month',
                // --- Pass highlighted days DIRECTLY in the options ---
                dates: {
                    dates: daysData, // Pass the array here
                },
                settings: {
                    lang: 'ar-DZ', // Arabic locale
                    iso8601: false, // Sunday first
                    range: {
                        // Optional: Limit range if needed
                        // min: currentPlanData?.startDate,
                    },
                    selection: {
                        day: false, // Disable day selection
                    },
                    visibility: {
                        theme: 'light',
                        weekend: false,
                        today: true, // Highlight today (library default + our CSS)
                    }
                    // We no longer need CSSClasses here if dates.dates works
                },
                // Removed actions for simplicity for now
            };

            // Clear placeholder before init
            calendarContainer.innerHTML = '';

            try {
                // Initialize the calendar
                calendarInstance = new VanillaCalendar(calendarContainer, options);
                calendarInstance.init();

                // --- No need for applyDateModifiers anymore ---

                 // Force a redraw/update IF NEEDED (sometimes helps with dynamic class application)
                 // Check library docs if calendarInstance.update() or similar exists
                 // if (calendarInstance && typeof calendarInstance.update === 'function') {
                 //     calendarInstance.update({ dates: { dates: daysData } });
                 // }


            } catch (error) {
                console.error("Error initializing calendar:", error);
                calendarContainer.innerHTML = `<p class="text" style="color:red; text-align:center; margin-top: 20px;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…. (${error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø­Ø¯Ø¯'})</p>`;
            }
        }

        // --- Remove the old applyDateModifiers function entirely ---
        // function applyDateModifiers(daysToHighlight) { /* ... REMOVE THIS ... */ } }

         // Helper to apply modifiers/classes if not directly supported in options
        function applyDateModifiers(daysToHighlight) {
             if (!calendarInstance || !daysToHighlight) return;

             daysToHighlight.forEach(highlight => {
                  const dateElement = calendarContainer.querySelector(`[data-calendar-date="${highlight.date}"]`);
                  if (dateElement) {
                     // The element might be the button or a child div, inspect generated HTML
                     // Often it's the parent button `vcal-day__btn`
                     const dayButton = dateElement.closest('.vcal-day__btn');
                     if(dayButton){
                        dayButton.classList.add(highlight.modifier);
                     } else {
                         // Fallback if structure differs
                         dateElement.classList.add(highlight.modifier);
                     }
                  } else {
                      // console.warn(`Calendar date element not found for ${highlight.date}`);
                  }
             });
        }

        // --- END: New Functions ---


        // --- MODIFIED Functions to Update Dashboard Sections ---
        function displayDailyTask() {
            if (!dailyTaskContent || !currentPlanData || !currentPlanData.tableRows) {
                if(dailyTaskContent) dailyTaskContent.innerHTML = '<p><i>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø·Ø©...</i></p>';
                if (todayDateSpan) todayDateSpan.textContent = formatDate(new Date());
                return;
            }

            const tableRows = currentPlanData.tableRows;
            const today = new Date();
            const todayStr = formatDate(today);

            if (todayDateSpan) todayDateSpan.textContent = todayStr; // Display current date

            // Find the row corresponding to today's actual date
            const todayRow = tableRows.find(row => row.displayDate === todayStr);

             if (!todayRow) {
                  dailyTaskContent.innerHTML = '<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØ§Ø¬Ø¨ Ù…Ù‚Ø±Ø± ÙÙŠ Ø§Ù„Ø®Ø·Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….</p>';
             } else if (todayRow.type === 'excuse') {
                  dailyTaskContent.innerHTML = `<p style="color: orange; font-weight:bold;">Ù„Ø¯ÙŠÙƒ Ø¹Ø°Ø± Ù…Ø³Ø¬Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… (${todayRow.excuseType || ''}).</p>`;
             } else if (todayRow.type === 'plan' && todayRow.state?.completed) { // Use optional chaining
                  dailyTaskContent.innerHTML = '<p style="color: green; font-weight: bold;">âœ… Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡ØŒ Ù„Ù‚Ø¯ Ø£ØªÙ…Ù…Øª ÙˆØ§Ø¬Ø¨ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…!</p>';
             } else if (todayRow.type === 'plan' && todayRow.state && !todayRow.state.completed) {
                 const taskDetails = getPlanData(todayRow.originalSequence);
                 if (taskDetails) {
                     let taskHTML = `<h4>Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¥Ù†Ø¬Ø§Ø²Ù‡ Ø§Ù„ÙŠÙˆÙ… (${todayStr}):</h4>`;
                     taskHTML += `<p><strong>Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙŠØ¯:</strong> ${taskDetails.fromPage ? `Øµ ${taskDetails.fromPage} - ${taskDetails.toPage}` : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'} (${taskDetails.surah || 'Ù…Ø±Ø§Ø¬Ø¹Ø©'})</p>`;
                     taskHTML += `<p><strong>Ø§Ù„Ø±Ø¨Ø·:</strong> ${taskDetails.linkFrom ? `Ù…Ù† ${taskDetails.linkFrom} Ø¥Ù„Ù‰ ${taskDetails.linkTo}` : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>`;
                     taskHTML += `<p><strong>Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©:</strong> ${taskDetails.reviewFrom ? `Ù…Ù† ${taskDetails.reviewFrom} Ø¥Ù„Ù‰ ${taskDetails.reviewTo}` : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'} ${taskDetails.round ? `(Ø¬${taskDetails.round})` : ''}</p>`;
                     dailyTaskContent.innerHTML = taskHTML;
                 } else {
                     dailyTaskContent.innerHTML = `<p><i>Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ø¨ Ù„Ù„ÙÙ‡Ø±Ø³ ${todayRow.originalSequence}.</i></p>`;
                 }
             } else {
                  // Fallback for unexpected row state or missing state
                 dailyTaskContent.innerHTML = '<p><i>ÙˆØ§Ø¬Ø¨ Ø§Ù„ÙŠÙˆÙ… Ù„Ù… ÙŠÙƒØªÙ…Ù„ Ø¨Ø¹Ø¯ Ø£Ùˆ Ø­Ø§Ù„ØªÙ‡ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©.</i></p>';
             }
        }


        function displayProgress(stats) {
            if (!currentPlanData) return;
            const planType = currentPlanData.planType || '?';
            const memorizedPages = stats.memorizedPages;
            const progressPercent = totalQuranPages > 0 ? Math.min(100, (memorizedPages / totalQuranPages) * 100).toFixed(0) : 0;

            if(currentPlanNameSpan) currentPlanNameSpan.textContent = `Ø®Ø·Ø© ${planType} ØµÙØ­Ø§Øª`;
            if(progressBarValue) {
                progressBarValue.style.width = `${progressPercent}%`;
                progressBarValue.style.backgroundColor = '#28a745';
                progressBarValue.textContent = `${progressPercent}%`;
            }
            if(completedPagesProgressSpan) completedPagesProgressSpan.textContent = memorizedPages;
        }

        function displayStats(stats) {
             if(statMemorized) statMemorized.textContent = stats.memorizedPages;
             if(statPerfected) statPerfected.textContent = stats.perfectedTasks;
             if(statLinked) statLinked.textContent = stats.linkedTasks;
             if(statExcuses) statExcuses.textContent = stats.excuseCount;
        }

         // --- New function to display Streak and Level ---
         function displayStreakAndLevel(streakData) {
             if(currentStreakSpan) currentStreakSpan.textContent = streakData.currentStreak;
             if(longestStreakSpan) longestStreakSpan.textContent = streakData.longestStreak;
             if(levelTitleSpan) levelTitleSpan.textContent = streakData.currentTitle;
             if(levelIconSpan) levelIconSpan.textContent = streakData.currentIcon; // Display icon if available
         }


        // --- Main Data Loading Function (MODIFIED) ---
        function loadDashboardData(user) {
            if (!user) return;
            const uid = user.uid;
            const planRef = db.collection("quranPlans").doc(uid);
            console.log("Dashboard: Checking Firestore for plan:", uid);
            showLoading("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø·ØªÙƒ...");

            planRef.get().then((doc) => {
                hideLoading();
                if (doc.exists) {
                    console.log("Dashboard: Plan data found.");
                    currentPlanData = doc.data(); // Store FULL data globally

                    // Validate FULL data needed for dashboard
                    if (!currentPlanData.startDate || !currentPlanData.planType || !currentPlanData.tableRows || !Array.isArray(currentPlanData.tableRows) || !currentPlanData.repetitionMax) {
                         console.error("Loaded data missing required fields (startDate, planType, tableRows array, or repetitionMax).", currentPlanData);
                         dashboardContent.style.display = 'block';
                         dailyTaskContent.innerHTML = `<p style="color:red; font-weight:bold;">Ø®Ø·Ø£: Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø·ØªÙƒ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø© Ø£Ùˆ ØªØ§Ù„ÙØ©. ÙŠØ±Ø¬Ù‰ <a href="index.html">Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„ØµÙØ­Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</a> ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø·Ø©.</p>`;
                         document.getElementById('plan-progress').style.display = 'none';
                         document.getElementById('quick-stats').style.display = 'none';
                         return;
                     }

                    // --- Process Data & Update UI ---
                    // 1. Calculate Basic Stats
                    const stats = calculateDashboardStats(currentPlanData.tableRows);

                    // 2. Calculate Streak and Level
                    const streakData = calculateStreaksAndLevel(currentPlanData.tableRows);

                    // 3. Update Display Sections
                    displayDailyTask();
                    displayProgress(stats);
                    displayStats(stats);
                    displayStreakAndLevel(streakData); // Display new streak info

                    // 4. Initialize Calendar
                    initializeCalendar(currentPlanData.tableRows);

                    // 5. Show the fully populated dashboard
                    displayDashboard();

                } else {
                     // No plan found logic
                     console.log("Dashboard: No plan data found.");
                     displayDashboard();
                     dailyTaskContent.innerHTML = '<p style="color:orange; font-weight:bold;">Ù„Ù… ØªÙ‚Ù… Ø¨Ø§Ø®ØªÙŠØ§Ø± Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø© Ø¨Ø¹Ø¯!</p><p>Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ <a href="index.html">ØµÙØ­Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</a> Ù„Ø§Ø®ØªÙŠØ§Ø± Ø®Ø·ØªÙƒ.</p>';
                     document.getElementById('plan-progress').style.display = 'none';
                     document.getElementById('quick-stats').style.display = 'none';
                     // Hide new/other sections as well
                     document.getElementById('calendar-view').style.display = 'none';
                     document.getElementById('streak-level').style.display = 'none'; // Hide streak section
                     document.getElementById('competition-section').style.display = 'none';
                     document.getElementById('badges-section').style.display = 'none';
                 }
            }).catch((error) => {
                 // Error handling
                 console.error("Error getting plan document:", error);
                 hideLoading();
                 displayDashboard();
                 dailyTaskContent.innerHTML = `<p style="color:red; font-weight:bold;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø·Ø©. (${error.code || 'UNKNOWN'})</p><p>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆÙ‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù† ÙÙŠ Firestore. <a href="index.html">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></p>`;
                 document.getElementById('plan-progress').style.display = 'none';
                 document.getElementById('quick-stats').style.display = 'none';
                 document.getElementById('calendar-view').style.display = 'none'; // Hide calendar on error
                 document.getElementById('streak-level').style.display = 'none'; // Hide streak on error
            });
        }

        // --- Authentication Listener ---
        auth.onAuthStateChanged(user => {
           hideLoading();
           currentUser = user;
           if (user) {
               console.log("Dashboard: Auth state OK.");
               loadDashboardData(user);
           } else {
               console.log("Dashboard: Not logged in. Redirecting to index...");
               // window.location.replace('index.html'); // Or login.html
               // --- For testing without redirect ---
                showLoading("ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
                console.warn("User not logged in, dashboard will not load data.");
                // Display a message instead of redirecting immediately for testing
                if(dashboardContent) dashboardContent.style.display = 'block'; // Show main area
                if(dailyTaskContent) dailyTaskContent.innerHTML = '<p style="color:red;">ÙŠØ±Ø¬Ù‰ <a href="index.html">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a> Ù„Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.</p>';
                // Hide sections requiring data
                const sectionsToHide = ['plan-progress', 'quick-stats', 'calendar-view', 'streak-level', 'competition-section', 'badges-section'];
                sectionsToHide.forEach(id => {
                    const section = document.getElementById(id);
                    if (section) section.style.display = 'none';
                });
               // --- End testing block ---
           }
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            showLoading("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...");
            // Authentication listener will handle the rest
        });

         // --- Print Function (Keep as is) ---
         function printData() { console.log("Initiating browser print..."); window.print(); }

    </script>

</body>
</html>