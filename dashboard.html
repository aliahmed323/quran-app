<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ููุญุฉ ุงููุชุงุจุนุฉ - ุฎุทุฉ ุญูุธ ุงููุฑุขู</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/vanilla-js-calendar@1.9.4/build/vanilla-js-calendar.min.css" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

    <style>
        /* --- CSS Styles (ุชุจูู ููุง ูู) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; background-color: #f4f7f6; color: #333; line-height: 1.7; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        h1, h2, h3, h4 { color: #1a5276; margin-bottom: 0.75em; }
        p { margin-bottom: 1em; color: #555; font-size: 0.95em; }
        a { text-decoration: none; color: #2980b9; }
        .card { background-color: #fff; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 3px 6px rgba(0,0,0,0.05); border: 1px solid #e0e0e0; }
        .dashboard-header { display: flex; justify-content: center; align-items: center; padding: 10px 20px; margin-bottom: 25px; border-bottom: 2px solid #aed6f1; background-color: #fff; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .dashboard-header .logo h1 { margin: 0; font-size: 1.8em; color: #1a5276; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: auto; gap: 25px; }
        #daily-task { grid-column: span 2; }
        #plan-progress {} #quick-stats {} #calendar-view {} #competition-section {}
        #badges-section { grid-column: span 3; }
        #daily-task h3 { color: #1e8449; font-size: 1.3em; border-bottom: 2px solid #aed6f1; padding-bottom: 8px;}
        #daily-task-content { min-height: 100px; padding-top: 10px;}
        #daily-task-content p { margin-bottom: 0.6em; font-size: 1.05em; line-height: 1.8; }
        #daily-task-content strong { color: #1a5276; margin-left: 8px;}
        #daily-task .plan-link { margin-top: 15px; display: inline-block; font-size: 0.9em; background-color: #5dade2; color: white; padding: 5px 10px; border-radius: 4px; }
        #daily-task .plan-link:hover { background-color: #3498db; }
        #plan-progress h3, #quick-stats h3, #calendar-view h3, #competition-section h3, #badges-section h3 { font-size: 1.15em; }
        #plan-progress .progress-bar-container { background-color: #e9ecef; border-radius: 0.25rem; height: 25px; overflow: hidden; margin-top: 10px; border: 1px solid #ccc; }
        #plan-progress .progress-bar-value { background-color: #28a745; height: 100%; width: 0%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.9em; font-weight: bold; transition: width 0.6s ease-in-out; }
        #quick-stats ul { list-style: none; padding: 0; margin-top: 15px;}
        #quick-stats ul li { margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px dotted #eee; font-size: 0.95em;}
        #quick-stats ul li strong { margin-left: 5px; color: #1a5276; min-width: 110px; display: inline-block;}
        #quick-stats ul li span { color: #1e8449; font-weight: bold;}
        .placeholder-box { min-height: 150px; background-color: #f0f4f8; border: 1px dashed #ccc; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #777; border-radius: 5px; padding: 15px; text-align: center; }
        .placeholder-box .icon { font-size: 3em; margin-bottom: 10px; opacity: 0.5; }
        .placeholder-box .text { font-style: italic; font-size: 0.9em; }
        .main-footer { text-align: center; padding: 20px; margin-top: 40px; background-color: #2c3e50; color: #ecf0f1; font-size: 0.9em; }
        .main-footer a { color: #3498db; }
        .action-buttons { display: none; }
        #loading-indicator { text-align: center; padding: 50px; font-size: 1.3em; color: #1a5276; display: block; }

        /* >>> ADDED: Calendar Custom Styles <<< */
        #calendar-container { /* Optional: Style the container */ }
        #calendar-container .vanilla-calendar-day__btn {
             border-radius: 4px;
             border: 1px solid transparent;
             color: #333;
             transition: background-color 0.2s, border-color 0.2s;
        }
        #calendar-container .status-completed .vanilla-calendar-day__btn {
             background-color: #d1e7dd !important;
             color: #0f5132 !important;
             border-color: #a3cfbb !important;
             font-weight: bold;
        }
        #calendar-container .status-excuse .vanilla-calendar-day__btn {
             background-color: #f8d7da !important;
             color: #58151c !important;
             border-color: #f1aeae !important;
             text-decoration: line-through;
             font-style: italic;
        }
        #calendar-container .vanilla-calendar-day_today .vanilla-calendar-day__btn {
             border-color: #0d6efd !important;
             background-color: rgba(13, 110, 253, 0.1) !important;
        }
        .calendar-legend { text-align: center; font-size: 0.8em; margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;}
        .calendar-legend span { display: inline-block; width: 12px; height: 12px; margin-left: 4px; margin-right: 8px; vertical-align: middle; border-radius: 3px; border: 1px solid rgba(0,0,0,0.2); }
        .legend-completed { background-color: #d1e7dd; }
        .legend-excuse { background-color: #f8d7da; }
        .legend-today { background-color: rgba(13, 110, 253, 0.1); border: 1px solid #0d6efd;}
        /* --- >>> END: Calendar Custom Styles <<< --- */

        /* Responsive Adjustments */
        @media (max-width: 992px) { .dashboard-grid { grid-template-columns: repeat(2, 1fr); } #daily-task { grid-column: span 2; } #badges-section { grid-column: span 2; } }
        @media (max-width: 600px) { .dashboard-header .logo h1 { font-size: 1.5em;} .dashboard-grid { grid-template-columns: 1fr; } #daily-task, #plan-progress, #quick-stats, #calendar-view, #competition-section, #badges-section { grid-column: span 1; } .card { padding: 15px; } h2 { font-size: 1.4em; } h3 { font-size: 1.1em; } }
    </style>
</head>
<body>

    <div class="container">

        <header class="dashboard-header">
            <div class="logo"><h1>ุฎุทุฉ ุญูุธ ุงููุฑุขู ุงููุฑูู</h1></div>
        </header>

        <div id="loading-indicator">ุฌุงุฑู ุงูุชุญููู...</div>

        <main id="dashboard-content" style="display: none;">

            <div class="dashboard-grid">

                <section id="daily-task" class="card">
                    <h3>๐ ูุงุฌุจ ุงูููู (<span id="today-date-display">...</span>)</h3>
                    <div id="daily-task-content">
                        <p><i>ูุชู ุชุญุฏูุฏ ุงููุงุฌุจ...</i></p>
                    </div>
                    <a href="plangen2.html" class="plan-link">ุงูุฐูุงุจ ุฅูู ุฌุฏูู ุงูุฎุทุฉ ุงูุชูุตููู &raquo;</a>
                </section>

                <section id="plan-progress" class="card">
                    <h3>ุงูุฎุทุฉ ูุงูุชูุฏู ุงูุนุงู</h3>
                    <p><strong>ุงูุฎุทุฉ ุงููุดุทุฉ:</strong> <span id="current-plan-name">-</span></p>
                    <p><strong>ุงูุชูุฏู ุงูููู:</strong></p>
                    <div class="progress-bar-container">
                        <div id="progress-bar-value" style="width: 0%; background-color: #28a745;">0%</div>
                    </div>
                    <p style="font-size: 0.9em; text-align: center; margin-top: 5px;">
                        <span id="completed-pages-progress">0</span> / 604 ุตูุญุฉ
                    </p>
                </section>

                <section id="quick-stats" class="card">
                    <h3>ุฅุญุตุงุฆูุงุช ุณุฑูุนุฉ</h3>
                    <ul>
                        <li><strong>ุงูุตูุญุงุช ุงููุญููุธุฉ:</strong> <span id="stat-memorized">0</span></li>
                        <li><strong>ุงูุตูุญุงุช ุงููุชููุฉ:</strong> <span id="stat-perfected">0</span></li>
                        <li><strong>ุงูุตูุญุงุช ุงููุฑุจูุทุฉ:</strong> <span id="stat-linked">0</span></li>
                        <li><strong>ุฃูุงู ุงูุฃุนุฐุงุฑ:</strong> <span id="stat-excuses">0</span></li>
                    </ul>
                </section>

                 <section id="calendar-view" class="card">
                    <h3>ุงูุชูููู</h3>
                    <div id="calendar-container" style="max-width: 300px; margin: 15px auto 0 auto;">
                         </div>
                    <div class="calendar-legend">
                        <span class="legend-completed"></span> ููุชูู &nbsp;
                        <span class="legend-excuse"></span> ุนุฐุฑ &nbsp;
                        <span class="legend-today"></span> ุงูููู
                    </div>
                </section>
                 <section id="competition-section" class="card">
                     <h3>ุงูููุงูุณุฉ</h3>
                     <div class="placeholder-box">
                         <div class="icon">๐</div>
                         <div class="text">(ูุฑูุจุงู: ููุญุฉ ุงูุตุฏุงุฑุฉ)</div>
                     </div>
                </section>

                 <section id="badges-section" class="card">
                      <h3>ุงูุฃูุณูุฉ</h3>
                       <div class="placeholder-box">
                          <div class="icon">๐</div>
                          <div class="text">(ูุฑูุจุงู: ูุธุงู ุงูุฃูุณูุฉ ูุงูุญูุงูุฒ)</div>
                      </div>
                 </section>

            </div>
        </main>

        <footer class="main-footer">
             <p>&copy; 2025 ุฎุทุฉ ุญูุธ ุงููุฑุขู ุงููุฑูู. ุฌููุน ุงูุญููู ูุญููุธุฉ.</p>
        </footer>

    </div>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/vanilla-js-calendar@1.9.4/build/vanilla-js-calendar.min.js"></script>

    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
         apiKey: "AIzaSyDuUebu7Qzz3JnTfa-58EIPZjOcrkmdGHU",
         authDomain: "quranplan2.firebaseapp.com",
         projectId: "quranplan2",
         storageBucket: "quranplan2.appspot.com",
         messagingSenderId: "1098692856811",
         appId: "1:1098692856811:web:923bca3a54fd78b1b267ae"
        };
         try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Firebase initialization error:", e); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- >>> ADDED: Calendar Global Variable <<< ---
        let calendarInstance = null;

        // --- DOM References (Keep as is) ---
        const loadingIndicator = document.getElementById('loading-indicator');
        const dashboardContent = document.getElementById('dashboard-content');
        const dailyTaskContent = document.getElementById('daily-task-content');
        const currentPlanNameSpan = document.getElementById('current-plan-name');
        const progressBarValue = document.getElementById('progress-bar-value');
        const completedPagesProgressSpan = document.getElementById('completed-pages-progress');
        const statMemorized = document.getElementById('stat-memorized');
        const statPerfected = document.getElementById('stat-perfected');
        const statLinked = document.getElementById('stat-linked');
        const statExcuses = document.getElementById('stat-excuses');
        const todayDateSpan = document.getElementById('today-date-display');

        // --- Constants (Keep as is) ---
        const totalQuranPages = 604;
        const initialTotalRows = 320;

        // --- Global State ---
        let currentUser = null;
        let currentPlanData = null; // Stores the FULL plan data

        // --- Data Arrays & Helper Functions (Keep as is) ---
        const surahs = ['ุงููุงุชุญุฉ ูุงูุจูุฑุฉ', /* ... */ 'ุฎุชู ุงููุฑุขู'];
        const linkFromData = ['', '', 1, /* ... */ 577];
        const linkToData = ['', '', 2, /* ... */ 604];
        const reviewFromData = [...Array(32).fill(''), 1, /* ... */ 481];
        const reviewToData = [...Array(32).fill(''), 2, /* ... */ 576];
        function formatDate(date) { if (!(date instanceof Date)) date = new Date(date); if (isNaN(date.getTime())) return ""; const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
        function getPlanData(originalIndex) { const index = parseInt(originalIndex); if (isNaN(index) || index < 0 || index >= initialTotalRows) { return null; } let fromPage = '', toPage = ''; if (index < 299) { fromPage = index * 2 + 1; toPage = fromPage + 1; } else if (index === 299) { fromPage = 601; toPage = 604; } return { fromPage: fromPage, toPage: toPage, surah: surahs[index] || '', linkFrom: linkFromData[index] ?? '', linkTo: linkToData[index] ?? '', reviewFrom: reviewFromData[index] ?? '', reviewTo: reviewToData[index] ?? '', round: calculateRoundNumber(index) }; }
        function calculateRoundNumber(originalIndex) { if (originalIndex < 32 || !reviewFromData || reviewFromData[originalIndex] == null || reviewFromData[originalIndex] === '') { return ''; } let reviewDataStartIndex = 32; let reviewCounter = 0; for(let i = reviewDataStartIndex; i <= originalIndex; i++){ if(reviewFromData[i] != null && reviewFromData[i] !== '') reviewCounter++; } if (reviewCounter === 0) return ''; return Math.ceil(reviewCounter / 6); }

        // --- UI Update Functions (Keep as is) ---
        function showLoading(message = "ุฌุงุฑู ุงูุชุญููู...") { /* ... */ }
        function hideLoading() { /* ... */ }
        function displayDashboard() { /* ... */ }

        // --- Functions to Calculate Stats from tableRows (Keep as is) ---
        function calculateDashboardStats(tableRows) { /* ... */ }

        // --- Functions to Update Dashboard Sections (Keep as is, including corrected displayDailyTask) ---
        function displayDailyTask() { /* ... (Keep the corrected version that checks today's date) ... */ }
        function displayProgress(stats) { /* ... */ }
        function displayStats(stats) { /* ... */ }

        // --- >>> ADDED: Calendar Functions <<< ---
        // 1. Prepare a map of date statuses
        function prepareDateStatusMap(tableRows) {
            const statusMap = {};
            if (!tableRows) return statusMap;
            tableRows.forEach(row => {
                if (row.displayDate) { // Ensure date exists
                    let currentStatus = statusMap[row.displayDate]; // Check if already set
                    if (row.type === 'excuse') {
                        statusMap[row.displayDate] = 'excuse'; // Excuse takes precedence
                    } else if (row.type === 'plan' && row.state && row.state.completed && currentStatus !== 'excuse') {
                        statusMap[row.displayDate] = 'completed'; // Set completed only if not already an excuse
                    }
                }
            });
            return statusMap;
        }

        // 2. Initialize calendar using the modifier
        function initializeCalendar(dateStatusMap) {
             const options = {
                 settings: {
                     lang: 'ar-EG', // Arabic locale
                     iso8601: false, // Week starts Saturday for ar-EG locale
                     visibility: {
                         theme: 'light',
                         today: true, // Highlight today's date
                         daysOutside: false, // Hide days from previous/next month
                     },
                     selection: {
                         day: false, // Disable date selection by user clicking
                     },
                     modifier: { // Use modifier to add CSS classes based on our status map
                          day: (dayElement, dateString) => {
                              const status = dateStatusMap[dateString];
                              // Remove previous status classes first
                              dayElement.classList.remove('status-completed', 'status-excuse');
                              // Add the current status class
                              if (status === 'completed') {
                                  dayElement.classList.add('status-completed');
                              } else if (status === 'excuse') {
                                  dayElement.classList.add('status-excuse');
                              }
                          }
                     }
                 },
                 actions: {} // No click actions needed for now
             };

             // Destroy previous instance if exists
             if (calendarInstance) {
                  try { calendarInstance.destroy(); } catch(e) { console.warn("Error destroying previous calendar:", e); }
             }
             // Create and initialize new instance
             const calendarElement = document.querySelector('#calendar-container');
             if(calendarElement) {
                calendarInstance = new VanillaCalendar(calendarElement, options);
                try {
                    calendarInstance.init();
                    console.log("Calendar initialized.");
                } catch(e) {
                    console.error("Error initializing calendar:", e);
                    calendarElement.innerHTML = "<p style='color:red;font-size:0.9em;'>ุฎุทุฃ ูู ุนุฑุถ ุงูุชูููู.</p>";
                }
             } else {
                console.error("Calendar container #calendar-container not found.");
             }
        }
        // --- >>> END: Calendar Functions <<< ---


        // --- Main Data Loading Function (MODIFIED to call calendar functions) ---
        function loadDashboardData(user) {
            if (!user) return;
            const uid = user.uid;
            const planRef = db.collection("quranPlans").doc(uid);
            console.log("Dashboard: Checking Firestore for plan:", uid);
            showLoading("ุฌุงุฑู ุชุญููู ุจูุงูุงุช ุฎุทุชู...");

            planRef.get().then((doc) => {
                hideLoading();
                if (doc.exists) {
                    console.log("Dashboard: Plan data found.");
                    currentPlanData = doc.data(); // Store FULL data globally

                    // Validate FULL data needed for dashboard
                    if (!currentPlanData.startDate || !currentPlanData.planType || !currentPlanData.tableRows || !Array.isArray(currentPlanData.tableRows) || !currentPlanData.repetitionMax) {
                        console.error("Loaded data missing required fields...", currentPlanData);
                        dashboardContent.style.display = 'block';
                        dailyTaskContent.innerHTML = `<p style="color:red; font-weight:bold;">ุฎุทุฃ: ุจูุงูุงุช ุฎุทุชู ุงููุญููุธุฉ ุบูุฑ ููุชููุฉ ุฃู ุชุงููุฉ. ูุฑุฌู <a href="index.html">ุงูุฐูุงุจ ูุตูุญุฉ ุงูุจุฏุงูุฉ</a> ูุฅุนุงุฏุฉ ุฅูุดุงุก ุงูุฎุทุฉ.</p>`;
                        document.getElementById('plan-progress').style.display = 'none';
                        document.getElementById('quick-stats').style.display = 'none';
                        // Handle calendar container in error state
                        const calendarContainer = document.getElementById('calendar-container');
                        if(calendarContainer) calendarContainer.innerHTML = "<p style='color:red;'><i>ูุง ูููู ุนุฑุถ ุงูุชูููู ุจุณุจุจ ุจูุงูุงุช ุฎุทุฉ ุบูุฑ ููุชููุฉ.</i></p>";
                        return;
                    }

                    // Calculate stats
                    const stats = calculateDashboardStats(currentPlanData.tableRows);

                    // --- >>> CALL Calendar Preparation & Initialization <<< ---
                    const dateStatusMap = prepareDateStatusMap(currentPlanData.tableRows);
                    initializeCalendar(dateStatusMap);
                    // --- >>> END Calendar Call <<< ---

                    // Update Display (Task, Progress, Stats)
                    displayDailyTask();
                    displayProgress(stats);
                    displayStats(stats);

                    displayDashboard(); // Show the dashboard content

                } else {
                     // No plan found logic
                     console.log("Dashboard: No plan data found.");
                     displayDashboard();
                     dailyTaskContent.innerHTML = '<p style="color:orange; font-weight:bold;">ูู ุชูู ุจุงุฎุชูุงุฑ ุฃู ุฅูุดุงุก ุฎุทุฉ ุจุนุฏ!</p><p>ุงุฐูุจ ุฅูู <a href="index.html">ุตูุญุฉ ุงูุจุฏุงูุฉ</a> ูุงุฎุชูุงุฑ ุฎุทุชู.</p>';
                     document.getElementById('plan-progress').style.display = 'none';
                     document.getElementById('quick-stats').style.display = 'none';
                     // Handle calendar container in no-plan state
                     const calendarContainer = document.getElementById('calendar-container');
                     if (calendarContainer) calendarContainer.innerHTML = "<p><i>ูุง ุชูุฌุฏ ุฎุทุฉ ูุนุฑุถ ุชูููููุง.</i></p>";
                     // Hide other placeholder sections
                     document.getElementById('calendar-view').style.display = 'none'; // Hide whole card if no plan
                     document.getElementById('competition-section').style.display = 'none';
                     document.getElementById('badges-section').style.display = 'none';
                }
            }).catch((error) => {
                 // Error handling
                 console.error("Error getting plan document:", error);
                 hideLoading();
                 displayDashboard();
                 dailyTaskContent.innerHTML = `<p style="color:red; font-weight:bold;">ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุจูุงูุงุช ุงูุฎุทุฉ. (${error.code || 'UNKNOWN'})</p><p>ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู ุฃู ุงูุชุฃูุฏ ูู ุงุชุตุงูู ุจุงูุฅูุชุฑูุช ูููุงุนุฏ ุงูุฃูุงู ูู Firestore. <a href="index.html">ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ</a></p>`;
                 document.getElementById('plan-progress').style.display = 'none';
                 document.getElementById('quick-stats').style.display = 'none';
                 // Handle calendar container in error state
                  const calendarContainer = document.getElementById('calendar-container');
                  if (calendarContainer) calendarContainer.innerHTML = "<p style='color:red;'><i>ุฎุทุฃ ุชุญููู ุจูุงูุงุช ุงูุชูููู.</i></p>";
            });
        }

        // --- Authentication Listener (remains the same) ---
        auth.onAuthStateChanged(user => {
            hideLoading();
            currentUser = user;
            if (user) {
                console.log("Dashboard: Auth state OK.");
                loadDashboardData(user);
            } else {
                console.log("Dashboard: Not logged in. Redirecting to index...");
                window.location.replace('index.html'); // Or login.html
            }
        });

        // --- Initial Load (remains the same) ---
        document.addEventListener('DOMContentLoaded', () => {
            showLoading("ุฌุงุฑู ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู...");
        });

         // --- Print Function (remains the same) ---
         function printData() { console.log("Initiating browser print..."); window.print(); }

    </script>

</body>
</html>