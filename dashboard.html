<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة المتابعة - خطة حفظ القرآن</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/jscalendar-css@1.0.5/dist/jsCalendar.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jscalendar-css@1.0.5/dist/jsCalendar.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

    <style>
        /* --- CSS Styles (تبقى كما هي - تأكد من وجود لون الخلفية الأخضر لشريط التقدم) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; background-color: #f4f7f6; color: #333; line-height: 1.7; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        h1, h2, h3, h4 { color: #1a5276; margin-bottom: 0.75em; }
        p { margin-bottom: 1em; color: #555; font-size: 0.95em; }
        a { text-decoration: none; color: #2980b9; }
        .card { background-color: #fff; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 3px 6px rgba(0,0,0,0.05); border: 1px solid #e0e0e0; }

        /* --- Header --- */
        .dashboard-header { display: flex; justify-content: center; align-items: center; padding: 10px 20px; margin-bottom: 25px; border-bottom: 2px solid #aed6f1; background-color: #fff; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .dashboard-header .logo h1 { margin: 0; font-size: 1.8em; color: #1a5276; }

        /* --- Dashboard Layout --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: auto; gap: 25px; }
        #daily-task { grid-column: span 2; }
        /* --- Start: New Layout for Streak/Level --- */
        #plan-progress { grid-column: 1 / 2; grid-row: 2 / 3; }
        #quick-stats { grid-column: 1 / 2; grid-row: 3 / 4; }
        #streak-level { grid-column: 2 / 4; grid-row: 2 / 3; } /* Span 2 cols */
        #calendar-view { grid-column: 2 / 4; grid-row: 3 / 4; } /* Span 2 cols */
        /* #competition-section { grid-column: ?; grid-row: ?; } /* Adjust if needed */
        /* #badges-section { grid-column: span 3; grid-row: 4 / 5; } /* Adjust if needed */
        /* --- End: New Layout --- */

        /* --- Section Specific Styles --- */
        #daily-task h3 { color: #1e8449; font-size: 1.3em; border-bottom: 2px solid #aed6f1; padding-bottom: 8px;}
        #daily-task-content { min-height: 80px; padding-top: 10px;} /* Adjusted height */
        #daily-task-content p { margin-bottom: 0.6em; font-size: 1.05em; line-height: 1.8; }
        #daily-task-content strong { color: #1a5276; margin-left: 8px;}
        #daily-task .plan-link { margin-top: 15px; display: inline-block; font-size: 0.9em; background-color: #5dade2; color: white; padding: 5px 10px; border-radius: 4px; }
        #daily-task .plan-link:hover { background-color: #3498db; }

        #plan-progress h3, #quick-stats h3, #calendar-view h3, #competition-section h3, #badges-section h3, #streak-level h3 { font-size: 1.15em; }
        #plan-progress .progress-bar-container { background-color: #e9ecef; border-radius: 0.25rem; height: 25px; overflow: hidden; margin-top: 10px; border: 1px solid #ccc; }
        #plan-progress .progress-bar-value { background-color: #28a745; height: 100%; width: 0%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.9em; font-weight: bold; transition: width 0.6s ease-in-out; }
        #quick-stats ul { list-style: none; padding: 0; margin-top: 15px;}
        #quick-stats ul li { margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px dotted #eee; font-size: 0.95em;}
        #quick-stats ul li strong { margin-left: 5px; color: #1a5276; min-width: 110px; display: inline-block;}
        #quick-stats ul li span { color: #1e8449; font-weight: bold;}

        /* --- Streak & Level Styles --- */
        #streak-level .streak-info { display: flex; justify-content: space-around; text-align: center; margin: 15px 0; }
        #streak-level .streak-info div { background-color: #eaf2f8; padding: 10px 15px; border-radius: 6px; border: 1px solid #d4e6f1; }
        #streak-level .streak-info strong { display: block; font-size: 1.5em; color: #1e8449; }
        #streak-level .level-title-container { text-align: center; margin-top: 15px; }
        #streak-level #level-title { font-size: 1.2em; color: #2c3e50; font-weight: bold; }
        #streak-level #level-icon { font-size: 1.5em; margin-left: 10px; } /* Placeholder for icon */

        /* --- Calendar Styles --- */
        #calendar-view { min-height: 280px; } /* Ensure card is tall enough */
        #calendar-container { margin-top: 15px; }
        /* #calendar-container { direction: ltr; /* Calendar library might expect LTR */ } */ /* Removed: jsCalendar handles RTL */

        /* ****** إزالة تنسيقات Vanilla Calendar القديمة ****** */
        /* .vcal-header { background-color: #aed6f1 !important; } */
        /* .vcal-date--today { background-color: #aed6f1 !important; ... } */
        /* .day-completed .vcal-date__day { background-color: #abebc6; ... } */
        /* .day-excused .vcal-date__day { background-color: #fadbd8; ... } */
        /* .vcal-date__day { color: #333; } */
        /* .vcal-day__btn:hover .vcal-date__day { background-color: #e0e0e0; } */
        /* .day-completed:hover .vcal-date__day { background-color: #82e0aa; } */
        /* .day-excused:hover .vcal-date__day { background-color: #f5b7b1; } */
        /* .vcal-body, .vcal-header__label, .vcal-week span { font-size: 0.9em; } */
        /* .vcal-date { height: 35px; } */
        /* .vcal-date__day { line-height: 35px; } */

        /* ****** إضافة تنسيقات jsCalendar للتلوين ****** */
        /* حاوية اليوم نفسها لتطبيق النمط الدائري */
        .jsCalendar-cell {
            display: flex !important; /* Use flexbox for centering */
            align-items: center !important;
            justify-content: center !important;
            width: 36px !important; /* Adjust size as needed */
            height: 36px !important; /* Make it square */
            margin: 1px auto !important; /* Adjust spacing */
            padding: 0 !important; /* Remove default padding */
            border-radius: 50%; /* Make it round */
            line-height: 36px !important; /* Vertically center text */
            font-size: 0.9em; /* Adjust font size if needed */
            cursor: default; /* No action on click */
        }

        /* اليوم المنجز */
        .jsCalendar-cell.day-completed {
            background-color: #c8e6c9 !important; /* Light green background */
            color: #1b5e20 !important;           /* Dark green text */
            border: 1px solid #a5d6a7;         /* Optional border */
        }

        /* اليوم المعذور */
        .jsCalendar-cell.day-excused {
            background-color: #ffcdd2 !important; /* Light red background */
            color: #b71c1c !important;           /* Dark red text */
            border: 1px solid #ef9a9a;         /* Optional border */
        }

        /* اليوم الحالي (افتراضي المكتبة قد لا يكون دائريًا) */
        .jsCalendar-cell.jsCalendar-today {
            background-color: #e3f2fd !important; /* Light blue background */
            color: #0d47a1 !important;           /* Dark blue text */
            border: 1px solid #90caf9 !important; /* Blue border */
            font-weight: bold;
        }

        /* إزالة أي خلفية عند المرور فوق الأيام المخصصة */
        .jsCalendar-cell.day-completed:hover,
        .jsCalendar-cell.day-excused:hover,
        .jsCalendar-cell.jsCalendar-today:hover {
            background-color: inherit !important; /* Keep original background on hover */
        }


        /* Placeholder Styles */
        .placeholder-box { min-height: 150px; background-color: #f0f4f8; border: 1px dashed #ccc; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #777; border-radius: 5px; padding: 15px; text-align: center; }
        .placeholder-box .icon { font-size: 3em; margin-bottom: 10px; opacity: 0.5; }
        .placeholder-box .text { font-style: italic; font-size: 0.9em; }

        /* Footer */
        .main-footer { text-align: center; padding: 20px; margin-top: 40px; background-color: #2c3e50; color: #ecf0f1; font-size: 0.9em; }
        .main-footer a { color: #3498db; }

        /* Action Buttons Hidden */
        .action-buttons { display: none; }

        /* Loading Indicator */
        #loading-indicator { text-align: center; padding: 50px; font-size: 1.3em; color: #1a5276; display: block; }

        /* Responsive Adjustments */
        @media (max-width: 992px) {
            .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
            #daily-task { grid-column: span 2; }
            #plan-progress, #quick-stats { grid-column: span 1; grid-row: auto; } /* Reset grid position */
            #streak-level, #calendar-view { grid-column: span 1; grid-row: auto; } /* Reset grid position */
            /* #badges-section { grid-column: span 2; } */ /* Adjust if needed */
        }
        @media (max-width: 768px) { /* Further adjust for smaller screens */
            #streak-level .streak-info { flex-direction: column; gap: 10px; }
            #streak-level .streak-info div { width: 80%; margin: 0 auto; }
        }
        @media (max-width: 600px) {
            .dashboard-header .logo h1 { font-size: 1.5em;}
            .dashboard-grid { grid-template-columns: 1fr; }
            #daily-task, #plan-progress, #quick-stats, #calendar-view, #streak-level, #competition-section, #badges-section { grid-column: span 1; } /* All span 1 */
            .card { padding: 15px; }
            h2 { font-size: 1.4em; }
            h3 { font-size: 1.1em; }
        }
    </style>
</head>
<body>

    <div class="container">

        <header class="dashboard-header">
            <div class="logo"><h1>خطة حفظ القرآن الكريم</h1></div>
        </header>

        <div id="loading-indicator">جاري التحميل...</div>

        <main id="dashboard-content" style="display: none;">

            <div class="dashboard-grid">

                <section id="daily-task" class="card">
                    <h3>🌟 واجب اليوم (<span id="today-date-display">...</span>)</h3>
                    <div id="daily-task-content">
                        <p><i>يتم تحديد الواجب...</i></p>
                    </div>
                    <a href="plangen2.html" class="plan-link">الذهاب إلى جدول الخطة التفصيلي &raquo;</a>
                </section>

                <section id="plan-progress" class="card">
                    <h3>الخطة والتقدم العام</h3>
                    <p><strong>خطتك الحالية:</strong> <span id="current-plan-name">-</span></p>
                    <p><strong>التقدم الكلي:</strong></p>
                    <div class="progress-bar-container">
                        <div id="progress-bar-value" style="width: 0%; background-color: #28a745;">0%</div>
                    </div>
                    <p style="font-size: 0.9em; text-align: center; margin-top: 5px;">
                        <span id="completed-pages-progress">0</span> / 604 صفحة
                    </p>
                </section>

                <section id="quick-stats" class="card">
                    <h3>إحصائيات سريعة</h3>
                    <ul>
                        <li><strong>الصفحات المحفوظة:</strong> <span id="stat-memorized">0</span></li>
                        <li><strong>الصفحات المتقنة:</strong> <span id="stat-perfected">0</span></li>
                        <li><strong>الصفحات المربوطة:</strong> <span id="stat-linked">0</span></li>
                        <li><strong>أيام الأعذار:</strong> <span id="stat-excuses">0</span></li>
                    </ul>
                </section>

                <section id="streak-level" class="card">
                    <h3> همة نحو القمة: الإنجاز المتتالي</h3>
                    <div class="streak-info">
                        <div>أيام الإنجاز الحالية<strong id="current-streak">0</strong></div>
                        <div> أطول سلسلة أيام حققتها<strong id="longest-streak">0</strong></div>
                    </div>
                    <div class="level-title-container">
                        <h4>لقبك الحالي: <span id="level-title">ابدأ رحلتك!</span> <span id="level-icon"></span></h4>
                    </div>
                </section>

                <section id="calendar-view" class="card">
                    <h3>التقويم والتتبع المرئي</h3>
                    <div id="calendar-container">
                        <p class="text" style="text-align: center; margin-top: 20px;">(جاري تحميل التقويم...)</p>
                    </div>
                </section>

                <section id="competition-section" class="card" style="display: none;"> <h3>المنافسة</h3>
                    <div class="placeholder-box">
                        <div class="icon">🏆</div>
                        <div class="text">(قريباً: لوحة الصدارة)</div>
                    </div>
                </section>
                <section id="badges-section" class="card" style="display: none;"> <h3>الأوسمة</h3>
                    <div class="placeholder-box">
                        <div class="icon">🏅</div>
                        <div class="text">(قريباً: نظام الأوسمة والحوافز)</div>
                    </div>
                </section>

            </div>
        </main>

        <footer class="main-footer">
            <p>&copy; 2025 خطة حفظ القرآن الكريم. جميع الحقوق محفوظة.</p>
        </footer>

    </div>


    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // استبدل بالمفتاح الفعلي إذا أمكن أو استخدم طرق آمنة
            authDomain: "quranplan2.firebaseapp.com",
            projectId: "quranplan2",
            storageBucket: "quranplan2.appspot.com",
            messagingSenderId: "1098692856811",
            appId: "1:1098692856811:web:923bca3a54fd78b1b267ae"
        };

        // --- Initialize Firebase ---
        try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Firebase initialization error:", e); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM References ---
        const loadingIndicator = document.getElementById('loading-indicator');
        const dashboardContent = document.getElementById('dashboard-content');
        const dailyTaskContent = document.getElementById('daily-task-content');
        const currentPlanNameSpan = document.getElementById('current-plan-name');
        const progressBarValue = document.getElementById('progress-bar-value');
        const completedPagesProgressSpan = document.getElementById('completed-pages-progress');
        const statMemorized = document.getElementById('stat-memorized');
        const statPerfected = document.getElementById('stat-perfected');
        const statLinked = document.getElementById('stat-linked');
        const statExcuses = document.getElementById('stat-excuses');
        const todayDateSpan = document.getElementById('today-date-display');
        const calendarContainer = document.getElementById('calendar-container');
        const currentStreakSpan = document.getElementById('current-streak');
        const longestStreakSpan = document.getElementById('longest-streak');
        const levelTitleSpan = document.getElementById('level-title');
        const levelIconSpan = document.getElementById('level-icon');

        // --- Constants ---
        const totalQuranPages = 604;
        const initialTotalRows = 320;

        // --- Global State ---
        let currentUser = null;
        let currentPlanData = null; // Stores the FULL plan data
        // let calendarInstance = null; // ****** لم نعد بحاجة لمتغير عام للتقويم مع jsCalendar بهذه الطريقة ******

        // --- Data Arrays & Helper Functions (Keep as is) ---
        const surahs = ['الفاتحة والبقرة', /* ... rest of surahs ... */ 'ختم القرآن'];
        const linkFromData = ['', '', 1, /* ... rest of data ... */ 577];
        const linkToData = ['', '', 2, /* ... rest of data ... */ 604];
        const reviewFromData = [...Array(32).fill(''), 1, /* ... rest of data ... */ 481];
        const reviewToData = [...Array(32).fill(''), 2, /* ... rest of data ... */ 576];

        function formatDate(date) { if (!(date instanceof Date)) date = new Date(date); if (isNaN(date.getTime())) return ""; const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
        function getPlanData(originalIndex) { const index = parseInt(originalIndex); if (isNaN(index) || index < 0 || index >= initialTotalRows) { return null; } let fromPage = '', toPage = ''; if (index < 299) { fromPage = index * 2 + 1; toPage = fromPage + 1; } else if (index === 299) { fromPage = 601; toPage = 604; } return { fromPage: fromPage, toPage: toPage, surah: surahs[index] || '', linkFrom: linkFromData[index] ?? '', linkTo: linkToData[index] ?? '', reviewFrom: reviewFromData[index] ?? '', reviewTo: reviewToData[index] ?? '', round: calculateRoundNumber(index) }; }
        function calculateRoundNumber(originalIndex) { if (originalIndex < 32 || !reviewFromData || reviewFromData[originalIndex] == null || reviewFromData[originalIndex] === '') { return ''; } let reviewDataStartIndex = 32; let reviewCounter = 0; for(let i = reviewDataStartIndex; i <= originalIndex; i++){ if(reviewFromData[i] != null && reviewFromData[i] !== '') reviewCounter++; } if (reviewCounter === 0) return ''; return Math.ceil(reviewCounter / 6); }


        // --- UI Update Functions ---
        function showLoading(message = "جاري التحميل...") { if(loadingIndicator){ loadingIndicator.textContent = message; loadingIndicator.style.display = 'block';} if(dashboardContent) dashboardContent.style.display = 'none'; }
        function hideLoading() { if(loadingIndicator) loadingIndicator.style.display = 'none'; }
        function displayDashboard() { hideLoading(); if(dashboardContent) dashboardContent.style.display = 'block'; }

        // --- Functions to Calculate Stats from tableRows (Keep as is) ---
        function calculateDashboardStats(tableRows) {
            let lastCompletedPage = 0; let linkedTasks = 0; let perfectedTasks = 0; let excuseCount = 0;
            if (!tableRows) return { memorizedPages: 0, linkedTasks: 0, perfectedTasks: 0, excuseCount: 0 };
            tableRows.forEach(row => {
                if (row.type === 'excuse') { excuseCount++; }
                else if (row.type === 'plan' && row.state && row.state.completed) {
                    const planInfo = getPlanData(row.originalSequence);
                    if (planInfo && planInfo.toPage) { const pageNum = parseInt(planInfo.toPage); if (!isNaN(pageNum)) { lastCompletedPage = Math.max(lastCompletedPage, pageNum); } }
                    if (planInfo && planInfo.linkTo !== '' && row.state.linked) { linkedTasks++; }
                    if (planInfo && planInfo.reviewTo !== '' && row.state.reviewed) { perfectedTasks++; }
                }
            });
            const memorizedPages = Math.min(lastCompletedPage, totalQuranPages);
            return { memorizedPages: memorizedPages, linkedTasks: linkedTasks, perfectedTasks: perfectedTasks, excuseCount: excuseCount };
        }

        // --- Streak, Level Functions (Keep as is) ---
        const levelTitles = [ /* ... Level Titles array remains the same ... */ ];
        const levelIcons = { /* ... Level Icons object remains the same ... */ };
        function calculateStreaksAndLevel(tableRows) { /* ... calculateStreaksAndLevel function remains the same ... */
                if (!tableRows || tableRows.length === 0) {
                    return { currentStreak: 0, longestStreak: 0, currentLevel: 0, currentTitle: levelTitles[0], currentIcon: '' };
                }
                const sortedRows = [...tableRows].sort((a, b) => new Date(a.displayDate) - new Date(b.displayDate));
                let currentStreak = 0;
                let longestStreak = 0;
                let currentRun = 0;
                const todayStr = formatDate(new Date());
                let isStreakActiveToday = false;
                for (const row of sortedRows) {
                    if (row.displayDate > todayStr) break;
                    if (row.type === 'plan' && row.state?.completed) {
                        currentRun++;
                        if(row.displayDate === todayStr) { isStreakActiveToday = true; }
                    } else if (row.type === 'excuse') {
                        if (currentRun > longestStreak) { longestStreak = currentRun; }
                        if(row.displayDate === todayStr){ isStreakActiveToday = false; }
                        // Don't reset currentRun here
                    } else {
                        if (currentRun > longestStreak) { longestStreak = currentRun; }
                        currentRun = 0;
                        isStreakActiveToday = false;
                    }
                }
                if (currentRun > longestStreak) { longestStreak = currentRun; }

                // Recalculate current streak from the end
                let tempCurrentStreak = 0;
                for (let i = sortedRows.length - 1; i >= 0; i--) {
                    const row = sortedRows[i];
                    if (row.displayDate > todayStr) continue;
                    if (row.type === 'plan' && row.state?.completed) {
                        tempCurrentStreak++;
                    } else if (row.type === 'excuse') {
                        continue; // Skip excuses when counting backwards for current streak
                    } else {
                        break; // Break on missed day or non-plan row
                    }
                }
                 // Determine if the current streak should be 0 or the calculated value
                // The streak continues only if the last relevant day (<= today) was 'completed'
                let finalCurrentStreak = 0;
                const lastRelevantRow = sortedRows.slice().reverse().find(r => r.displayDate <= todayStr);
                if(lastRelevantRow && lastRelevantRow.type === 'plan' && lastRelevantRow.state?.completed) {
                     finalCurrentStreak = tempCurrentStreak;
                } else if (lastRelevantRow && lastRelevantRow.type === 'excuse') {
                     // If today is an excuse, the streak ended yesterday. We need to find the last completed day before today
                     let yesterdayStreak = 0;
                      for (let i = sortedRows.length - 1; i >= 0; i--) {
                            const row = sortedRows[i];
                            if (row.displayDate >= todayStr) continue; // Look only before today
                            if (row.type === 'plan' && row.state?.completed) {
                                yesterdayStreak++;
                            } else if (row.type === 'excuse') {
                                continue;
                            } else {
                                break;
                            }
                        }
                     finalCurrentStreak = yesterdayStreak;

                }
                // If the last relevant day was missed or non-existent, finalCurrentStreak remains 0.


                const levelIndex = Math.min(Math.floor(finalCurrentStreak / 10), levelTitles.length - 1);
                const currentTitle = levelTitles[levelIndex] || levelTitles[0];
                const currentIcon = levelIcons[levelIndex] || '';

                return {
                    currentStreak: finalCurrentStreak,
                    longestStreak: longestStreak,
                    currentLevel: levelIndex,
                    currentTitle: currentTitle,
                    currentIcon: currentIcon
                };
         }

        // --- ****** إزالة دالة initializeCalendar القديمة ****** ---
        // function initializeCalendar(tableRows) { /* ... REMOVED ... */ }

        // --- ****** إزالة دالة applyDateModifiers القديمة ****** ---
        // function applyDateModifiers(daysToHighlight) { /* ... REMOVED ... */ }


        // --- ****** دالة جديدة لتهيئة jsCalendar ****** ---
        function initializeJsCalendar(tableRows) {
            if (!calendarContainer) {
                console.error("Calendar container '#calendar-container' not found!");
                return;
            }
            if (typeof jsCalendar === 'undefined') {
                 console.error("jsCalendar library is not loaded!");
                 calendarContainer.innerHTML = '<p class="text" style="color:red;">خطأ: مكتبة التقويم (jsCalendar) لم يتم تحميلها.</p>';
                 return;
            }

            console.log("Initializing jsCalendar...");
            calendarContainer.innerHTML = ''; // مسح المحتوى السابق (مثل رسالة التحميل)

            try {
                // تهيئة التقويم الشهري الأساسي باللغة العربية
                jsCalendar.new(calendarContainer, new Date(), {
                    language: 'ar',
                    monthFormat: 'month YYYY', // تنسيق الشهر والسنة
                    navigator : true, // السماح بالتنقل بين الأشهر
                    zeroFill: true // Ensure day numbers have leading zeros if needed by date format
                });
                console.log("jsCalendar base initialized. Applying highlighting soon...");

                // استدعاء دالة التلوين بعد تأخير بسيط لضمان رسم التقويم
                setTimeout(() => applyJsCalendarHighlighting(tableRows), 150); // 150ms delay

            } catch (error) {
                console.error("Error initializing jsCalendar:", error);
                calendarContainer.innerHTML = `<p class="text" style="color:red;">خطأ في تهيئة التقويم: ${error.message}</p>`;
            }
        }

        // --- ****** دالة جديدة لتطبيق التلوين على jsCalendar ****** ---
        function applyJsCalendarHighlighting(tableRows) {
            if (!calendarContainer || !tableRows || !Array.isArray(tableRows)) {
                console.warn("Cannot apply highlighting: Missing container or tableRows data.");
                return;
            }
             console.log("Applying jsCalendar highlighting...");

            // 1. إنشاء خريطة لحالة الأيام لسهولة البحث
            const dayStatusMap = {};
            tableRows.forEach(row => {
                if (row.displayDate && /^\d{4}-\d{2}-\d{2}$/.test(row.displayDate)) {
                    if (row.type === 'plan' && row.state?.completed) {
                        dayStatusMap[row.displayDate] = 'completed';
                    } else if (row.type === 'excuse') {
                        dayStatusMap[row.displayDate] = 'excused';
                    }
                }
            });
            // console.log("Day Status Map:", dayStatusMap); // For debugging

            // 2. العثور على جميع خلايا الأيام التي أنشأتها jsCalendar
            // jsCalendar uses data-date attribute in YYYY-MM-DD format
            const dayElements = calendarContainer.querySelectorAll('.jsCalendar-cell[data-date]');
            // console.log(`Found ${dayElements.length} day elements to check.`); // For debugging

            // 3. المرور على كل يوم وتطبيق الكلاس المناسب
            dayElements.forEach(dayElement => {
                const dateStr = dayElement.getAttribute('data-date');
                const status = dayStatusMap[dateStr];

                // إزالة الكلاسات القديمة أولاً
                dayElement.classList.remove('day-completed', 'day-excused');

                // إضافة الكلاس الجديد إذا كان اليوم له حالة خاصة
                if (status === 'completed') {
                    dayElement.classList.add('day-completed');
                    // console.log(`Highlighting ${dateStr} as completed.`); // For debugging
                } else if (status === 'excused') {
                    dayElement.classList.add('day-excused');
                     // console.log(`Highlighting ${dateStr} as excused.`); // For debugging
                }
            });
             console.log("jsCalendar highlighting applied.");
        }


        // --- MODIFIED Functions to Update Dashboard Sections ---
        function displayDailyTask() { /* ... function remains the same ... */
            if (!dailyTaskContent || !currentPlanData || !currentPlanData.tableRows) {
                if(dailyTaskContent) dailyTaskContent.innerHTML = '<p><i>جاري تحميل بيانات الخطة...</i></p>';
                if (todayDateSpan) todayDateSpan.textContent = formatDate(new Date());
                return;
            }
            const tableRows = currentPlanData.tableRows;
            const today = new Date();
            const todayStr = formatDate(today);
            if (todayDateSpan) todayDateSpan.textContent = todayStr;
            const todayRow = tableRows.find(row => row.displayDate === todayStr);
            if (!todayRow) { dailyTaskContent.innerHTML = '<p>لا يوجد واجب مقرر في الخطة لهذا اليوم.</p>'; }
            else if (todayRow.type === 'excuse') { dailyTaskContent.innerHTML = `<p style="color: orange; font-weight:bold;">لديك عذر مسجل لهذا اليوم (${todayRow.excuseType || ''}).</p>`; }
            else if (todayRow.type === 'plan' && todayRow.state?.completed) { dailyTaskContent.innerHTML = '<p style="color: green; font-weight: bold;">✅ الحمد لله، لقد أتممت واجب هذا اليوم!</p>'; }
            else if (todayRow.type === 'plan' && todayRow.state && !todayRow.state.completed) {
                const taskDetails = getPlanData(todayRow.originalSequence);
                if (taskDetails) {
                    let taskHTML = `<h4>المطلوب إنجازه اليوم (${todayStr}):</h4>`;
                    taskHTML += `<p><strong>الحفظ الجديد:</strong> ${taskDetails.fromPage ? `ص ${taskDetails.fromPage} - ${taskDetails.toPage}` : 'لا يوجد'} (${taskDetails.surah || 'مراجعة'})</p>`;
                    taskHTML += `<p><strong>الربط:</strong> ${taskDetails.linkFrom ? `من ${taskDetails.linkFrom} إلى ${taskDetails.linkTo}` : 'لا يوجد'}</p>`;
                    taskHTML += `<p><strong>المراجعة:</strong> ${taskDetails.reviewFrom ? `من ${taskDetails.reviewFrom} إلى ${taskDetails.reviewTo}` : 'لا يوجد'} ${taskDetails.round ? `(ج${taskDetails.round})` : ''}</p>`;
                    dailyTaskContent.innerHTML = taskHTML;
                } else { dailyTaskContent.innerHTML = `<p><i>خطأ: لم يتم العثور على تفاصيل الواجب للفهرس ${todayRow.originalSequence}.</i></p>`; }
            } else { dailyTaskContent.innerHTML = '<p><i>واجب اليوم لم يكتمل بعد أو حالته غير معروفة.</i></p>'; }
         }
        function displayProgress(stats) { /* ... function remains the same ... */
             if (!currentPlanData) return;
             const planType = currentPlanData.planType || '?';
             const memorizedPages = stats.memorizedPages;
             const progressPercent = totalQuranPages > 0 ? Math.min(100, (memorizedPages / totalQuranPages) * 100).toFixed(0) : 0;
             if(currentPlanNameSpan) currentPlanNameSpan.textContent = `خطة ${planType} صفحات`;
             if(progressBarValue) { progressBarValue.style.width = `${progressPercent}%`; progressBarValue.style.backgroundColor = '#28a745'; progressBarValue.textContent = `${progressPercent}%`; }
             if(completedPagesProgressSpan) completedPagesProgressSpan.textContent = memorizedPages;
         }
        function displayStats(stats) { /* ... function remains the same ... */
             if(statMemorized) statMemorized.textContent = stats.memorizedPages;
             if(statPerfected) statPerfected.textContent = stats.perfectedTasks;
             if(statLinked) statLinked.textContent = stats.linkedTasks;
             if(statExcuses) statExcuses.textContent = stats.excuseCount;
         }
        function displayStreakAndLevel(streakData) { /* ... function remains the same ... */
             if(currentStreakSpan) currentStreakSpan.textContent = streakData.currentStreak;
             if(longestStreakSpan) longestStreakSpan.textContent = streakData.longestStreak;
             if(levelTitleSpan) levelTitleSpan.textContent = streakData.currentTitle;
             if(levelIconSpan) levelIconSpan.textContent = streakData.currentIcon;
         }


        // --- Main Data Loading Function (MODIFIED) ---
        function loadDashboardData(user) {
            if (!user) return;
            const uid = user.uid;
            const planRef = db.collection("quranPlans").doc(uid);
            console.log("Dashboard: Checking Firestore for plan:", uid);
            showLoading("جاري تحميل بيانات خطتك...");

            planRef.get().then((doc) => {
                hideLoading();
                if (doc.exists) {
                    console.log("Dashboard: Plan data found.");
                    currentPlanData = doc.data(); // Store FULL data globally

                    if (!currentPlanData.startDate || !currentPlanData.planType || !currentPlanData.tableRows || !Array.isArray(currentPlanData.tableRows) || !currentPlanData.repetitionMax) {
                        console.error("Loaded data missing required fields (startDate, planType, tableRows array, or repetitionMax).", currentPlanData);
                         dashboardContent.style.display = 'block';
                         dailyTaskContent.innerHTML = `<p style="color:red; font-weight:bold;">خطأ: بيانات خطتك المحفوظة غير مكتملة أو تالفة. يرجى <a href="index.html">الذهاب لصفحة البداية</a> وإعادة إنشاء الخطة.</p>`;
                         document.getElementById('plan-progress').style.display = 'none';
                         document.getElementById('quick-stats').style.display = 'none';
                         document.getElementById('calendar-view').style.display = 'none'; // Hide calendar too
                         return;
                    }

                    // --- Process Data & Update UI ---
                    const stats = calculateDashboardStats(currentPlanData.tableRows);
                    const streakData = calculateStreaksAndLevel(currentPlanData.tableRows);

                    displayDailyTask();
                    displayProgress(stats);
                    displayStats(stats);
                    displayStreakAndLevel(streakData);

                    // ****** تحديث: استدعاء دالة تهيئة jsCalendar الجديدة ******
                    initializeJsCalendar(currentPlanData.tableRows);

                    displayDashboard();

                } else {
                     console.log("Dashboard: No plan data found.");
                     displayDashboard();
                     dailyTaskContent.innerHTML = '<p style="color:orange; font-weight:bold;">لم تقم باختيار أو إنشاء خطة بعد!</p><p>اذهب إلى <a href="index.html">صفحة البداية</a> لاختيار خطتك.</p>';
                     document.getElementById('plan-progress').style.display = 'none';
                     document.getElementById('quick-stats').style.display = 'none';
                     document.getElementById('calendar-view').style.display = 'none';
                     document.getElementById('streak-level').style.display = 'none';
                     document.getElementById('competition-section').style.display = 'none';
                     document.getElementById('badges-section').style.display = 'none';
                }
            }).catch((error) => {
                 console.error("Error getting plan document:", error);
                 hideLoading();
                 displayDashboard();
                 dailyTaskContent.innerHTML = `<p style="color:red; font-weight:bold;">حدث خطأ أثناء تحميل بيانات الخطة. (${error.code || 'UNKNOWN'})</p><p>يرجى المحاولة مرة أخرى أو التأكد من اتصالك بالإنترنت وقواعد الأمان في Firestore. <a href="index.html">العودة للرئيسية</a></p>`;
                 document.getElementById('plan-progress').style.display = 'none';
                 document.getElementById('quick-stats').style.display = 'none';
                 document.getElementById('calendar-view').style.display = 'none';
                 document.getElementById('streak-level').style.display = 'none';
            });
        }

        // --- Authentication Listener ---
        auth.onAuthStateChanged(user => {
            hideLoading();
            currentUser = user;
            if (user) {
                console.log("Dashboard: Auth state OK.");
                loadDashboardData(user);
            } else {
                console.log("Dashboard: Not logged in.");
                showLoading("غير مسجل الدخول. يرجى تسجيل الدخول أولاً.");
                console.warn("User not logged in, dashboard will not load data.");
                if(dashboardContent) dashboardContent.style.display = 'block'; // Show main area
                if(dailyTaskContent) dailyTaskContent.innerHTML = '<p style="color:red;">يرجى <a href="index.html">تسجيل الدخول</a> لعرض لوحة المتابعة.</p>';
                const sectionsToHide = ['plan-progress', 'quick-stats', 'calendar-view', 'streak-level', 'competition-section', 'badges-section'];
                sectionsToHide.forEach(id => {
                    const section = document.getElementById(id);
                    if (section) section.style.display = 'none';
                });
            }
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            showLoading("جاري التحقق من تسجيل الدخول...");
            // Authentication listener will handle the rest
        });

        // --- Print Function (Keep as is) ---
        function printData() { console.log("Initiating browser print..."); window.print(); }

    </script>

</body>
</html>