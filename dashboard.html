<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة المتابعة - خطة حفظ القرآن</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

    <link href="vanilla-calendar.min.css" rel="stylesheet">
    <script src="vanilla-calendar.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

    <style>
        /* --- CSS Styles (تبقى كما هي - تأكد من وجود لون الخلفية الأخضر لشريط التقدم) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; background-color: #f4f7f6; color: #333; line-height: 1.7; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        h1, h2, h3, h4 { color: #1a5276; margin-bottom: 0.75em; }
        p { margin-bottom: 1em; color: #555; font-size: 0.95em; }
        a { text-decoration: none; color: #2980b9; }
        .card { background-color: #fff; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 3px 6px rgba(0,0,0,0.05); border: 1px solid #e0e0e0; }

        /* --- Header --- */
        .dashboard-header { display: flex; justify-content: center; align-items: center; padding: 10px 20px; margin-bottom: 25px; border-bottom: 2px solid #aed6f1; background-color: #fff; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .dashboard-header .logo h1 { margin: 0; font-size: 1.8em; color: #1a5276; }

        /* --- Dashboard Layout --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: auto; gap: 25px; }
        #daily-task { grid-column: span 2; }
        /* --- Start: New Layout for Streak/Level --- */
        #plan-progress { grid-column: 1 / 2; grid-row: 2 / 3; }
        #quick-stats { grid-column: 1 / 2; grid-row: 3 / 4; }
        #streak-level { grid-column: 2 / 4; grid-row: 2 / 3; } /* Span 2 cols */
        #calendar-view { grid-column: 2 / 4; grid-row: 3 / 4; } /* Span 2 cols */
        /* #competition-section { grid-column: ?; grid-row: ?; } /* Adjust if needed */
        /* #badges-section { grid-column: span 3; grid-row: 4 / 5; } /* Adjust if needed */
        /* --- End: New Layout --- */

        /* --- Section Specific Styles --- */
        #daily-task h3 { color: #1e8449; font-size: 1.3em; border-bottom: 2px solid #aed6f1; padding-bottom: 8px;}
        #daily-task-content { min-height: 80px; padding-top: 10px;} /* Adjusted height */
        #daily-task-content p { margin-bottom: 0.6em; font-size: 1.05em; line-height: 1.8; }
        #daily-task-content strong { color: #1a5276; margin-left: 8px;}
        #daily-task .plan-link { margin-top: 15px; display: inline-block; font-size: 0.9em; background-color: #5dade2; color: white; padding: 5px 10px; border-radius: 4px; }
        #daily-task .plan-link:hover { background-color: #3498db; }

        #plan-progress h3, #quick-stats h3, #calendar-view h3, #competition-section h3, #badges-section h3, #streak-level h3 { font-size: 1.15em; }
        #plan-progress .progress-bar-container { background-color: #e9ecef; border-radius: 0.25rem; height: 25px; overflow: hidden; margin-top: 10px; border: 1px solid #ccc; }
        #plan-progress .progress-bar-value { background-color: #28a745; height: 100%; width: 0%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.9em; font-weight: bold; transition: width 0.6s ease-in-out; }
        #quick-stats ul { list-style: none; padding: 0; margin-top: 15px;}
        #quick-stats ul li { margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px dotted #eee; font-size: 0.95em;}
        #quick-stats ul li strong { margin-left: 5px; color: #1a5276; min-width: 110px; display: inline-block;}
        #quick-stats ul li span { color: #1e8449; font-weight: bold;}

        /* --- Streak & Level Styles --- */
        #streak-level .streak-info { display: flex; justify-content: space-around; text-align: center; margin: 15px 0; }
        #streak-level .streak-info div { background-color: #eaf2f8; padding: 10px 15px; border-radius: 6px; border: 1px solid #d4e6f1; }
        #streak-level .streak-info strong { display: block; font-size: 1.5em; color: #1e8449; }
        #streak-level .level-title-container { text-align: center; margin-top: 15px; }
        #streak-level #level-title { font-size: 1.2em; color: #2c3e50; font-weight: bold; }
        #streak-level #level-icon { font-size: 1.5em; margin-left: 10px; } /* Placeholder for icon */

        /* --- Calendar Styles --- */
        #calendar-view { min-height: 280px; } /* Ensure card is tall enough */
        #calendar-container { margin-top: 15px; direction: ltr; /* Calendar library might expect LTR */ }

        /* --- !! Vanilla Calendar Customization !! --- */
        /* Header Style */
        .vanilla-calendar .vcal-header { background-color: #aed6f1 !important; padding: 10px 0; }
        .vanilla-calendar .vcal-header__label { color: #1a5276; font-weight: bold; }
        .vanilla-calendar .vcal-arrow { background-color: #ffffff; border-radius: 50%; width: 30px; height: 30px; line-height: 30px; }
        .vanilla-calendar .vcal-arrow::before { border-color: #1a5276; }

        /* Week Days Style */
        .vanilla-calendar .vcal-week { background-color: #eaf2f8; padding: 5px 0; }
        .vanilla-calendar .vcal-week span { color: #1a5276; font-weight: bold; }

        /* Day Cell Styles */
        .vanilla-calendar .vcal-day__btn { border: none; background: none; cursor: pointer; width: 100%; height: 40px; /* Adjust height */ display: flex; justify-content: center; align-items: center; padding: 0; position: relative; /* Needed for potential future absolute positioning */ }
        .vanilla-calendar .vcal-day__btn:hover .vcal-date { background-color: #e0e0e0; border-radius: 50%; } /* Default hover */

        /* Inner Day Number Style */
        .vanilla-calendar .vcal-date { width: 32px; /* Circle size */ height: 32px; line-height: 32px; text-align: center; border-radius: 50%; transition: background-color 0.2s, color 0.2s; display: block; margin: 0 auto; } /* Default day style */
        .vanilla-calendar .vcal-date__day { color: #333; } /* Default text color */
        .vanilla-calendar .vcal-date--today .vcal-date__day { color: #1a5276 !important; font-weight: bold; } /* Today's text color */
        .vanilla-calendar .vcal-date--today { background-color: #aed6f1 !important; border: 1px solid #1a5276; } /* Today's background and border */

        /* --- !! Custom Coloring Styles - Applied to .vcal-day__btn !! --- */
        .vanilla-calendar .vcal-day__btn.day-completed .vcal-date { background-color: #abebc6; /* Light green */ }
        .vanilla-calendar .vcal-day__btn.day-completed .vcal-date__day { color: #186a3b; font-weight: bold; }
        .vanilla-calendar .vcal-day__btn.day-excused .vcal-date { background-color: #fadbd8; /* Light red */ }
        .vanilla-calendar .vcal-day__btn.day-excused .vcal-date__day { color: #922b21; font-weight: bold; }

        /* Hover effects for custom colored days */
        .vanilla-calendar .vcal-day__btn.day-completed:hover .vcal-date { background-color: #82e0aa; } /* Darker green on hover */
        .vanilla-calendar .vcal-day__btn.day-excused:hover .vcal-date { background-color: #f5b7b1; } /* Darker red on hover */

        /* Font size adjustments */
        .vanilla-calendar .vcal-body, .vanilla-calendar .vcal-header__label, .vanilla-calendar .vcal-week span { font-size: 0.9em; }

        /* --- End Calendar Styles --- */

        /* Placeholder Styles */
        .placeholder-box { min-height: 150px; background-color: #f0f4f8; border: 1px dashed #ccc; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #777; border-radius: 5px; padding: 15px; text-align: center; }
        .placeholder-box .icon { font-size: 3em; margin-bottom: 10px; opacity: 0.5; }
        .placeholder-box .text { font-style: italic; font-size: 0.9em; }

        /* Footer */
        .main-footer { text-align: center; padding: 20px; margin-top: 40px; background-color: #2c3e50; color: #ecf0f1; font-size: 0.9em; }
        .main-footer a { color: #3498db; }

        /* Action Buttons Hidden */
        .action-buttons { display: none; }

        /* Loading Indicator */
        #loading-indicator { text-align: center; padding: 50px; font-size: 1.3em; color: #1a5276; display: block; }

        /* Responsive Adjustments */
        @media (max-width: 992px) {
            .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
            #daily-task { grid-column: span 2; }
            #plan-progress, #quick-stats { grid-column: span 1; grid-row: auto; } /* Reset grid position */
            #streak-level, #calendar-view { grid-column: span 1; grid-row: auto; } /* Reset grid position */
            /* #badges-section { grid-column: span 2; } */ /* Adjust if needed */
        }
        @media (max-width: 768px) { /* Further adjust for smaller screens */
            #streak-level .streak-info { flex-direction: column; gap: 10px; }
            #streak-level .streak-info div { width: 80%; margin: 0 auto; }
        }
        @media (max-width: 600px) {
            .dashboard-header .logo h1 { font-size: 1.5em;}
            .dashboard-grid { grid-template-columns: 1fr; }
            #daily-task, #plan-progress, #quick-stats, #calendar-view, #streak-level, #competition-section, #badges-section { grid-column: span 1; } /* All span 1 */
            .card { padding: 15px; }
            h2 { font-size: 1.4em; }
            h3 { font-size: 1.1em; }
        }
    </style>
</head>
<body>

    <div class="container">

        <header class="dashboard-header">
            <div class="logo"><h1>خطة حفظ القرآن الكريم</h1></div>
        </header>

        <div id="loading-indicator">جاري التحميل...</div>

        <main id="dashboard-content" style="display: none;">

            <div class="dashboard-grid">

                <section id="daily-task" class="card">
                    <h3>🌟 واجب اليوم (<span id="today-date-display">...</span>)</h3>
                    <div id="daily-task-content">
                        <p><i>يتم تحديد الواجب...</i></p>
                    </div>
                    <a href="plangen2.html" class="plan-link">الذهاب إلى جدول الخطة التفصيلي &raquo;</a>
                </section>

                <section id="plan-progress" class="card">
                    <h3>الخطة والتقدم العام</h3>
                    <p><strong>خطتك الحالية:</strong> <span id="current-plan-name">-</span></p>
                    <p><strong>التقدم الكلي:</strong></p>
                    <div class="progress-bar-container">
                        <div id="progress-bar-value" class="progress-bar-value" style="width: 0%;">0%</div>
                    </div>
                    <p style="font-size: 0.9em; text-align: center; margin-top: 5px;">
                        <span id="completed-pages-progress">0</span> / 604 صفحة
                    </p>
                </section>

                <section id="quick-stats" class="card">
                    <h3>إحصائيات سريعة</h3>
                    <ul>
                        <li><strong>الصفحات المحفوظة:</strong> <span id="stat-memorized">0</span></li>
                        <li><strong>الصفحات المتقنة:</strong> <span id="stat-perfected">0</span></li>
                        <li><strong>الصفحات المربوطة:</strong> <span id="stat-linked">0</span></li>
                        <li><strong>أيام الأعذار:</strong> <span id="stat-excuses">0</span></li>
                    </ul>
                </section>

                <section id="streak-level" class="card">
                    <h3> همة نحو القمة: الإنجاز المتتالي</h3>
                    <div class="streak-info">
                        <div>أيام الإنجاز الحالية<strong id="current-streak">0</strong></div>
                        <div> أطول سلسلة أيام حققتها<strong id="longest-streak">0</strong></div>
                    </div>
                    <div class="level-title-container">
                        <h4>لقبك الحالي: <span id="level-title">ابدأ رحلتك!</span> <span id="level-icon"></span></h4>
                    </div>
                </section>
                <section id="calendar-view" class="card">
                    <h3>التقويم والتتبع المرئي</h3>
                    <div id="calendar-container">
                        <p class="text" style="text-align: center; margin-top: 20px;">(جاري تحميل التقويم...)</p>
                    </div>
                </section>

                <section id="competition-section" class="card" style="display: none;"> <h3>المنافسة</h3>
                    <div class="placeholder-box">
                        <div class="icon">🏆</div>
                        <div class="text">(قريباً: لوحة الصدارة)</div>
                    </div>
                </section>
                <section id="badges-section" class="card" style="display: none;"> <h3>الأوسمة</h3>
                    <div class="placeholder-box">
                        <div class="icon">🏅</div>
                        <div class="text">(قريباً: نظام الأوسمة والحوافز)</div>
                    </div>
                </section>

            </div>
        </main>

        <footer class="main-footer">
            <p>&copy; 2025 خطة حفظ القرآن الكريم. جميع الحقوق محفوظة.</p>
        </footer>

    </div>

    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDuUebu7Qzz3JnTfa-58EIPZjOcrkmdGHU", // WARNING: Exposing API keys client-side is risky. Consider security rules.
            authDomain: "quranplan2.firebaseapp.com",
            projectId: "quranplan2",
            storageBucket: "quranplan2.appspot.com",
            messagingSenderId: "1098692856811",
            appId: "1:1098692856811:web:923bca3a54fd78b1b267ae"
        };

        // --- Initialize Firebase ---
         try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Firebase initialization error:", e); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM References ---
        const loadingIndicator = document.getElementById('loading-indicator');
        const dashboardContent = document.getElementById('dashboard-content');
        const dailyTaskContent = document.getElementById('daily-task-content');
        const currentPlanNameSpan = document.getElementById('current-plan-name');
        const progressBarValue = document.getElementById('progress-bar-value');
        const completedPagesProgressSpan = document.getElementById('completed-pages-progress');
        const statMemorized = document.getElementById('stat-memorized');
        const statPerfected = document.getElementById('stat-perfected');
        const statLinked = document.getElementById('stat-linked');
        const statExcuses = document.getElementById('stat-excuses');
        const todayDateSpan = document.getElementById('today-date-display');
        const calendarContainer = document.getElementById('calendar-container'); // Reference needed globally for calendar
        const currentStreakSpan = document.getElementById('current-streak');
        const longestStreakSpan = document.getElementById('longest-streak');
        const levelTitleSpan = document.getElementById('level-title');
        const levelIconSpan = document.getElementById('level-icon');

        // --- Constants ---
        const totalQuranPages = 604;
        const initialTotalRows = 320; // Assuming this is correct based on your plan data generation

        // --- Global State ---
        let currentUser = null;
        let currentPlanData = null; // Stores the FULL plan data
        let calendarInstance = null; // To hold the calendar object
        let dayStatus = {}; // <-- !! Global object to store day statuses for the calendar !!

        // --- Data Arrays & Helper Functions (Keep as is) ---
        // These arrays are placeholders, replace with your actual data if needed, but functions rely on them
        const surahs = ['الفاتحة والبقرة', 'آل عمران', 'النساء', 'المائدة', 'الأنعام', 'الأعراف', 'الأنفال', 'التوبة', 'يونس', 'هود', 'يوسف', 'الرعد', 'إبراهيم', 'الحجر', 'النحل', 'الإسراء', 'الكهف', 'مريم', 'طه', 'الأنبياء', 'الحج', 'المؤمنون', 'النور', 'الفرقان', 'الشعراء', 'النمل', 'القصص', 'العنكبوت', 'الروم', 'لقمان', 'السجدة', 'الأحزاب', 'سبأ', 'فاطر', 'يس', 'الصافات', 'ص', 'الزمر', 'غافر', 'فصلت', 'الشورى', 'الزخرف', 'الدخان', 'الجاثية', 'الأحقاف', 'محمد', 'الفتح', 'الحجرات', 'ق', 'الذاريات', 'الطور', 'النجم', 'القمر', 'الرحمن', 'الواقعة', 'الحديد', 'المجادلة', 'الحشر', 'الممتحنة', 'الصف', 'الجمعة', 'المنافقون', 'التغابن', 'الطلاق', 'التحريم', 'الملك', 'القلم', 'الحاقة', 'المعارج', 'نوح', 'الجن', 'المزمل', 'المدثر', 'القيامة', 'الإنسان', 'المرسلات', 'النبأ', 'النازعات', 'عبس', 'التكوير', 'الإنفطار', 'المطففين', 'الإنشقاق', 'البروج', 'الطارق', 'الأعلى', 'الغاشية', 'الفجر', 'البلد', 'الشمس', 'الليل', 'الضحى', 'الشرح', 'التين', 'العلق', 'القدر', 'البينة', 'الزلزلة', 'العاديات', 'القارعة', 'التكاثر', 'العصر', 'الهمزة', 'الفيل', 'قريش', 'الماعون', 'الكوثر', 'الكافرون', 'النصر', 'المسد', 'الإخلاص', 'الفلق', 'الناس', 'ختم القرآن']; // Example, fill completely
        const linkFromData = ['', '', 1, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154, 155, 156, 157, 158, 159, 160, 161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182, 183, 184, 185, 186, 187, 188, 189, 190, 191, 192, 193, 194, 195, 196, 197, 198, 199, 200, 201, 202, 203, 204, 205, 206, 207, 208, 209, 210, 211, 212, 213, 214, 215, 216, 217, 218, 219, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 230, 231, 232, 233, 234, 235, 236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255, 256, 257, 258, 259, 260, 261, 262, 263, 264, 265, 266, 267, 268, 269, 270, 271, 272, 273, 274, 275, 276, 277, 278, 279, 280, 281, 282, 283, 284, 285, 286, 287, 288, 289, 290, 291, 292, 293, 294, 295, 296, 297, 298, 577 ]; // Example, fill completely
        const linkToData = ['', '', 2, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154, 155, 156, 157, 158, 159, 160, 161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182, 183, 184, 185, 186, 187, 188, 189, 190, 191, 192, 193, 194, 195, 196, 197, 198, 199, 200, 201, 202, 203, 204, 205, 206, 207, 208, 209, 210, 211, 212, 213, 214, 215, 216, 217, 218, 219, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 230, 231, 232, 233, 234, 235, 236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255, 256, 257, 258, 259, 260, 261, 262, 263, 264, 265, 266, 267, 268, 269, 270, 271, 272, 273, 274, 275, 276, 277, 278, 279, 280, 281, 282, 283, 284, 285, 286, 287, 288, 289, 290, 291, 292, 293, 294, 295, 296, 297, 298, 300, 604 ]; // Example, fill completely
        const reviewFromData = [...Array(32).fill(''), 1, 2, 3, 4, 5, 6, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 481]; // Example, fill completely
        const reviewToData = [...Array(32).fill(''), 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154, 155, 156, 157, 158, 159, 160, 161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182, 183, 184, 185, 186, 187, 188, 189, 190, 191, 192, 193, 194, 195, 196, 197, 198, 199, 200, 201, 202, 203, 204, 205, 206, 207, 208, 209, 210, 211, 212, 213, 214, 215, 216, 217, 218, 219, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 230, 231, 232, 233, 234, 235, 236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255, 256, 257, 258, 259, 260, 261, 262, 263, 264, 265, 266, 267, 268, 269, 270, 271, 272, 273, 274, 275, 276, 277, 278, 279, 280, 281, 282, 283, 284, 285, 286, 287, 288, 289, 290, 291, 292, 293, 294, 295, 296, 297, 298, 299, 300, 576]; // Example, fill completely

        function formatDate(date) { if (!(date instanceof Date)) date = new Date(date); if (isNaN(date.getTime())) return ""; const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
        function getPlanData(originalIndex) { const index = parseInt(originalIndex); if (isNaN(index) || index < 0 || index >= initialTotalRows) { return null; } let fromPage = '', toPage = ''; if (index < 299) { fromPage = index * 2 + 1; toPage = fromPage + 1; } else if (index === 299) { fromPage = 601; toPage = 604; } return { fromPage: fromPage, toPage: toPage, surah: surahs[index] || '', linkFrom: linkFromData[index] ?? '', linkTo: linkToData[index] ?? '', reviewFrom: reviewFromData[index] ?? '', reviewTo: reviewToData[index] ?? '', round: calculateRoundNumber(index) }; }
        function calculateRoundNumber(originalIndex) { if (originalIndex < 32 || !reviewFromData || reviewFromData[originalIndex] == null || reviewFromData[originalIndex] === '') { return ''; } let reviewDataStartIndex = 32; let reviewCounter = 0; for(let i = reviewDataStartIndex; i <= originalIndex; i++){ if(reviewFromData[i] != null && reviewFromData[i] !== '') reviewCounter++; } if (reviewCounter === 0) return ''; return Math.ceil(reviewCounter / 6); }

        // --- UI Update Functions ---
        function showLoading(message = "جاري التحميل...") { if(loadingIndicator){ loadingIndicator.textContent = message; loadingIndicator.style.display = 'block';} if(dashboardContent) dashboardContent.style.display = 'none'; }
        function hideLoading() { if(loadingIndicator) loadingIndicator.style.display = 'none'; }
        function displayDashboard() { hideLoading(); if(dashboardContent) dashboardContent.style.display = 'block'; }

        // --- Functions to Calculate Stats from tableRows ---
        function calculateDashboardStats(tableRows) {
            let lastCompletedPage = 0; let linkedTasks = 0; let perfectedTasks = 0; let excuseCount = 0;
            if (!tableRows) return { memorizedPages: 0, linkedTasks: 0, perfectedTasks: 0, excuseCount: 0 };
            tableRows.forEach(row => {
                if (row.type === 'excuse') { excuseCount++; }
                else if (row.type === 'plan' && row.state?.completed) {
                    const planInfo = getPlanData(row.originalSequence);
                    if (planInfo && planInfo.toPage) { const pageNum = parseInt(planInfo.toPage); if (!isNaN(pageNum)) { lastCompletedPage = Math.max(lastCompletedPage, pageNum); } }
                    if (planInfo && planInfo.linkTo !== '' && row.state.linked) { linkedTasks++; }
                    if (planInfo && planInfo.reviewTo !== '' && row.state.reviewed) { perfectedTasks++; }
                }
            });
            const memorizedPages = Math.min(lastCompletedPage, totalQuranPages);
            return { memorizedPages: memorizedPages, linkedTasks: linkedTasks, perfectedTasks: perfectedTasks, excuseCount: excuseCount };
        }

        // --- START: New Functions for Streak, Level, and Calendar ---

        // Level Titles (Customize these!)
        const levelTitles = [
            "ابدأ رحلتك!", "🌱 غرسة الإيمان", "✨ بادرة أمل", "🏃 ساعٍ للعلا", "⭐ نجم صاعد",
            "💪 مثابر مجتهد", "🧭 على الدرب", "💯 صاحب السبعين", "🚀 انطلاقة قوية", "💎 جوهرة مصقولة",
            "👑 صاحب المئة يوم", "📖 رفيق القرآن", "🕯️ منارة هدى", "🏔️ قمة شامخة", "🌳 شجرة طيبة",
            "⏳ عابر منتصف الطريق", "🎯 دقة والتزام", "🌊 بحر زاخر", "🌟 كوكب دري", "🧭 بوصلة الحق",
            "💯💯 المئتان لا تقفان!", "🤲 قلب خاشع", "🕊️ روح مطمئنة", "💖 محب للرحمن", "🙏 عبد شكور",
            "💡 بصيرة نافذة", "🕌 معمّر بيوت الله", "🌙 هلال الكمال", "✨ نور على نور", "🏁 قاب قوسين أو أدنى",
            "🏆 فارس الثلاثمائة", "🎉 مقترب من الختام", "🎊 خاتم مبارك",
        ];
        const levelIcons = { 10: '👑', 20: '💯', 30: '🏆', 32: '🎊' };

        function calculateStreaksAndLevel(tableRows) {
             if (!tableRows || tableRows.length === 0) {
                 return { currentStreak: 0, longestStreak: 0, currentLevel: 0, currentTitle: levelTitles[0], currentIcon: '' };
             }
             const sortedRows = [...tableRows].sort((a, b) => new Date(a.displayDate) - new Date(b.displayDate));
             let currentStreak = 0; let longestStreak = 0; let currentRun = 0;
             const todayStr = formatDate(new Date());
             let isStreakActiveToday = false;

             for (const row of sortedRows) {
                 if (row.displayDate > todayStr) break;
                 if (row.type === 'plan' && row.state?.completed) {
                     currentRun++;
                     if(row.displayDate === todayStr) isStreakActiveToday = true;
                 } else if (row.type === 'excuse') {
                     if (currentRun > longestStreak) longestStreak = currentRun;
                     if(row.displayDate === todayStr) isStreakActiveToday = false;
                     // Don't reset currentRun, excuse pauses streak
                 } else { // Missed day or non-plan/excuse row
                     if (currentRun > longestStreak) longestStreak = currentRun;
                     currentRun = 0;
                     isStreakActiveToday = false;
                 }
             }
             if (currentRun > longestStreak) longestStreak = currentRun;

             // Recalculate current streak from end backwards
             let tempCurrentStreak = 0;
             let streakBroken = false;
             for (let i = sortedRows.length - 1; i >= 0; i--) {
                const row = sortedRows[i];
                if (row.displayDate > todayStr) continue; // Only consider days up to today

                 if (row.type === 'plan' && row.state?.completed) {
                     if (!streakBroken) tempCurrentStreak++;
                 } else if (row.type === 'excuse') {
                     // Excuses don't break the *potential* current streak when counting backwards,
                     // but they don't count towards it either.
                     continue;
                 } else {
                    // A non-completed, non-excuse day breaks the current streak definitively.
                    streakBroken = true;
                    // If this break happened before today, the streak ended earlier.
                    // If it happened today, the streak is 0.
                    if (row.displayDate === todayStr) {
                        tempCurrentStreak = 0; // Reset if today is the break
                    }
                    break; // Stop counting backwards once a definitive break is found
                 }
             }

            // Edge case: If the loop finished without a break, but today wasn't completed or excuse
            const lastRelevantRow = sortedRows.slice().reverse().find(r => r.displayDate <= todayStr);
            if (!streakBroken && lastRelevantRow && lastRelevantRow.displayDate < todayStr) {
                // If the last recorded day was before today and was completed, the streak ended yesterday.
                // But the loop calculated it. We need to check if today exists and breaks it.
                const todayRow = sortedRows.find(r => r.displayDate === todayStr);
                 if (!todayRow || (todayRow.type !== 'plan' || !todayRow.state?.completed) && todayRow.type !== 'excuse') {
                    // If today doesn't exist, or is not completed/excused, the current streak is 0
                     tempCurrentStreak = 0;
                 }
            }


             currentStreak = tempCurrentStreak;

             const levelIndex = Math.min(Math.floor(currentStreak / 10), levelTitles.length - 1);
             const currentTitle = levelTitles[levelIndex] || levelTitles[0];
             const currentIcon = levelIcons[levelIndex] || '';

             return { currentStreak: currentStreak, longestStreak: longestStreak, currentLevel: levelIndex, currentTitle: currentTitle, currentIcon: currentIcon };
        }

        // --- START: !! NEW Calendar Coloring Code !! ---

        /**
         * Applies custom CSS classes to calendar days based on the dayStatus object.
         */
/**
 * تطبق كلاسات CSS المخصصة على أيام التقويم بناءً على كائن dayStatus.
 */
function applyCustomColoring() {
    console.log("Attempting to apply custom coloring..."); // <-- سجل المحاولة
    setTimeout(() => {
        if (!calendarContainer) {
             console.error("Coloring failed: Calendar container not found.");
             return;
        }

        // المحدد لعناصر الأيام القابلة للنقر في Vanilla Calendar v2
        const dayElements = calendarContainer.querySelectorAll('.vcal-day__btn');
        console.log(`Found ${dayElements.length} day button elements with selector '.vcal-day__btn'.`); // <-- سجل عدد العناصر

        if (dayElements.length === 0) {
            console.warn("Coloring issue: No day elements found. Check the selector '.vcal-day__btn' or wait longer?");
            // يمكنك محاولة محدد أوسع مؤقتًا للتشخيص، مثل:
            // const allElements = calendarContainer.querySelectorAll('*');
            // console.log('All elements inside container:', allElements);
        }

        let appliedCount = 0;
        dayElements.forEach((buttonElement, index) => {
            // البحث عن العنصر الداخلي الذي يحمل التاريخ
            const dateSpan = buttonElement.querySelector('[data-calendar-date]');

            // --- تشخيص إضافي ---
            if (!dateSpan) {
                // إذا لم نجد التاريخ، سجل العنصر الأب لنرى هيكله
                // console.log(`Index ${index}: Button found, but inner element with [data-calendar-date] NOT found. Button HTML:`, buttonElement.outerHTML);
                return; // انتقل للعنصر التالي
            }

            const dateAttribute = dateSpan.dataset.calendarDate; // الحصول على التاريخ 'YYYY-MM-DD'

            if (!dateAttribute || !/^\d{4}-\d{2}-\d{2}$/.test(dateAttribute)) {
                 console.warn(`Index ${index}: Found date attribute, but format is invalid: '${dateAttribute}'. Expected YYYY-MM-DD.`);
                 return; // انتقل للعنصر التالي
            }
            // --- نهاية التشخيص الإضافي ---

            // إزالة الكلاسات القديمة لضمان عدم التراكم
            buttonElement.classList.remove('day-completed', 'day-excused');

            // التحقق من الحالة في كائن dayStatus وتطبيق الكلاس الجديد على الزر نفسه
            const status = dayStatus[dateAttribute]; // احصل على الحالة
            if (status === 'completed') {
                buttonElement.classList.add('day-completed');
                // console.log(`Applied 'day-completed' to ${dateAttribute}`); // <-- سجل عند التطبيق
                appliedCount++;
            } else if (status === 'excused') {
                buttonElement.classList.add('day-excused');
                // console.log(`Applied 'day-excused' to ${dateAttribute}`); // <-- سجل عند التطبيق
                appliedCount++;
            }
        });
       console.log(`Custom coloring logic finished. Applied colors to ${appliedCount} days.`); // <-- سجل النتيجة النهائية

    }, 300); // <-- زدنا التأخير قليلاً للتجربة (300ms)
}

/**
 * تهيئة Vanilla Calendar وتطبيق التلوين المخصص.
 * @param {Array} tableRows - مصفوفة بيانات الصفوف من Firestore.
 */
function initializeAndColorCalendar(tableRows) {
    console.log("Initializing calendar with manual coloring approach...");
    const calendarContainer = document.getElementById('calendar-container');

    if (!calendarContainer) {
        console.error("Calendar container '#calendar-container' not found!");
        return;
    }

    // 1. تحضير كائن dayStatus من tableRows
    dayStatus = {}; // إعادة تعيين الكائن قبل ملئه
    if (tableRows && Array.isArray(tableRows)) {
        tableRows.forEach(row => {
            if (row.displayDate && /^\d{4}-\d{2}-\d{2}$/.test(row.displayDate)) {
                if (row.type === 'plan' && row.state?.completed) {
                    dayStatus[row.displayDate] = 'completed';
                } else if (row.type === 'excuse') {
                    dayStatus[row.displayDate] = 'excused';
                }
            }
        });
        // !! سجل الكائن الناتج للتحقق منه !!
        console.log("Prepared dayStatus object:", JSON.stringify(dayStatus, null, 2));
        if (Object.keys(dayStatus).length === 0) {
            console.warn("dayStatus object is empty. No days will be colored.");
        }
    } else {
        console.log("No tableRows data provided for calendar status.");
    }

    const today = new Date();

    // 2. إعداد خيارات Vanilla Calendar الأساسية (بدون تلوين مدمج)
    const options = {
        settings: { lang: 'ar', iso8601: false, range: { disablePast: false, disableGaps: false, }, selection: { day: false, month: false, year: false, }, visibility: { theme: 'light', weekend: false, today: true, }, },
        actions: {
            update: (calendar) => {
                console.log('Calendar updated (e.g., month changed), reapplying coloring.');
                applyCustomColoring(); // إعادة تطبيق التلوين
            },
             clickDay(event, dates) { /* يمكنك إضافة وظيفة هنا */ },
        }
    };

    calendarContainer.innerHTML = ''; // مسح المحتوى المؤقت

    try {
        console.log("Initializing VanillaCalendar instance...");
        // Destroy previous instance if exists
        if (calendarInstance && typeof calendarInstance.destroy === 'function') {
             calendarInstance.destroy();
             console.log("Previous calendar instance destroyed.");
        }
        calendarInstance = new VanillaCalendar(calendarContainer, options);
        calendarInstance.init();
        console.log("Vanilla Calendar initialized successfully.");

        // 3. تطبيق التلوين لأول مرة بعد التهيئة مباشرة
        applyCustomColoring();

    } catch (error) {
        console.error("Error initializing Vanilla Calendar:", error);
        calendarContainer.innerHTML = `<p class="text" style="color:red;">Error initializing calendar. (${error.message})</p>`;
    }
}

        // --- END: !! NEW Calendar Coloring Code !! ---

        // --- MODIFIED Functions to Update Dashboard Sections ---
        function displayDailyTask() {
            if (!dailyTaskContent || !currentPlanData || !currentPlanData.tableRows) {
                if(dailyTaskContent) dailyTaskContent.innerHTML = '<p><i>جاري تحميل بيانات الخطة...</i></p>';
                if (todayDateSpan) todayDateSpan.textContent = formatDate(new Date());
                return;
            }
            const tableRows = currentPlanData.tableRows;
            const today = new Date();
            const todayStr = formatDate(today);
            if (todayDateSpan) todayDateSpan.textContent = todayStr;
            const todayRow = tableRows.find(row => row.displayDate === todayStr);

            if (!todayRow) { dailyTaskContent.innerHTML = '<p>لا يوجد واجب مقرر في الخطة لهذا اليوم.</p>'; }
            else if (todayRow.type === 'excuse') { dailyTaskContent.innerHTML = `<p style="color: orange; font-weight:bold;">لديك عذر مسجل لهذا اليوم (${todayRow.excuseType || ''}).</p>`; }
            else if (todayRow.type === 'plan' && todayRow.state?.completed) { dailyTaskContent.innerHTML = '<p style="color: green; font-weight: bold;">✅ الحمد لله، لقد أتممت واجب هذا اليوم!</p>'; }
            else if (todayRow.type === 'plan' && todayRow.state && !todayRow.state.completed) {
                const taskDetails = getPlanData(todayRow.originalSequence);
                if (taskDetails) {
                    let taskHTML = `<h4>المطلوب إنجازه اليوم (${todayStr}):</h4>`;
                    taskHTML += `<p><strong>الحفظ الجديد:</strong> ${taskDetails.fromPage ? `ص ${taskDetails.fromPage} - ${taskDetails.toPage}` : 'لا يوجد'} (${taskDetails.surah || 'مراجعة'})</p>`;
                    taskHTML += `<p><strong>الربط:</strong> ${taskDetails.linkFrom ? `من ${taskDetails.linkFrom} إلى ${taskDetails.linkTo}` : 'لا يوجد'}</p>`;
                    taskHTML += `<p><strong>المراجعة:</strong> ${taskDetails.reviewFrom ? `من ${taskDetails.reviewFrom} إلى ${taskDetails.reviewTo}` : 'لا يوجد'} ${taskDetails.round ? `(ج${taskDetails.round})` : ''}</p>`;
                    dailyTaskContent.innerHTML = taskHTML;
                } else { dailyTaskContent.innerHTML = `<p><i>خطأ: لم يتم العثور على تفاصيل الواجب للفهرس ${todayRow.originalSequence}.</i></p>`; }
            } else { dailyTaskContent.innerHTML = '<p><i>واجب اليوم لم يكتمل بعد أو حالته غير معروفة.</i></p>'; }
        }
        function displayProgress(stats) {
            if (!currentPlanData) return;
            const planType = currentPlanData.planType || '?';
            const memorizedPages = stats.memorizedPages;
            const progressPercent = totalQuranPages > 0 ? Math.min(100, (memorizedPages / totalQuranPages) * 100).toFixed(0) : 0;
            if(currentPlanNameSpan) currentPlanNameSpan.textContent = `خطة ${planType} صفحات`;
            if(progressBarValue) { progressBarValue.style.width = `${progressPercent}%`; progressBarValue.textContent = `${progressPercent}%`; }
            if(completedPagesProgressSpan) completedPagesProgressSpan.textContent = memorizedPages;
        }
        function displayStats(stats) {
            if(statMemorized) statMemorized.textContent = stats.memorizedPages;
            if(statPerfected) statPerfected.textContent = stats.perfectedTasks;
            if(statLinked) statLinked.textContent = stats.linkedTasks;
            if(statExcuses) statExcuses.textContent = stats.excuseCount;
        }
        function displayStreakAndLevel(streakData) {
            if(currentStreakSpan) currentStreakSpan.textContent = streakData.currentStreak;
            if(longestStreakSpan) longestStreakSpan.textContent = streakData.longestStreak;
            if(levelTitleSpan) levelTitleSpan.textContent = streakData.currentTitle;
            if(levelIconSpan) levelIconSpan.textContent = streakData.currentIcon;
        }

        // --- Main Data Loading Function (MODIFIED to call new calendar function) ---
        function loadDashboardData(user) {
            if (!user) return;
            const uid = user.uid;
            const planRef = db.collection("quranPlans").doc(uid);
            console.log("Dashboard: Checking Firestore for plan:", uid);
            showLoading("جاري تحميل بيانات خطتك...");

            planRef.get().then((doc) => {
                hideLoading();
                if (doc.exists) {
                    console.log("Dashboard: Plan data found.");
                    currentPlanData = doc.data(); // Store FULL data globally

                    // Validate FULL data needed for dashboard
                    if (!currentPlanData.startDate || !currentPlanData.planType || !currentPlanData.tableRows || !Array.isArray(currentPlanData.tableRows) || !currentPlanData.repetitionMax) {
                        console.error("Loaded data missing required fields (startDate, planType, tableRows array, or repetitionMax).", currentPlanData);
                        dashboardContent.style.display = 'block'; // Show content area to display error
                        dailyTaskContent.innerHTML = `<p style="color:red; font-weight:bold;">خطأ: بيانات خطتك المحفوظة غير مكتملة أو تالفة. يرجى <a href="index.html">الذهاب لصفحة البداية</a> وإعادة إنشاء الخطة.</p>`;
                        // Hide sections that rely on valid data
                        const sectionsToHideOnError = ['plan-progress', 'quick-stats', 'calendar-view', 'streak-level', 'competition-section', 'badges-section'];
                        sectionsToHideOnError.forEach(id => {
                            const section = document.getElementById(id);
                            if (section) section.style.display = 'none';
                        });
                        return;
                    }

                    // --- Process Data & Update UI ---
                    const stats = calculateDashboardStats(currentPlanData.tableRows);
                    const streakData = calculateStreaksAndLevel(currentPlanData.tableRows);

                    displayDailyTask();
                    displayProgress(stats);
                    displayStats(stats);
                    displayStreakAndLevel(streakData);

                    // --- !! MODIFIED CALL: Initialize Calendar using the NEW function !! ---
                    initializeAndColorCalendar(currentPlanData.tableRows); // <-- Use the new function here

                    // Show the fully populated dashboard
                    displayDashboard();

                } else {
                    // No plan found logic
                    console.log("Dashboard: No plan data found.");
                    displayDashboard(); // Show main area
                    dailyTaskContent.innerHTML = '<p style="color:orange; font-weight:bold;">لم تقم باختيار أو إنشاء خطة بعد!</p><p>اذهب إلى <a href="index.html">صفحة البداية</a> لاختيار خطتك.</p>';
                     // Hide sections requiring data
                    const sectionsToHide = ['plan-progress', 'quick-stats', 'calendar-view', 'streak-level', 'competition-section', 'badges-section'];
                    sectionsToHide.forEach(id => {
                        const section = document.getElementById(id);
                        if (section) section.style.display = 'none';
                    });
                }
            }).catch((error) => {
                // Error handling
                console.error("Error getting plan document:", error);
                hideLoading();
                displayDashboard(); // Show main area to display error
                dailyTaskContent.innerHTML = `<p style="color:red; font-weight:bold;">حدث خطأ أثناء تحميل بيانات الخطة. (${error.code || 'UNKNOWN'})</p><p>يرجى المحاولة مرة أخرى أو التأكد من اتصالك بالإنترنت وقواعد الأمان في Firestore. <a href="index.html">العودة للرئيسية</a></p>`;
                // Hide sections requiring data on error
                const sectionsToHideOnError = ['plan-progress', 'quick-stats', 'calendar-view', 'streak-level', 'competition-section', 'badges-section'];
                sectionsToHideOnError.forEach(id => {
                    const section = document.getElementById(id);
                    if (section) section.style.display = 'none';
                });
            });
        }

        // --- Authentication Listener ---
        auth.onAuthStateChanged(user => {
           // hideLoading(); // Hide loading should happen inside loadDashboardData or its error/success paths
           currentUser = user;
           if (user) {
               console.log("Dashboard: Auth state OK.");
               loadDashboardData(user);
           } else {
               console.log("Dashboard: Not logged in.");
               // Show login message instead of redirecting immediately
               showLoading("غير مسجل الدخول. يرجى تسجيل الدخول أولاً."); // Use showLoading to hide dashboard content
               console.warn("User not logged in, dashboard will not load data.");
               if(dashboardContent) dashboardContent.style.display = 'block'; // Show main area
               if(dailyTaskContent) dailyTaskContent.innerHTML = '<p style="color:red;">يرجى <a href="index.html">تسجيل الدخول</a> لعرض لوحة المتابعة.</p>';
               // Hide sections requiring data
               const sectionsToHide = ['plan-progress', 'quick-stats', 'calendar-view', 'streak-level', 'competition-section', 'badges-section'];
               sectionsToHide.forEach(id => {
                   const section = document.getElementById(id);
                   if (section) section.style.display = 'none';
               });
               hideLoading(); // Make sure loading indicator is hidden after showing the login message
           }
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            showLoading("جاري التحقق من تسجيل الدخول...");
            // Authentication listener (onAuthStateChanged) will handle the rest
        });

        // --- Print Function (Keep as is) ---
        function printData() { console.log("Initiating browser print..."); window.print(); }

    </script>
    </body>
</html>