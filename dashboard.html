<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة المتابعة - خطة حفظ القرآن</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

    <link href="jsCalendar.min.css" rel="stylesheet">
    <script src="jsCalendar.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

    <style>
        /* --- CSS Styles العامة (تبقى كما هي) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; background-color: #f4f7f6; color: #333; line-height: 1.7; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        h1, h2, h3, h4 { color: #1a5276; margin-bottom: 0.75em; }
        p { margin-bottom: 1em; color: #555; font-size: 0.95em; }
        a { text-decoration: none; color: #2980b9; }
        .card { background-color: #fff; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 3px 6px rgba(0,0,0,0.05); border: 1px solid #e0e0e0; }

        /* --- Header (تبقى كما هي) --- */
        .dashboard-header { display: flex; justify-content: center; align-items: center; padding: 10px 20px; margin-bottom: 25px; border-bottom: 2px solid #aed6f1; background-color: #fff; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .dashboard-header .logo h1 { margin: 0; font-size: 1.8em; color: #1a5276; }

        /* --- Dashboard Layout (تبقى كما هي) --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: auto; gap: 25px; }
        #daily-task { grid-column: span 2; }
        #plan-progress { grid-column: 1 / 2; grid-row: 2 / 3; }
        #quick-stats { grid-column: 1 / 2; grid-row: 3 / 4; }
        #streak-level { grid-column: 2 / 4; grid-row: 2 / 3; }
        #calendar-view { grid-column: 2 / 4; grid-row: 3 / 4; }

        /* --- Section Specific Styles (تبقى كما هي) --- */
        #daily-task h3 { color: #1e8449; font-size: 1.3em; border-bottom: 2px solid #aed6f1; padding-bottom: 8px;}
        #daily-task-content { min-height: 80px; padding-top: 10px;}
        #daily-task-content p { margin-bottom: 0.6em; font-size: 1.05em; line-height: 1.8; }
        #daily-task-content strong { color: #1a5276; margin-left: 8px;}
        #daily-task .plan-link { margin-top: 15px; display: inline-block; font-size: 0.9em; background-color: #5dade2; color: white; padding: 5px 10px; border-radius: 4px; }
        #daily-task .plan-link:hover { background-color: #3498db; }
        #plan-progress h3, #quick-stats h3, #calendar-view h3, #competition-section h3, #badges-section h3, #streak-level h3 { font-size: 1.15em; }
        #plan-progress .progress-bar-container { background-color: #e9ecef; border-radius: 0.25rem; height: 25px; overflow: hidden; margin-top: 10px; border: 1px solid #ccc; }
        #plan-progress .progress-bar-value { background-color: #28a745; height: 100%; width: 0%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.9em; font-weight: bold; transition: width 0.6s ease-in-out; }
        #quick-stats ul { list-style: none; padding: 0; margin-top: 15px;}
        #quick-stats ul li { margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px dotted #eee; font-size: 0.95em;}
        #quick-stats ul li strong { margin-left: 5px; color: #1a5276; min-width: 110px; display: inline-block;}
        #quick-stats ul li span { color: #1e8449; font-weight: bold;}
        #streak-level .streak-info { display: flex; justify-content: space-around; text-align: center; margin: 15px 0; }
        #streak-level .streak-info div { background-color: #eaf2f8; padding: 10px 15px; border-radius: 6px; border: 1px solid #d4e6f1; }
        #streak-level .streak-info strong { display: block; font-size: 1.5em; color: #1e8449; }
        #streak-level .level-title-container { text-align: center; margin-top: 15px; }
        #streak-level #level-title { font-size: 1.2em; color: #2c3e50; font-weight: bold; }
        #streak-level #level-icon { font-size: 1.5em; margin-left: 10px; }

        /* --- Calendar Styles (jsCalendar) --- */
        #calendar-view { min-height: 280px; }
        #calendar-container { margin-top: 15px; }

        /* --- تمت إزالة قواعد CSS الخاصة بإصلاح التوزيع --- */
        /* #calendar-container .jsCalendar-table { ... } */
        /* #calendar-container .jsCalendar-table tr { ... } */
        /* #calendar-container .jsCalendar-table td, ... { ... } */

        /* --- تنسيقات التلوين الجديدة لـ jsCalendar (تستهدف TD) --- */
        td.jsCalendar-day.day-completed { /* استهداف الخلية TD مباشرة */
            background-color: #abebc6 !important;
            color: #186a3b !important;
            border-radius: 50% !important;
            font-weight: bold !important;
        }
        td.jsCalendar-day.day-excused { /* استهداف الخلية TD مباشرة */
            background-color: #fadbd8 !important;
            color: #922b21 !important;
            border-radius: 50% !important;
            font-weight: bold !important;
        }
         /* تنسيق اليوم الحالي (قد يضاف الكلاس للـ TD أيضاً) */
         td.jsCalendar-day.jsCalendar-today {
             background-color: #e3f2fd !important;
             border: 1px solid #aed6f1 !important;
             color: #1a5276 !important;
             border-radius: 50% !important;
         }
         /* التأكد من ظهور الرقم داخل الخلية الملونة */
         td.jsCalendar-day .jsCalendar-day-number {
              display: inline-block !important;
              width: 1.9em !important;
              line-height: 1.9em !important;
              text-align: center !important;
              border-radius: 50%;
              background-color: transparent !important;
              color: inherit !important;
         }
        /* --- نهاية تنسيقات jsCalendar --- */

        /* Placeholder Styles (تبقى كما هي) */
        .placeholder-box { /* ... */ }
        .placeholder-box .icon { /* ... */ }
        .placeholder-box .text { /* ... */ }

        /* Footer (تبقى كما هي) */
        .main-footer { /* ... */ }
        .main-footer a { /* ... */ }

        /* Action Buttons Hidden (تبقى كما هي) */
        .action-buttons { display: none; }

        /* Loading Indicator (تبقى كما هي) */
        #loading-indicator { /* ... */ }

        /* Responsive Adjustments (تبقى كما هي) */
        @media (max-width: 992px) { /* ... */ }
        @media (max-width: 768px) { /* ... */ }
        @media (max-width: 600px) { /* ... */ }
    </style>
</head>
<body>

    <div class="container">

        <header class="dashboard-header">
            <div class="logo"><h1>خطة حفظ القرآن الكريم</h1></div>
        </header>

        <div id="loading-indicator">جاري التحميل...</div>

        <main id="dashboard-content" style="display: none;">

            <div class="dashboard-grid">

                <section id="daily-task" class="card"> </section>
                <section id="plan-progress" class="card"> </section>
                <section id="quick-stats" class="card"> </section>
                <section id="streak-level" class="card"> </section>

                <section id="calendar-view" class="card">
                    <h3>التقويم والتتبع المرئي</h3>
                    <div id="calendar-container">
                        <p class="text" style="text-align: center; margin-top: 20px;">(جاري تحميل التقويم...)</p>
                    </div>
                </section>

                <section id="competition-section" class="card" style="display: none;"> </section>
                <section id="badges-section" class="card" style="display: none;"> </section>

            </div>
        </main>

        <footer class="main-footer">
             <p>&copy; 2025 خطة حفظ القرآن الكريم. جميع الحقوق محفوظة.</p>
        </footer>

    </div>

    <script>
        // --- Firebase Config (تبقى كما هي) ---
        const firebaseConfig = { /* ... */ };

        // --- Initialize Firebase (تبقى كما هي) ---
         try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Firebase initialization error:", e); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM References (تبقى كما هي) ---
        const loadingIndicator = document.getElementById('loading-indicator');
        const dashboardContent = document.getElementById('dashboard-content');
        // ... (بقية المراجع)
        const calendarContainer = document.getElementById('calendar-container');
        // ...

        // --- Constants (تبقى كما هي) ---
        const totalQuranPages = 604;
        const initialTotalRows = 320;

        // --- Global State (تبقى كما هي) ---
        let currentUser = null;
        let currentPlanData = null;

        // --- Data Arrays & Helper Functions (تبقى كما هي) ---
        const surahs = [/* ... */];
        const linkFromData = [/* ... */];
        const linkToData = [/* ... */];
        const reviewFromData = [/* ... */];
        const reviewToData = [/* ... */];
        function formatDate(date) { if (!(date instanceof Date)) date = new Date(date); if (isNaN(date.getTime())) return ""; const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
        function getPlanData(originalIndex) { const index = parseInt(originalIndex); if (isNaN(index) || index < 0 || index >= initialTotalRows) { return null; } let fromPage = '', toPage = ''; if (index < 299) { fromPage = index * 2 + 1; toPage = fromPage + 1; } else if (index === 299) { fromPage = 601; toPage = 604; } return { fromPage: fromPage, toPage: toPage, surah: surahs[index] || '', linkFrom: linkFromData[index] ?? '', linkTo: linkToData[index] ?? '', reviewFrom: reviewFromData[index] ?? '', reviewTo: reviewToData[index] ?? '', round: calculateRoundNumber(index) }; }
        function calculateRoundNumber(originalIndex) { if (originalIndex < 32 || !reviewFromData || reviewFromData[originalIndex] == null || reviewFromData[originalIndex] === '') { return ''; } let reviewDataStartIndex = 32; let reviewCounter = 0; for(let i = reviewDataStartIndex; i <= originalIndex; i++){ if(reviewFromData[i] != null && reviewFromData[i] !== '') reviewCounter++; } if (reviewCounter === 0) return ''; return Math.ceil(reviewCounter / 6); }

        // --- UI Update Functions (تبقى كما هي) ---
        function showLoading(message = "جاري التحميل...") { /* ... */ }
        function hideLoading() { /* ... */ }
        function displayDashboard() { /* ... */ }

        // --- Functions to Calculate Stats (تبقى كما هي) ---
        function calculateDashboardStats(tableRows) { /* ... الكود الأصلي ... */ }

        // --- Streak, Level Functions (تبقى كما هي) ---
        const levelTitles = [ /* ... */ ];
        const levelIcons = { /* ... */ };
        function calculateStreaksAndLevel(tableRows) { /* ... الكود الأصلي ... */ }

        // --- *** START: الدوال الجديدة للتقويم (jsCalendar + التلوين اليدوي) *** ---

        // --- دالة جديدة لتطبيق التلوين يدويًا بعد إنشاء التقويم ---
        function applyCustomHighlights(tableRows) {
            console.log("[Highlight Debug V2] Applying highlights...");
            const calendarContainer = document.getElementById('calendar-container');
            if (!calendarContainer || !tableRows) {
                 console.error("[Highlight Debug V2] Failed: Missing container or tableRows.");
                 return;
             }

            const dayStatus = {};
            tableRows.forEach(row => {
                if (row.displayDate) {
                    if (row.type === 'plan' && row.state?.completed) { dayStatus[row.displayDate] = 'completed'; }
                    else if (row.type === 'excuse') { dayStatus[row.displayDate] = 'excused'; }
                }
            });
            console.log("[Highlight Debug V2] Day status lookup:", dayStatus);

            // --- استهداف العنصر الصحيح: TD مع الكلاس jsCalendar-day ---
            const dayElements = calendarContainer.querySelectorAll('td.jsCalendar-day'); // *** تم تحديث المحدد ***
            console.log(`[Highlight Debug V2] Found ${dayElements.length} TD elements with class 'jsCalendar-day'.`);

            let appliedCount = 0;
            dayElements.forEach((element, index) => {
                const dateStringFromAttr = element.dataset.date; // التاريخ كنص طويل

                // --- إزالة الكلاسات القديمة أولاً ---
                element.classList.remove('day-completed', 'day-excused');

                if (dateStringFromAttr) {
                    try {
                        // --- تحويل صيغة التاريخ ---
                        const dateObject = new Date(dateStringFromAttr);
                        if (isNaN(dateObject.getTime())) {
                             console.warn(`[Highlight Debug V2] Could not parse date from attribute: ${dateStringFromAttr}`);
                             return;
                        }
                        const formattedDateKey = formatDate(dateObject); // تحويل إلى YYYY-MM-DD

                        // --- البحث عن الحالة باستخدام الصيغة الصحيحة ---
                        const status = dayStatus[formattedDateKey];

                        if (status === 'completed') {
                            // console.log(`[Highlight Debug V2] Applying 'day-completed' to TD for: ${formattedDateKey}`);
                            element.classList.add('day-completed'); // إضافة الكلاس للخلية TD
                            appliedCount++;
                        } else if (status === 'excused') {
                            // console.log(`[Highlight Debug V2] Applying 'day-excused' to TD for: ${formattedDateKey}`);
                            element.classList.add('day-excused'); // إضافة الكلاس للخلية TD
                            appliedCount++;
                        }
                    } catch(e) {
                         console.error(`[Highlight Debug V2] Error processing date ${dateStringFromAttr}:`, e);
                    }
                } else {
                     console.warn(`[Highlight Debug V2] TD element ${index} has no data-date attribute.`);
                }
            });
            console.log(`[Highlight Debug V2] Finished applying highlights. Applied ${appliedCount} classes to TD elements.`);
            if (appliedCount === 0 && Object.keys(dayStatus).length > 0) {
                 console.warn("[Highlight Debug V2] No classes applied, but statuses exist. Check date matching and CSS rules.");
            }
             console.warn("[Highlight Debug V2] Reminder: Check CSS rules target td.jsCalendar-day.day-completed / .day-excused");
        }


        // --- دالة تهيئة التقويم الجديدة (jsCalendar) مع تعديلات اللغة والترتيب ---
        function initializeCalendar(tableRows) {
            console.log("Initializing jsCalendar with language/layout fixes...");
            const calendarContainer = document.getElementById('calendar-container');
            if (!calendarContainer) { console.error("Calendar container not found!"); return; }
            calendarContainer.innerHTML = '';

            const today = new Date();
            try {
                const targetElement = calendarContainer;

                // إنشاء نسخة التقويم باستخدام new
                const calendarInstance = new jsCalendar(targetElement, today, {
                     // language: 'ar', // تمت إزالة هذا السطر، سنستخدم setLanguage
                     monthFormat: 'MMMM<y_bin_46>', // تنسيق الشهر والسنة
                     fdotw: 6 // <<== تحديد السبت (6) كأول يوم في الأسبوع
                     // تمت إزالة مصفوفات الشهور والأيام من هنا
                });

                // *** محاولة تعيين اللغة بعد التهيئة ***
                if (calendarInstance && typeof calendarInstance.setLanguage === 'function') {
                     calendarInstance.setLanguage('ar'); // استخدام كود اللغة 'ar'
                     console.log("jsCalendar language attempted to set to 'ar' via method.");
                } else {
                     console.warn("Could not set jsCalendar language via method (method not found?).");
                     // كحل بديل إذا فشل تعيين اللغة، يمكن إضافة الكود التالي لتغيير النصوص يدويًا
                     // لكن الأفضل أن تعمل setLanguage
                     /*
                     const titleElement = targetElement.querySelector('.jsCalendar-title-name');
                     if (titleElement) {
                         const currentMonth = today.getMonth();
                         const currentYear = today.getFullYear();
                         const arabicMonths = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
                         titleElement.textContent = `${arabicMonths[currentMonth]} ${currentYear}`;
                     }
                     const dayHeaders = targetElement.querySelectorAll('.jsCalendar-table th');
                     const arabicDays = ["ح", "ن", "ث", "ر", "خ", "ج", "س"]; // أو الأسماء الكاملة
                     if (dayHeaders.length === 7) { // تأكد من وجود 7 أيام
                         // الترتيب يعتمد على fdotw=6 (السبت أولاً)
                         const orderedArabicDays = ["س", "ح", "ن", "ث", "ر", "خ", "ج"];
                         dayHeaders.forEach((th, index) => {
                             th.textContent = orderedArabicDays[index];
                         });
                     }
                     */
                }

                console.log("jsCalendar initialized successfully (with layout/lang fixes).");

                // استدعاء دالة التلوين اليدوي بعد التهيئة مع تأخير
                setTimeout(() => {
                    applyCustomHighlights(tableRows);
                }, 300); // <<== زيادة التأخير قليلاً (300ms)

            } catch (error) {
                console.error("Error initializing jsCalendar:", error);
                calendarContainer.innerHTML = `<p class="text" style="color:red;">Error loading calendar. (${error.message})</p>`;
            }
        }
        // --- *** END: الدوال الجديدة للتقويم *** ---


        // --- الدوال الأخرى (تبقى كما هي) ---
        function displayDailyTask() { /* ... الكود الأصلي ... */ }
        function displayProgress(stats) { /* ... الكود الأصلي ... */ }
        function displayStats(stats) { /* ... الكود الأصلي ... */ }
        function displayStreakAndLevel(streakData) { /* ... الكود الأصلي ... */ }

        // --- Main Data Loading Function (تبقى كما هي) ---
        function loadDashboardData(user) {
            if (!user) return;
            const uid = user.uid;
            const planRef = db.collection("quranPlans").doc(uid);
            console.log("Dashboard: Checking Firestore for plan:", uid);
            showLoading("جاري تحميل بيانات خطتك...");
            planRef.get().then((doc) => {
                hideLoading();
                if (doc.exists) {
                    console.log("Dashboard: Plan data found.");
                    currentPlanData = doc.data();
                    if (!currentPlanData.startDate || !currentPlanData.planType || !currentPlanData.tableRows || !Array.isArray(currentPlanData.tableRows) || !currentPlanData.repetitionMax) {
                         console.error("Loaded data missing required fields.");
                         dashboardContent.style.display = 'block';
                         dailyTaskContent.innerHTML = `<p style="color:red; font-weight:bold;">خطأ: بيانات خطتك المحفوظة غير مكتملة أو تالفة. يرجى <a href="index.html">الذهاب لصفحة البداية</a> وإعادة إنشاء الخطة.</p>`;
                         const sectionsToHide = ['plan-progress', 'quick-stats', 'calendar-view', 'streak-level'];
                         sectionsToHide.forEach(id => { const el = document.getElementById(id); if(el) el.style.display = 'none'; });
                         return;
                     }
                    // Process Data & Update UI
                    const stats = typeof calculateDashboardStats === 'function' ? calculateDashboardStats(currentPlanData.tableRows) : { memorizedPages: 0, linkedTasks: 0, perfectedTasks: 0, excuseCount: 0 };
                    const streakData = typeof calculateStreaksAndLevel === 'function' ? calculateStreaksAndLevel(currentPlanData.tableRows) : { currentStreak: 0, longestStreak: 0, currentLevel: 0, currentTitle: levelTitles[0], currentIcon: '' };

                    if (typeof displayDailyTask === 'function') displayDailyTask(); else console.error("displayDailyTask is not defined");
                    if (typeof displayProgress === 'function') displayProgress(stats); else console.error("displayProgress is not defined");
                    if (typeof displayStats === 'function') displayStats(stats); else console.error("displayStats is not defined");
                    if (typeof displayStreakAndLevel === 'function') displayStreakAndLevel(streakData); else console.error("displayStreakAndLevel is not defined");
                    if (typeof initializeCalendar === 'function') initializeCalendar(currentPlanData.tableRows); // استدعاء دالة التقويم الجديدة
                    else console.error("initializeCalendar function is not defined!");

                    if (typeof displayDashboard === 'function') displayDashboard(); else console.error("displayDashboard function is not defined!");

                } else {
                     // No plan found logic
                     console.log("Dashboard: No plan data found.");
                     if (typeof displayDashboard === 'function') displayDashboard();
                     if(dailyTaskContent) dailyTaskContent.innerHTML = '<p style="color:orange; font-weight:bold;">لم تقم باختيار أو إنشاء خطة بعد!</p><p>اذهب إلى <a href="index.html">صفحة البداية</a> لاختيار خطتك.</p>';
                     const sectionsToHide = ['plan-progress', 'quick-stats', 'calendar-view', 'streak-level', 'competition-section', 'badges-section'];
                     sectionsToHide.forEach(id => { const el = document.getElementById(id); if(el) el.style.display = 'none'; });
                 }
            }).catch((error) => {
                 // Error handling
                 console.error("Error getting plan document:", error); // طباعة الخطأ الفعلي هنا
                 hideLoading();
                 if (typeof displayDashboard === 'function') displayDashboard();
                 if(dailyTaskContent) dailyTaskContent.innerHTML = `<p style="color:red; font-weight:bold;">حدث خطأ أثناء تحميل بيانات الخطة. (${error.code || error.message || 'UNKNOWN'})</p><p>يرجى المحاولة مرة أخرى أو التأكد من اتصالك بالإنترنت وقواعد الأمان في Firestore. <a href="index.html">العودة للرئيسية</a></p>`;
                 const sectionsToHide = ['plan-progress', 'quick-stats', 'calendar-view', 'streak-level', 'competition-section', 'badges-section'];
                 sectionsToHide.forEach(id => { const el = document.getElementById(id); if(el) el.style.display = 'none'; });
            });
        }

        // --- Authentication Listener (تبقى كما هي) ---
        auth.onAuthStateChanged(user => {
           hideLoading();
           currentUser = user;
           if (user) {
               console.log("Dashboard: Auth state OK.");
               loadDashboardData(user);
           } else {
               console.log("Dashboard: Not logged in.");
                showLoading("غير مسجل الدخول. يرجى تسجيل الدخول أولاً.");
                console.warn("User not logged in, dashboard will not load data.");
                if(dashboardContent) dashboardContent.style.display = 'block';
                if(dailyTaskContent) dailyTaskContent.innerHTML = '<p style="color:red;">يرجى <a href="index.html">تسجيل الدخول</a> لعرض لوحة المتابعة.</p>';
                const sectionsToHide = ['plan-progress', 'quick-stats', 'calendar-view', 'streak-level', 'competition-section', 'badges-section'];
                sectionsToHide.forEach(id => { const section = document.getElementById(id); if (section) section.style.display = 'none'; });
           }
        });

        // --- Initial Load (تبقى كما هي) ---
        document.addEventListener('DOMContentLoaded', () => {
            showLoading("جاري التحقق من تسجيل الدخول...");
        });

         // --- Print Function (تبقى كما هي) ---
         function printData() { console.log("Initiating browser print..."); window.print(); }

    </script>

</body>
</html>
