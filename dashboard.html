<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة المتابعة - خطة حفظ القرآن</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

    <link href="vanilla-calendar.min.css" rel="stylesheet">
    <script src="vanilla-calendar.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

    <style>
        /* --- General Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; background-color: #f4f7f6; color: #333; line-height: 1.7; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        h1, h2, h3, h4 { color: #1a5276; margin-bottom: 0.75em; }
        p { margin-bottom: 1em; color: #555; font-size: 0.95em; }
        a { text-decoration: none; color: #2980b9; }
        .card { background-color: #fff; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 3px 6px rgba(0,0,0,0.05); border: 1px solid #e0e0e0; }

        /* --- Header --- */
        .dashboard-header { display: flex; justify-content: center; align-items: center; padding: 10px 20px; margin-bottom: 25px; border-bottom: 2px solid #aed6f1; background-color: #fff; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .dashboard-header .logo h1 { margin: 0; font-size: 1.8em; color: #1a5276; }

        /* --- Dashboard Layout --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: auto auto auto;
            gap: 25px;
            align-items: start;
        }
        #daily-task { grid-column: 1 / 4; grid-row: 1 / 2; }
        #plan-progress { grid-column: 1 / 2; grid-row: 2 / 3; }
        #quick-stats { grid-column: 1 / 2; grid-row: 3 / 4; }
        #calendar-view {
            grid-column: 2 / 4;
            grid-row: 2 / 4;
            display: flex;
            flex-direction: column;
        }

        /* --- Section Specific Styles --- */
        #daily-task h3 { color: #1e8449; font-size: 1.3em; border-bottom: 2px solid #aed6f1; padding-bottom: 8px;}
        #daily-task-content { min-height: 80px; padding-top: 10px;}
        #daily-task-content p { margin-bottom: 0.6em; font-size: 1.05em; line-height: 1.8; }
        #daily-task-content strong { color: #1a5276; margin-left: 8px;}
        #daily-task .plan-link { margin-top: 15px; display: inline-block; font-size: 0.9em; background-color: #5dade2; color: white; padding: 5px 10px; border-radius: 4px; }
        #daily-task .plan-link:hover { background-color: #3498db; }

        #plan-progress h3, #quick-stats h3, #calendar-view h3, #competition-section h3, #badges-section h3 { font-size: 1.15em; }
        #plan-progress .progress-bar-container { background-color: #e9ecef; border-radius: 0.25rem; height: 25px; overflow: hidden; margin-top: 10px; border: 1px solid #ccc; }
        #plan-progress .progress-bar-value { background-color: #28a745; height: 100%; width: 0%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.9em; font-weight: bold; transition: width 0.6s ease-in-out; }
        #quick-stats ul { list-style: none; padding: 0; margin-top: 15px;}
        #quick-stats ul li { margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px dotted #eee; font-size: 0.95em;}
        #quick-stats ul li strong { margin-left: 5px; color: #1a5276; min-width: 110px; display: inline-block;}
        #quick-stats ul li span { color: #1e8449; font-weight: bold;}

        /* --- Calendar Section Styles --- */
        #calendar-view .card-header {
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 15px; width: 100%; flex-shrink: 0;
        }
        #calendar-view .card-header h3 { margin-bottom: 0; }
        #calendar-container {
            direction: ltr; width: 100%; max-width: 450px;
            margin: 0 auto 15px auto; min-height: 300px; flex-shrink: 0;
        }
        /* Today Button styles removed */

        /* --- Streak Info (Inside Calendar Card) Styles --- */
        .streak-info-condensed {
            border-top: 1px solid #eee; margin: 15px auto 0 auto; padding: 15px; text-align: center;
            width: 100%; max-width: 450px; flex-shrink: 0;
        }
        .streak-info-condensed h4 { font-size: 1.05em; color: #1a5276; margin-bottom: 10px; }
        .streak-info-condensed .streak-boxes { display: flex; justify-content: space-around; gap: 10px; margin-bottom: 15px; }
        .streak-info-condensed .streak-box { background-color: #eaf2f8; padding: 8px 12px; border-radius: 6px; border: 1px solid #d4e6f1; font-size: 0.9em; flex: 1; position: relative; min-width: 120px; }
        .streak-info-condensed .streak-box strong { display: block; font-size: 1.4em; color: #1e8449; margin-top: 2px; }
        .streak-info-condensed .level-display-wrapper { position: relative; display: inline-block; padding-left: 25px; text-align: right; }
        /* Level & Title Styling */
        .streak-info-condensed .level-number-display,
        .streak-info-condensed .level-title-display {
            display: block; font-size: 1.0em; color: #2c3e50; /* Same color */
            font-weight: bold; line-height: 1.4; /* Same font */
        }
         .streak-info-condensed .level-number-display { margin-bottom: 3px; } /* Space below level */
         .streak-info-condensed .level-title-display .level-icon { font-size: 1.1em; margin-right: 3px; vertical-align: middle; }
        /* Info Icon Styling */
        .info-icon {
            display: inline-block;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; /* Use system font */
            font-weight: normal; /* Normal weight */
            font-style: normal; /* Normal style */
            color: #6c757d;
            background-color: #e9ecef;
            border-radius: 50%;
            width: 18px; /* Slightly larger */
            height: 18px;
            line-height: 18px; /* Center vertically */
            text-align: center;
            font-size: 0.9em; /* Adjust size */
            cursor: help;
            margin-right: 5px;
            vertical-align: middle;
            user-select: none; /* Prevent text selection */
        }
        /* Position icons */
        .streak-box .info-icon { position: absolute; left: 8px; top: 8px; }
        .level-display-wrapper .info-icon { position: absolute; left: 0; top: 50%; transform: translateY(-50%); }


        /* --- Base Calendar Styles (Vanilla Calendar) --- */
        .vanilla-calendar { border: 1px solid #ddd; border-radius: 4px; }
        .vanilla-calendar .vcal-header { background-color: #aed6f1; padding: 10px 0; border-bottom: 1px solid #ddd;}
        .vanilla-calendar .vcal-header__label { color: #1a5276; font-weight: bold; cursor: pointer; }
        .vanilla-calendar .vcal-arrow { background-color: #ffffff; border-radius: 50%; width: 30px; height: 30px; line-height: 30px; border: 1px solid #ccc; cursor: pointer;}
        .vanilla-calendar .vcal-arrow::before { border-color: #1a5276; }
        .vanilla-calendar .vcal-week { background-color: #eaf2f8; padding: 5px 0; display: flex; justify-content: space-around; }
        .vanilla-calendar .vcal-week span { color: #1a5276; font-weight: bold; font-size: 0.85em; text-align: center; flex: 1; }
        .vanilla-calendar .vcal-body { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; padding: 5px; }
        .vanilla-calendar .vcal-day { display: flex; justify-content: center; align-items: center; min-height: 36px; }


        /* --- Calendar Day Coloring CSS --- */
        /* These styles rely on the JS adding the classes */
        .vanilla-calendar .vanilla-calendar-day__btn { border: 1px solid transparent; background-color: transparent; cursor: pointer; width: 34px; height: 34px; padding: 0; display: flex; justify-content: center; align-items: center; font-size: 0.9em; position: relative; border-radius: 50%; transition: background-color 0.2s, color 0.2s, border-color 0.2s; color: #333; }
        .vanilla-calendar .vanilla-calendar-day__btn.day-completed { background-color: #abebc6 !important; color: #186a3b !important; font-weight: bold; border-color: #82e0aa !important; }
        .vanilla-calendar .vanilla-calendar-day__btn.day-excused { background-color: #fadbd8 !important; color: #922b21 !important; font-weight: bold; border-color: #f5b7b1 !important; }
        .vanilla-calendar .vanilla-calendar-day__btn.day-completed:hover { background-color: #82e0aa !important; border-color: #5fcf8f !important; }
        .vanilla-calendar .vanilla-calendar-day__btn.day-excused:hover { background-color: #f5b7b1 !important; border-color: #e59894 !important; }
        .vanilla-calendar .vanilla-calendar-day__btn:not(.day-completed):not(.day-excused):not([data-calendar-is-today]):hover { background-color: #e9ecef !important; border-color: #dee2e6 !important; }
        .vanilla-calendar .vanilla-calendar-day__btn[data-calendar-is-today]:not(.day-completed):not(.day-excused) { background-color: #aed6f1 !important; border: 1px solid #1a5276 !important; color: #1a5276 !important; font-weight: bold; }
        .vanilla-calendar .vanilla-calendar-day__btn.day-completed[data-calendar-is-today],
        .vanilla-calendar .vanilla-calendar-day__btn.day-excused[data-calendar-is-today] { border-width: 1px; }


        /* Placeholder Styles */
        .placeholder-box { min-height: 150px; background-color: #f0f4f8; border: 1px dashed #ccc; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #777; border-radius: 5px; padding: 15px; text-align: center; }
        .placeholder-box .icon { font-size: 3em; margin-bottom: 10px; opacity: 0.5; }
        .placeholder-box .text { font-style: italic; font-size: 0.9em; }

        /* Footer */
        .main-footer { text-align: center; padding: 20px; margin-top: 40px; background-color: #2c3e50; color: #ecf0f1; font-size: 0.9em; }
        .main-footer a { color: #3498db; }

        /* Action Buttons Hidden */
        .action-buttons { display: none; }

        /* Loading Indicator */
        #loading-indicator { text-align: center; padding: 50px; font-size: 1.3em; color: #1a5276; display: block; }


        /* --- Responsive Adjustments --- */
        @media (max-width: 992px) { /* 2 columns layout */
            .dashboard-grid { grid-template-columns: repeat(2, 1fr); grid-template-rows: auto auto auto; }
            #daily-task { grid-column: span 2; grid-row: 1 / 2; }
            #plan-progress { grid-column: 1 / 2; grid-row: 2 / 3; }
            #quick-stats { grid-column: 1 / 2; grid-row: 3 / 4; }
            #calendar-view { grid-column: 2 / 3; grid-row: 2 / 4; }
        }
         @media (max-width: 768px) { /* 1 column layout */
             .dashboard-grid { grid-template-columns: 1fr; grid-template-rows: auto; }
             #daily-task, #plan-progress, #quick-stats, #calendar-view { grid-column: span 1; grid-row: auto;}
             .streak-info-condensed .streak-boxes { flex-direction: column; gap: 8px; }
         }

    </style>
</head>
<body>

    <div class="container">

        <header class="dashboard-header">
            <div class="logo"><h1>خطة حفظ القرآن الكريم</h1></div>
        </header>

        <div id="loading-indicator">جاري التحميل...</div>

        <main id="dashboard-content" style="display: none;">

            <div class="dashboard-grid">

                <section id="daily-task" class="card">
                    <h3>🌟 واجب اليوم (<span id="today-date-display">...</span>)</h3>
                    <div id="daily-task-content"> <p><i>يتم تحديد الواجب...</i></p> </div>
                    <a href="plangen2.html" class="plan-link">الذهاب إلى جدول الخطة التفصيلي &raquo;</a>
                </section>

                <section id="plan-progress" class="card">
                    <h3>الخطة والتقدم العام</h3>
                    <p><strong>خطتك الحالية:</strong> <span id="current-plan-name">-</span></p>
                    <p><strong>التقدم الكلي:</strong></p>
                    <div class="progress-bar-container">
                        <div id="progress-bar-value" class="progress-bar-value" style="width: 0%;">0%</div>
                    </div>
                    <p style="font-size: 0.9em; text-align: center; margin-top: 5px;">
                        <span id="completed-pages-progress">0</span> / 604 صفحة
                    </p>
                </section>

                <section id="quick-stats" class="card">
                    <h3>إحصائيات سريعة</h3>
                    <ul>
                        <li><strong>الصفحات المحفوظة:</strong> <span id="stat-memorized">0</span></li>
                        <li><strong>الصفحات المتقنة:</strong> <span id="stat-perfected">0</span></li>
                        <li><strong>الصفحات المربوطة:</strong> <span id="stat-linked">0</span></li>
                        <li><strong>أيام الأعذار:</strong> <span id="stat-excuses">0</span></li>
                    </ul>
                </section>

                <section id="calendar-view" class="card">
                    <div class="card-header">
                      <h3>التقويم والتتبع المرئي</h3>
                    </div>
                    <div id="calendar-container">
                        <p class="text" style="text-align: center; margin-top: 20px;">(جاري تحميل التقويم...)</p>
                    </div>
                    <div id="calendar-streak-info" class="streak-info-condensed" style="display: none;">
                        </div>
                </section>

                <section id="competition-section" class="card" style="display: none;">...</section>
                <section id="badges-section" class="card" style="display: none;">...</section>
            </div>
        </main>

        <footer class="main-footer">
             <p>&copy; <span id="current-year">2025</span> خطة حفظ القرآن الكريم. جميع الحقوق محفوظة.</p>
         </footer>
    </div>

    <script>
        // --- Firebase Config ---
        const firebaseConfig = { /* ... */ apiKey: "AIzaSyDuUebu7Qzz3JnTfa-58EIPZjOcrkmdGHU", authDomain: "quranplan2.firebaseapp.com", projectId: "quranplan2", storageBucket: "quranplan2.appspot.com", messagingSenderId: "1098692856811", appId: "1:1098692856811:web:923bca3a54fd78b1b267ae" };

        // --- Initialize Firebase ---
         try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Firebase initialization error:", e); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM References ---
        const loadingIndicator = document.getElementById('loading-indicator');
        const dashboardContent = document.getElementById('dashboard-content');
        const dailyTaskContent = document.getElementById('daily-task-content');
        const currentPlanNameSpan = document.getElementById('current-plan-name');
        const progressBarValue = document.getElementById('progress-bar-value');
        const completedPagesProgressSpan = document.getElementById('completed-pages-progress');
        const statMemorized = document.getElementById('stat-memorized');
        const statPerfected = document.getElementById('stat-perfected');
        const statLinked = document.getElementById('stat-linked');
        const statExcuses = document.getElementById('stat-excuses');
        const todayDateSpan = document.getElementById('today-date-display');
        const calendarContainer = document.getElementById('calendar-container');
        const calendarStreakInfoDiv = document.getElementById('calendar-streak-info');
        const currentYearSpan = document.getElementById('current-year');

        // --- Constants ---
        const totalQuranPages = 604;
        const initialTotalRows = 320;

        // --- Global State ---
        let currentUser = null;
        let currentPlanData = null;
        let calendarInstance = null;
        let dayStatus = {};
        let calendarObserver = null; // Variable for the MutationObserver

        // --- Data Arrays & Helper Functions ---
        const surahs = [ /* ... كما هي ... */ 'الفاتحة والبقرة', 'آل عمران', 'النساء', 'المائدة', 'الأنعام', 'الأعراف', 'الأنفال', 'التوبة', 'يونس', 'هود', 'يوسف', 'الرعد', 'إبراهيم', 'الحجر', 'النحل', 'الإسراء', 'الكهف', 'مريم', 'طه', 'الأنبياء', 'الحج', 'المؤمنون', 'النور', 'الفرقان', 'الشعراء', 'النمل', 'القصص', 'العنكبوت', 'الروم', 'لقمان', 'السجدة', 'الأحزاب', 'سبأ', 'فاطر', 'يس', 'الصافات', 'ص', 'الزمر', 'غافر', 'فصلت', 'الشورى', 'الزخرف', 'الدخان', 'الجاثية', 'الأحقاف', 'محمد', 'الفتح', 'الحجرات', 'ق', 'الذاريات', 'الطور', 'النجم', 'القمر', 'الرحمن', 'الواقعة', 'الحديد', 'المجادلة', 'الحشر', 'الممتحنة', 'الصف', 'الجمعة', 'المنافقون', 'التغابن', 'الطلاق', 'التحريم', 'الملك', 'القلم', 'الحاقة', 'المعارج', 'نوح', 'الجن', 'المزمل', 'المدثر', 'القيامة', 'الإنسان', 'المرسلات', 'النبأ', 'النازعات', 'عبس', 'التكوير', 'الإنفطار', 'المطففين', 'الإنشقاق', 'البروج', 'الطارق', 'الأعلى', 'الغاشية', 'الفجر', 'البلد', 'الشمس', 'الليل', 'الضحى', 'الشرح', 'التين', 'العلق', 'القدر', 'البينة', 'الزلزلة', 'العاديات', 'القارعة', 'التكاثر', 'العصر', 'الهمزة', 'الفيل', 'قريش', 'الماعون', 'الكوثر', 'الكافرون', 'النصر', 'المسد', 'الإخلاص', 'الفلق', 'الناس', 'ختم القرآن'];
        const linkFromData = [ /* ... كما هي ... */ ];
        const linkToData = [ /* ... كما هي ... */ ];
        const reviewFromData = [ /* ... كما هي ... */ ];
        const reviewToData = [ /* ... كما هي ... */ ];

        function formatDate(date) { if (!(date instanceof Date)) date = new Date(date); if (isNaN(date.getTime())) return ""; const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
        function getPlanData(originalIndex) { const index = parseInt(originalIndex); if (isNaN(index) || index < 0 || index >= initialTotalRows) { return null; } let fromPage = '', toPage = ''; if (index < 299) { fromPage = index * 2 + 1; toPage = fromPage + 1; } else if (index === 299) { fromPage = 601; toPage = 604; } return { fromPage: fromPage, toPage: toPage, surah: surahs[index] || '', linkFrom: linkFromData[index] ?? '', linkTo: linkToData[index] ?? '', reviewFrom: reviewFromData[index] ?? '', reviewTo: reviewToData[index] ?? '', round: calculateRoundNumber(index) }; }
        function calculateRoundNumber(originalIndex) { if (originalIndex < 32 || !reviewFromData || reviewFromData[originalIndex] == null || reviewFromData[originalIndex] === '') { return ''; } let reviewDataStartIndex = 32; let reviewCounter = 0; for(let i = reviewDataStartIndex; i <= originalIndex; i++){ if(reviewFromData[i] != null && reviewFromData[i] !== '') reviewCounter++; } if (reviewCounter === 0) return ''; return Math.ceil(reviewCounter / 6); }

        // --- UI Update Functions ---
        function showLoading(message = "جاري التحميل...") { if(loadingIndicator){ loadingIndicator.textContent = message; loadingIndicator.style.display = 'block';} if(dashboardContent) dashboardContent.style.display = 'none'; }
        function hideLoading() { if(loadingIndicator) loadingIndicator.style.display = 'none'; }
        function displayDashboard() { hideLoading(); if(dashboardContent) dashboardContent.style.display = 'block'; }

        // --- Stats Calculation ---
        function calculateDashboardStats(tableRows) { /* ... كما هي ... */ let lastCompletedPage = 0; let linkedTasks = 0; let perfectedTasks = 0; let excuseCount = 0; if (!tableRows) return { memorizedPages: 0, linkedTasks: 0, perfectedTasks: 0, excuseCount: 0 }; tableRows.forEach(row => { if (row.type === 'excuse') { excuseCount++; } else if (row.type === 'plan' && row.state?.completed) { const planInfo = getPlanData(row.originalSequence); if (planInfo && planInfo.toPage) { const pageNum = parseInt(planInfo.toPage); if (!isNaN(pageNum)) { lastCompletedPage = Math.max(lastCompletedPage, pageNum); } } if (planInfo && planInfo.linkTo !== '' && row.state.linked) { linkedTasks++; } if (planInfo && planInfo.reviewTo !== '' && row.state.reviewed) { perfectedTasks++; } } }); const memorizedPages = Math.min(lastCompletedPage, totalQuranPages); return { memorizedPages: memorizedPages, linkedTasks: linkedTasks, perfectedTasks: perfectedTasks, excuseCount: excuseCount }; }

        // --- Streak Calculation ---
        const levelTitles = [ /* ... الألقاب كما هي ... */ "ابدأ رحلتك!", "🌱 غرسة الإيمان", "✨ بادرة أمل", "🏃 ساعٍ للعلا", "⭐ نجم صاعد", "💪 مثابر مجتهد", "🧭 على الدرب", "💯 صاحب السبعين", "🚀 انطلاقة قوية", "💎 جوهرة مصقولة", "👑 صاحب المئة يوم", "📖 رفيق القرآن", "🕯️ منارة هدى", "🏔️ قمة شامخة", "🌳 شجرة طيبة", "⏳ عابر منتصف الطريق", "🎯 دقة والتزام", "🌊 بحر زاخر", "🌟 كوكب دري", "🧭 بوصلة الحق", "💯💯 المئتان لا تقفان!", "🤲 قلب خاشع", "🕊️ روح مطمئنة", "💖 محب للرحمن", "🙏 عبد شكور", "💡 بصيرة نافذة", "🕌 معمّر بيوت الله", "🌙 هلال الكمال", "✨ نور على نور", "🏁 قاب قوسين أو أدنى", "🏆 فارس الثلاثمائة", "🎉 مقترب من الختام", "🎊 خاتم مبارك" ];
        const levelIcons = { 10: '👑', 20: '💯', 30: '🏆', 32: '🎊' };

        function calculateStreaksAndLevel(tableRows) { /* ... كما هي ... */ if (!tableRows || tableRows.length === 0) { return { currentStreak: 0, longestStreak: 0, currentLevel: 0, currentTitle: levelTitles[0], currentIcon: '' }; } const sortedRows = [...tableRows].sort((a, b) => new Date(a.displayDate) - new Date(b.displayDate)); let currentStreak = 0; let longestStreak = 0; let currentRun = 0; const todayStr = formatDate(new Date()); for (const row of sortedRows) { if (row.displayDate > todayStr) break; if (row.type === 'plan' && row.state?.completed) { currentRun++; } else if (row.type === 'excuse') { if (currentRun > longestStreak) longestStreak = currentRun; } else { if (currentRun > longestStreak) longestStreak = currentRun; currentRun = 0; } } if (currentRun > longestStreak) longestStreak = currentRun; let tempCurrentStreak = 0; let streakBroken = false; for (let i = sortedRows.length - 1; i >= 0; i--) { const row = sortedRows[i]; if (row.displayDate > todayStr) continue; if (row.type === 'plan' && row.state?.completed) { if (!streakBroken) tempCurrentStreak++; } else if (row.type === 'excuse') { continue; } else { streakBroken = true; if (row.displayDate === todayStr) tempCurrentStreak = 0; break; } } currentStreak = tempCurrentStreak; const levelIndex = Math.min(Math.floor(currentStreak / 10), levelTitles.length - 1); const currentTitle = levelTitles[levelIndex] || levelTitles[0]; const currentIcon = levelIcons[levelIndex] || ''; return { currentStreak: currentStreak, longestStreak: longestStreak, currentLevel: levelIndex, /* Return 0-based index */ currentTitle: currentTitle, currentIcon: currentIcon }; }


        // --- START: Calendar Coloring and Initialization Functions (Using MutationObserver) ---

        /**
         * Applies custom CSS classes to calendar days. (Manual method)
         */
        function applyCustomColoring() {
            console.log("[applyCustomColoring] Function called.");
            setTimeout(() => {
                if (!calendarContainer) { console.error("[applyCustomColoring] Error: Calendar container not found."); return; }
                const dayButtonElements = calendarContainer.querySelectorAll('.vanilla-calendar-day__btn');
                console.log(`[applyCustomColoring] Found ${dayButtonElements.length} elements.`);

                if (dayButtonElements.length === 0 && calendarContainer.innerHTML !== '' && !calendarContainer.querySelector('.text')) {
                     console.warn("[applyCustomColoring] No day elements found.");
                     return;
                 }

                let appliedCount = 0;
                dayButtonElements.forEach((buttonElement) => {
                    const dateAttribute = buttonElement.dataset.calendarDay;
                    if (!dateAttribute || !/^\d{4}-\d{2}-\d{2}$/.test(dateAttribute)) { return; }
                    buttonElement.classList.remove('day-completed', 'day-excused'); // Clear first
                    const status = dayStatus[dateAttribute];
                    if (status === 'completed') { buttonElement.classList.add('day-completed'); appliedCount++; }
                    else if (status === 'excused') { buttonElement.classList.add('day-excused'); appliedCount++; }
                });
                if(appliedCount > 0 || dayButtonElements.length > 0) {
                     console.log(`[applyCustomColoring] Finished. Applied colors to ${appliedCount} days.`);
                 }
            }, 300); // Moderate delay
        }

        /**
         * Initializes Vanilla Calendar and sets up MutationObserver for persistent coloring.
         */
        function initializeAndColorCalendar(tableRows) {
            console.log("[initializeAndColorCalendar] Initializing with MutationObserver approach...");
            const calendarContainer = document.getElementById('calendar-container');
            if (!calendarContainer) { console.error("[initializeAndColorCalendar] Calendar container not found!"); return false; }

            // 1. Prepare dayStatus object
            dayStatus = {};
            if (tableRows && Array.isArray(tableRows)) {
                tableRows.forEach(row => { /* ... */ if (row.displayDate && /^\d{4}-\d{2}-\d{2}$/.test(row.displayDate)) { if (row.type === 'plan' && row.state?.completed) { dayStatus[row.displayDate] = 'completed'; } else if (row.type === 'excuse') { dayStatus[row.displayDate] = 'excused'; } } });
                 console.log("[initializeAndColorCalendar] Prepared dayStatus object:", Object.keys(dayStatus).length > 0 ? "Contains data" : "Empty");
            }

            // 2. Setup Vanilla Calendar options (Manual coloring, nav enabled)
            const options = {
                settings: { lang: 'ar', iso8601: false, range: { disablePast: false, disableGaps: false }, selection: { day: false, month: true, year: true }, visibility: { theme: 'light', weekend: false, today: true }, },
                 actions: {
                     // Keep update as a potential trigger, but rely more on Observer
                     update: (calendar) => {
                         console.log("[VanillaCalendar Action] 'update' event fired (backup coloring trigger).");
                         applyCustomColoring();
                     },
                     clickDay(event, dates) { /* Optional */ },
                 }
                 // No settings.dates here
            };

            calendarContainer.innerHTML = ''; // Clear placeholder

            try {
                console.log("[initializeAndColorCalendar] Destroying previous instance...");
                if (calendarInstance && typeof calendarInstance.destroy === 'function') { calendarInstance.destroy(); calendarInstance = null; }
                if (calendarObserver) { calendarObserver.disconnect(); console.log("[initializeAndColorCalendar] Disconnected previous observer."); } // Disconnect old observer

                console.log("[initializeAndColorCalendar] Creating new VanillaCalendar instance...");
                calendarInstance = new VanillaCalendar(calendarContainer, options);

                console.log("[initializeAndColorCalendar] Calling calendarInstance.init()...");
                calendarInstance.init();
                 console.log("[initializeAndColorCalendar] Calendar initialized.");

                // --- Explicitly call initial coloring AFTER init ---
                 console.log("[initializeAndColorCalendar] Calling initial applyCustomColoring().");
                 applyCustomColoring();

                // --- Setup MutationObserver AFTER initializing calendar ---
                setupCalendarObserver();

                 return true; // Signal success

            } catch (error) {
                console.error("[initializeAndColorCalendar] Error:", error);
                calendarContainer.innerHTML = `<p class="text" style="color:red;">Error initializing calendar. (${error.message})</p>`;
                calendarInstance = null;
                if (calendarObserver) { calendarObserver.disconnect(); } // Disconnect observer on error
                return false;
            }
        }

        /**
         * Sets up the MutationObserver to watch for changes in the calendar container.
         */
        function setupCalendarObserver() {
            if (!calendarContainer || !window.MutationObserver) {
                console.warn("[setupCalendarObserver] Container not found or MutationObserver not supported.");
                return;
             }

            // Debounce function to prevent excessive calls
            let debounceTimeout;
            const debouncedApplyColoring = () => {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => {
                    console.log("[MutationObserver Debounced] Applying colors after DOM change.");
                    applyCustomColoring();
                }, 150); // Debounce delay
            };

            const config = { childList: true, subtree: true }; // Watch for node additions/removals

            const callback = function(mutationsList, observer) {
                let relevantChangeDetected = false;
                for(const mutation of mutationsList) {
                    // Check if day buttons were likely added or removed
                     if (mutation.type === 'childList' && (mutation.addedNodes.length > 0 || mutation.removedNodes.length > 0)) {
                        // Simple check: Does the change involve the calendar body or day buttons?
                        if (mutation.target.classList?.contains('vcal-body') ||
                            mutation.target.querySelector?.('.vanilla-calendar-day__btn') ||
                            Array.from(mutation.addedNodes).some(node => node.nodeType === 1 && (node.classList?.contains('vanilla-calendar-day__btn') || node.querySelector?.('.vanilla-calendar-day__btn'))) ||
                             Array.from(mutation.removedNodes).some(node => node.nodeType === 1 && node.classList?.contains('vanilla-calendar-day__btn')))
                        {
                             relevantChangeDetected = true;
                             break; // Found a relevant change, no need to check further mutations in this batch
                         }
                     }
                }
                if (relevantChangeDetected) {
                    console.log('[MutationObserver] Detected relevant change in calendar, triggering debounced coloring.');
                    debouncedApplyColoring();
                }
            };

            calendarObserver = new MutationObserver(callback);
            calendarObserver.observe(calendarContainer, config);
            console.log("[setupCalendarObserver] MutationObserver is now watching #calendar-container.");
        }

        // --- Display Streak Info (Rearranged, Level starts at 1, Unicode Icon) ---
        function displayStreakInfoInCalendarCard(streakData) {
            const targetDiv = document.getElementById('calendar-streak-info');
            if (!targetDiv) { console.warn("Target div #calendar-streak-info not found."); return; }

            const currentStreakTitle = "عدد الأيام المتتالية التي أكملت فيها واجبك حتى اليوم.";
            const longestStreakTitle = "أطول سلسلة أيام متتالية أكملت فيها واجبك خلال الخطة.";
            const displayLevel = streakData.currentLevel + 1; // Display level starting from 1
            const levelExplanation = `يعتمد مستواك (${displayLevel}) ولقبك على عدد أيام إنجازك المتتالية الحالية.`;
            const infoIconHTML = `<span class="info-icon" title="${levelExplanation}">&#x2139;</span>`; // Unicode Info Icon

            let content = `
                <h4>الإنجاز المتتالي</h4>
                <div class="streak-boxes">
                    <div class="streak-box" title="${currentStreakTitle}">
                        أيام الإنجاز الحالية
                        <span class="info-icon" title="${currentStreakTitle}">&#x2139;</span>
                        <strong>${streakData.currentStreak}</strong>
                    </div>
                    <div class="streak-box" title="${longestStreakTitle}">
                        أطول سلسلة أيام
                         <span class="info-icon" title="${longestStreakTitle}">&#x2139;</span>
                        <strong>${streakData.longestStreak}</strong>
                    </div>
                </div>
                <div class="level-display-wrapper" title="${levelExplanation}">
                    <span class="level-number-display">مستواك الحالي: ${displayLevel}</span>
                    <span class="level-title-display">لقبك الحالي: ${streakData.currentTitle} ${streakData.currentIcon}</span>
                     ${infoIconHTML}
                </div>
            `;
            targetDiv.innerHTML = content;
            targetDiv.style.display = 'block';
            // console.log("[displayStreakInfoInCalendarCard] Streak info displayed.");
        }


        // --- Dashboard Display Functions ---
        function displayDailyTask() { /* ... كما هي ... */ if (!dailyTaskContent || !currentPlanData || !currentPlanData.tableRows) { if(dailyTaskContent) dailyTaskContent.innerHTML = '<p><i>جاري تحميل بيانات الخطة...</i></p>'; if (todayDateSpan) todayDateSpan.textContent = formatDate(new Date()); return; } const tableRows = currentPlanData.tableRows; const todayStr = formatDate(new Date()); if (todayDateSpan) todayDateSpan.textContent = todayStr; const todayRow = tableRows.find(row => row.displayDate === todayStr); if (!todayRow) { dailyTaskContent.innerHTML = '<p>لا يوجد واجب مقرر في الخطة لهذا اليوم.</p>'; } else if (todayRow.type === 'excuse') { dailyTaskContent.innerHTML = `<p style="color: orange; font-weight:bold;">لديك عذر مسجل لهذا اليوم (${todayRow.excuseType || ''}).</p>`; } else if (todayRow.type === 'plan' && todayRow.state?.completed) { dailyTaskContent.innerHTML = '<p style="color: green; font-weight: bold;">✅ الحمد لله، لقد أتممت واجب هذا اليوم!</p>'; } else if (todayRow.type === 'plan' && (!todayRow.state || !todayRow.state.completed)) { const taskDetails = getPlanData(todayRow.originalSequence); if (taskDetails) { let taskHTML = `<h4>المطلوب إنجازه اليوم (${todayStr}):</h4>`; taskHTML += `<p><strong>الحفظ الجديد:</strong> ${taskDetails.fromPage ? `ص ${taskDetails.fromPage} - ${taskDetails.toPage}` : 'لا يوجد'} (${taskDetails.surah || 'مراجعة'})</p>`; taskHTML += `<p><strong>الربط:</strong> ${taskDetails.linkFrom ? `من ${taskDetails.linkFrom} إلى ${taskDetails.linkTo}` : 'لا يوجد'}</p>`; taskHTML += `<p><strong>المراجعة:</strong> ${taskDetails.reviewFrom ? `من ${taskDetails.reviewFrom} إلى ${taskDetails.reviewTo}` : 'لا يوجد'} ${taskDetails.round ? `(ج${taskDetails.round})` : ''}</p>`; dailyTaskContent.innerHTML = taskHTML; } else { dailyTaskContent.innerHTML = `<p><i>خطأ: لم يتم العثور على تفاصيل الواجب للفهرس ${todayRow.originalSequence}.</i></p>`; } } else { dailyTaskContent.innerHTML = '<p><i>واجب اليوم لم يكتمل بعد أو حالته غير معروفة.</i></p>'; } }
        function displayProgress(stats) { /* ... كما هي ... */ if (!currentPlanData) return; const planType = currentPlanData.planType || '?'; const memorizedPages = stats.memorizedPages; const progressPercent = totalQuranPages > 0 ? Math.min(100, (memorizedPages / totalQuranPages) * 100).toFixed(0) : 0; if(currentPlanNameSpan) currentPlanNameSpan.textContent = `خطة ${planType} صفحات`; if(progressBarValue) { progressBarValue.style.width = `${progressPercent}%`; progressBarValue.textContent = `${progressPercent}%`; } if(completedPagesProgressSpan) completedPagesProgressSpan.textContent = memorizedPages; }
        function displayStats(stats) { /* ... كما هي ... */ if(statMemorized) statMemorized.textContent = stats.memorizedPages; if(statPerfected) statPerfected.textContent = stats.perfectedTasks; if(statLinked) statLinked.textContent = stats.linkedTasks; if(statExcuses) statExcuses.textContent = stats.excuseCount; }


        // --- Main Data Loading Function ---
         function loadDashboardData(user) {
             if (!user) return;
             const uid = user.uid;
             const planRef = db.collection("quranPlans").doc(uid);
             showLoading("جاري تحميل بيانات خطتك...");
             planRef.get().then((doc) => {
                 hideLoading();
                 if (doc.exists) {
                     currentPlanData = doc.data();
                     if (!currentPlanData.startDate /* ... etc ... */) { /* ... Error handling ... */ console.error("Loaded data missing required fields.", currentPlanData); dashboardContent.style.display = 'block'; dailyTaskContent.innerHTML = `<p style="color:red; font-weight:bold;">خطأ: بيانات خطتك المحفوظة غير مكتملة أو تالفة. يرجى <a href="index.html">الذهاب لصفحة البداية</a> وإعادة إنشاء الخطة.</p>`; const sectionsToHideOnError = ['plan-progress', 'quick-stats', 'calendar-view']; sectionsToHideOnError.forEach(id => { const section = document.getElementById(id); if (section) section.style.display = 'none'; }); return; }
                     const stats = calculateDashboardStats(currentPlanData.tableRows);
                     const streakData = calculateStreaksAndLevel(currentPlanData.tableRows);
                     displayDailyTask();
                     displayProgress(stats);
                     displayStats(stats);
                     displayStreakInfoInCalendarCard(streakData);
                     // Initialize calendar - Observer is set up inside this function
                     initializeAndColorCalendar(currentPlanData.tableRows);
                     displayDashboard();
                 } else { /* No plan found logic */
                      displayDashboard();
                      dailyTaskContent.innerHTML = '<p style="color:orange; font-weight:bold;">لم تقم باختيار أو إنشاء خطة بعد!</p><p>اذهب إلى <a href="index.html">صفحة البداية</a> لاختيار خطتك.</p>';
                      const sectionsToHide = ['plan-progress', 'quick-stats', 'calendar-view'];
                      sectionsToHide.forEach(id => { const section = document.getElementById(id); if (section) section.style.display = 'none'; });
                  }
             }).catch((error) => { /* Error handling */
                  console.error("Error getting plan document:", error);
                  hideLoading(); displayDashboard();
                  dailyTaskContent.innerHTML = `<p style="color:red; font-weight:bold;">حدث خطأ أثناء تحميل بيانات الخطة. (${error.code || 'UNKNOWN'})</p><p>يرجى المحاولة مرة أخرى. <a href="index.html">العودة للرئيسية</a></p>`;
                  const sectionsToHideOnError = ['plan-progress', 'quick-stats', 'calendar-view'];
                  sectionsToHideOnError.forEach(id => { const section = document.getElementById(id); if (section) section.style.display = 'none'; });
             });
         }

        // --- Authentication Listener ---
        auth.onAuthStateChanged(user => { /* ... كما هي ... */
             currentUser = user;
             if (user) { loadDashboardData(user); }
             else { /* Not logged in logic */
                 showLoading("غير مسجل الدخول. يرجى تسجيل الدخول أولاً.");
                 if(dashboardContent) dashboardContent.style.display = 'block';
                 if(dailyTaskContent) dailyTaskContent.innerHTML = '<p style="color:red;">يرجى <a href="index.html">تسجيل الدخول</a> لعرض لوحة المتابعة.</p>';
                 const sectionsToHide = ['plan-progress', 'quick-stats', 'calendar-view'];
                 sectionsToHide.forEach(id => { const section = document.getElementById(id); if (section) section.style.display = 'none'; });
                 // Disconnect observer if user logs out
                 if (calendarObserver) { calendarObserver.disconnect(); calendarObserver = null; console.log("Disconnected observer on logout.");}
                 if (calendarInstance && typeof calendarInstance.destroy === 'function') { calendarInstance.destroy(); calendarInstance = null;}
                 hideLoading();
             }
         });

        // --- Initial Load & Footer Year ---
        document.addEventListener('DOMContentLoaded', () => { /* ... كما هي ... */
              showLoading("جاري التحقق من تسجيل الدخول...");
              if(currentYearSpan) { currentYearSpan.textContent = new Date().getFullYear(); }
          });

        // --- Print Function ---
        function printData() { console.log("Initiating browser print..."); window.print(); }

    </script>
    </body>
</html>