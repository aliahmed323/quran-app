<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© - Ø®Ø·Ø© Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù†</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/vanilla-js-calendar@1.9.4/build/vanilla-js-calendar.min.css" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

    <style>
        /* --- CSS Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; background-color: #f4f7f6; color: #333; line-height: 1.7; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        h1, h2, h3, h4 { color: #1a5276; margin-bottom: 0.75em; }
        p { margin-bottom: 1em; color: #555; font-size: 0.95em; }
        a { text-decoration: none; color: #2980b9; }
        .card { background-color: #fff; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 3px 6px rgba(0,0,0,0.05); border: 1px solid #e0e0e0; }
        .dashboard-header { display: flex; justify-content: center; align-items: center; padding: 10px 20px; margin-bottom: 25px; border-bottom: 2px solid #aed6f1; background-color: #fff; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .dashboard-header .logo h1 { margin: 0; font-size: 1.8em; color: #1a5276; }

        /* --- Dashboard Layout (Using auto-fit for responsiveness) --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(270px, 1fr)); grid-auto-rows: auto; gap: 25px; }
        #daily-task { grid-column: span 2; } /* Let daily task take more space if possible */
        @media (max-width: 860px) { #daily-task { grid-column: span 1; } } /* Adjust for medium screens */
        /* Ensure other sections span full width on small screens */
        @media (max-width: 600px) { .dashboard-grid { grid-template-columns: 1fr; } #daily-task, #plan-progress, #quick-stats, #streak-info, #calendar-view, #competition-section, #badges-section { grid-column: span 1; } .card { padding: 15px; } h2 { font-size: 1.4em; } h3 { font-size: 1.1em; } .dashboard-header .logo h1 { font-size: 1.5em;} }

        /* --- Section Specific Styles --- */
        #daily-task h3 { color: #1e8449; font-size: 1.3em; border-bottom: 2px solid #aed6f1; padding-bottom: 8px;}
        #daily-task-content { min-height: 80px; padding-top: 10px;} /* Adjusted min-height */
        #daily-task-content p { margin-bottom: 0.6em; font-size: 1.05em; line-height: 1.8; }
        #daily-task-content strong { color: #1a5276; margin-left: 8px;}
        #daily-task .plan-link { margin-top: 15px; display: inline-block; font-size: 0.9em; background-color: #5dade2; color: white; padding: 5px 10px; border-radius: 4px; }
        #daily-task .plan-link:hover { background-color: #3498db; }

        #plan-progress h3, #quick-stats h3, #streak-info h3, #calendar-view h3, #competition-section h3, #badges-section h3 { font-size: 1.15em; }
        #plan-progress .progress-bar-container { background-color: #e9ecef; border-radius: 0.25rem; height: 25px; overflow: hidden; margin-top: 10px; border: 1px solid #ccc; }
        #plan-progress .progress-bar-value { background-color: #28a745; height: 100%; width: 0%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.9em; font-weight: bold; transition: width 0.6s ease-in-out; }
        #quick-stats ul { list-style: none; padding: 0; margin-top: 15px;}
        #quick-stats ul li { margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px dotted #eee; font-size: 0.95em;}
        #quick-stats ul li strong { margin-left: 5px; color: #1a5276; min-width: 110px; display: inline-block;}
        #quick-stats ul li span { color: #1e8449; font-weight: bold;}

        /* Streak Info Card */
        #streak-info p { margin-bottom: 0.6em; font-size: 1em;}
        #streak-info strong { color: #1a5276; }
        #streak-level-title { font-weight: bold; color: #1e8449; }
        #streak-level-icon { margin-right: 5px; }

        /* Placeholder Styles */
        .placeholder-box { min-height: 150px; background-color: #f0f4f8; border: 1px dashed #ccc; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #777; border-radius: 5px; padding: 15px; text-align: center; }
        .placeholder-box .icon { font-size: 3em; margin-bottom: 10px; opacity: 0.5; }
        .placeholder-box .text { font-style: italic; font-size: 0.9em; }
        .main-footer { text-align: center; padding: 20px; margin-top: 40px; background-color: #2c3e50; color: #ecf0f1; font-size: 0.9em; }
        .main-footer a { color: #3498db; }
        .action-buttons { display: none; }
        #loading-indicator { text-align: center; padding: 50px; font-size: 1.3em; color: #1a5276; display: block; }

        /* Calendar Custom Styles */
        #calendar-container { max-width: 300px; margin: 15px auto 0 auto; }
        #calendar-container .vanilla-calendar-day__btn { border-radius: 4px; border: 1px solid transparent; color: #333; transition: background-color 0.2s, border-color 0.2s; padding: 5px !important; /* Adjust padding */ }
        #calendar-container .status-completed .vanilla-calendar-day__btn { background-color: #d1e7dd !important; color: #0f5132 !important; border-color: #a3cfbb !important; font-weight: bold; }
        #calendar-container .status-excuse .vanilla-calendar-day__btn { background-color: #f8d7da !important; color: #58151c !important; border-color: #f1aeae !important; text-decoration: line-through; font-style: italic; }
        #calendar-container .vanilla-calendar-day_today .vanilla-calendar-day__btn { border-color: #0d6efd !important; background-color: rgba(13, 110, 253, 0.1) !important; }
        .calendar-legend { text-align: center; font-size: 0.8em; margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;}
        .calendar-legend span { display: inline-block; width: 12px; height: 12px; margin-left: 4px; margin-right: 8px; vertical-align: middle; border-radius: 3px; border: 1px solid rgba(0,0,0,0.2); }
        .legend-completed { background-color: #d1e7dd; }
        .legend-excuse { background-color: #f8d7da; }
        .legend-today { background-color: rgba(13, 110, 253, 0.1); border: 1px solid #0d6efd;}
    </style>
</head>
<body>

    <div class="container">

        <header class="dashboard-header">
            <div class="logo"><h1>Ø®Ø·Ø© Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</h1></div>
        </header>

        <div id="loading-indicator">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

        <main id="dashboard-content" style="display: none;">

            <div class="dashboard-grid">

                <section id="daily-task" class="card">
                    <h3>ğŸŒŸ ÙˆØ§Ø¬Ø¨ Ø§Ù„ÙŠÙˆÙ… (<span id="today-date-display">...</span>)</h3>
                    <div id="daily-task-content">
                        <p><i>ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ§Ø¬Ø¨...</i></p>
                    </div>
                    <a href="plangen2.html" class="plan-link">Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªÙØµÙŠÙ„ÙŠ &raquo;</a>
                </section>

                <section id="plan-progress" class="card">
                    <h3>Ø§Ù„Ø®Ø·Ø© ÙˆØ§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¹Ø§Ù…</h3>
                    <p><strong>Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù†Ø´Ø·Ø©:</strong> <span id="current-plan-name">-</span></p>
                    <p><strong>Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„ÙƒÙ„ÙŠ:</strong></p>
                    <div class="progress-bar-container">
                        <div id="progress-bar-value" style="width: 0%; background-color: #28a745;">0%</div>
                    </div>
                    <p style="font-size: 0.9em; text-align: center; margin-top: 5px;">
                        <span id="completed-pages-progress">0</span> / 604 ØµÙØ­Ø©
                    </p>
                </section>

                <section id="quick-stats" class="card">
                    <h3>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©</h3>
                    <ul>
                        <li><strong>Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:</strong> <span id="stat-memorized">0</span></li>
                        <li><strong>Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…ØªÙ‚Ù†Ø©:</strong> <span id="stat-perfected">0</span></li>
                        <li><strong>Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø©:</strong> <span id="stat-linked">0</span></li>
                        <li><strong>Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø¹Ø°Ø§Ø±:</strong> <span id="stat-excuses">0</span></li>
                    </ul>
                </section>

                <section id="streak-info" class="card">
                     <h3>ğŸ”¥ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…ØªØªØ§Ù„ÙŠ</h3>
                     <p><strong>Ø§Ù„Ø­Ø§Ù„ÙŠ:</strong> <span id="streak-current">0</span> Ø£ÙŠØ§Ù…</p>
                     <p><strong>Ø§Ù„Ø£ÙØ¶Ù„:</strong> <span id="streak-longest">0</span> Ø£ÙŠØ§Ù…</p>
                     <p><strong>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ:</strong> <span id="streak-level-title">...</span> <span id="streak-level-icon"></span></p>
                 </section>

                 <section id="calendar-view" class="card">
                    <h3>Ø§Ù„ØªÙ‚ÙˆÙŠÙ…</h3>
                    <div id="calendar-container" style="max-width: 300px; margin: 15px auto 0 auto;">
                         </div>
                    <div class="calendar-legend">
                        <span class="legend-completed"></span> Ù…ÙƒØªÙ…Ù„ &nbsp;
                        <span class="legend-excuse"></span> Ø¹Ø°Ø± &nbsp;
                        <span class="legend-today"></span> Ø§Ù„ÙŠÙˆÙ…
                    </div>
                </section>
                 <section id="competition-section" class="card">
                     <h3>Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©</h3>
                     <div class="placeholder-box">
                         <div class="icon">ğŸ†</div>
                         <div class="text">(Ù‚Ø±ÙŠØ¨Ø§Ù‹: Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©)</div>
                     </div>
                </section>

                 <section id="badges-section" class="card">
                      <h3>Ø§Ù„Ø£ÙˆØ³Ù…Ø©</h3>
                       <div class="placeholder-box">
                          <div class="icon">ğŸ…</div>
                          <div class="text">(Ù‚Ø±ÙŠØ¨Ø§Ù‹: Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆØ³Ù…Ø© ÙˆØ§Ù„Ø­ÙˆØ§ÙØ²)</div>
                      </div>
                 </section>

            </div>
        </main>

        <footer class="main-footer">
             <p>&copy; 2025 Ø®Ø·Ø© Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
        </footer>

    </div>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanilla-js-calendar@1.9.4/build/vanilla-js-calendar.min.js"></script>

    <script>
        // --- Firebase Config (Using values you provided) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDuUebu7Qzz3JnTfa-58EIPZjOcrkmdGHU",
            authDomain: "quranplan2.firebaseapp.com",
            projectId: "quranplan2",
            storageBucket: "quranplan2.appspot.com",
            messagingSenderId: "1098692856811",
            appId: "1:1098692856811:web:923bca3a54fd78b1b267ae"
        };

         try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Firebase initialization error:", e); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Global Variables ---
        let calendarInstance = null; // For Calendar
        let currentUser = null;
        let currentPlanData = null; // Stores the FULL plan data

        // --- DOM References ---
        const loadingIndicator = document.getElementById('loading-indicator');
        const dashboardContent = document.getElementById('dashboard-content');
        const dailyTaskContent = document.getElementById('daily-task-content');
        const currentPlanNameSpan = document.getElementById('current-plan-name');
        const progressBarValue = document.getElementById('progress-bar-value');
        const completedPagesProgressSpan = document.getElementById('completed-pages-progress');
        const statMemorized = document.getElementById('stat-memorized');
        const statPerfected = document.getElementById('stat-perfected');
        const statLinked = document.getElementById('stat-linked');
        const statExcuses = document.getElementById('stat-excuses');
        const todayDateSpan = document.getElementById('today-date-display');
        // >> Streak DOM References
        const streakCurrentEl = document.getElementById('streak-current');
        const streakLongestEl = document.getElementById('streak-longest');
        const streakLevelTitleEl = document.getElementById('streak-level-title');
        const streakLevelIconEl = document.getElementById('streak-level-icon');

        // --- Constants ---
        const totalQuranPages = 604;
        const initialTotalRows = 320; // Should match plangen2
        // >> Streak Level Titles (Example - Needs refinement/completion)
        const streakLevelTitles = [
            /* 0 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 0: Ø³Ø§Ø¹Ù Ù„Ù„Ø¹Ù„Ø§ ğŸŒ±", /* 1 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1: Ù…Ø«Ø§Ø¨Ø± Ù…Ø¬ØªÙ‡Ø¯ ğŸ¥‰", /* 2 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 2: Ø°Ùˆ Ù‡Ù…Ø©Ù Ø¹Ø§Ù„ÙŠØ© ğŸ¥ˆ", /* 3 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 3: Ø±ÙÙŠÙ‚ Ø§Ù„Ù‚Ø±Ø¢Ù† ğŸ¥‰", /* 4 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 4: Ø«Ø§Ø¨Øª Ø§Ù„Ù‚Ø¯Ù… ğŸ¥ˆ", /* 5 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 5: Ù†Ø¬Ù…ÙŒ ØµØ§Ø¹Ø¯ ğŸŒŸ", /* 6 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 6: Ù…Ø¬ØªØ§Ø² Ø§Ù„ØµØ¹Ø§Ø¨", /* 7 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 7: Ø°Ùˆ Ø¹Ø²ÙŠÙ…Ø©", /* 8 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 8: Ù…ÙƒØ§ÙØ­ Ù…Ø«Ù…Ø±", /* 9 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 9: Ù‚Ø§Ø±Ø¨ Ø§Ù„Ù…Ø¦Ø©", /* 10 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 10: ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ø¦Ø© ÙŠÙˆÙ… ğŸ’¯", /* 11 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 11: ÙØ§Ø±Ø³ Ø§Ù„Ù…Ø«Ø§Ø¨Ø±Ø©", /* 12 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 12: ØµØ§Ø­Ø¨ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²", /* 13 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 13: Ù…ØªÙ‚Ø¯Ù… ÙˆØ§Ø¹Ø¯", /* 14 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 14: Ø¹Ø§Ø¨Ø± Ø§Ù„Ù…Ø±Ø§Ø­Ù„", /* 15 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 15: Ø¨Ù„Øº Ù†ØµÙ Ø§Ù„Ù…Ø¯Ù‰ ğŸ", /* 16 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 16: Ù…ØªÙ…ÙƒÙ† Ø¨Ø¥Ø°Ù† Ø§Ù„Ù„Ù‡", /* 17 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 17: Ù†Ø¬Ù… Ø³Ø§Ø·Ø¹ âœ¨", /* 18 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 18: Ù…Ù† Ø£Ù‡Ù„ Ø§Ù„Ù‚Ø±Ø¢Ù† (Ù…Ø±Ø´Ø­)", /* 19 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 19: Ø­Ø«ÙŠØ« Ø§Ù„Ø®Ø·Ù‰", /* 20 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 20: Ù‚Ø§Ù‡Ø± Ø§Ù„ØµØ¹Ø§Ø¨ ğŸ’ª", /* 21 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 21: Ù‡Ù…Ø© ØªÙ†Ø§Ø·Ø­ Ø§Ù„Ø³Ø­Ø§Ø¨", /* 22 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 22: Ø³ÙÙŠØ± Ø§Ù„Ø¥ØªÙ‚Ø§Ù†", /* 23 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 23: Ù…Ø«Ø§Ù„ ÙŠØ­ØªØ°Ù‰", /* 24 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 24: Ø¯Ø§Ø¦Ù… Ø§Ù„Ø°ÙƒØ±", /* 25 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 25: Ù‚Ø§Ø¨ Ù‚ÙˆØ³ÙŠÙ† Ø£Ùˆ Ø£Ø¯Ù†Ù‰ ğŸ¯", /* 26 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 26: Ø¹Ù„Ù‰ Ø£Ø¹ØªØ§Ø¨ Ø§Ù„Ø®ØªÙ…", /* 27 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 27: Ù…Ø¬Ø§ÙˆØ± Ù„Ù„ØªÙ…Ø§Ù…", /* 28 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 28: Ù…Ù‚Ø¯Ø§Ù… Ù„Ø§ ÙŠØªØ±Ø§Ø¬Ø¹", /* 29 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 29: ØµØ§Ø­Ø¨ Ø§Ù„Ù†ÙØ³ Ø§Ù„Ø·ÙˆÙŠÙ„", /* 30 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 30: Ø­Ø§Ù…Ù„ Ù„ÙˆØ§Ø¡ Ø§Ù„Ù‚Ø±Ø¢Ù† ğŸš©", /* 31 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 31: Ø£Ù‡Ù„ Ø§Ù„Ù„Ù‡ ÙˆØ®Ø§ØµØªÙ‡ (Ù…ØªÙ‚Ø¯Ù…)", /* 32 */ "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 32: Ø®Ø§ØªÙ…ÙŒ Ù…ÙØ¨Ø§Ø±Ùƒ ğŸ†ğŸ‘‘"
        ];

        // --- Data Arrays & Helper Functions ---
        const surahs = ['Ø§Ù„ÙØ§ØªØ­Ø© ÙˆØ§Ù„Ø¨Ù‚Ø±Ø©', /* ... */ 'Ø®ØªÙ… Ø§Ù„Ù‚Ø±Ø¢Ù†']; // Assume full data arrays are here
        const linkFromData = ['', '', 1, /* ... */ 577];
        const linkToData = ['', '', 2, /* ... */ 604];
        const reviewFromData = [...Array(32).fill(''), 1, /* ... */ 481];
        const reviewToData = [...Array(32).fill(''), 2, /* ... */ 576];
        function formatDate(date) { if (!(date instanceof Date)) date = new Date(date); if (isNaN(date.getTime())) return ""; const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
        function getPlanData(originalIndex) { const index = parseInt(originalIndex); if (isNaN(index) || index < 0 || index >= initialTotalRows) { return null; } let fromPage = '', toPage = ''; if (index < 299) { fromPage = index * 2 + 1; toPage = fromPage + 1; } else if (index === 299) { fromPage = 601; toPage = 604; } return { fromPage: fromPage, toPage: toPage, surah: surahs[index] || '', linkFrom: linkFromData[index] ?? '', linkTo: linkToData[index] ?? '', reviewFrom: reviewFromData[index] ?? '', reviewTo: reviewToData[index] ?? '', round: calculateRoundNumber(index) }; }
        function calculateRoundNumber(originalIndex) { if (originalIndex < 32 || !reviewFromData || reviewFromData[originalIndex] == null || reviewFromData[originalIndex] === '') { return ''; } let reviewDataStartIndex = 32; let reviewCounter = 0; for(let i = reviewDataStartIndex; i <= originalIndex; i++){ if(reviewFromData[i] != null && reviewFromData[i] !== '') reviewCounter++; } if (reviewCounter === 0) return ''; return Math.ceil(reviewCounter / 6); }

        // --- UI Update Functions ---
        function showLoading(message = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...") { if(loadingIndicator){ loadingIndicator.textContent = message; loadingIndicator.style.display = 'block';} if(dashboardContent) dashboardContent.style.display = 'none'; }
        function hideLoading() { if(loadingIndicator) loadingIndicator.style.display = 'none'; }
        function displayDashboard() { hideLoading(); if(dashboardContent) dashboardContent.style.display = 'block'; }

        // --- Functions to Calculate Stats & Streaks ---
        function calculateDashboardStats(tableRows) { /* ... (same as previous version) ... */ }

        // >> NEW: Calculate Streak Info
        function calculateStreakInfo(tableRows) {
             if (!tableRows || !Array.isArray(tableRows) || tableRows.length === 0) {
                 return { currentStreak: 0, longestStreak: 0, displayedLevel: 0 };
             }
             // Create a map for quick date lookup & filter out rows without dates
             const rowMap = new Map();
             const validRows = tableRows.filter(row => row.displayDate).sort((a, b) => a.displayDate.localeCompare(b.displayDate));
             validRows.forEach(row => rowMap.set(row.displayDate, row));

             let longestStreak = 0;
             let currentConsecutiveForward = 0;

             // Calculate longest streak by iterating through sorted valid rows
             for (let i = 0; i < validRows.length; i++) {
                 const row = validRows[i];
                 if (row.type === 'plan' && row.state?.completed) {
                     if (i > 0) {
                         const prevRow = validRows[i-1];
                         const currentDateObj = new Date(row.displayDate + 'T00:00:00Z');
                         const prevDateObj = new Date(prevRow.displayDate + 'T00:00:00Z');
                         const diffDays = Math.round((currentDateObj - prevDateObj) / (1000 * 60 * 60 * 24));

                         if (diffDays === 1) {
                              // Check if previous was also completed or excuse doesn't break sequence for longest calc?
                              // For now, assume only completed days count for streak continuation
                              if(prevRow.type === 'plan' && prevRow.state?.completed) {
                                 currentConsecutiveForward++;
                              } else {
                                 // Previous day broke the streak
                                 longestStreak = Math.max(longestStreak, currentConsecutiveForward);
                                 currentConsecutiveForward = 1; // Start new streak
                              }
                         } else { // Gap or non-consecutive
                             longestStreak = Math.max(longestStreak, currentConsecutiveForward);
                             currentConsecutiveForward = 1; // Start new streak from this completed day
                         }
                     } else { // First day in sorted list
                         currentConsecutiveForward = 1;
                     }
                 } else { // Excuse or incomplete/non-plan day breaks the streak
                     longestStreak = Math.max(longestStreak, currentConsecutiveForward);
                     currentConsecutiveForward = 0; // Reset
                 }
             }
             longestStreak = Math.max(longestStreak, currentConsecutiveForward); // Final check

             // Calculate current streak by iterating backward from today
             let currentStreak = 0;
             let dateToCheck = new Date(); // Today
             let safety = 366; // Safety break

             while (safety > 0) {
                 const dateStr = formatDate(dateToCheck);
                 const row = rowMap.get(dateStr);

                 if (!row || row.type === 'excuse' || (row.type === 'plan' && !row.state?.completed)) {
                     // Streak ends here (or never started today/yesterday)
                     break;
                 } else if (row.type === 'plan' && row.state?.completed) {
                     currentStreak++;
                     // Go to previous day
                     dateToCheck.setUTCDate(dateToCheck.getUTCDate() - 1);
                 } else {
                     // Unexpected state
                     break;
                 }
                 safety--;
             }
             if(safety === 0) console.error("Streak check backwards loop safety break triggered.");


             // Calculate displayed level based ONLY on current streak for now
             // The "drop one level" logic display needs persistent state tracking (highestLevel, currentDisplayedLevel)
             // which should ideally be updated/saved via plangen2.html or cloud functions.
             // For dashboard display simplicity *at this stage*, level reflects current consecutive days.
             const displayedLevel = Math.floor(currentStreak / 10);

             return { currentStreak, longestStreak, displayedLevel };
        }

        // --- Calendar Functions ---
        function prepareDateStatusMap(tableRows) { /* ... (same as previous) ... */ }
        function initializeCalendar(dateStatusMap) { /* ... (same as previous) ... */ }

        // --- Functions to Update Dashboard Sections ---
        function displayDailyTask() { /* ... (same as previous) ... */ }
        function displayProgress(stats) { /* ... (same as previous) ... */ }
        function displayStats(stats) { /* ... (same as previous) ... */ }

        // >> NEW: Display Streak Info
        function displayStreakInfo(streakData) {
            if (!streakCurrentEl || !streakLongestEl || !streakLevelTitleEl || !streakLevelIconEl) {
                 console.warn("Streak display elements not found.");
                 return;
            }
            const level = streakData.displayedLevel;
            const title = streakLevelTitles[level] || streakLevelTitles[0]; // Fallback

            streakCurrentEl.textContent = streakData.currentStreak || 0;
            streakLongestEl.textContent = streakData.longestStreak || 0;
            streakLevelTitleEl.textContent = title;
            // Extract icon from title string if present (simple example)
            const iconMatch = title.match(/(\p{Emoji})/u);
             streakLevelIconEl.textContent = iconMatch ? iconMatch[1] : ''; // Display emoji if found

            // Add logic later to show warning if streak is at risk?
        }

        // --- Main Data Loading Function (MODIFIED to call streak functions) ---
        function loadDashboardData(user) {
            if (!user) return;
            const uid = user.uid;
            const planRef = db.collection("quranPlans").doc(uid);
            console.log("Dashboard: Checking Firestore for plan:", uid);
            showLoading("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø·ØªÙƒ...");

            planRef.get().then((doc) => {
                hideLoading();
                if (doc.exists) {
                    console.log("Dashboard: Plan data found.");
                    currentPlanData = doc.data();

                    // Validate FULL data
                    if (!currentPlanData.startDate || !currentPlanData.planType || !currentPlanData.tableRows || !Array.isArray(currentPlanData.tableRows) || !currentPlanData.repetitionMax) {
                         // ... (Error handling for incomplete data) ...
                         console.error("Loaded data missing required fields...", currentPlanData);
                         dashboardContent.style.display = 'block';
                         dailyTaskContent.innerHTML = `<p style="color:red; font-weight:bold;">Ø®Ø·Ø£: Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø·ØªÙƒ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø© Ø£Ùˆ ØªØ§Ù„ÙØ©. ÙŠØ±Ø¬Ù‰ <a href="index.html">Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„ØµÙØ­Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</a> ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø·Ø©.</p>`;
                         document.getElementById('plan-progress').style.display = 'none';
                         document.getElementById('quick-stats').style.display = 'none';
                         const calendarContainer = document.getElementById('calendar-container'); if(calendarContainer) calendarContainer.innerHTML = "<p style='color:red;'><i>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙˆÙŠÙ….</i></p>";
                         const streakInfoCard = document.getElementById('streak-info'); if(streakInfoCard) streakInfoCard.style.display = 'none'; // Hide streak card too
                         return;
                    }

                    // Calculate Stats & Streak
                    const stats = calculateDashboardStats(currentPlanData.tableRows);
                    const streakData = calculateStreakInfo(currentPlanData.tableRows); // << Calculate Streak

                    // Prepare and Initialize Calendar
                    const dateStatusMap = prepareDateStatusMap(currentPlanData.tableRows);
                    initializeCalendar(dateStatusMap);

                    // Update Display
                    displayDailyTask();
                    displayProgress(stats);
                    displayStats(stats);
                    displayStreakInfo(streakData); // << Display Streak Info

                    displayDashboard(); // Show all content

                } else {
                     // No plan found logic
                     // ... (Hide sections as before) ...
                      const calendarContainer = document.getElementById('calendar-container'); if (calendarContainer) calendarContainer.innerHTML = "<p><i>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·Ø© Ù„Ø¹Ø±Ø¶ ØªÙ‚ÙˆÙŠÙ…Ù‡Ø§.</i></p>";
                      const streakInfoCard = document.getElementById('streak-info'); if(streakInfoCard) streakInfoCard.style.display = 'none'; // Hide streak card too
                      document.getElementById('calendar-view').style.display = 'none';
                      // ... hide other placeholders ...
                }
            }).catch((error) => {
                 // Error handling
                 // ... (Hide sections as before) ...
                  const calendarContainer = document.getElementById('calendar-container'); if (calendarContainer) calendarContainer.innerHTML = "<p style='color:red;'><i>Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚ÙˆÙŠÙ….</i></p>";
                  const streakInfoCard = document.getElementById('streak-info'); if(streakInfoCard) streakInfoCard.style.display = 'none'; // Hide streak card too
            });
        }

        // --- Authentication Listener (remains the same) ---
        auth.onAuthStateChanged(user => { /* ... */ });
        // --- Initial Load (remains the same) ---
        document.addEventListener('DOMContentLoaded', () => { /* ... */ });
         // --- Print Function (remains the same) ---
         function printData() { /* ... */ }

    </script>

</body>
</html>