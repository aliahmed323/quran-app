<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة المتابعة - خطة حفظ القرآن</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vanilla-calendar-pro/build/vanilla-calendar.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vanilla-calendar-pro/build/vanilla-calendar.min.js" defer></script>

    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

    <style>
        /* --- CSS Styles (تعديلات طفيفة وإضافات للتقويم والـ Streak) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; background-color: #f4f7f6; color: #333; line-height: 1.7; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        h1, h2, h3, h4 { color: #1a5276; margin-bottom: 0.75em; }
        p { margin-bottom: 1em; color: #555; font-size: 0.95em; }
        a { text-decoration: none; color: #2980b9; }
        .card { background-color: #fff; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 3px 6px rgba(0,0,0,0.05); border: 1px solid #e0e0e0; }

        /* --- Header --- */
        .dashboard-header { display: flex; justify-content: center; align-items: center; padding: 10px 20px; margin-bottom: 25px; border-bottom: 2px solid #aed6f1; background-color: #fff; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .dashboard-header .logo h1 { margin: 0; font-size: 1.8em; color: #1a5276; }

        /* --- Dashboard Layout (تم تعديل الشبكة لاستيعاب القسم الجديد) --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* أصبح متجاوبًا أكثر */ grid-template-rows: auto; gap: 25px; }
        #daily-task { grid-column: span 2; } /* يأخذ عمودين إذا كان هناك مساحة */
        #plan-progress {}
        #quick-stats {}
        #streak-level-section { /* قسم جديد للـ Streak */ }
        #calendar-view {}
        #competition-section {} /* تم الإبقاء عليه مؤقتاً */
        #badges-section { grid-column: span 3; } /* يأخذ العرض الكامل إذا كان هناك مساحة */

        /* Media query لتعديل تخطيط الشبكة في الشاشات الأصغر */
        @media (max-width: 992px) {
             .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
             #daily-task { grid-column: span 2; }
             #badges-section { grid-column: span 2; }
        }
        @media (max-width: 768px) { /* تعديل إضافي لشاشات أصغر */
             .dashboard-grid { grid-template-columns: 1fr; }
             #daily-task, #plan-progress, #quick-stats, #streak-level-section, #calendar-view, #competition-section, #badges-section { grid-column: span 1; }
        }
        @media (max-width: 600px) {
             .dashboard-header .logo h1 { font-size: 1.5em;}
             .card { padding: 15px; }
             h2 { font-size: 1.4em; }
             h3 { font-size: 1.1em; }
        }

        /* --- Section Specific Styles --- */
        #daily-task h3 { color: #1e8449; font-size: 1.3em; border-bottom: 2px solid #aed6f1; padding-bottom: 8px;}
        #daily-task-content { min-height: 80px; padding-top: 10px;} /* تقليل الارتفاع الأدنى قليلاً */
        #daily-task-content p { margin-bottom: 0.6em; font-size: 1.05em; line-height: 1.8; }
        #daily-task-content strong { color: #1a5276; margin-left: 8px;}
        #daily-task .plan-link { margin-top: 15px; display: inline-block; font-size: 0.9em; background-color: #5dade2; color: white; padding: 5px 10px; border-radius: 4px; }
        #daily-task .plan-link:hover { background-color: #3498db; }

        #plan-progress h3, #quick-stats h3, #streak-level-section h3, #calendar-view h3, #competition-section h3, #badges-section h3 { font-size: 1.15em; }
        #plan-progress .progress-bar-container { background-color: #e9ecef; border-radius: 0.25rem; height: 25px; overflow: hidden; margin-top: 10px; border: 1px solid #ccc; }
        #plan-progress .progress-bar-value { background-color: #28a745; height: 100%; width: 0%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.9em; font-weight: bold; transition: width 0.6s ease-in-out; }
        #quick-stats ul { list-style: none; padding: 0; margin-top: 15px;}
        #quick-stats ul li { margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px dotted #eee; font-size: 0.95em;}
        #quick-stats ul li strong { margin-left: 5px; color: #1a5276; min-width: 110px; display: inline-block;}
        #quick-stats ul li span { color: #1e8449; font-weight: bold;}

        /* --- Styles for Streak & Level Section (جديد) --- */
        #streak-level-section .streak-info { margin-top: 15px; text-align: center; }
        #streak-level-section .streak-item { margin-bottom: 10px; }
        #streak-level-section .streak-label { font-weight: bold; color: #1a5276; display: block; margin-bottom: 3px; font-size: 0.95em; }
        #streak-level-section .streak-value { font-size: 1.4em; font-weight: bold; color: #1e8449; }
        #streak-level-section .level-title { font-size: 1.2em; font-weight: bold; color: #884ea0; margin-top: 15px; }
        #streak-level-section .level-icon { font-size: 2em; margin-right: 8px; vertical-align: middle; }

        /* --- Styles for Calendar (جديد) --- */
        #calendar-container { margin-top: 15px; }
        /* تخصيص ألوان أيام التقويم */
        .vanilla-calendar-day--completed .vanilla-calendar-day__btn { background-color: #a9dfbf !important; color: #145a32 !important; font-weight: bold; }
        .vanilla-calendar-day--excused .vanilla-calendar-day__btn { background-color: #f5b7b1 !important; color: #922b21 !important; text-decoration: line-through; }
        .vanilla-calendar-day--today .vanilla-calendar-day__btn { border: 2px solid #2980b9 !important; background-color: #ebf5fb !important; color: #1a5276 !important; font-weight: bold; }
        /* تقليل حجم التقويم قليلاً */
        .vanilla-calendar { width: 100%; max-width: 320px; margin: 0 auto; box-shadow: none; border: 1px solid #ddd; padding: 10px; }
        .vanilla-calendar-header { padding-bottom: 5px; }
        .vanilla-calendar-week__day { font-size: 0.8em; }
        .vanilla-calendar-day__btn { height: 30px; width: 30px; font-size: 0.85em; }

        /* Enhanced Placeholder Styles (تم الإبقاء عليها للأقسام الأخرى) */
        .placeholder-box { min-height: 150px; background-color: #f0f4f8; border: 1px dashed #ccc; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #777; border-radius: 5px; padding: 15px; text-align: center; }
        .placeholder-box .icon { font-size: 3em; margin-bottom: 10px; opacity: 0.5; }
        .placeholder-box .text { font-style: italic; font-size: 0.9em; }

        /* Footer */
        .main-footer { text-align: center; padding: 20px; margin-top: 40px; background-color: #2c3e50; color: #ecf0f1; font-size: 0.9em; }
        .main-footer a { color: #3498db; }

        /* Action Buttons Hidden */
        .action-buttons { display: none; }

        /* Loading Indicator */
        #loading-indicator { text-align: center; padding: 50px; font-size: 1.3em; color: #1a5276; display: block; }

    </style>
</head>
<body>

    <div class="container">

        <header class="dashboard-header">
            <div class="logo"><h1>خطة حفظ القرآن الكريم</h1></div>
        </header>

        <div id="loading-indicator">جاري التحميل...</div>

        <main id="dashboard-content" style="display: none;">

            <div class="dashboard-grid">

                <section id="daily-task" class="card">
                    <h3>🌟 واجب اليوم (<span id="today-date-display">...</span>)</h3>
                    <div id="daily-task-content">
                        <p><i>يتم تحديد الواجب...</i></p>
                    </div>
                    <a href="plangen2.html" class="plan-link">الذهاب إلى جدول الخطة التفصيلي &raquo;</a>
                </section>

                <section id="plan-progress" class="card">
                    <h3>الخطة والتقدم العام</h3>
                    <p><strong>الخطة النشطة:</strong> <span id="current-plan-name">-</span></p>
                    <p><strong>التقدم الكلي:</strong></p>
                    <div class="progress-bar-container">
                        <div id="progress-bar-value" class="progress-bar-value">0%</div>
                    </div>
                    <p style="font-size: 0.9em; text-align: center; margin-top: 5px;">
                        <span id="completed-pages-progress">0</span> / 604 صفحة
                    </p>
                </section>

                <section id="quick-stats" class="card">
                    <h3>إحصائيات سريعة</h3>
                    <ul>
                        <li><strong>الصفحات المحفوظة:</strong> <span id="stat-memorized">0</span></li>
                        <li><strong>الصفحات المتقنة:</strong> <span id="stat-perfected">0</span></li>
                        <li><strong>الصفحات المربوطة:</strong> <span id="stat-linked">0</span></li>
                        <li><strong>أيام الأعذار:</strong> <span id="stat-excuses">0</span></li>
                    </ul>
                </section>

                <section id="streak-level-section" class="card">
                     <h3>🔥 أيام الإنجاز المتتالي والمستوى</h3>
                     <div class="streak-info">
                         <div class="streak-item">
                             <span class="streak-label">الـ Streak الحالي:</span>
                             <span class="streak-value" id="current-streak">0</span> يوم
                         </div>
                         <div class="streak-item">
                             <span class="streak-label">أطول Streak:</span>
                             <span class="streak-value" id="longest-streak">0</span> يوم
                         </div>
                         <div class="level-title">
                             <span class="level-icon" id="current-level-icon">🏁</span>
                             <span id="current-level-title">مبتدئ</span>
                         </div>
                     </div>
                </section>

                <section id="calendar-view" class="card">
                    <h3>التقويم وتتبع الإنجاز</h3>
                    <div id="calendar-container">
                         <div id="vanilla-calendar" style="min-height: 280px;"></div>
                    </div>
                </section>

                <section id="competition-section" class="card">
                    <h3>المنافسة</h3>
                    <div class="placeholder-box">
                        <div class="icon">🏆</div>
                        <div class="text">(قريباً: لوحة الصدارة)</div>
                    </div>
                </section>

                <section id="badges-section" class="card">
                    <h3>الأوسمة</h3>
                    <div class="placeholder-box">
                        <div class="icon">🏅</div>
                        <div class="text">(قريباً: نظام الأوسمة والحوافز)</div>
                    </div>
                </section>

            </div>
        </main>

        <footer class="main-footer">
            <p>&copy; 2025 خطة حفظ القرآن الكريم. جميع الحقوق محفوظة.</p>
        </footer>

    </div>

    <script>
        // --- Firebase Config (كما هي) ---
        const firebaseConfig = {
          apiKey: "AIzaSyDuUebu7Qzz3JnTfa-58EIPZjOcrkmdGHU",
          authDomain: "quranplan2.firebaseapp.com",
          projectId: "quranplan2",
          storageBucket: "quranplan2.appspot.com",
          messagingSenderId: "1098692856811",
          appId: "1:1098692856811:web:923bca3a54fd78b1b267ae"
        };

        // --- Initialize Firebase (كما هي) ---
        try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Firebase initialization error:", e); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM References (إضافة مراجع للعناصر الجديدة) ---
        const loadingIndicator = document.getElementById('loading-indicator');
        const dashboardContent = document.getElementById('dashboard-content');
        const dailyTaskContent = document.getElementById('daily-task-content');
        const currentPlanNameSpan = document.getElementById('current-plan-name');
        const progressBarValue = document.getElementById('progress-bar-value');
        const completedPagesProgressSpan = document.getElementById('completed-pages-progress');
        const statMemorized = document.getElementById('stat-memorized');
        const statPerfected = document.getElementById('stat-perfected');
        const statLinked = document.getElementById('stat-linked');
        const statExcuses = document.getElementById('stat-excuses');
        const todayDateSpan = document.getElementById('today-date-display');
        // مراجع جديدة
        const currentStreakSpan = document.getElementById('current-streak');
        const longestStreakSpan = document.getElementById('longest-streak');
        const currentLevelTitleSpan = document.getElementById('current-level-title');
        const currentLevelIconSpan = document.getElementById('current-level-icon');
        const calendarContainer = document.getElementById('vanilla-calendar');

        // --- Constants (كما هي) ---
        const totalQuranPages = 604;
        const initialTotalRows = 320; // عدد الأيام الكلي للخطة

        // --- Global State ---
        let currentUser = null;
        let currentPlanData = null; // Stores the FULL plan data
        let calendarInstance = null; // للحفاظ على مرجع للتقويم

        // --- Data Arrays & Helper Functions (كما هي) ---
        const surahs = ['الفاتحة والبقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة وآل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء والمائدة', 'المائدة', 'المائدة', 'المائدة', 'المائدة', 'المائدة', 'المائدة', 'المائدة', 'المائدة', 'المائدة', 'المائدة', 'المائدة والأنعام', 'الأنعام', 'الأنعام', 'الأنعام', 'الأنعام', 'الأنعام', 'الأنعام', 'الأنعام', 'الأنعام', 'الأنعام', 'الأنعام', 'الأنعام', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأنفال', 'الأنفال', 'الأنفال', 'الأنفال', 'الأنفال', 'التوبة', 'التوبة', 'التوبة', 'التوبة', 'التوبة', 'التوبة', 'التوبة', 'التوبة', 'التوبة', 'التوبة', 'التوبة ويونس', 'يونس', 'يونس', 'يونس', 'يونس', 'يونس', 'يونس', 'يونس وهود', 'هود', 'هود', 'هود', 'هود', 'هود', 'هود', 'هود ويوسف', 'يوسف', 'يوسف', 'يوسف', 'يوسف', 'يوسف', 'يوسف', 'الرعد', 'الرعد', 'الرعد', 'إبراهيم', 'إبراهيم', 'إبراهيم', 'إبراهيم والحجر', 'الحجر', 'الحجر', 'الحجر والنحل', 'النحل', 'النحل', 'النحل', 'النحل', 'النحل', 'النحل', 'النحل والإسراء', 'الإسراء', 'الإسراء', 'الإسراء', 'الإسراء', 'الإسراء', 'الإسراء والكهف', 'الكهف', 'الكهف', 'الكهف', 'الكهف', 'الكهف', 'مريم', 'مريم', 'مريم', 'مريم وطه', 'طه', 'طه', 'طه', 'طه', 'طه والأنبياء', 'الأنبياء', 'الأنبياء', 'الأنبياء', 'الأنبياء', 'الأنبياء والحج', 'الحج', 'الحج', 'الحج', 'الحج', 'الحج والمؤمنون', 'المؤمنون', 'المؤمنون', 'المؤمنون', 'المؤمنون والنور', 'النور', 'النور', 'النور', 'النور', 'النور والفرقان', 'الفرقان', 'الفرقان', 'الفرقان', 'الشعراء', 'الشعراء', 'الشعراء', 'الشعراء', 'الشعراء', 'النمل', 'النمل', 'النمل', 'النمل', 'النمل والقصص', 'القصص', 'القصص', 'القصص', 'القصص', 'القصص والعنكبوت', 'العنكبوت', 'العنكبوت', 'العنكبوت', 'العنكبوت والروم', 'الروم', 'الروم', 'الروم', 'لقمان', 'لقمان', 'السجدة', 'السجدة والأحزاب', 'الأحزاب', 'الأحزاب', 'الأحزاب', 'الأحزاب', 'الأحزاب وسبأ', 'سبأ', 'سبأ', 'سبأ وفاطر', 'فاطر', 'فاطر', 'فاطر ويس', 'يس', 'يس', 'يس والصافات', 'الصافات', 'الصافات', 'الصافات', 'ص', 'ص', 'ص والزمر', 'الزمر', 'الزمر', 'الزمر', 'الزمر', 'غافر', 'غافر', 'غافر', 'غافر', 'غافر', 'فصلت', 'فصلت', 'فصلت', 'الشورى', 'الشورى', 'الشورى', 'الشورى والزخرف', 'الزخرف', 'الزخرف', 'الزخرف والدخان', 'الدخان', 'الجاثية', 'الجاثية والأحقاف', 'الأحقاف', 'الأحقاف', 'محمد', 'محمد', 'الفتح', 'الفتح', 'الفتح والحجرات', 'الحجرات و ق', 'ق', 'الذاريات', 'الذاريات والطور', 'الطور والنجم', 'النجم والقمر', 'القمر', 'القمر والرحمن', 'الرحمن والواقعة', 'الواقعة', 'الواقعة والحديد', 'الحديد', 'الحديد والمجادلة', 'المجادلة', 'المجادلة والحشر', 'الحشر', 'الممتحنة', 'الممتحنة والصف', 'الجمعة والمنافقون', 'المنافقون والتغابن', 'التغابن والطلاق', 'الطلاق والتحريم', 'التحريم والملك', 'الملك والقلم', 'القلم والحاقة', 'الحاقة والمعارج', 'المعارج ونوح', 'نوح والجن', 'الجن والمزمل', 'المزمل والمدثر', 'المدثر والقيامة والإنسان', 'الإنسان والمرسلات', 'المرسلات والنبأ', 'النبأ والنازعات', 'عبس والتكوير', 'الإنفطار والمطففين', 'الإنشقاق والبروج', 'الطارق والأعلى والغاشية', 'الفجر والبلد', 'الشمس والليل', 'الضحى إلى الناس', 'ختم القرآن'];
        const linkFromData = ['', '', 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, 13,13,13,13,13,13,25,25,25,25,25,25,37,37,37,37,37,37,49,49,49,49,49,49,61,61,61,61,61,61, 73,73,73,73,73,73,85,85,85,85,85,85,97,97,97,97,97,97,109,109,109,109,109,109,121,121,121,121,121,121, 133,133,133,133,133,133,145,145,145,145,145,145,157,157,157,157,157,157,169,169,169,169,169,169,181,181,181,181,181,181, 193,193,193,193,193,193,205,205,205,205,205,205,217,217,217,217,217,217,229,229,229,229,229,229,241,241,241,241,241,241, 253,253,253,253,253,253,265,265,265,265,265,265,277,277,277,277,277,277,289,289,289,289,289,289,301,301,301,301,301,301, 313,313,313,313,313,313,325,325,325,325,325,325,337,337,337,337,337,337,349,349,349,349,349,349,361,361,361,361,361,361, 373,373,373,373,373,373,385,385,385,385,385,385,397,397,397,397,397,397,409,409,409,409,409,409,421,421,421,421,421,421, 433,433,433,433,433,433,445,445,445,445,445,445,457,457,457,457,457,457,469,469,469,469,469,469,481,481,481,481,481,481, 493,493,493,493,493,493,505,505,505,505,505,505,517,517,517,517,517,517,529,529,529,529,529,529,541,541,541,541,541,541, 553,553,553,553,553,553,565,565,565,565,565,565,577,577,577,577,577,577];
        const linkToData = ['', '', 2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40,42,44,46,48,50,52,54,56,58,60, 62,64,66,68,70,72,74,76,78,80,82,84,86,88,90,92,94,96,98,100,102,104,106,108,110,112,114,116, 118,120,122,124,126,128,130,132,134,136,138,140,142,144,146,148,150,152,154,156,158,160,162,164,166,168, 170,172,174,176,178,180,182,184,186,188,190,192,194,196,198,200,202,204,206,208,210,212,214,216,218,220, 222,224,226,228,230,232,234,236,238,240,242,244,246,248,250,252,254,256,258,260,262,264,266,268,270,272, 274,276,278,280,282,284,286,288,290,292,294,296,298,300,302,304,306,308,310,312,314,316,318,320,322,324, 326,328,330,332,334,336,338,340,342,344,346,348,350,352,354,356,358,360,362,364,366,368,370,372,374,376, 378,380,382,384,386,388,390,392,394,396,398,400,402,404,406,408,410,412,414,416,418,420,422,424,426,428, 430,432,434,436,438,440,442,444,446,448,450,452,454,456,458,460,462,464,466,468,470,472,474,476,478,480, 482,484,486,488,490,492,494,496,498,500,502,504,506,508,510,512,514,516,518,520,522,524,526,528,530,532, 534,536,538,540,542,544,546,548,550,552,554,556,558,560,562,564,566,568,570,572,574,576,578,580,582,584, 586,588,590,592,594,597,600,604];
        const reviewFromData = [...Array(32).fill(''), 1,3,5,7,9,11,1,5,9,13,17,21,1,7,13,19,25,31,1,9,17,25,33,41, 1,11,21,31,41,51,1,13,25,37,49,61,1,15,29,43,57,71,1,17,33,49,65,81, 1,19,37,55,73,91,1,21,41,61,81,101,1,23,45,67,89,111,1,25,49,73,97,121, 1,27,53,79,105,131,1,29,57,85,113,141,1,31,61,91,121,151,1,33,65,97,129,161, 1,35,69,103,137,171,1,37,73,109,145,181,1,39,77,115,153,191,1,41,81,121,161,201, 1,43,85,127,169,211,1,45,89,133,177,221,1,47,93,139,185,231,1,49,97,145,193,241, 1,51,101,151,201,251,1,53,105,157,209,261,1,55,109,163,217,271,1,57,113,169,225,281, 1,59,117,175,233,291,1,61,121,181,241,301,1,63,125,187,249,311,1,65,129,193,257,321, 1,67,133,199,265,331,1,69,137,205,273,341,1,71,141,211,281,351,1,73,145,217,289,361, 1,75,149,223,297,371,1,77,153,229,305,381,1,79,157,235,313,391,1,81,161,241,321,401, 1,83,165,247,329,411,1,85,169,253,337,421,1,87,173,259,345,431,1,89,177,265,353,441, 1,91,181,271,361,451,1,93,185,277,369,461,1,95,189,283,377,471,1,97,193,289,385,481];
        const reviewToData = [...Array(32).fill(''), 2,4,6,8,10,12,4,8,12,16,20,24,6,12,18,24,30,36,8,16,24,32,40,48, 10,20,30,40,50,60,12,24,36,48,60,72,14,28,42,56,70,84,16,32,48,64,80,96, 18,36,54,72,90,108,20,40,60,80,100,120,22,44,66,88,110,132,24,48,72,96,120,144, 26,52,78,104,130,156,28,56,84,112,140,168,30,60,90,120,150,180,32,64,96,128,160,192, 34,68,102,136,170,204,36,72,108,144,180,216,38,76,114,152,190,228,40,80,120,160,200,240, 42,84,126,168,210,252,44,88,132,176,220,264,46,92,138,184,230,276,48,96,144,192,240,288, 50,100,150,200,250,300,52,104,156,208,260,312,54,108,162,216,270,324,56,112,168,224,280,336, 58,116,174,232,290,348,60,120,180,240,300,360,62,124,186,248,310,372,64,128,192,256,320,384, 66,132,198,264,330,396,68,136,204,272,340,408,70,140,210,280,350,420,72,144,216,288,360,432, 74,148,222,296,370,444,76,152,228,304,380,456,78,156,234,312,390,468,80,160,240,320,400,480, 82,164,246,328,410,492,84,168,252,336,420,504,86,172,258,344,430,516,88,176,264,352,440,528, 90,180,270,360,450,540,92,184,276,368,460,552,94,188,282,376,470,564,96,192,288,384,480,576];

        // --- Helper Functions (إضافة دالة تحويل النص لتاريخ) ---
        function formatDate(date) { if (!(date instanceof Date)) date = new Date(date); if (isNaN(date.getTime())) return ""; const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
        function getDateFromString(dateString) { // YYYY-MM-DD
            if (!dateString) return null;
            const parts = dateString.split('-');
            if (parts.length !== 3) return null;
            // ملاحظة: الشهر في كائن Date يبدأ من 0 (يناير)
            return new Date(Date.UTC(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2])));
        }
        function getPlanData(originalIndex) { const index = parseInt(originalIndex); if (isNaN(index) || index < 0 || index >= initialTotalRows) { return null; } let fromPage = '', toPage = ''; if (index < 299) { fromPage = index * 2 + 1; toPage = fromPage + 1; } else if (index === 299) { fromPage = 601; toPage = 604; } return { fromPage: fromPage, toPage: toPage, surah: surahs[index] || '', linkFrom: linkFromData[index] ?? '', linkTo: linkToData[index] ?? '', reviewFrom: reviewFromData[index] ?? '', reviewTo: reviewToData[index] ?? '', round: calculateRoundNumber(index) }; }
        function calculateRoundNumber(originalIndex) { if (originalIndex < 32 || !reviewFromData || reviewFromData[originalIndex] == null || reviewFromData[originalIndex] === '') { return ''; } let reviewDataStartIndex = 32; let reviewCounter = 0; for(let i = reviewDataStartIndex; i <= originalIndex; i++){ if(reviewFromData[i] != null && reviewFromData[i] !== '') reviewCounter++; } if (reviewCounter === 0) return ''; return Math.ceil(reviewCounter / 6); }

        // --- UI Update Functions ---
        function showLoading(message = "جاري التحميل...") { if(loadingIndicator){ loadingIndicator.textContent = message; loadingIndicator.style.display = 'block';} if(dashboardContent) dashboardContent.style.display = 'none'; }
        function hideLoading() { if(loadingIndicator) loadingIndicator.style.display = 'none'; }
        function displayDashboard() { hideLoading(); if(dashboardContent) dashboardContent.style.display = 'block'; }

        // --- Functions to Calculate Stats from tableRows (كما هي) ---
        function calculateDashboardStats(tableRows) {
            let lastCompletedPage = 0;
            let linkedTasks = 0;
            let perfectedTasks = 0; // Based on 'reviewed' state
            let excuseCount = 0;

            if (!tableRows) return { memorizedPages: 0, linkedTasks: 0, perfectedTasks: 0, excuseCount: 0 };

            tableRows.forEach(row => {
                if (row.type === 'excuse') {
                    excuseCount++;
                } else if (row.type === 'plan' && row.state && row.state.completed) {
                    const planInfo = getPlanData(row.originalSequence);
                    if (planInfo && planInfo.toPage) {
                        const pageNum = parseInt(planInfo.toPage);
                        if (!isNaN(pageNum)) {
                            lastCompletedPage = Math.max(lastCompletedPage, pageNum);
                        }
                    }
                    if (planInfo && planInfo.linkTo !== '' && row.state.linked) {
                        linkedTasks++;
                    }
                    if (planInfo && planInfo.reviewTo !== '' && row.state.reviewed) {
                        perfectedTasks++;
                    }
                }
            });
            const memorizedPages = Math.min(lastCompletedPage, totalQuranPages);
            return { memorizedPages: memorizedPages, linkedTasks: linkedTasks, perfectedTasks: perfectedTasks, excuseCount: excuseCount };
        }

        // --- Levels & Titles Definition (جديد) ---
        const levelsAndTitles = [
            { level: 0, title: 'مبتدئ', icon: '🏁' }, // المستوى الافتراضي
            { level: 1, title: 'ساعٍ للعلا', icon: '🌱' }, // 10-19
            { level: 2, title: 'مثابر مجتهد', icon: '🏃‍♂️' }, // 20-29
            { level: 3, title: 'صاحب همة', icon: '💪' }, // 30-39
            { level: 4, title: 'رفيق القرآن', icon: '📖' }, // 40-49
            { level: 5, title: 'طالب علم', icon: '🎓' }, // 50-59
            { level: 6, title: 'حافظ متقن', icon: '✨' }, // 60-69
            { level: 7, title: 'من أهل الله وخاصته', icon: '💖' }, // 70-79
            { level: 8, title: 'نجم ساطع', icon: '🌟' }, // 80-89
            { level: 9, title: 'صاحب المئة يوم', icon: '💯' }, // 90-99
            { level: 10, title: 'قائد المسيرة', icon: '🏆' }, // 100-109 - أيقونة مميزة
            { level: 11, title: 'حامل اللواء', icon: '🚩' }, // 110-119
            { level: 12, title: 'مُعلم الأجيال', icon: '👨‍🏫' }, // 120-129
            { level: 13, title: 'قدوة حسنة', icon: '⭐' }, // 130-139
            { level: 14, title: 'إمام متقن', icon: '🕌' }, // 140-149
            { level: 15, title: 'صاحب العزيمة الفولاذية', icon: '🦾' }, // 150-159
            { level: 16, title: 'نور على نور', icon: '💡' }, // 160-169
            { level: 17, title: 'صاحب المئتي يوم', icon: '🏅' }, // 170-179
            { level: 18, title: 'مُجدد الهمم', icon: '🚀' }, // 180-189
            { level: 19, title: 'فارس القرآن', icon: '⚔️' }, // 190-199
            { level: 20, title: 'خادم الكتاب', icon: '📚' }, // 200-209
            { level: 21, title: 'مُحقق الأهداف', icon: '🎯' }, // 210-219
            { level: 22, title: 'صاحب القلب العامر', icon: '❤️' }, // 220-229
            { level: 23, title: 'سفير القرآن', icon: '🌐' }, // 230-239
            { level: 24, title: 'جبل شامخ', icon: '⛰️' }, // 240-249
            { level: 25, title: 'صاحب الثلاثمائة يوم', icon: '👑' }, // 250-259
            { level: 26, title: 'رافع الهمة', icon: '📈' }, // 260-269
            { level: 27, title: 'مُتقن مُعلم', icon: '🥇' }, // 270-279
            { level: 28, title: 'وارث الأنبياء', icon: '🙏' }, // 280-289
            { level: 29, title: 'نبراس الهدى', icon: '🕯️' }, // 290-299
            { level: 30, title: 'صاحب الإنجاز العظيم', icon: '🎉' }, // 300-309
            { level: 31, title: 'رفيق الملأ الأعلى', icon: '🕊️' }, // 310-319
            { level: 32, title: 'خاتم الحفاظ الأبرار', icon: '🎇' }, // 320+
        ];

        // --- Function to Calculate Streak & Level (جديد) ---
        function calculateStreaksAndLevel(tableRows, todayStr) {
            if (!tableRows || tableRows.length === 0) {
                return { currentStreak: 0, longestStreak: 0, currentLevel: 0, highestLevelAchieved: 0, effectiveLevel: 0 };
            }

            let currentStreak = 0;
            let longestStreak = 0;
            let tempStreak = 0;
            let lastCompletionDate = null; // تاريخ آخر يوم تم إكماله
            let highestLevelAchieved = 0; // أعلى مستوى تم الوصول إليه تاريخيًا
            let streakBroken = false; // هل انكسر الستريك مؤخرًا؟

            // فرز الصفوف حسب التاريخ للتأكد من الترتيب
            const sortedRows = [...tableRows].sort((a, b) => {
                const dateA = getDateFromString(a.displayDate);
                const dateB = getDateFromString(b.displayDate);
                if (!dateA || !dateB) return 0;
                return dateA - dateB;
            });

            const todayDate = getDateFromString(todayStr);
            let yesterdayDate = new Date(todayDate);
            yesterdayDate.setDate(yesterdayDate.getDate() - 1);

            // حساب أعلى مستوى تم الوصول إليه سابقاً بناءً على أطول Streak تاريخي
            // هذا الجزء يحتاج إلى تخزين أطول streak في Firestore إذا أردنا دقة تاريخية
            // كحل مؤقت، سنحسبه بناءً على السجل الحالي في tableRows
            let historicalLongestStreak = 0;
            let tempHistoricalStreak = 0;
             sortedRows.forEach(row => {
                 if (row.type === 'plan' && row.state?.completed) {
                     tempHistoricalStreak++;
                 } else {
                     historicalLongestStreak = Math.max(historicalLongestStreak, tempHistoricalStreak);
                     tempHistoricalStreak = 0; // Reset streak if not completed or excuse
                 }
             });
             historicalLongestStreak = Math.max(historicalLongestStreak, tempHistoricalStreak); // Check last sequence
             highestLevelAchieved = Math.floor(historicalLongestStreak / 10);


            // حساب الـ Streak الحالي وأطول Streak (مع اعتبار الانقطاع)
            for (const row of sortedRows) {
                const rowDate = getDateFromString(row.displayDate);
                if (!rowDate || rowDate >= todayDate) {
                    // نتوقف عند الوصول لليوم الحالي (الستريك يعتمد على الأيام الماضية)
                    break;
                }

                if (row.type === 'plan' && row.state?.completed) {
                    // إذا كان هناك انقطاع قبل هذا اليوم
                    if (lastCompletionDate && (rowDate - lastCompletionDate) > (1000 * 60 * 60 * 24 + 60000)) { // أكثر من يوم واحد فرق (نضيف دقيقة احتياط)
                        longestStreak = Math.max(longestStreak, tempStreak);
                        tempStreak = 1; // بداية ستريك جديد
                        streakBroken = true; // حدث انقطاع
                    } else {
                        tempStreak++;
                    }
                    lastCompletionDate = rowDate; // تحديث تاريخ آخر إكمال
                } else {
                    // انقطاع بسبب عدم الإكمال أو عذر
                    longestStreak = Math.max(longestStreak, tempStreak);
                    tempStreak = 0;
                    if(rowDate <= yesterdayDate) { // فقط إذا كان الانقطاع قبل يوم أمس
                       streakBroken = true;
                    }
                    lastCompletionDate = null; // إعادة تعيين تاريخ آخر إكمال
                }
            }
            longestStreak = Math.max(longestStreak, tempStreak); // التحقق من الستريك الأخير
            currentStreak = tempStreak; // الستريك الحالي هو آخر ستريك متصل

            // تحديد المستوى الحالي بناءً على الـ Streak الحالي
            let currentLevel = Math.min(32, Math.floor(currentStreak / 10));

            // تطبيق قاعدة الرجوع مستوى واحد للخلف عند الانقطاع
            let effectiveLevel = currentLevel;
            if (streakBroken && currentStreak === 0) { // إذا انكسر الستريك تمامًا اليوم
                 effectiveLevel = Math.max(0, highestLevelAchieved - 1);
            } else {
                 // إذا استمر الستريك أو بدأ من جديد، المستوى هو المستوى الحالي الطبيعي
                 effectiveLevel = currentLevel;
                 // تحديث أعلى مستوى وصل إليه المستخدم *إذا كان الستريك الحالي أكبر*
                 if (currentLevel > highestLevelAchieved) {
                     highestLevelAchieved = currentLevel;
                     // هنا يمكن إضافة كود لتحديث highestLevelAchieved في Firestore للمستقبل
                 }
            }


            // تأكد من أن المستوى الفعال لا يتجاوز الحد الأقصى
             effectiveLevel = Math.min(32, effectiveLevel);


            return {
                currentStreak: currentStreak,
                longestStreak: longestStreak, // أو historicalLongestStreak إذا أردنا الأطول تاريخيًا بشكل أدق
                highestLevelAchieved: highestLevelAchieved,
                effectiveLevel: effectiveLevel // المستوى الذي سيتم عرضه
            };
        }


        // --- Function to Initialize and Update Calendar (جديد) ---
        function initializeAndUpdateCalendar(tableRows, todayStr) {
            if (!calendarContainer) return;

            // إعداد البيانات للتقويم
            const markedDates = [];
            let firstPlanDate = null;

            if (tableRows && tableRows.length > 0) {
                tableRows.forEach(row => {
                    if (!firstPlanDate && row.displayDate) {
                        firstPlanDate = row.displayDate; // تحديد تاريخ أول يوم في الخطة
                    }
                    if (row.displayDate) {
                        let cssClass = '';
                        if (row.type === 'excuse') {
                            cssClass = 'vanilla-calendar-day--excused';
                        } else if (row.type === 'plan' && row.state?.completed) {
                            cssClass = 'vanilla-calendar-day--completed';
                        }

                        if (row.displayDate === todayStr) {
                            cssClass += ' vanilla-calendar-day--today'; // إضافة كلاس اليوم الحالي
                        }

                        if (cssClass) {
                            markedDates.push({
                                date: row.displayDate,
                                description: row.type === 'excuse' ? `عذر: ${row.excuseType || ''}` : (row.state?.completed ? 'تم الإنجاز' : 'مقرر'), // نص وصفي اختياري
                                cssClass: cssClass.trim() // إضافة الكلاسات المخصصة
                            });
                        } else if (row.displayDate === todayStr) {
                             // التعامل مع حالة اليوم الحالي إذا لم يكن منجزًا أو عذرًا
                              markedDates.push({
                                date: row.displayDate,
                                description: 'اليوم الحالي',
                                cssClass: 'vanilla-calendar-day--today'
                            });
                        }
                    }
                });
            }

             // تحديد الشهر الذي سيعرضه التقويم (شهر اليوم الحالي أو شهر أول يوم بالخطة إذا كان مستقبليًا)
            const initialCalendarDate = firstPlanDate ? new Date(firstPlanDate + 'T00:00:00Z') : new Date();
            if (new Date() > initialCalendarDate) {
                initialCalendarDate = new Date(); // اعرض الشهر الحالي إذا بدأت الخطة بالفعل
            }


            const options = {
                type: 'month', // عرض شهري
                settings: {
                    lang: 'ar-SA', // استخدام اللغة العربية للتقويم
                    iso8601: false, // الأسبوع يبدأ من الأحد
                    range: {
                        disablePast: false, // السماح برؤية التواريخ الماضية
                    },
                    visibility: {
                        theme: 'light', // أو 'dark'
                        weekend: false, // عدم تمييز عطلة نهاية الأسبوع تلقائيا
                        today: false, // تمييز اليوم الحالي يتم عبر الكلاس المخصص
                    },
                     selection: {
                        day: false, // تعطيل اختيار الأيام بالنقر
                    },
                     // إضافة الأيام المميزة
                     selected: {
                         dates: markedDates.map(d => d.date), // تواريخ الأيام
                         modifier: (dayEl, date) => { // دالة لتطبيق الكلاسات
                              const mark = markedDates.find(d => d.date === date);
                              if (mark && mark.cssClass) {
                                  mark.cssClass.split(' ').forEach(cls => dayEl.classList.add(cls));
                              }
                         }
                    }
                },
                // تعيين التاريخ الأولي للعرض
                 date: {
                     today: initialCalendarDate // ابدأ من الشهر الحالي أو شهر بداية الخطة
                }
            };

            // تدمير المثيل القديم إذا كان موجودًا قبل إنشاء واحد جديد
            if (calendarInstance) {
                calendarInstance.destroy();
            }
            // إنشاء التقويم
             if (typeof VanillaCalendar !== 'undefined') {
                calendarInstance = new VanillaCalendar(calendarContainer, options);
                calendarInstance.init();
            } else {
                console.error("Vanilla JS Calendar library not loaded.");
                calendarContainer.innerHTML = "<p>خطأ: لم يتم تحميل مكتبة التقويم.</p>";
            }
        }


        // --- MODIFIED Functions to Update Dashboard Sections ---
        function displayDailyTask() {
            if (!dailyTaskContent || !currentPlanData || !currentPlanData.tableRows) {
                if(dailyTaskContent) dailyTaskContent.innerHTML = '<p><i>جاري تحميل بيانات الخطة...</i></p>';
                if (todayDateSpan) todayDateSpan.textContent = formatDate(new Date());
                return;
            }

            const tableRows = currentPlanData.tableRows;
            const today = new Date();
            const todayStr = formatDate(today);

            if (todayDateSpan) todayDateSpan.textContent = todayStr;

            const todayRow = tableRows.find(row => row.displayDate === todayStr);

            if (!todayRow) {
                 dailyTaskContent.innerHTML = '<p>لا يوجد واجب مقرر في الخطة لهذا اليوم.</p>';
            } else if (todayRow.type === 'excuse') {
                dailyTaskContent.innerHTML = `<p style="color: orange; font-weight:bold;">لديك عذر مسجل لهذا اليوم (${todayRow.excuseType || ''}).</p>`;
            } else if (todayRow.type === 'plan' && todayRow.state && todayRow.state.completed) {
                dailyTaskContent.innerHTML = '<p style="color: green; font-weight: bold;">✅ الحمد لله، لقد أتممت واجب هذا اليوم!</p>';
            } else if (todayRow.type === 'plan') { // لا داعي للتحقق من state لأنه يجب أن يكون موجودًا لصف الخطة
                const taskDetails = getPlanData(todayRow.originalSequence);
                if (taskDetails) {
                    let taskHTML = `<h4>المطلوب إنجازه اليوم (${todayStr}):</h4>`;
                    taskHTML += `<p><strong>الحفظ الجديد:</strong> ${taskDetails.fromPage ? `ص ${taskDetails.fromPage} - ${taskDetails.toPage}` : 'لا يوجد'} (${taskDetails.surah || 'مراجعة'})</p>`;
                    taskHTML += `<p><strong>الربط:</strong> ${taskDetails.linkFrom ? `من ${taskDetails.linkFrom} إلى ${taskDetails.linkTo}` : 'لا يوجد'}</p>`;
                    taskHTML += `<p><strong>المراجعة:</strong> ${taskDetails.reviewFrom ? `من ${taskDetails.reviewFrom} إلى ${taskDetails.reviewTo}` : 'لا يوجد'} ${taskDetails.round ? `(ج${taskDetails.round})` : ''}</p>`;
                    dailyTaskContent.innerHTML = taskHTML;
                } else {
                    dailyTaskContent.innerHTML = `<p><i>خطأ: لم يتم العثور على تفاصيل الواجب للفهرس ${todayRow.originalSequence}.</i></p>`;
                }
            } else {
                dailyTaskContent.innerHTML = '<p><i>لم يتم التعرف على حالة واجب اليوم.</i></p>';
            }
        }

        function displayProgress(stats) {
            if (!currentPlanData) return;
            const planType = currentPlanData.planType || '?';
            const memorizedPages = stats.memorizedPages;
            const progressPercent = totalQuranPages > 0 ? Math.min(100, (memorizedPages / totalQuranPages) * 100).toFixed(0) : 0;
            if(currentPlanNameSpan) currentPlanNameSpan.textContent = `خطة ${planType} صفحات`;
            if(progressBarValue) {
                progressBarValue.style.width = `${progressPercent}%`;
                progressBarValue.style.backgroundColor = '#28a745';
                progressBarValue.textContent = `${progressPercent}%`;
            }
            if(completedPagesProgressSpan) completedPagesProgressSpan.textContent = memorizedPages;
        }

        function displayStats(stats) {
            if(statMemorized) statMemorized.textContent = stats.memorizedPages;
            if(statPerfected) statPerfected.textContent = stats.perfectedTasks;
            if(statLinked) statLinked.textContent = stats.linkedTasks;
            if(statExcuses) statExcuses.textContent = stats.excuseCount;
        }

        // دالة تحديث قسم الـ Streak والمستوى (جديد)
        function displayStreaksAndLevel(streakData) {
             if (!currentStreakSpan || !longestStreakSpan || !currentLevelTitleSpan || !currentLevelIconSpan) return;

             currentStreakSpan.textContent = streakData.currentStreak;
             longestStreakSpan.textContent = streakData.longestStreak;

            // البحث عن اللقب والأيقونة للمستوى الفعال
             const levelInfo = levelsAndTitles.find(l => l.level === streakData.effectiveLevel) || levelsAndTitles[0]; // استخدام المستوى 0 كافتراضي

             currentLevelTitleSpan.textContent = levelInfo.title;
             currentLevelIconSpan.textContent = levelInfo.icon;
        }


        // --- Main Data Loading Function (تعديل لإضافة حساب وعرض الـ Streak والتقويم) ---
        function loadDashboardData(user) {
            if (!user) return;
            const uid = user.uid;
            const planRef = db.collection("quranPlans").doc(uid);
            console.log("Dashboard: Checking Firestore for plan:", uid);
            showLoading("جاري تحميل بيانات خطتك...");

            planRef.get().then((doc) => {
                hideLoading();
                if (doc.exists) {
                    console.log("Dashboard: Plan data found.");
                    currentPlanData = doc.data();

                    if (!currentPlanData.startDate || !currentPlanData.planType || !currentPlanData.tableRows || !Array.isArray(currentPlanData.tableRows) || !currentPlanData.repetitionMax) {
                        console.error("Loaded data missing required fields (startDate, planType, tableRows array, or repetitionMax).", currentPlanData);
                        displayDashboard(); // عرض المحتوى لإظهار رسالة الخطأ
                        dailyTaskContent.innerHTML = `<p style="color:red; font-weight:bold;">خطأ: بيانات خطتك المحفوظة غير مكتملة أو تالفة. يرجى <a href="index.html">الذهاب لصفحة البداية</a> وإعادة إنشاء الخطة.</p>`;
                         // إخفاء الأقسام الأخرى عند وجود خطأ جوهري
                         document.getElementById('plan-progress').style.display = 'none';
                         document.getElementById('quick-stats').style.display = 'none';
                         document.getElementById('streak-level-section').style.display = 'none';
                         document.getElementById('calendar-view').style.display = 'none';
                        return;
                    }

                    // حساب الإحصائيات الأساسية
                    const stats = calculateDashboardStats(currentPlanData.tableRows);

                    // حساب بيانات الـ Streak والمستوى (جديد)
                    const todayStr = formatDate(new Date());
                    const streakData = calculateStreaksAndLevel(currentPlanData.tableRows, todayStr);

                    // تحديث واجهة المستخدم
                    displayDailyTask();
                    displayProgress(stats);
                    displayStats(stats);
                    displayStreaksAndLevel(streakData); // عرض بيانات الـ Streak (جديد)
                    initializeAndUpdateCalendar(currentPlanData.tableRows, todayStr); // عرض التقويم (جديد)

                    displayDashboard(); // عرض الداشبورد بالكامل بعد تحميل كل شيء

                } else {
                    console.log("Dashboard: No plan data found.");
                    displayDashboard(); // عرض المحتوى لإظهار رسالة "لا توجد خطة"
                    dailyTaskContent.innerHTML = '<p style="color:orange; font-weight:bold;">لم تقم باختيار أو إنشاء خطة بعد!</p><p>اذهب إلى <a href="index.html">صفحة البداية</a> لاختيار خطتك.</p>';
                    // إخفاء الأقسام التي تعتمد على وجود خطة
                    document.getElementById('plan-progress').style.display = 'none';
                    document.getElementById('quick-stats').style.display = 'none';
                    document.getElementById('streak-level-section').style.display = 'none';
                    document.getElementById('calendar-view').style.display = 'none';
                    document.getElementById('competition-section').style.display = 'none';
                    document.getElementById('badges-section').style.display = 'none';
                }
            }).catch((error) => {
                console.error("Error getting plan document:", error);
                hideLoading();
                displayDashboard(); // عرض المحتوى لإظهار رسالة الخطأ
                dailyTaskContent.innerHTML = `<p style="color:red; font-weight:bold;">حدث خطأ أثناء تحميل بيانات الخطة. (${error.code || 'UNKNOWN'})</p><p>يرجى المحاولة مرة أخرى أو التأكد من اتصالك بالإنترنت وقواعد الأمان في Firestore. <a href="index.html">العودة للرئيسية</a></p>`;
                // إخفاء الأقسام الأخرى عند وجود خطأ
                document.getElementById('plan-progress').style.display = 'none';
                document.getElementById('quick-stats').style.display = 'none';
                 document.getElementById('streak-level-section').style.display = 'none';
                 document.getElementById('calendar-view').style.display = 'none';
            });
        }

        // --- Authentication Listener (كما هي) ---
        auth.onAuthStateChanged(user => {
            hideLoading();
            currentUser = user;
            if (user) {
                console.log("Dashboard: Auth state OK.");
                loadDashboardData(user);
            } else {
                console.log("Dashboard: Not logged in. Redirecting to index...");
                // تأكد من أن اسم صفحة تسجيل الدخول أو البداية صحيح
                window.location.replace('index.html'); // أو login.html
            }
        });

        // --- Initial Load (كما هي) ---
        document.addEventListener('DOMContentLoaded', () => {
            showLoading("جاري التحقق من تسجيل الدخول...");
        });

        // --- Print Function (كما هي) ---
        function printData() { console.log("Initiating browser print..."); window.print(); }

    </script>

</body>
</html>