<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© - Ø®Ø·Ø© Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù†</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

    <style>
        /* --- CSS Styles (ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; background-color: #f4f7f6; color: #333; line-height: 1.7; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        h1, h2, h3, h4 { color: #1a5276; margin-bottom: 0.75em; }
        p { margin-bottom: 1em; color: #555; font-size: 0.95em; }
        a { text-decoration: none; color: #2980b9; }
        .card { background-color: #fff; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 3px 6px rgba(0,0,0,0.05); border: 1px solid #e0e0e0; }

        /* --- Header --- */
        .dashboard-header { display: flex; justify-content: center; align-items: center; padding: 10px 20px; margin-bottom: 25px; border-bottom: 2px solid #aed6f1; background-color: #fff; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .dashboard-header .logo h1 { margin: 0; font-size: 1.8em; color: #1a5276; }

        /* --- Dashboard Layout --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: auto; gap: 25px; }
        #daily-task { grid-column: span 2; }
        #plan-progress {} #quick-stats {} #calendar-view {} #competition-section {}
        #badges-section { grid-column: span 3; }

        /* --- Section Specific Styles --- */
        #daily-task h3 { color: #1e8449; font-size: 1.3em; border-bottom: 2px solid #aed6f1; padding-bottom: 8px;}
        #daily-task-content { min-height: 100px; padding-top: 10px;}
        #daily-task-content p { margin-bottom: 0.6em; font-size: 1.05em; line-height: 1.8; }
        #daily-task-content strong { color: #1a5276; margin-left: 8px;}
        #daily-task .plan-link { margin-top: 15px; display: inline-block; font-size: 0.9em; background-color: #5dade2; color: white; padding: 5px 10px; border-radius: 4px; }
        #daily-task .plan-link:hover { background-color: #3498db; }

        #plan-progress h3, #quick-stats h3, #calendar-view h3, #competition-section h3, #badges-section h3 { font-size: 1.15em; }
        #plan-progress .progress-bar-container { background-color: #e9ecef; border-radius: 0.25rem; height: 25px; overflow: hidden; margin-top: 10px; border: 1px solid #ccc; }
        #plan-progress .progress-bar-value { background-color: #28a745; height: 100%; width: 0%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.9em; font-weight: bold; transition: width 0.6s ease-in-out; }
        #quick-stats ul { list-style: none; padding: 0; margin-top: 15px;}
        #quick-stats ul li { margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px dotted #eee; font-size: 0.95em;}
        #quick-stats ul li strong { margin-left: 5px; color: #1a5276; min-width: 110px; display: inline-block;}
        #quick-stats ul li span { color: #1e8449; font-weight: bold;}

        /* Enhanced Placeholder Styles */
        .placeholder-box { min-height: 150px; background-color: #f0f4f8; border: 1px dashed #ccc; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #777; border-radius: 5px; padding: 15px; text-align: center; }
        .placeholder-box .icon { font-size: 3em; margin-bottom: 10px; opacity: 0.5; }
        .placeholder-box .text { font-style: italic; font-size: 0.9em; }
        /* Basic Calendar Grid Placeholder */
        #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; max-width: 250px; margin-left:auto; margin-right:auto;}
        #calendar-grid div { background-color: #e9ecef; height: 25px; border-radius: 3px; font-size: 0.7em; display: flex; justify-content: center; align-items: center;}

         /* Footer */
        .main-footer { text-align: center; padding: 20px; margin-top: 40px; background-color: #2c3e50; color: #ecf0f1; font-size: 0.9em; }
        .main-footer a { color: #3498db; }

         /* Action Buttons Area Styling - Button removed, container hidden */
         .action-buttons { padding: 15px 0; text-align: left; display: none; }
         #print-button { margin-right: 15px; padding: 10px 25px; font-size: 15px; font-weight: bold; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; font-family: 'Tajawal', sans-serif; }
         #print-button { background-color: #2980b9; } #print-button:hover { background-color: #3498db; }
         .clear { clear: both; }

         /* Loading Indicator */
         #loading-indicator { text-align: center; padding: 50px; font-size: 1.3em; color: #1a5276; display: block; }

         /* Responsive Adjustments */
         @media (max-width: 992px) { .dashboard-grid { grid-template-columns: repeat(2, 1fr); } #daily-task { grid-column: span 2; } #badges-section { grid-column: span 2; } }
         @media (max-width: 600px) { .dashboard-header .logo h1 { font-size: 1.5em;} .dashboard-grid { grid-template-columns: 1fr; } #daily-task, #plan-progress, #quick-stats, #calendar-view, #competition-section, #badges-section { grid-column: span 1; } .card { padding: 15px; } h2 { font-size: 1.4em; } h3 { font-size: 1.1em; } }
    </style>
</head>
<body>

    <div class="container">

        <header class="dashboard-header">
            <div class="logo"><h1>Ø®Ø·Ø© Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</h1></div>
             </header>

        <div id="loading-indicator">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

        <main id="dashboard-content" style="display: none;">

            <div class="dashboard-grid">

                <section id="daily-task" class="card">
                    <h3>ğŸŒŸ ÙˆØ§Ø¬Ø¨ Ø§Ù„ÙŠÙˆÙ… (<span id="today-date">...</span>)</h3>
                    <div id="daily-task-content">
                        <p><i>ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ§Ø¬Ø¨...</i></p>
                    </div>
                    <a href="plangen2.html" class="plan-link">Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªÙØµÙŠÙ„ÙŠ &raquo;</a>
                </section>

                <section id="plan-progress" class="card">
                    <h3>Ø§Ù„Ø®Ø·Ø© ÙˆØ§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¹Ø§Ù…</h3>
                    <p><strong>Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù†Ø´Ø·Ø©:</strong> <span id="current-plan-name">-</span></p>
                    <p><strong>Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„ÙƒÙ„ÙŠ:</strong></p>
                    <div class="progress-bar-container">
                        <div id="progress-bar-value" style="width: 0%;">0%</div>
                    </div>
                    <p style="font-size: 0.9em; text-align: center; margin-top: 5px;">
                        <span id="completed-pages-progress">0</span> / 604 ØµÙØ­Ø©
                    </p>
                </section>

                <section id="quick-stats" class="card">
                    <h3>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©</h3>
                    <ul>
                        <li><strong>Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:</strong> <span id="stat-memorized">0</span></li>
                        <li><strong>Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªÙ‚Ù†Ø© (Ù…Ø±Ø§Ø¬Ø¹Ø©):</strong> <span id="stat-perfected">0</span></li> {/* Changed Label */}
                        <li><strong>Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø©:</strong> <span id="stat-linked">0</span></li> {/* Changed Label */}
                        <li><strong>Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø¹Ø°Ø§Ø±:</strong> <span id="stat-excuses">0</span></li>
                    </ul>
                </section>

                <section id="calendar-view" class="card">
                    <h3>Ø§Ù„ØªÙ‚ÙˆÙŠÙ…</h3>
                    <div class="placeholder-box">
                         <div class="icon" style="font-size: 2.5em;">ğŸ—“ï¸</div>
                         <div id="calendar-grid">
                              <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
                              <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
                              <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
                              <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
                         </div>
                         <div class="text" style="margin-top: 10px;">(Ù‚Ø±ÙŠØ¨Ø§Ù‹: ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ)</div>
                    </div>
                </section>

                <section id="competition-section" class="card">
                     <h3>Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©</h3>
                     <div class="placeholder-box">
                         <div class="icon">ğŸ†</div>
                         <div class="text">(Ù‚Ø±ÙŠØ¨Ø§Ù‹: Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©)</div>
                     </div>
                </section>

                 <section id="badges-section" class="card">
                      <h3>Ø§Ù„Ø£ÙˆØ³Ù…Ø©</h3>
                       <div class="placeholder-box">
                          <div class="icon">ğŸ…</div>
                          <div class="text">(Ù‚Ø±ÙŠØ¨Ø§Ù‹: Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆØ³Ù…Ø© ÙˆØ§Ù„Ø­ÙˆØ§ÙØ²)</div>
                      </div>
                 </section>

            </div>
        </main>

        <footer class="main-footer">
             <p>&copy; 2025 Ø®Ø·Ø© Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
        </footer>

    </div>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
         apiKey: "AIzaSyDuUebu7Qzz3JnTfa-58EIPZjOcrkmdGHU", // Ø§Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„ÙØ¹Ù„ÙŠØ©
         authDomain: "quranplan2.firebaseapp.com",
         projectId: "quranplan2",
         storageBucket: "quranplan2.appspot.com",
         messagingSenderId: "1098692856811",
         appId: "1:1098692856811:web:923bca3a54fd78b1b267ae"
        };

        // --- Initialize Firebase ---
         try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Firebase initialization error:", e); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM References ---
        const loadingIndicator = document.getElementById('loading-indicator');
        const dashboardContent = document.getElementById('dashboard-content');
        // const actionButtonsContainer = document.querySelector('.action-buttons'); // Keep if needed later
        const dailyTaskContent = document.getElementById('daily-task-content');
        const currentPlanNameSpan = document.getElementById('current-plan-name');
        const progressBarValue = document.getElementById('progress-bar-value');
        const completedPagesProgressSpan = document.getElementById('completed-pages-progress');
        const statMemorized = document.getElementById('stat-memorized');
        const statPerfected = document.getElementById('stat-perfected');
        const statLinked = document.getElementById('stat-linked');
        const statExcuses = document.getElementById('stat-excuses');
        const todayDateSpan = document.getElementById('today-date');

        // --- Constants ---
        const totalQuranPages = 604;
        const initialTotalRows = 320; // Needed for getPlanData index check

        // --- Global State ---
        let currentUser = null;
        let currentPlanData = null; // Will store the FULL plan data including tableRows

        // --- Data Arrays & Helper Functions (Copied from plangen2.html for consistency) ---
        const surahs = ['Ø§Ù„ÙØ§ØªØ­Ø© ÙˆØ§Ù„Ø¨Ù‚Ø±Ø©', 'Ø§Ù„Ø¨Ù‚Ø±Ø©', 'Ø§Ù„Ø¨Ù‚Ø±Ø©', 'Ø§Ù„Ø¨Ù‚Ø±Ø©', 'Ø§Ù„Ø¨Ù‚Ø±Ø©', 'Ø§Ù„Ø¨Ù‚Ø±Ø©', 'Ø§Ù„Ø¨Ù‚Ø±Ø©', 'Ø§Ù„Ø¨Ù‚Ø±Ø©', 'Ø§Ù„Ø¨Ù‚Ø±Ø©', 'Ø§Ù„Ø¨Ù‚Ø±Ø©', 'Ø§Ù„Ø¨Ù‚Ø±Ø©', 'Ø§Ù„Ø¨Ù‚Ø±Ø©', 'Ø§Ù„Ø¨Ù‚Ø±Ø©', 'Ø§Ù„Ø¨Ù‚Ø±Ø©', 'Ø§Ù„Ø¨Ù‚Ø±Ø©', 'Ø§Ù„Ø¨Ù‚Ø±Ø©', 'Ø§Ù„Ø¨Ù‚Ø±Ø©', 'Ø§Ù„Ø¨Ù‚Ø±Ø©', 'Ø§Ù„Ø¨Ù‚Ø±Ø©', 'Ø§Ù„Ø¨Ù‚Ø±Ø©', 'Ø§Ù„Ø¨Ù‚Ø±Ø©', 'Ø§Ù„Ø¨Ù‚Ø±Ø©', 'Ø§Ù„Ø¨Ù‚Ø±Ø©', 'Ø§Ù„Ø¨Ù‚Ø±Ø©', 'Ø§Ù„Ø¨Ù‚Ø±Ø© ÙˆØ¢Ù„ Ø¹Ù…Ø±Ø§Ù†', 'Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†', 'Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†', 'Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†', 'Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†', 'Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†', 'Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†', 'Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†', 'Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†', 'Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†', 'Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†', 'Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†', 'Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†', 'Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†', 'Ø§Ù„Ù†Ø³Ø§Ø¡', 'Ø§Ù„Ù†Ø³Ø§Ø¡', 'Ø§Ù„Ù†Ø³Ø§Ø¡', 'Ø§Ù„Ù†Ø³Ø§Ø¡', 'Ø§Ù„Ù†Ø³Ø§Ø¡', 'Ø§Ù„Ù†Ø³Ø§Ø¡', 'Ø§Ù„Ù†Ø³Ø§Ø¡', 'Ø§Ù„Ù†Ø³Ø§Ø¡', 'Ø§Ù„Ù†Ø³Ø§Ø¡', 'Ø§Ù„Ù†Ø³Ø§Ø¡', 'Ø§Ù„Ù†Ø³Ø§Ø¡', 'Ø§Ù„Ù†Ø³Ø§Ø¡', 'Ø§Ù„Ù†Ø³Ø§Ø¡', 'Ø§Ù„Ù†Ø³Ø§Ø¡', 'Ø§Ù„Ù†Ø³Ø§Ø¡ ÙˆØ§Ù„Ù…Ø§Ø¦Ø¯Ø©', 'Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©', 'Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©', 'Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©', 'Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©', 'Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©', 'Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©', 'Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©', 'Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©', 'Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©', 'Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©', 'Ø§Ù„Ù…Ø§Ø¦Ø¯Ø© ÙˆØ§Ù„Ø£Ù†Ø¹Ø§Ù…', 'Ø§Ù„Ø£Ù†Ø¹Ø§Ù…', 'Ø§Ù„Ø£Ù†Ø¹Ø§Ù…', 'Ø§Ù„Ø£Ù†Ø¹Ø§Ù…', 'Ø§Ù„Ø£Ù†Ø¹Ø§Ù…', 'Ø§Ù„Ø£Ù†Ø¹Ø§Ù…', 'Ø§Ù„Ø£Ù†Ø¹Ø§Ù…', 'Ø§Ù„Ø£Ù†Ø¹Ø§Ù…', 'Ø§Ù„Ø£Ù†Ø¹Ø§Ù…', 'Ø§Ù„Ø£Ù†Ø¹Ø§Ù…', 'Ø§Ù„Ø£Ù†Ø¹Ø§Ù…', 'Ø§Ù„Ø£Ù†Ø¹Ø§Ù…', 'Ø§Ù„Ø£Ø¹Ø±Ø§Ù', 'Ø§Ù„Ø£Ø¹Ø±Ø§Ù', 'Ø§Ù„Ø£Ø¹Ø±Ø§Ù', 'Ø§Ù„Ø£Ø¹Ø±Ø§Ù', 'Ø§Ù„Ø£Ø¹Ø±Ø§Ù', 'Ø§Ù„Ø£Ø¹Ø±Ø§Ù', 'Ø§Ù„Ø£Ø¹Ø±Ø§Ù', 'Ø§Ù„Ø£Ø¹Ø±Ø§Ù', 'Ø§Ù„Ø£Ø¹Ø±Ø§Ù', 'Ø§Ù„Ø£Ø¹Ø±Ø§Ù', 'Ø§Ù„Ø£Ø¹Ø±Ø§Ù', 'Ø§Ù„Ø£Ø¹Ø±Ø§Ù', 'Ø§Ù„Ø£Ø¹Ø±Ø§Ù', 'Ø§Ù„Ø£Ù†ÙØ§Ù„', 'Ø§Ù„Ø£Ù†ÙØ§Ù„', 'Ø§Ù„Ø£Ù†ÙØ§Ù„', 'Ø§Ù„Ø£Ù†ÙØ§Ù„', 'Ø§Ù„Ø£Ù†ÙØ§Ù„', 'Ø§Ù„ØªÙˆØ¨Ø©', 'Ø§Ù„ØªÙˆØ¨Ø©', 'Ø§Ù„ØªÙˆØ¨Ø©', 'Ø§Ù„ØªÙˆØ¨Ø©', 'Ø§Ù„ØªÙˆØ¨Ø©', 'Ø§Ù„ØªÙˆØ¨Ø©', 'Ø§Ù„ØªÙˆØ¨Ø©', 'Ø§Ù„ØªÙˆØ¨Ø©', 'Ø§Ù„ØªÙˆØ¨Ø©', 'Ø§Ù„ØªÙˆØ¨Ø©', 'Ø§Ù„ØªÙˆØ¨Ø© ÙˆÙŠÙˆÙ†Ø³', 'ÙŠÙˆÙ†Ø³', 'ÙŠÙˆÙ†Ø³', 'ÙŠÙˆÙ†Ø³', 'ÙŠÙˆÙ†Ø³', 'ÙŠÙˆÙ†Ø³', 'ÙŠÙˆÙ†Ø³', 'ÙŠÙˆÙ†Ø³ ÙˆÙ‡ÙˆØ¯', 'Ù‡ÙˆØ¯', 'Ù‡ÙˆØ¯', 'Ù‡ÙˆØ¯', 'Ù‡ÙˆØ¯', 'Ù‡ÙˆØ¯', 'Ù‡ÙˆØ¯', 'Ù‡ÙˆØ¯ ÙˆÙŠÙˆØ³Ù', 'ÙŠÙˆØ³Ù', 'ÙŠÙˆØ³Ù', 'ÙŠÙˆØ³Ù', 'ÙŠÙˆØ³Ù', 'ÙŠÙˆØ³Ù', 'ÙŠÙˆØ³Ù', 'Ø§Ù„Ø±Ø¹Ø¯', 'Ø§Ù„Ø±Ø¹Ø¯', 'Ø§Ù„Ø±Ø¹Ø¯', 'Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…', 'Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…', 'Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…', 'Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… ÙˆØ§Ù„Ø­Ø¬Ø±', 'Ø§Ù„Ø­Ø¬Ø±', 'Ø§Ù„Ø­Ø¬Ø±', 'Ø§Ù„Ø­Ø¬Ø± ÙˆØ§Ù„Ù†Ø­Ù„', 'Ø§Ù„Ù†Ø­Ù„', 'Ø§Ù„Ù†Ø­Ù„', 'Ø§Ù„Ù†Ø­Ù„', 'Ø§Ù„Ù†Ø­Ù„', 'Ø§Ù„Ù†Ø­Ù„', 'Ø§Ù„Ù†Ø­Ù„', 'Ø§Ù„Ù†Ø­Ù„ ÙˆØ§Ù„Ø¥Ø³Ø±Ø§Ø¡', 'Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡', 'Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡', 'Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡', 'Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡', 'Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡', 'Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡ ÙˆØ§Ù„ÙƒÙ‡Ù', 'Ø§Ù„ÙƒÙ‡Ù', 'Ø§Ù„ÙƒÙ‡Ù', 'Ø§Ù„ÙƒÙ‡Ù', 'Ø§Ù„ÙƒÙ‡Ù', 'Ø§Ù„ÙƒÙ‡Ù', 'Ù…Ø±ÙŠÙ…', 'Ù…Ø±ÙŠÙ…', 'Ù…Ø±ÙŠÙ…', 'Ù…Ø±ÙŠÙ… ÙˆØ·Ù‡', 'Ø·Ù‡', 'Ø·Ù‡', 'Ø·Ù‡', 'Ø·Ù‡', 'Ø·Ù‡ ÙˆØ§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡', 'Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡', 'Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡', 'Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡', 'Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡', 'Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡ ÙˆØ§Ù„Ø­Ø¬', 'Ø§Ù„Ø­Ø¬', 'Ø§Ù„Ø­Ø¬', 'Ø§Ù„Ø­Ø¬', 'Ø§Ù„Ø­Ø¬', 'Ø§Ù„Ø­Ø¬ ÙˆØ§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†', 'Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†', 'Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†', 'Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†', 'Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ† ÙˆØ§Ù„Ù†ÙˆØ±', 'Ø§Ù„Ù†ÙˆØ±', 'Ø§Ù„Ù†ÙˆØ±', 'Ø§Ù„Ù†ÙˆØ±', 'Ø§Ù„Ù†ÙˆØ±', 'Ø§Ù„Ù†ÙˆØ± ÙˆØ§Ù„ÙØ±Ù‚Ø§Ù†', 'Ø§Ù„ÙØ±Ù‚Ø§Ù†', 'Ø§Ù„ÙØ±Ù‚Ø§Ù†', 'Ø§Ù„ÙØ±Ù‚Ø§Ù†', 'Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡', 'Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡', 'Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡', 'Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡', 'Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡', 'Ø§Ù„Ù†Ù…Ù„', 'Ø§Ù„Ù†Ù…Ù„', 'Ø§Ù„Ù†Ù…Ù„', 'Ø§Ù„Ù†Ù…Ù„', 'Ø§Ù„Ù†Ù…Ù„ ÙˆØ§Ù„Ù‚ØµØµ', 'Ø§Ù„Ù‚ØµØµ', 'Ø§Ù„Ù‚ØµØµ', 'Ø§Ù„Ù‚ØµØµ', 'Ø§Ù„Ù‚ØµØµ', 'Ø§Ù„Ù‚ØµØµ ÙˆØ§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª', 'Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª', 'Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª', 'Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª', 'Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª ÙˆØ§Ù„Ø±ÙˆÙ…', 'Ø§Ù„Ø±ÙˆÙ…', 'Ø§Ù„Ø±ÙˆÙ…', 'Ø§Ù„Ø±ÙˆÙ…', 'Ù„Ù‚Ù…Ø§Ù†', 'Ù„Ù‚Ù…Ø§Ù†', 'Ø§Ù„Ø³Ø¬Ø¯Ø©', 'Ø§Ù„Ø³Ø¬Ø¯Ø© ÙˆØ§Ù„Ø£Ø­Ø²Ø§Ø¨', 'Ø§Ù„Ø£Ø­Ø²Ø§Ø¨', 'Ø§Ù„Ø£Ø­Ø²Ø§Ø¨', 'Ø§Ù„Ø£Ø­Ø²Ø§Ø¨', 'Ø§Ù„Ø£Ø­Ø²Ø§Ø¨', 'Ø§Ù„Ø£Ø­Ø²Ø§Ø¨ ÙˆØ³Ø¨Ø£', 'Ø³Ø¨Ø£', 'Ø³Ø¨Ø£', 'Ø³Ø¨Ø£ ÙˆÙØ§Ø·Ø±', 'ÙØ§Ø·Ø±', 'ÙØ§Ø·Ø±', 'ÙØ§Ø·Ø± ÙˆÙŠØ³', 'ÙŠØ³', 'ÙŠØ³', 'ÙŠØ³ ÙˆØ§Ù„ØµØ§ÙØ§Øª', 'Ø§Ù„ØµØ§ÙØ§Øª', 'Ø§Ù„ØµØ§ÙØ§Øª', 'Ø§Ù„ØµØ§ÙØ§Øª', 'Øµ', 'Øµ', 'Øµ ÙˆØ§Ù„Ø²Ù…Ø±', 'Ø§Ù„Ø²Ù…Ø±', 'Ø§Ù„Ø²Ù…Ø±', 'Ø§Ù„Ø²Ù…Ø±', 'Ø§Ù„Ø²Ù…Ø±', 'ØºØ§ÙØ±', 'ØºØ§ÙØ±', 'ØºØ§ÙØ±', 'ØºØ§ÙØ±', 'ØºØ§ÙØ±', 'ÙØµÙ„Øª', 'ÙØµÙ„Øª', 'ÙØµÙ„Øª', 'Ø§Ù„Ø´ÙˆØ±Ù‰', 'Ø§Ù„Ø´ÙˆØ±Ù‰', 'Ø§Ù„Ø´ÙˆØ±Ù‰', 'Ø§Ù„Ø´ÙˆØ±Ù‰ ÙˆØ§Ù„Ø²Ø®Ø±Ù', 'Ø§Ù„Ø²Ø®Ø±Ù', 'Ø§Ù„Ø²Ø®Ø±Ù', 'Ø§Ù„Ø²Ø®Ø±Ù ÙˆØ§Ù„Ø¯Ø®Ø§Ù†', 'Ø§Ù„Ø¯Ø®Ø§Ù†', 'Ø§Ù„Ø¬Ø§Ø«ÙŠØ©', 'Ø§Ù„Ø¬Ø§Ø«ÙŠØ© ÙˆØ§Ù„Ø£Ø­Ù‚Ø§Ù', 'Ø§Ù„Ø£Ø­Ù‚Ø§Ù', 'Ø§Ù„Ø£Ø­Ù‚Ø§Ù', 'Ù…Ø­Ù…Ø¯', 'Ù…Ø­Ù…Ø¯', 'Ø§Ù„ÙØªØ­', 'Ø§Ù„ÙØªØ­', 'Ø§Ù„ÙØªØ­ ÙˆØ§Ù„Ø­Ø¬Ø±Ø§Øª', 'Ø§Ù„Ø­Ø¬Ø±Ø§Øª Ùˆ Ù‚', 'Ù‚', 'Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª', 'Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª ÙˆØ§Ù„Ø·ÙˆØ±', 'Ø§Ù„Ø·ÙˆØ± ÙˆØ§Ù„Ù†Ø¬Ù…', 'Ø§Ù„Ù†Ø¬Ù… ÙˆØ§Ù„Ù‚Ù…Ø±', 'Ø§Ù„Ù‚Ù…Ø±', 'Ø§Ù„Ù‚Ù…Ø± ÙˆØ§Ù„Ø±Ø­Ù…Ù†', 'Ø§Ù„Ø±Ø­Ù…Ù† ÙˆØ§Ù„ÙˆØ§Ù‚Ø¹Ø©', 'Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©', 'Ø§Ù„ÙˆØ§Ù‚Ø¹Ø© ÙˆØ§Ù„Ø­Ø¯ÙŠØ¯', 'Ø§Ù„Ø­Ø¯ÙŠØ¯', 'Ø§Ù„Ø­Ø¯ÙŠØ¯ ÙˆØ§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©', 'Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©', 'Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø© ÙˆØ§Ù„Ø­Ø´Ø±', 'Ø§Ù„Ø­Ø´Ø±', 'Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©', 'Ø§Ù„Ù…Ù…ØªØ­Ù†Ø© ÙˆØ§Ù„ØµÙ', 'Ø§Ù„Ø¬Ù…Ø¹Ø© ÙˆØ§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†', 'Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ† ÙˆØ§Ù„ØªØºØ§Ø¨Ù†', 'Ø§Ù„ØªØºØ§Ø¨Ù† ÙˆØ§Ù„Ø·Ù„Ø§Ù‚', 'Ø§Ù„Ø·Ù„Ø§Ù‚ ÙˆØ§Ù„ØªØ­Ø±ÙŠÙ…', 'Ø§Ù„ØªØ­Ø±ÙŠÙ… ÙˆØ§Ù„Ù…Ù„Ùƒ', 'Ø§Ù„Ù…Ù„Ùƒ ÙˆØ§Ù„Ù‚Ù„Ù…', 'Ø§Ù„Ù‚Ù„Ù… ÙˆØ§Ù„Ø­Ø§Ù‚Ø©', 'Ø§Ù„Ø­Ø§Ù‚Ø© ÙˆØ§Ù„Ù…Ø¹Ø§Ø±Ø¬', 'Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬ ÙˆÙ†ÙˆØ­', 'Ù†ÙˆØ­ ÙˆØ§Ù„Ø¬Ù†', 'Ø§Ù„Ø¬Ù† ÙˆØ§Ù„Ù…Ø²Ù…Ù„', 'Ø§Ù„Ù…Ø²Ù…Ù„ ÙˆØ§Ù„Ù…Ø¯Ø«Ø±', 'Ø§Ù„Ù…Ø¯Ø«Ø± ÙˆØ§Ù„Ù‚ÙŠØ§Ù…Ø© ÙˆØ§Ù„Ø¥Ù†Ø³Ø§Ù†', 'Ø§Ù„Ø¥Ù†Ø³Ø§Ù† ÙˆØ§Ù„Ù…Ø±Ø³Ù„Ø§Øª', 'Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª ÙˆØ§Ù„Ù†Ø¨Ø£', 'Ø§Ù„Ù†Ø¨Ø£ ÙˆØ§Ù„Ù†Ø§Ø²Ø¹Ø§Øª', 'Ø¹Ø¨Ø³ ÙˆØ§Ù„ØªÙƒÙˆÙŠØ±', 'Ø§Ù„Ø¥Ù†ÙØ·Ø§Ø± ÙˆØ§Ù„Ù…Ø·ÙÙÙŠÙ†', 'Ø§Ù„Ø¥Ù†Ø´Ù‚Ø§Ù‚ ÙˆØ§Ù„Ø¨Ø±ÙˆØ¬', 'Ø§Ù„Ø·Ø§Ø±Ù‚ ÙˆØ§Ù„Ø£Ø¹Ù„Ù‰ ÙˆØ§Ù„ØºØ§Ø´ÙŠØ©', 'Ø§Ù„ÙØ¬Ø± ÙˆØ§Ù„Ø¨Ù„Ø¯', 'Ø§Ù„Ø´Ù…Ø³ ÙˆØ§Ù„Ù„ÙŠÙ„', 'Ø§Ù„Ø¶Ø­Ù‰ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø§Ø³', 'Ø®ØªÙ… Ø§Ù„Ù‚Ø±Ø¢Ù†'];
        const linkFromData = ['', '', 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, 13,13,13,13,13,13,25,25,25,25,25,25,37,37,37,37,37,37,49,49,49,49,49,49,61,61,61,61,61,61, 73,73,73,73,73,73,85,85,85,85,85,85,97,97,97,97,97,97,109,109,109,109,109,109,121,121,121,121,121,121, 133,133,133,133,133,133,145,145,145,145,145,145,157,157,157,157,157,157,169,169,169,169,169,169,181,181,181,181,181,181, 193,193,193,193,193,193,205,205,205,205,205,205,217,217,217,217,217,217,229,229,229,229,229,229,241,241,241,241,241,241, 253,253,253,253,253,253,265,265,265,265,265,265,277,277,277,277,277,277,289,289,289,289,289,289,301,301,301,301,301,301, 313,313,313,313,313,313,325,325,325,325,325,325,337,337,337,337,337,337,349,349,349,349,349,349,361,361,361,361,361,361, 373,373,373,373,373,373,385,385,385,385,385,385,397,397,397,397,397,397,409,409,409,409,409,409,421,421,421,421,421,421, 433,433,433,433,433,433,445,445,445,445,445,445,457,457,457,457,457,457,469,469,469,469,469,469,481,481,481,481,481,481, 493,493,493,493,493,493,505,505,505,505,505,505,517,517,517,517,517,517,529,529,529,529,529,529,541,541,541,541,541,541, 553,553,553,553,553,553,565,565,565,565,565,565,577,577,577,577,577,577];
        const linkToData = ['', '', 2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40,42,44,46,48,50,52,54,56,58,60, 62,64,66,68,70,72,74,76,78,80,82,84,86,88,90,92,94,96,98,100,102,104,106,108,110,112,114,116, 118,120,122,124,126,128,130,132,134,136,138,140,142,144,146,148,150,152,154,156,158,160,162,164,166,168, 170,172,174,176,178,180,182,184,186,188,190,192,194,196,198,200,202,204,206,208,210,212,214,216,218,220, 222,224,226,228,230,232,234,236,238,240,242,244,246,248,250,252,254,256,258,260,262,264,266,268,270,272, 274,276,278,280,282,284,286,288,290,292,294,296,298,300,302,304,306,308,310,312,314,316,318,320,322,324, 326,328,330,332,334,336,338,340,342,344,346,348,350,352,354,356,358,360,362,364,366,368,370,372,374,376, 378,380,382,384,386,388,390,392,394,396,398,400,402,404,406,408,410,412,414,416,418,420,422,424,426,428, 430,432,434,436,438,440,442,444,446,448,450,452,454,456,458,460,462,464,466,468,470,472,474,476,478,480, 482,484,486,488,490,492,494,496,498,500,502,504,506,508,510,512,514,516,518,520,522,524,526,528,530,532, 534,536,538,540,542,544,546,548,550,552,554,556,558,560,562,564,566,568,570,572,574,576,578,580,582,584, 586,588,590,592,594,597,600,604];
        const reviewFromData = [...Array(32).fill(''), 1,3,5,7,9,11,1,5,9,13,17,21,1,7,13,19,25,31,1,9,17,25,33,41, 1,11,21,31,41,51,1,13,25,37,49,61,1,15,29,43,57,71,1,17,33,49,65,81, 1,19,37,55,73,91,1,21,41,61,81,101,1,23,45,67,89,111,1,25,49,73,97,121, 1,27,53,79,105,131,1,29,57,85,113,141,1,31,61,91,121,151,1,33,65,97,129,161, 1,35,69,103,137,171,1,37,73,109,145,181,1,39,77,115,153,191,1,41,81,121,161,201, 1,43,85,127,169,211,1,45,89,133,177,221,1,47,93,139,185,231,1,49,97,145,193,241, 1,51,101,151,201,251,1,53,105,157,209,261,1,55,109,163,217,271,1,57,113,169,225,281, 1,59,117,175,233,291,1,61,121,181,241,301,1,63,125,187,249,311,1,65,129,193,257,321, 1,67,133,199,265,331,1,69,137,205,273,341,1,71,141,211,281,351,1,73,145,217,289,361, 1,75,149,223,297,371,1,77,153,229,305,381,1,79,157,235,313,391,1,81,161,241,321,401, 1,83,165,247,329,411,1,85,169,253,337,421,1,87,173,259,345,431,1,89,177,265,353,441, 1,91,181,271,361,451,1,93,185,277,369,461,1,95,189,283,377,471,1,97,193,289,385,481];
        const reviewToData = [...Array(32).fill(''), 2,4,6,8,10,12,4,8,12,16,20,24,6,12,18,24,30,36,8,16,24,32,40,48, 10,20,30,40,50,60,12,24,36,48,60,72,14,28,42,56,70,84,16,32,48,64,80,96, 18,36,54,72,90,108,20,40,60,80,100,120,22,44,66,88,110,132,24,48,72,96,120,144, 26,52,78,104,130,156,28,56,84,112,140,168,30,60,90,120,150,180,32,64,96,128,160,192, 34,68,102,136,170,204,36,72,108,144,180,216,38,76,114,152,190,228,40,80,120,160,200,240, 42,84,126,168,210,252,44,88,132,176,220,264,46,92,138,184,230,276,48,96,144,192,240,288, 50,100,150,200,250,300,52,104,156,208,260,312,54,108,162,216,270,324,56,112,168,224,280,336, 58,116,174,232,290,348,60,120,180,240,300,360,62,124,186,248,310,372,64,128,192,256,320,384, 66,132,198,264,330,396,68,136,204,272,340,408,70,140,210,280,350,420,72,144,216,288,360,432, 74,148,222,296,370,444,76,152,228,304,380,456,78,156,234,312,390,468,80,160,240,320,400,480, 82,164,246,328,410,492,84,168,252,336,420,504,86,172,258,344,430,516,88,176,264,352,440,528, 90,180,270,360,450,540,92,184,276,368,460,552,94,188,282,376,470,564,96,192,288,384,480,576];

        function formatDate(date) { if (!(date instanceof Date)) date = new Date(date); if (isNaN(date.getTime())) return ""; const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
        // Use the exact same getPlanData as in plangen2.html to ensure consistency
        function getPlanData(originalIndex) { const index = parseInt(originalIndex); if (isNaN(index) || index < 0 || index >= initialTotalRows) { return null; } let fromPage = '', toPage = ''; if (index < 299) { fromPage = index * 2 + 1; toPage = fromPage + 1; } else if (index === 299) { fromPage = 601; toPage = 604; } return { fromPage: fromPage, toPage: toPage, surah: surahs[index] || '', linkFrom: linkFromData[index] ?? '', linkTo: linkToData[index] ?? '', reviewFrom: reviewFromData[index] ?? '', reviewTo: reviewToData[index] ?? '', round: calculateRoundNumber(index) }; }
        function calculateRoundNumber(originalIndex) { if (originalIndex < 32 || reviewFromData[originalIndex] == null || reviewFromData[originalIndex] === '') { return ''; } let reviewDataStartIndex = 32; let reviewCounter = 0; for(let i = reviewDataStartIndex; i <= originalIndex; i++){ if(reviewFromData[i] != null && reviewFromData[i] !== '') reviewCounter++; } if (reviewCounter === 0) return ''; return Math.ceil(reviewCounter / 6); }


        // --- UI Update Functions ---
        function showLoading(message = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...") { if(loadingIndicator){ loadingIndicator.textContent = message; loadingIndicator.style.display = 'block';} if(dashboardContent) dashboardContent.style.display = 'none'; /*if(actionButtonsContainer) actionButtonsContainer.style.display = 'none';*/ }
        function hideLoading() { if(loadingIndicator) loadingIndicator.style.display = 'none'; }
        function displayDashboard() { hideLoading(); if(dashboardContent) dashboardContent.style.display = 'block'; /*if(actionButtonsContainer) actionButtonsContainer.style.display = 'block';*/ } // Keep actions hidden for now


        // --- >>> NEW: Functions to Calculate Stats from tableRows <<< ---
        function findCurrentTaskInfo(tableRows) {
            if (!tableRows || tableRows.length === 0) {
                return null; // No rows to process
            }
            // Find the first row that is a 'plan' type and not completed
            const firstIncompleteTask = tableRows.find(row => row.type === 'plan' && row.state && !row.state.completed);

            if (firstIncompleteTask) {
                // Return details needed to display the task
                return {
                    originalSequence: firstIncompleteTask.originalSequence,
                    displayDate: firstIncompleteTask.displayDate
                };
            } else {
                // Check if the last row is a plan and completed (or if all are excuses?)
                 const lastRow = tableRows[tableRows.length - 1];
                 if(lastRow && lastRow.type === 'plan' && lastRow.state && lastRow.state.completed) {
                    return { completed: true }; // Indicate plan completion
                 } else {
                    // Or maybe the plan is just excuses? Return null for now.
                    return null;
                 }
            }
        }

        function calculateDashboardStats(tableRows) {
            let memorizedPages = 0;
            let linkedTasks = 0;
            let perfectedTasks = 0;
            let excuseCount = 0;
            let lastCompletedPage = 0;

            if (!tableRows) return { memorizedPages: 0, linkedTasks: 0, perfectedTasks: 0, excuseCount: 0 };

            tableRows.forEach(row => {
                if (row.type === 'excuse') {
                    excuseCount++;
                } else if (row.type === 'plan' && row.state && row.state.completed) {
                    // Get page info for completed row
                    const planInfo = getPlanData(row.originalSequence);
                    if (planInfo && planInfo.toPage) {
                        lastCompletedPage = Math.max(lastCompletedPage, planInfo.toPage);
                    }
                    // Count linked tasks
                    if (row.state.linked) {
                        linkedTasks++;
                    }
                    // Count perfected (reviewed) tasks
                    if (row.state.reviewed) {
                        perfectedTasks++;
                    }
                }
            });

            // Ensure lastCompletedPage doesn't exceed total pages
            memorizedPages = Math.min(lastCompletedPage, totalQuranPages);

            return {
                memorizedPages: memorizedPages,
                linkedTasks: linkedTasks,
                perfectedTasks: perfectedTasks,
                excuseCount: excuseCount
            };
        }


        // --- >>> MODIFIED: Functions to Update Dashboard Sections <<< ---
        function displayDailyTask(taskInfo) {
            if (!dailyTaskContent) return;

            // Set today's date regardless
             if (todayDateSpan) todayDateSpan.textContent = formatDate(new Date());

            if (!taskInfo) {
                dailyTaskContent.innerHTML = '<p><i>Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ§Ø¬Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ. Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ø®Ø·Ø© ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©.</i></p>';
                return;
            }

            if (taskInfo.completed) {
                 dailyTaskContent.innerHTML = '<p style="color: green; font-weight: bold;">ğŸ‰ Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡! Ù„Ù‚Ø¯ Ø£ØªÙ…Ù…Øª Ø§Ù„Ø®Ø·Ø© ÙƒØ§Ù…Ù„Ø©!</p>';
                 if (todayDateSpan) todayDateSpan.textContent = "Ø§Ù„Ø®ØªÙ…"; // Or completion date?
                 return;
            }

            // If we have an incomplete task
            if (taskInfo.originalSequence !== undefined) {
                 if (todayDateSpan && taskInfo.displayDate) todayDateSpan.textContent = formatDate(taskInfo.displayDate); // Show date of the task

                 const taskDetails = getPlanData(taskInfo.originalSequence); // Get details using the sequence

                 if (taskDetails) {
                     let taskHTML = `<p><strong>Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙŠØ¯:</strong> ${taskDetails.fromPage ? `Øµ ${taskDetails.fromPage} - ${taskDetails.toPage}` : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'} (${taskDetails.surah || 'Ù…Ø±Ø§Ø¬Ø¹Ø©'})</p>`;
                     taskHTML += `<p><strong>Ø§Ù„Ø±Ø¨Ø·:</strong> ${taskDetails.linkFrom ? `Ù…Ù† ${taskDetails.linkFrom} Ø¥Ù„Ù‰ ${taskDetails.linkTo}` : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>`;
                     taskHTML += `<p><strong>Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©:</strong> ${taskDetails.reviewFrom ? `Ù…Ù† ${taskDetails.reviewFrom} Ø¥Ù„Ù‰ ${taskDetails.reviewTo}` : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'} ${taskDetails.round ? `(Ø¬${taskDetails.round})` : ''}</p>`;
                     dailyTaskContent.innerHTML = taskHTML;
                 } else {
                     dailyTaskContent.innerHTML = `<p><i>Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ø¨ Ù„Ù„ÙÙ‡Ø±Ø³ ${taskInfo.originalSequence}.</i></p>`;
                 }
            } else {
                 // Fallback if taskInfo structure is unexpected
                 dailyTaskContent.innerHTML = '<p><i>Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ ÙˆØ§Ø¬Ø¨ Ø§Ù„ÙŠÙˆÙ…...</i></p>';
            }
        }

        function displayProgress(stats) {
            const planType = currentPlanData?.planType || '?'; // Use loaded data
            const memorizedPages = stats.memorizedPages;
            const progressPercent = totalQuranPages > 0 ? ((memorizedPages / totalQuranPages) * 100).toFixed(0) : 0;

            if(currentPlanNameSpan) currentPlanNameSpan.textContent = `Ø®Ø·Ø© ${planType} ØµÙØ­Ø§Øª`;
            if(progressBarValue) {
                progressBarValue.style.width = `${progressPercent}%`;
                progressBarValue.textContent = `${progressPercent}%`;
            }
            if(completedPagesProgressSpan) completedPagesProgressSpan.textContent = memorizedPages;
        }

        function displayStats(stats) {
            if(statMemorized) statMemorized.textContent = stats.memorizedPages;
            if(statPerfected) statPerfected.textContent = stats.perfectedTasks; // Display count of perfected tasks
            if(statLinked) statLinked.textContent = stats.linkedTasks; // Display count of linked tasks
            if(statExcuses) statExcuses.textContent = stats.excuseCount;
        }

        // --- Main Data Loading Function (MODIFIED) ---
        function loadDashboardData(user) {
            if (!user) return;
            const uid = user.uid;
            const planRef = db.collection("quranPlans").doc(uid);
            console.log("Dashboard: Checking Firestore for plan:", uid);
            showLoading("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø·ØªÙƒ...");

            planRef.get().then((doc) => {
                hideLoading();
                if (doc.exists) {
                    console.log("Dashboard: Plan data found.");
                    currentPlanData = doc.data(); // Store FULL data globally

                    // --- >>> NEW: Validate FULL data needed for dashboard <<< ---
                    if (!currentPlanData.startDate || !currentPlanData.planType || !currentPlanData.tableRows || !Array.isArray(currentPlanData.tableRows)) {
                        console.error("Loaded data missing required fields (startDate, planType, or tableRows array).", currentPlanData);
                        dashboardContent.style.display = 'block'; // Show content area to display error
                        // if(actionButtonsContainer) actionButtonsContainer.style.display = 'none';
                        dailyTaskContent.innerHTML = `<p style="color:red; font-weight:bold;">Ø®Ø·Ø£: Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø·ØªÙƒ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø© Ø£Ùˆ ØªØ§Ù„ÙØ©. ÙŠØ±Ø¬Ù‰ <a href="index.html">Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„ØµÙØ­Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</a> ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø·Ø©.</p>`;
                        // Hide other sections that rely on full data
                        document.getElementById('plan-progress').style.display = 'none';
                        document.getElementById('quick-stats').style.display = 'none';
                        return; // Stop processing
                    }

                    // --- >>> NEW: Calculate stats and find task using tableRows <<< ---
                    const taskInfo = findCurrentTaskInfo(currentPlanData.tableRows);
                    const stats = calculateDashboardStats(currentPlanData.tableRows);

                    // --- >>> UPDATE Display using calculated info <<< ---
                    displayDailyTask(taskInfo); // Pass calculated task info
                    displayProgress(stats); // Pass calculated stats
                    displayStats(stats); // Pass calculated stats

                    displayDashboard(); // Show the dashboard content

                } else {
                     // No plan found logic (remains mostly the same)
                     console.log("Dashboard: No plan data found.");
                     displayDashboard(); // Show dashboard structure to display message
                     dailyTaskContent.innerHTML = '<p style="color:orange; font-weight:bold;">Ù„Ù… ØªÙ‚Ù… Ø¨Ø§Ø®ØªÙŠØ§Ø± Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø© Ø¨Ø¹Ø¯!</p><p>Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ <a href="index.html">ØµÙØ­Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</a> Ù„Ø§Ø®ØªÙŠØ§Ø± Ø®Ø·ØªÙƒ.</p>';
                     document.getElementById('plan-progress').style.display = 'none';
                     document.getElementById('quick-stats').style.display = 'none';
                     document.getElementById('calendar-view').style.display = 'none';
                     document.getElementById('competition-section').style.display = 'none';
                     document.getElementById('badges-section').style.display = 'none';
                     // if (actionButtonsContainer) actionButtonsContainer.style.display = 'none';
                }
            }).catch((error) => {
                 // Error handling (remains mostly the same)
                 console.error("Error getting plan document:", error);
                 hideLoading();
                 displayDashboard();
                 dailyTaskContent.innerHTML = `<p style="color:red; font-weight:bold;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø·Ø©. (${error.code || 'UNKNOWN'})</p><p>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆÙ‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù† ÙÙŠ Firestore. <a href="index.html">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></p>`;
                 document.getElementById('plan-progress').style.display = 'none';
                 document.getElementById('quick-stats').style.display = 'none';
                 // if (actionButtonsContainer) actionButtonsContainer.style.display = 'none';
            });
        }

        // Removed deletePlanData and related listeners as button is removed

        // --- Authentication Listener (remains the same) ---
        auth.onAuthStateChanged(user => {
         hideLoading(); // Hide loading once auth state is known
         currentUser = user;
         if (user) {
             console.log("Dashboard: Auth state OK.");
             loadDashboardData(user); // Load data for logged-in user
         } else {
             console.log("Dashboard: Not logged in. Redirecting to index...");
             // Redirect to index/login page if not logged in
             window.location.replace('index.html'); // Or login.html if you have a separate login
         }
        });

        // --- Initial Load (remains the same) ---
        document.addEventListener('DOMContentLoaded', () => {
            showLoading("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„..."); // Show loading until auth resolves
        });

         // --- Print Function (remains the same) ---
         function printData() { console.log("Initiating browser print..."); window.print(); }

    </script>

</body>
</html>