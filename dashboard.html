<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© - Ø®Ø·Ø© Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù†</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

    <link href="vanilla-calendar.min.css" rel="stylesheet">
    <script src="vanilla-calendar.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

    <style>
        /* --- General Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; background-color: #f4f7f6; color: #333; line-height: 1.7; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        h1, h2, h3, h4 { color: #1a5276; margin-bottom: 0.75em; }
        p { margin-bottom: 1em; color: #555; font-size: 0.95em; }
        a { text-decoration: none; color: #2980b9; }
        .card { background-color: #fff; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 3px 6px rgba(0,0,0,0.05); border: 1px solid #e0e0e0; }

        /* --- Header --- */
        .dashboard-header { display: flex; justify-content: center; align-items: center; padding: 10px 20px; margin-bottom: 25px; border-bottom: 2px solid #aed6f1; background-color: #fff; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .dashboard-header .logo h1 { margin: 0; font-size: 1.8em; color: #1a5276; }

        /* --- !! START: REVISED Dashboard Layout (Simpler) !! --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 columns */
            grid-template-rows: auto auto auto; /* Auto rows */
            gap: 25px;
        }
        /* Row 1 */
        #daily-task { grid-column: 1 / 4; grid-row: 1 / 2; } /* Daily task spans full width */
        /* Row 2 */
        #plan-progress { grid-column: 1 / 2; grid-row: 2 / 3; }
        #quick-stats { grid-column: 1 / 2; grid-row: 3 / 4; } /* Stats below progress */
        /* Calendar spans remaining columns */
        #calendar-view { grid-column: 2 / 4; grid-row: 2 / 4; } /* Span cols 2 & 3, rows 2 & 3 */
        /* --- !! END: REVISED Dashboard Layout !! --- */


        /* --- Section Specific Styles --- */
        #daily-task h3 { color: #1e8449; font-size: 1.3em; border-bottom: 2px solid #aed6f1; padding-bottom: 8px;}
        #daily-task-content { min-height: 80px; padding-top: 10px;}
        #daily-task-content p { margin-bottom: 0.6em; font-size: 1.05em; line-height: 1.8; }
        #daily-task-content strong { color: #1a5276; margin-left: 8px;}
        #daily-task .plan-link { margin-top: 15px; display: inline-block; font-size: 0.9em; background-color: #5dade2; color: white; padding: 5px 10px; border-radius: 4px; }
        #daily-task .plan-link:hover { background-color: #3498db; }

        #plan-progress h3, #quick-stats h3, #calendar-view h3, #competition-section h3, #badges-section h3 { font-size: 1.15em; }
        #plan-progress .progress-bar-container { background-color: #e9ecef; border-radius: 0.25rem; height: 25px; overflow: hidden; margin-top: 10px; border: 1px solid #ccc; }
        #plan-progress .progress-bar-value { background-color: #28a745; height: 100%; width: 0%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.9em; font-weight: bold; transition: width 0.6s ease-in-out; }
        #quick-stats ul { list-style: none; padding: 0; margin-top: 15px;}
        #quick-stats ul li { margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px dotted #eee; font-size: 0.95em;}
        #quick-stats ul li strong { margin-left: 5px; color: #1a5276; min-width: 110px; display: inline-block;}
        #quick-stats ul li span { color: #1e8449; font-weight: bold;}

        /* --- Style for Streak Info INSIDE Calendar Card --- */
        .streak-info-condensed {
            border-top: 1px solid #eee; /* Separator line */
            margin-top: 15px;
            padding-top: 15px;
            text-align: center;
        }
        .streak-info-condensed h4 { /* Title: "Ø§Ù„Ø§Ù†Ø¬Ø§Ø² Ø§Ù„Ù…ØªØªØ§Ù„ÙŠ" */
             font-size: 1.05em;
             color: #1a5276;
             margin-bottom: 10px;
        }
        .streak-info-condensed .streak-boxes {
            display: flex;
            justify-content: space-around; /* Distribute boxes */
            gap: 10px; /* Space between boxes */
            margin-bottom: 15px;
        }
        .streak-info-condensed .streak-box {
            background-color: #eaf2f8;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #d4e6f1;
            font-size: 0.9em;
            flex: 1; /* Allow boxes to take equal space */
        }
         .streak-info-condensed .streak-box strong {
            display: block;
            font-size: 1.4em; /* Larger number */
            color: #1e8449;
            margin-top: 2px;
        }
        .streak-info-condensed .level-display { /* Display for current title */
             font-size: 1em;
             color: #2c3e50;
             font-weight: bold;
        }
         .streak-info-condensed .level-display #level-icon {
             font-size: 1.3em;
             margin-left: 5px;
             vertical-align: middle;
         }
         /* --- End Streak Info Style --- */


        /* --- Calendar Section Header & Today Button --- */
         #calendar-view { display: flex; flex-direction: column; } /* Allow content to stack vertically */
         #calendar-view .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-shrink: 0;
        }
        #calendar-view .card-header h3 { margin-bottom: 0; }
        .today-button {
            font-family: 'Tajawal', sans-serif; font-size: 0.8em; padding: 4px 10px;
            background-color: #eaf2f8; border: 1px solid #aed6f1; border-radius: 4px;
            cursor: pointer; color: #1a5276; transition: background-color 0.2s; white-space: nowrap;
        }
        .today-button:hover { background-color: #d4e6f1; border-color: #aed6f1; }
         #calendar-container {
             margin-top: 0;
             direction: ltr;
             min-height: 300px; /* Ensure minimum height */
             height: auto; /* Allow height to adjust */
             flex-shrink: 0; /* Prevent shrinking if card has fixed height */
         }


        /* --- Base Calendar Styles (Vanilla Calendar) --- */
        /* Resetting flex properties that might cause issues */
        .vanilla-calendar { border: 1px solid #ddd; border-radius: 4px; /* Removed height, display:flex */ }
        .vanilla-calendar .vcal-header { background-color: #aed6f1; padding: 10px 0; border-bottom: 1px solid #ddd; /* Removed flex-shrink */ }
        .vanilla-calendar .vcal-header__label { color: #1a5276; font-weight: bold; cursor: pointer; }
        .vanilla-calendar .vcal-arrow { background-color: #ffffff; border-radius: 50%; width: 30px; height: 30px; line-height: 30px; border: 1px solid #ccc; cursor: pointer;}
        .vanilla-calendar .vcal-arrow::before { border-color: #1a5276; }
        .vanilla-calendar .vcal-week { background-color: #eaf2f8; padding: 5px 0; display: flex; justify-content: space-around; /* Removed flex-shrink */ }
        .vanilla-calendar .vcal-week span { color: #1a5276; font-weight: bold; font-size: 0.85em; text-align: center; flex: 1; }
        .vanilla-calendar .vcal-body { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; padding: 5px; /* Removed flex-grow */ }
        .vanilla-calendar .vcal-day { display: flex; justify-content: center; align-items: center; min-height: 36px; /* Ensure minimum day height */ }


        /* --- !! START: Calendar Day Coloring CSS (Keep as is) !! --- */
        /* This part should be correct now */
        .vanilla-calendar .vanilla-calendar-day__btn {
            border: 1px solid transparent; background-color: transparent; cursor: pointer;
            width: 34px; height: 34px; padding: 0; display: flex; justify-content: center;
            align-items: center; font-size: 0.9em; position: relative; border-radius: 50%;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s; color: #333;
        }
        .vanilla-calendar .vanilla-calendar-day__btn.day-completed {
            background-color: #abebc6 !important; color: #186a3b !important; font-weight: bold;
            border-color: #82e0aa !important;
        }
        .vanilla-calendar .vanilla-calendar-day__btn.day-excused {
            background-color: #fadbd8 !important; color: #922b21 !important; font-weight: bold;
            border-color: #f5b7b1 !important;
        }
        .vanilla-calendar .vanilla-calendar-day__btn.day-completed:hover {
            background-color: #82e0aa !important; border-color: #5fcf8f !important;
        }
        .vanilla-calendar .vanilla-calendar-day__btn.day-excused:hover {
            background-color: #f5b7b1 !important; border-color: #e59894 !important;
        }
        .vanilla-calendar .vanilla-calendar-day__btn:not(.day-completed):not(.day-excused):not([data-calendar-is-today]):hover {
             background-color: #e9ecef !important; border-color: #dee2e6 !important;
         }
        .vanilla-calendar .vanilla-calendar-day__btn[data-calendar-is-today]:not(.day-completed):not(.day-excused) {
            background-color: #aed6f1 !important; border: 1px solid #1a5276 !important;
            color: #1a5276 !important; font-weight: bold;
        }
        .vanilla-calendar .vanilla-calendar-day__btn.day-completed[data-calendar-is-today],
        .vanilla-calendar .vanilla-calendar-day__btn.day-excused[data-calendar-is-today] {
             border-width: 1px; /* Keep colored border */
        }
        /* --- !! END: Calendar Day Coloring CSS !! --- */


        /* Placeholder Styles */
        .placeholder-box { min-height: 150px; background-color: #f0f4f8; border: 1px dashed #ccc; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #777; border-radius: 5px; padding: 15px; text-align: center; }
        .placeholder-box .icon { font-size: 3em; margin-bottom: 10px; opacity: 0.5; }
        .placeholder-box .text { font-style: italic; font-size: 0.9em; }

        /* Footer */
        .main-footer { text-align: center; padding: 20px; margin-top: 40px; background-color: #2c3e50; color: #ecf0f1; font-size: 0.9em; }
        .main-footer a { color: #3498db; }

        /* Action Buttons Hidden */
        .action-buttons { display: none; }

        /* Loading Indicator */
        #loading-indicator { text-align: center; padding: 50px; font-size: 1.3em; color: #1a5276; display: block; }


        /* --- !! START: REVISED Responsive Adjustments !! --- */
        @media (max-width: 992px) { /* ØªØ®Ø·ÙŠØ· Ù„Ù€ 2 Ø£Ø¹Ù…Ø¯Ø© */
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr); /* Ø¹Ù…ÙˆØ¯Ø§Ù† */
                grid-template-rows: auto auto auto; /* Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙÙˆÙ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© */
            }
            #daily-task { grid-column: span 2; grid-row: 1 / 2; } /* Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ØªÙ…ØªØ¯ Ø¹Ø±Ø¶Ù‹Ø§ */
            #plan-progress { grid-column: 1 / 2; grid-row: 2 / 3; } /* Ø¹Ù…ÙˆØ¯ 1ØŒ ØµÙ 2 */
            #quick-stats { grid-column: 1 / 2; grid-row: 3 / 4; } /* Ø¹Ù…ÙˆØ¯ 1ØŒ ØµÙ 3 */
            /* Calendar now takes full column */
            #calendar-view { grid-column: 2 / 3; grid-row: 2 / 4; } /* Ø¹Ù…ÙˆØ¯ 2ØŒ ØµÙ 2 & 3 */
             /* Hide streak info on this layout? Or display it below calendar? */
             /* Let's keep it inside calendar view */
         }

         @media (max-width: 768px) { /* ØªØ®Ø·ÙŠØ· Ù„Ø¹Ù…ÙˆØ¯ ÙˆØ§Ø­Ø¯ */
             .dashboard-grid {
                 grid-template-columns: 1fr; /* Ø¹Ù…ÙˆØ¯ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· */
             }
             /* Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØªÙ…ØªØ¯ Ø¹Ù„Ù‰ Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…ÙˆØ¯ ÙˆØªØ£Ø®Ø° ØµÙÙ‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ */
             #daily-task, #plan-progress, #quick-stats, #calendar-view {
                 grid-column: span 1;
                 grid-row: auto;
             }
             /* ØªØ¹Ø¯ÙŠÙ„ ØªÙ†Ø³ÙŠÙ‚ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
             #calendar-view .card-header {
                flex-direction: column; /* Ø¬Ø¹Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙÙˆÙ‚ Ø§Ù„Ø²Ø± */
                align-items: flex-start; /* Ù…Ø­Ø§Ø°Ø§Ø© Ù„Ù„ÙŠÙ…ÙŠÙ† */
                gap: 8px; /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ø²Ø± */
            }
             /* Stack streak boxes vertically inside calendar card */
             .streak-info-condensed .streak-boxes { flex-direction: column; gap: 8px; }
         }
        /* --- !! END: REVISED Responsive Adjustments !! --- */

    </style>
</head>
<body>

    <div class="container">

        <header class="dashboard-header">
            <div class="logo"><h1>Ø®Ø·Ø© Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</h1></div>
        </header>

        <div id="loading-indicator">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

        <main id="dashboard-content" style="display: none;">

            <div class="dashboard-grid">

                <section id="daily-task" class="card">
                    <h3>ğŸŒŸ ÙˆØ§Ø¬Ø¨ Ø§Ù„ÙŠÙˆÙ… (<span id="today-date-display">...</span>)</h3>
                    <div id="daily-task-content"> <p><i>ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ§Ø¬Ø¨...</i></p> </div>
                    <a href="plangen2.html" class="plan-link">Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªÙØµÙŠÙ„ÙŠ &raquo;</a>
                </section>

                <section id="plan-progress" class="card">
                    <h3>Ø§Ù„Ø®Ø·Ø© ÙˆØ§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¹Ø§Ù…</h3>
                    <p><strong>Ø®Ø·ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</strong> <span id="current-plan-name">-</span></p>
                    <p><strong>Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„ÙƒÙ„ÙŠ:</strong></p>
                    <div class="progress-bar-container">
                        <div id="progress-bar-value" class="progress-bar-value" style="width: 0%;">0%</div>
                    </div>
                    <p style="font-size: 0.9em; text-align: center; margin-top: 5px;">
                        <span id="completed-pages-progress">0</span> / 604 ØµÙØ­Ø©
                    </p>
                </section>

                <section id="quick-stats" class="card">
                    <h3>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©</h3>
                    <ul>
                        <li><strong>Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:</strong> <span id="stat-memorized">0</span></li>
                        <li><strong>Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…ØªÙ‚Ù†Ø©:</strong> <span id="stat-perfected">0</span></li>
                        <li><strong>Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø©:</strong> <span id="stat-linked">0</span></li>
                        <li><strong>Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø¹Ø°Ø§Ø±:</strong> <span id="stat-excuses">0</span></li>
                    </ul>
                </section>

                <section id="calendar-view" class="card">
                    <div class="card-header">
                      <h3>Ø§Ù„ØªÙ‚ÙˆÙŠÙ… ÙˆØ§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø±Ø¦ÙŠ</h3>
                      <button id="goto-today-btn" class="today-button" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ÙŠÙˆÙ…">Ø§Ù„ÙŠÙˆÙ…</button>
                    </div>
                    <div id="calendar-container">
                        <p class="text" style="text-align: center; margin-top: 20px;">(Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…...)</p>
                    </div>
                    <div id="calendar-streak-info" class="streak-info-condensed" style="display: none;"> </div>
                </section>

                <section id="competition-section" class="card" style="display: none;">...</section>
                <section id="badges-section" class="card" style="display: none;">...</section>

            </div>
        </main>

        <footer class="main-footer">
             <p>&copy; <span id="current-year">2025</span> Ø®Ø·Ø© Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
         </footer>

    </div>

    <script>
        // --- Firebase Config ---
        const firebaseConfig = { /* ... ÙƒÙ…Ø§ Ù‡ÙŠ ... */
            apiKey: "AIzaSyDuUebu7Qzz3JnTfa-58EIPZjOcrkmdGHU",
            authDomain: "quranplan2.firebaseapp.com",
            projectId: "quranplan2",
            storageBucket: "quranplan2.appspot.com",
            messagingSenderId: "1098692856811",
            appId: "1:1098692856811:web:923bca3a54fd78b1b267ae"
        };

        // --- Initialize Firebase ---
         try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Firebase initialization error:", e); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM References ---
        const loadingIndicator = document.getElementById('loading-indicator');
        const dashboardContent = document.getElementById('dashboard-content');
        const dailyTaskContent = document.getElementById('daily-task-content');
        const currentPlanNameSpan = document.getElementById('current-plan-name');
        const progressBarValue = document.getElementById('progress-bar-value');
        const completedPagesProgressSpan = document.getElementById('completed-pages-progress');
        const statMemorized = document.getElementById('stat-memorized');
        const statPerfected = document.getElementById('stat-perfected');
        const statLinked = document.getElementById('stat-linked');
        const statExcuses = document.getElementById('stat-excuses');
        const todayDateSpan = document.getElementById('today-date-display');
        const calendarContainer = document.getElementById('calendar-container');
        // !! References for streak info inside calendar card (used later) !!
        const calendarStreakInfoDiv = document.getElementById('calendar-streak-info');
        // !! Remove old streak refs if they existed !!
        // const currentStreakSpan = document.getElementById('current-streak');
        // const longestStreakSpan = document.getElementById('longest-streak');
        // const levelTitleSpan = document.getElementById('level-title');
        // const levelIconSpan = document.getElementById('level-icon');
        const currentYearSpan = document.getElementById('current-year');

        // --- Constants ---
        const totalQuranPages = 604;
        const initialTotalRows = 320;

        // --- Global State ---
        let currentUser = null;
        let currentPlanData = null;
        let calendarInstance = null;
        let dayStatus = {};

        // --- Data Arrays & Helper Functions ---
        const surahs = [ /* ... ÙƒÙ…Ø§ Ù‡ÙŠ ... */ 'Ø§Ù„ÙØ§ØªØ­Ø© ÙˆØ§Ù„Ø¨Ù‚Ø±Ø©', 'Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†', 'Ø§Ù„Ù†Ø³Ø§Ø¡', 'Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©', 'Ø§Ù„Ø£Ù†Ø¹Ø§Ù…', 'Ø§Ù„Ø£Ø¹Ø±Ø§Ù', 'Ø§Ù„Ø£Ù†ÙØ§Ù„', 'Ø§Ù„ØªÙˆØ¨Ø©', 'ÙŠÙˆÙ†Ø³', 'Ù‡ÙˆØ¯', 'ÙŠÙˆØ³Ù', 'Ø§Ù„Ø±Ø¹Ø¯', 'Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…', 'Ø§Ù„Ø­Ø¬Ø±', 'Ø§Ù„Ù†Ø­Ù„', 'Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡', 'Ø§Ù„ÙƒÙ‡Ù', 'Ù…Ø±ÙŠÙ…', 'Ø·Ù‡', 'Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡', 'Ø§Ù„Ø­Ø¬', 'Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†', 'Ø§Ù„Ù†ÙˆØ±', 'Ø§Ù„ÙØ±Ù‚Ø§Ù†', 'Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡', 'Ø§Ù„Ù†Ù…Ù„', 'Ø§Ù„Ù‚ØµØµ', 'Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª', 'Ø§Ù„Ø±ÙˆÙ…', 'Ù„Ù‚Ù…Ø§Ù†', 'Ø§Ù„Ø³Ø¬Ø¯Ø©', 'Ø§Ù„Ø£Ø­Ø²Ø§Ø¨', 'Ø³Ø¨Ø£', 'ÙØ§Ø·Ø±', 'ÙŠØ³', 'Ø§Ù„ØµØ§ÙØ§Øª', 'Øµ', 'Ø§Ù„Ø²Ù…Ø±', 'ØºØ§ÙØ±', 'ÙØµÙ„Øª', 'Ø§Ù„Ø´ÙˆØ±Ù‰', 'Ø§Ù„Ø²Ø®Ø±Ù', 'Ø§Ù„Ø¯Ø®Ø§Ù†', 'Ø§Ù„Ø¬Ø§Ø«ÙŠØ©', 'Ø§Ù„Ø£Ø­Ù‚Ø§Ù', 'Ù…Ø­Ù…Ø¯', 'Ø§Ù„ÙØªØ­', 'Ø§Ù„Ø­Ø¬Ø±Ø§Øª', 'Ù‚', 'Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª', 'Ø§Ù„Ø·ÙˆØ±', 'Ø§Ù„Ù†Ø¬Ù…', 'Ø§Ù„Ù‚Ù…Ø±', 'Ø§Ù„Ø±Ø­Ù…Ù†', 'Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©', 'Ø§Ù„Ø­Ø¯ÙŠØ¯', 'Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©', 'Ø§Ù„Ø­Ø´Ø±', 'Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©', 'Ø§Ù„ØµÙ', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†', 'Ø§Ù„ØªØºØ§Ø¨Ù†', 'Ø§Ù„Ø·Ù„Ø§Ù‚', 'Ø§Ù„ØªØ­Ø±ÙŠÙ…', 'Ø§Ù„Ù…Ù„Ùƒ', 'Ø§Ù„Ù‚Ù„Ù…', 'Ø§Ù„Ø­Ø§Ù‚Ø©', 'Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬', 'Ù†ÙˆØ­', 'Ø§Ù„Ø¬Ù†', 'Ø§Ù„Ù…Ø²Ù…Ù„', 'Ø§Ù„Ù…Ø¯Ø«Ø±', 'Ø§Ù„Ù‚ÙŠØ§Ù…Ø©', 'Ø§Ù„Ø¥Ù†Ø³Ø§Ù†', 'Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª', 'Ø§Ù„Ù†Ø¨Ø£', 'Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª', 'Ø¹Ø¨Ø³', 'Ø§Ù„ØªÙƒÙˆÙŠØ±', 'Ø§Ù„Ø¥Ù†ÙØ·Ø§Ø±', 'Ø§Ù„Ù…Ø·ÙÙÙŠÙ†', 'Ø§Ù„Ø¥Ù†Ø´Ù‚Ø§Ù‚', 'Ø§Ù„Ø¨Ø±ÙˆØ¬', 'Ø§Ù„Ø·Ø§Ø±Ù‚', 'Ø§Ù„Ø£Ø¹Ù„Ù‰', 'Ø§Ù„ØºØ§Ø´ÙŠØ©', 'Ø§Ù„ÙØ¬Ø±', 'Ø§Ù„Ø¨Ù„Ø¯', 'Ø§Ù„Ø´Ù…Ø³', 'Ø§Ù„Ù„ÙŠÙ„', 'Ø§Ù„Ø¶Ø­Ù‰', 'Ø§Ù„Ø´Ø±Ø­', 'Ø§Ù„ØªÙŠÙ†', 'Ø§Ù„Ø¹Ù„Ù‚', 'Ø§Ù„Ù‚Ø¯Ø±', 'Ø§Ù„Ø¨ÙŠÙ†Ø©', 'Ø§Ù„Ø²Ù„Ø²Ù„Ø©', 'Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª', 'Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©', 'Ø§Ù„ØªÙƒØ§Ø«Ø±', 'Ø§Ù„Ø¹ØµØ±', 'Ø§Ù„Ù‡Ù…Ø²Ø©', 'Ø§Ù„ÙÙŠÙ„', 'Ù‚Ø±ÙŠØ´', 'Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†', 'Ø§Ù„ÙƒÙˆØ«Ø±', 'Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†', 'Ø§Ù„Ù†ØµØ±', 'Ø§Ù„Ù…Ø³Ø¯', 'Ø§Ù„Ø¥Ø®Ù„Ø§Øµ', 'Ø§Ù„ÙÙ„Ù‚', 'Ø§Ù„Ù†Ø§Ø³', 'Ø®ØªÙ… Ø§Ù„Ù‚Ø±Ø¢Ù†'];
        const linkFromData = [ /* ... ÙƒÙ…Ø§ Ù‡ÙŠ ... */ '', '', 1, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154, 155, 156, 157, 158, 159, 160, 161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182, 183, 184, 185, 186, 187, 188, 189, 190, 191, 192, 193, 194, 195, 196, 197, 198, 199, 200, 201, 202, 203, 204, 205, 206, 207, 208, 209, 210, 211, 212, 213, 214, 215, 216, 217, 218, 219, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 230, 231, 232, 233, 234, 235, 236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255, 256, 257, 258, 259, 260, 261, 262, 263, 264, 265, 266, 267, 268, 269, 270, 271, 272, 273, 274, 275, 276, 277, 278, 279, 280, 281, 282, 283, 284, 285, 286, 287, 288, 289, 290, 291, 292, 293, 294, 295, 296, 297, 298, 577 ];
        const linkToData = [ /* ... ÙƒÙ…Ø§ Ù‡ÙŠ ... */ '', '', 2, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154, 155, 156, 157, 158, 159, 160, 161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182, 183, 184, 185, 186, 187, 188, 189, 190, 191, 192, 193, 194, 195, 196, 197, 198, 199, 200, 201, 202, 203, 204, 205, 206, 207, 208, 209, 210, 211, 212, 213, 214, 215, 216, 217, 218, 219, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 230, 231, 232, 233, 234, 235, 236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255, 256, 257, 258, 259, 260, 261, 262, 263, 264, 265, 266, 267, 268, 269, 270, 271, 272, 273, 274, 275, 276, 277, 278, 279, 280, 281, 282, 283, 284, 285, 286, 287, 288, 289, 290, 291, 292, 293, 294, 295, 296, 297, 298, 300, 604 ];
        const reviewFromData = [ /* ... ÙƒÙ…Ø§ Ù‡ÙŠ ... */ ...Array(32).fill(''), 1, 2, 3, 4, 5, 6, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 481];
        const reviewToData = [ /* ... ÙƒÙ…Ø§ Ù‡ÙŠ ... */ ...Array(32).fill(''), 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154, 155, 156, 157, 158, 159, 160, 161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182, 183, 184, 185, 186, 187, 188, 189, 190, 191, 192, 193, 194, 195, 196, 197, 198, 199, 200, 201, 202, 203, 204, 205, 206, 207, 208, 209, 210, 211, 212, 213, 214, 215, 216, 217, 218, 219, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 230, 231, 232, 233, 234, 235, 236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255, 256, 257, 258, 259, 260, 261, 262, 263, 264, 265, 266, 267, 268, 269, 270, 271, 272, 273, 274, 275, 276, 277, 278, 279, 280, 281, 282, 283, 284, 285, 286, 287, 288, 289, 290, 291, 292, 293, 294, 295, 296, 297, 298, 299, 300, 576];

        function formatDate(date) { if (!(date instanceof Date)) date = new Date(date); if (isNaN(date.getTime())) return ""; const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
        function getPlanData(originalIndex) { const index = parseInt(originalIndex); if (isNaN(index) || index < 0 || index >= initialTotalRows) { return null; } let fromPage = '', toPage = ''; if (index < 299) { fromPage = index * 2 + 1; toPage = fromPage + 1; } else if (index === 299) { fromPage = 601; toPage = 604; } return { fromPage: fromPage, toPage: toPage, surah: surahs[index] || '', linkFrom: linkFromData[index] ?? '', linkTo: linkToData[index] ?? '', reviewFrom: reviewFromData[index] ?? '', reviewTo: reviewToData[index] ?? '', round: calculateRoundNumber(index) }; }
        function calculateRoundNumber(originalIndex) { if (originalIndex < 32 || !reviewFromData || reviewFromData[originalIndex] == null || reviewFromData[originalIndex] === '') { return ''; } let reviewDataStartIndex = 32; let reviewCounter = 0; for(let i = reviewDataStartIndex; i <= originalIndex; i++){ if(reviewFromData[i] != null && reviewFromData[i] !== '') reviewCounter++; } if (reviewCounter === 0) return ''; return Math.ceil(reviewCounter / 6); }

        // --- UI Update Functions ---
        function showLoading(message = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...") { if(loadingIndicator){ loadingIndicator.textContent = message; loadingIndicator.style.display = 'block';} if(dashboardContent) dashboardContent.style.display = 'none'; }
        function hideLoading() { if(loadingIndicator) loadingIndicator.style.display = 'none'; }
        function displayDashboard() { hideLoading(); if(dashboardContent) dashboardContent.style.display = 'block'; }

        // --- Stats Calculation ---
        function calculateDashboardStats(tableRows) { /* ... ÙƒÙ…Ø§ Ù‡ÙŠ ... */
            let lastCompletedPage = 0; let linkedTasks = 0; let perfectedTasks = 0; let excuseCount = 0;
            if (!tableRows) return { memorizedPages: 0, linkedTasks: 0, perfectedTasks: 0, excuseCount: 0 };
            tableRows.forEach(row => {
                if (row.type === 'excuse') { excuseCount++; }
                else if (row.type === 'plan' && row.state?.completed) {
                    const planInfo = getPlanData(row.originalSequence);
                    if (planInfo && planInfo.toPage) { const pageNum = parseInt(planInfo.toPage); if (!isNaN(pageNum)) { lastCompletedPage = Math.max(lastCompletedPage, pageNum); } }
                    if (planInfo && planInfo.linkTo !== '' && row.state.linked) { linkedTasks++; }
                    if (planInfo && planInfo.reviewTo !== '' && row.state.reviewed) { perfectedTasks++; }
                }
            });
            const memorizedPages = Math.min(lastCompletedPage, totalQuranPages);
            return { memorizedPages: memorizedPages, linkedTasks: linkedTasks, perfectedTasks: perfectedTasks, excuseCount: excuseCount };
         }

        // --- Streak Calculation ---
        const levelTitles = [ /* ... Ø§Ù„Ø£Ù„Ù‚Ø§Ø¨ ÙƒÙ…Ø§ Ù‡ÙŠ ... */
            "Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ!", "ğŸŒ± ØºØ±Ø³Ø© Ø§Ù„Ø¥ÙŠÙ…Ø§Ù†", "âœ¨ Ø¨Ø§Ø¯Ø±Ø© Ø£Ù…Ù„", "ğŸƒ Ø³Ø§Ø¹Ù Ù„Ù„Ø¹Ù„Ø§", "â­ Ù†Ø¬Ù… ØµØ§Ø¹Ø¯",
            "ğŸ’ª Ù…Ø«Ø§Ø¨Ø± Ù…Ø¬ØªÙ‡Ø¯", "ğŸ§­ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø¨", "ğŸ’¯ ØµØ§Ø­Ø¨ Ø§Ù„Ø³Ø¨Ø¹ÙŠÙ†", "ğŸš€ Ø§Ù†Ø·Ù„Ø§Ù‚Ø© Ù‚ÙˆÙŠØ©", "ğŸ’ Ø¬ÙˆÙ‡Ø±Ø© Ù…ØµÙ‚ÙˆÙ„Ø©",
            "ğŸ‘‘ ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ø¦Ø© ÙŠÙˆÙ…", "ğŸ“– Ø±ÙÙŠÙ‚ Ø§Ù„Ù‚Ø±Ø¢Ù†", "ğŸ•¯ï¸ Ù…Ù†Ø§Ø±Ø© Ù‡Ø¯Ù‰", "ğŸ”ï¸ Ù‚Ù…Ø© Ø´Ø§Ù…Ø®Ø©", "ğŸŒ³ Ø´Ø¬Ø±Ø© Ø·ÙŠØ¨Ø©",
            "â³ Ø¹Ø§Ø¨Ø± Ù…Ù†ØªØµÙ Ø§Ù„Ø·Ø±ÙŠÙ‚", "ğŸ¯ Ø¯Ù‚Ø© ÙˆØ§Ù„ØªØ²Ø§Ù…", "ğŸŒŠ Ø¨Ø­Ø± Ø²Ø§Ø®Ø±", "ğŸŒŸ ÙƒÙˆÙƒØ¨ Ø¯Ø±ÙŠ", "ğŸ§­ Ø¨ÙˆØµÙ„Ø© Ø§Ù„Ø­Ù‚",
            "ğŸ’¯ğŸ’¯ Ø§Ù„Ù…Ø¦ØªØ§Ù† Ù„Ø§ ØªÙ‚ÙØ§Ù†!", "ğŸ¤² Ù‚Ù„Ø¨ Ø®Ø§Ø´Ø¹", "ğŸ•Šï¸ Ø±ÙˆØ­ Ù…Ø·Ù…Ø¦Ù†Ø©", "ğŸ’– Ù…Ø­Ø¨ Ù„Ù„Ø±Ø­Ù…Ù†", "ğŸ™ Ø¹Ø¨Ø¯ Ø´ÙƒÙˆØ±",
            "ğŸ’¡ Ø¨ØµÙŠØ±Ø© Ù†Ø§ÙØ°Ø©", "ğŸ•Œ Ù…Ø¹Ù…Ù‘Ø± Ø¨ÙŠÙˆØª Ø§Ù„Ù„Ù‡", "ğŸŒ™ Ù‡Ù„Ø§Ù„ Ø§Ù„ÙƒÙ…Ø§Ù„", "âœ¨ Ù†ÙˆØ± Ø¹Ù„Ù‰ Ù†ÙˆØ±", "ğŸ Ù‚Ø§Ø¨ Ù‚ÙˆØ³ÙŠÙ† Ø£Ùˆ Ø£Ø¯Ù†Ù‰",
            "ğŸ† ÙØ§Ø±Ø³ Ø§Ù„Ø«Ù„Ø§Ø«Ù…Ø§Ø¦Ø©", "ğŸ‰ Ù…Ù‚ØªØ±Ø¨ Ù…Ù† Ø§Ù„Ø®ØªØ§Ù…", "ğŸŠ Ø®Ø§ØªÙ… Ù…Ø¨Ø§Ø±Ùƒ",
        ];
        const levelIcons = { 10: 'ğŸ‘‘', 20: 'ğŸ’¯', 30: 'ğŸ†', 32: 'ğŸŠ' };

        function calculateStreaksAndLevel(tableRows) { /* ... ÙƒÙ…Ø§ Ù‡ÙŠ ... */
             if (!tableRows || tableRows.length === 0) {
                 return { currentStreak: 0, longestStreak: 0, currentLevel: 0, currentTitle: levelTitles[0], currentIcon: '' };
             }
             const sortedRows = [...tableRows].sort((a, b) => new Date(a.displayDate) - new Date(b.displayDate));
             let currentStreak = 0; let longestStreak = 0; let currentRun = 0;
             const todayStr = formatDate(new Date());
             for (const row of sortedRows) {
                 if (row.displayDate > todayStr) break;
                 if (row.type === 'plan' && row.state?.completed) { currentRun++; }
                 else if (row.type === 'excuse') { if (currentRun > longestStreak) longestStreak = currentRun; /* Pause, don't reset run */ }
                 else { if (currentRun > longestStreak) longestStreak = currentRun; currentRun = 0; }
             }
             if (currentRun > longestStreak) longestStreak = currentRun;
             let tempCurrentStreak = 0; let streakBroken = false;
             for (let i = sortedRows.length - 1; i >= 0; i--) {
                 const row = sortedRows[i];
                 if (row.displayDate > todayStr) continue;
                 if (row.type === 'plan' && row.state?.completed) { if (!streakBroken) tempCurrentStreak++; }
                 else if (row.type === 'excuse') { continue; }
                 else { streakBroken = true; if (row.displayDate === todayStr) tempCurrentStreak = 0; break; }
             }
             currentStreak = tempCurrentStreak;
             const levelIndex = Math.min(Math.floor(currentStreak / 10), levelTitles.length - 1);
             const currentTitle = levelTitles[levelIndex] || levelTitles[0];
             const currentIcon = levelIcons[levelIndex] || '';
             return { currentStreak: currentStreak, longestStreak: longestStreak, currentLevel: levelIndex, currentTitle: currentTitle, currentIcon: currentIcon };
         }


        // --- START: Calendar Coloring and Initialization Functions (REVISED) ---

        /**
         * Applies custom CSS classes to calendar days. Includes console logs for debugging.
         */
        function applyCustomColoring() {
            console.log("Attempting to apply custom coloring..."); // <-- Log for debugging
            setTimeout(() => {
                if (!calendarContainer) { return; }
                const dayButtonElements = calendarContainer.querySelectorAll('.vanilla-calendar-day__btn');
                console.log(`Found ${dayButtonElements.length} day button elements.`); // <-- Log for debugging

                if (dayButtonElements.length === 0 && calendarContainer.innerHTML !== '' && !calendarContainer.querySelector('.text')) {
                    console.warn("applyCustomColoring: No day button elements found. Retrying in 500ms...");
                    // Retry once after a longer delay if elements weren't found initially
                     setTimeout(applyCustomColoring, 500);
                     return; // Exit this attempt
                 }

                let appliedCount = 0;
                dayButtonElements.forEach((buttonElement) => {
                    const dateAttribute = buttonElement.dataset.calendarDay;
                    if (!dateAttribute || !/^\d{4}-\d{2}-\d{2}$/.test(dateAttribute)) { return; }
                    // --- !! Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙƒÙ„Ø§Ø³Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ© !! ---
                    buttonElement.classList.remove('day-completed', 'day-excused');
                    const status = dayStatus[dateAttribute];
                    if (status === 'completed') { buttonElement.classList.add('day-completed'); appliedCount++; }
                    else if (status === 'excused') { buttonElement.classList.add('day-excused'); appliedCount++; }
                });
                console.log(`Applied coloring to ${appliedCount} days.`); // <-- Log for debugging
            }, 150); // Initial delay
        }

        /**
         * Initializes Vanilla Calendar, enables navigation, adds "Today" button functionality.
         * Includes extra checks and explicit coloring call.
         */
        function initializeAndColorCalendar(tableRows) {
            console.log("Initializing calendar..."); // <-- Log for debugging
            const calendarContainer = document.getElementById('calendar-container');
            const todayBtn = document.getElementById('goto-today-btn');

            if (!calendarContainer) { console.error("Calendar container not found!"); return; }

            // 1. Prepare dayStatus object
            dayStatus = {};
            if (tableRows && Array.isArray(tableRows)) {
                tableRows.forEach(row => {
                    if (row.displayDate && /^\d{4}-\d{2}-\d{2}$/.test(row.displayDate)) {
                        if (row.type === 'plan' && row.state?.completed) { dayStatus[row.displayDate] = 'completed'; }
                        else if (row.type === 'excuse') { dayStatus[row.displayDate] = 'excused'; }
                    }
                });
                 console.log("Prepared dayStatus object:", Object.keys(dayStatus).length > 0 ? dayStatus : "Empty"); // <-- Log for debugging
            }

            // 2. Setup Vanilla Calendar options (Navigation enabled)
            const options = {
                settings: {
                    lang: 'ar', iso8601: false,
                    range: { disablePast: false, disableGaps: false },
                    selection: { day: false, month: true, year: true }, // Enable nav
                    visibility: { theme: 'light', weekend: false, today: true },
                },
                actions: {
                     // --- !! Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø¯Ø« init Ù„Ù„ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø£ÙˆÙ„ÙŠ !! ---
                    init: (calendar) => {
                        console.log("Calendar init event fired."); // <-- Log for debugging
                        applyCustomColoring(); // Apply colors right after init
                        // Attach the "Today" button listener here *after* init guarantees instance exists
                        attachTodayButtonListener();
                    },
                    // --- !! Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø¯Ø« update Ù„Ù„ØªÙ„ÙˆÙŠÙ† Ø¹Ù†Ø¯ Ø§Ù„ØªÙ†Ù‚Ù„ !! ---
                    update: (calendar) => {
                        console.log("Calendar update event fired."); // <-- Log for debugging
                        applyCustomColoring(); // Reapply colors on month/year change
                    },
                    clickDay(event, dates) { /* Optional */ },
                }
            };

            calendarContainer.innerHTML = ''; // Clear placeholder

            try {
                console.log("Initializing VanillaCalendar instance..."); // <-- Log for debugging
                if (calendarInstance && typeof calendarInstance.destroy === 'function') {
                     calendarInstance.destroy();
                }
                calendarInstance = new VanillaCalendar(calendarContainer, options);
                // --- !! Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ init() Ù‡Ùˆ Ø§Ù„Ø°ÙŠ ÙŠØ´ØºÙ„ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… ÙˆØ£Ø­Ø¯Ø§Ø«Ù‡ !! ---
                calendarInstance.init();
                 console.log("VanillaCalendar instance initialized."); // <-- Log for debugging
                // Note: Initial coloring is now handled by the 'init' action above.

            } catch (error) {
                console.error("Error initializing Vanilla Calendar:", error);
                calendarContainer.innerHTML = `<p class="text" style="color:red;">Error initializing calendar. (${error.message})</p>`;
            }
        }

         /**
          * Attaches the event listener to the "Go to Today" button.
          * Moved to a separate function to be called after calendar init.
          */
         function attachTodayButtonListener() {
             const todayBtn = document.getElementById('goto-today-btn');
             if (todayBtn && calendarInstance) {
                 // Use a flag to prevent multiple listeners if init fires multiple times somehow
                 if (!todayBtn.hasAttribute('data-listener-attached')) {
                     todayBtn.addEventListener('click', () => {
                         console.log("Today button clicked."); // <-- Log for debugging
                         if (calendarInstance && typeof calendarInstance.today === 'function') {
                             calendarInstance.today();
                              console.log("calendarInstance.today() called."); // <-- Log for debugging
                             // --- !! Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ØªÙ„ÙˆÙŠÙ† Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù‡Ù†Ø§ !! ---
                             // Although .today() should trigger 'update', call coloring manually too
                             // Use a small delay to ensure navigation completes before coloring
                             setTimeout(applyCustomColoring, 100);
                         } else {
                             console.error('Cannot go to today, calendar instance or method missing.');
                         }
                     });
                     todayBtn.setAttribute('data-listener-attached', 'true'); // Mark as attached
                      console.log('Go to Today button event listener attached.'); // <-- Log for debugging
                 }
             } else if (!todayBtn) {
                  console.warn('attachTodayButtonListener: Go to Today button not found.'); // <-- Log for debugging
             } else if (!calendarInstance) {
                 console.warn('attachTodayButtonListener: Calendar instance not ready.'); // <-- Log for debugging
             }
         }

        // --- END: Calendar Coloring and Initialization Functions ---


        // --- Dashboard Display Functions ---
        function displayDailyTask() { /* ... ÙƒÙ…Ø§ Ù‡ÙŠ ... */
            if (!dailyTaskContent || !currentPlanData || !currentPlanData.tableRows) {
                if(dailyTaskContent) dailyTaskContent.innerHTML = '<p><i>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø·Ø©...</i></p>';
                if (todayDateSpan) todayDateSpan.textContent = formatDate(new Date());
                return;
            }
            const tableRows = currentPlanData.tableRows;
            const todayStr = formatDate(new Date());
            if (todayDateSpan) todayDateSpan.textContent = todayStr;
            const todayRow = tableRows.find(row => row.displayDate === todayStr);
            if (!todayRow) { dailyTaskContent.innerHTML = '<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØ§Ø¬Ø¨ Ù…Ù‚Ø±Ø± ÙÙŠ Ø§Ù„Ø®Ø·Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….</p>'; }
            else if (todayRow.type === 'excuse') { dailyTaskContent.innerHTML = `<p style="color: orange; font-weight:bold;">Ù„Ø¯ÙŠÙƒ Ø¹Ø°Ø± Ù…Ø³Ø¬Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… (${todayRow.excuseType || ''}).</p>`; }
            else if (todayRow.type === 'plan' && todayRow.state?.completed) { dailyTaskContent.innerHTML = '<p style="color: green; font-weight: bold;">âœ… Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡ØŒ Ù„Ù‚Ø¯ Ø£ØªÙ…Ù…Øª ÙˆØ§Ø¬Ø¨ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…!</p>'; }
            else if (todayRow.type === 'plan' && (!todayRow.state || !todayRow.state.completed)) {
                const taskDetails = getPlanData(todayRow.originalSequence);
                if (taskDetails) { let taskHTML = `<h4>Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¥Ù†Ø¬Ø§Ø²Ù‡ Ø§Ù„ÙŠÙˆÙ… (${todayStr}):</h4>`; taskHTML += `<p><strong>Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙŠØ¯:</strong> ${taskDetails.fromPage ? `Øµ ${taskDetails.fromPage} - ${taskDetails.toPage}` : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'} (${taskDetails.surah || 'Ù…Ø±Ø§Ø¬Ø¹Ø©'})</p>`; taskHTML += `<p><strong>Ø§Ù„Ø±Ø¨Ø·:</strong> ${taskDetails.linkFrom ? `Ù…Ù† ${taskDetails.linkFrom} Ø¥Ù„Ù‰ ${taskDetails.linkTo}` : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>`; taskHTML += `<p><strong>Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©:</strong> ${taskDetails.reviewFrom ? `Ù…Ù† ${taskDetails.reviewFrom} Ø¥Ù„Ù‰ ${taskDetails.reviewTo}` : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'} ${taskDetails.round ? `(Ø¬${taskDetails.round})` : ''}</p>`; dailyTaskContent.innerHTML = taskHTML; }
                else { dailyTaskContent.innerHTML = `<p><i>Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ø¨ Ù„Ù„ÙÙ‡Ø±Ø³ ${todayRow.originalSequence}.</i></p>`; }
            } else { dailyTaskContent.innerHTML = '<p><i>ÙˆØ§Ø¬Ø¨ Ø§Ù„ÙŠÙˆÙ… Ù„Ù… ÙŠÙƒØªÙ…Ù„ Ø¨Ø¹Ø¯ Ø£Ùˆ Ø­Ø§Ù„ØªÙ‡ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©.</i></p>'; }
        }
        function displayProgress(stats) { /* ... ÙƒÙ…Ø§ Ù‡ÙŠ ... */
            if (!currentPlanData) return;
            const planType = currentPlanData.planType || '?';
            const memorizedPages = stats.memorizedPages;
            const progressPercent = totalQuranPages > 0 ? Math.min(100, (memorizedPages / totalQuranPages) * 100).toFixed(0) : 0;
            if(currentPlanNameSpan) currentPlanNameSpan.textContent = `Ø®Ø·Ø© ${planType} ØµÙØ­Ø§Øª`;
            if(progressBarValue) { progressBarValue.style.width = `${progressPercent}%`; progressBarValue.textContent = `${progressPercent}%`; }
            if(completedPagesProgressSpan) completedPagesProgressSpan.textContent = memorizedPages;
         }
        function displayStats(stats) { /* ... ÙƒÙ…Ø§ Ù‡ÙŠ ... */
            if(statMemorized) statMemorized.textContent = stats.memorizedPages;
            if(statPerfected) statPerfected.textContent = stats.perfectedTasks;
            if(statLinked) statLinked.textContent = stats.linkedTasks;
            if(statExcuses) statExcuses.textContent = stats.excuseCount;
        }
        // !! Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² ÙÙŠ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯ !!
        function displayStreakInfoInCalendarCard(streakData) {
            const targetDiv = document.getElementById('calendar-streak-info');
            if (!targetDiv) return;

            let content = `
                <h4>Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…ØªØªØ§Ù„ÙŠ</h4>
                <div class="streak-boxes">
                    <div class="streak-box">Ø£ÙŠØ§Ù… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø­Ø§Ù„ÙŠØ©<strong>${streakData.currentStreak}</strong></div>
                    <div class="streak-box">Ø£Ø·ÙˆÙ„ Ø³Ù„Ø³Ù„Ø© Ø£ÙŠØ§Ù…<strong>${streakData.longestStreak}</strong></div>
                </div>
                <div class="level-display">
                    Ù„Ù‚Ø¨Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ:
                    <span>${streakData.currentTitle}</span>
                    <span id="level-icon">${streakData.currentIcon}</span>
                </div>
            `;
            targetDiv.innerHTML = content;
            targetDiv.style.display = 'block'; // Show the div
        }


        // --- Main Data Loading Function ---
        function loadDashboardData(user) {
            if (!user) return;
            const uid = user.uid;
            const planRef = db.collection("quranPlans").doc(uid);
            showLoading("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø·ØªÙƒ...");
            planRef.get().then((doc) => {
                hideLoading();
                if (doc.exists) {
                    currentPlanData = doc.data();
                    // --- Validation ---
                    if (!currentPlanData.startDate || !currentPlanData.planType || !currentPlanData.tableRows || !Array.isArray(currentPlanData.tableRows) || !currentPlanData.repetitionMax) {
                        console.error("Loaded data missing required fields.", currentPlanData);
                        /* ... Error display logic ... */
                         dashboardContent.style.display = 'block';
                         dailyTaskContent.innerHTML = `<p style="color:red; font-weight:bold;">Ø®Ø·Ø£: Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø·ØªÙƒ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø© Ø£Ùˆ ØªØ§Ù„ÙØ©. ÙŠØ±Ø¬Ù‰ <a href="index.html">Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„ØµÙØ­Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</a> ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø·Ø©.</p>`;
                         const sectionsToHideOnError = ['plan-progress', 'quick-stats', 'calendar-view']; // Hide calendar too
                         sectionsToHideOnError.forEach(id => { const section = document.getElementById(id); if (section) section.style.display = 'none'; });
                        return;
                    }
                    // --- Calculations ---
                    const stats = calculateDashboardStats(currentPlanData.tableRows);
                    const streakData = calculateStreaksAndLevel(currentPlanData.tableRows);
                    // --- Update UI ---
                    displayDailyTask();
                    displayProgress(stats);
                    displayStats(stats);
                    // !! Call the NEW display function for streak info !!
                    displayStreakInfoInCalendarCard(streakData);
                    // Init calendar (coloring happens via events now)
                    initializeAndColorCalendar(currentPlanData.tableRows);
                    // --- Show Dashboard ---
                    displayDashboard();
                } else { /* No plan found logic */
                     displayDashboard();
                     dailyTaskContent.innerHTML = '<p style="color:orange; font-weight:bold;">Ù„Ù… ØªÙ‚Ù… Ø¨Ø§Ø®ØªÙŠØ§Ø± Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø© Ø¨Ø¹Ø¯!</p><p>Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ <a href="index.html">ØµÙØ­Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</a> Ù„Ø§Ø®ØªÙŠØ§Ø± Ø®Ø·ØªÙƒ.</p>';
                     const sectionsToHide = ['plan-progress', 'quick-stats', 'calendar-view']; // Hide calendar view as well
                     sectionsToHide.forEach(id => { const section = document.getElementById(id); if (section) section.style.display = 'none'; });
                 }
            }).catch((error) => { /* Error handling */
                 console.error("Error getting plan document:", error);
                 hideLoading(); displayDashboard();
                 dailyTaskContent.innerHTML = `<p style="color:red; font-weight:bold;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø·Ø©. (${error.code || 'UNKNOWN'})</p><p>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰. <a href="index.html">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></p>`;
                 const sectionsToHideOnError = ['plan-progress', 'quick-stats', 'calendar-view'];
                 sectionsToHideOnError.forEach(id => { const section = document.getElementById(id); if (section) section.style.display = 'none'; });
            });
        }

        // --- Authentication Listener ---
        auth.onAuthStateChanged(user => {
           currentUser = user;
           if (user) { loadDashboardData(user); }
           else { /* Not logged in logic */
               showLoading("ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
               if(dashboardContent) dashboardContent.style.display = 'block';
               if(dailyTaskContent) dailyTaskContent.innerHTML = '<p style="color:red;">ÙŠØ±Ø¬Ù‰ <a href="index.html">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a> Ù„Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.</p>';
               const sectionsToHide = ['plan-progress', 'quick-stats', 'calendar-view'];
               sectionsToHide.forEach(id => { const section = document.getElementById(id); if (section) section.style.display = 'none'; });
               if (calendarInstance && typeof calendarInstance.destroy === 'function') { calendarInstance.destroy(); calendarInstance = null;}
               hideLoading();
           }
        });

        // --- Initial Load & Footer Year ---
        document.addEventListener('DOMContentLoaded', () => {
            showLoading("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...");
            if(currentYearSpan) { currentYearSpan.textContent = new Date().getFullYear(); }
            // Auth listener handles data loading
        });

        // --- Print Function ---
        function printData() { console.log("Initiating browser print..."); window.print(); }

    </script>
    </body>
</html>