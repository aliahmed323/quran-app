<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة المتابعة - خطة حفظ القرآن</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

    <link href="vanilla-calendar.min.css" rel="stylesheet">
    <script src="vanilla-calendar.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>

    <style>
        /* --- CSS Styles (تبقى كما هي - تأكد من وجود لون الخلفية الأخضر لشريط التقدم) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; background-color: #f4f7f6; color: #333; line-height: 1.7; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        h1, h2, h3, h4 { color: #1a5276; margin-bottom: 0.75em; }
        p { margin-bottom: 1em; color: #555; font-size: 0.95em; }
        a { text-decoration: none; color: #2980b9; }
        .card { background-color: #fff; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 3px 6px rgba(0,0,0,0.05); border: 1px solid #e0e0e0; }

        /* --- Header --- */
        .dashboard-header { display: flex; justify-content: center; align-items: center; padding: 10px 20px; margin-bottom: 25px; border-bottom: 2px solid #aed6f1; background-color: #fff; border-radius: 0 0 8px 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .dashboard-header .logo h1 { margin: 0; font-size: 1.8em; color: #1a5276; }

        /* --- Dashboard Layout --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: auto; gap: 25px; }
        #daily-task { grid-column: span 2; }
        #plan-progress { grid-column: 1 / 2; grid-row: 2 / 3; }
        #quick-stats { grid-column: 1 / 2; grid-row: 3 / 4; }
        #streak-level { grid-column: 2 / 4; grid-row: 2 / 3; }
        #calendar-view { grid-column: 2 / 4; grid-row: 3 / 4; }

        /* --- Section Specific Styles --- */
        #daily-task h3 { color: #1e8449; font-size: 1.3em; border-bottom: 2px solid #aed6f1; padding-bottom: 8px;}
        #daily-task-content { min-height: 80px; padding-top: 10px;}
        #daily-task-content p { margin-bottom: 0.6em; font-size: 1.05em; line-height: 1.8; }
        #daily-task-content strong { color: #1a5276; margin-left: 8px;}
        #daily-task .plan-link { margin-top: 15px; display: inline-block; font-size: 0.9em; background-color: #5dade2; color: white; padding: 5px 10px; border-radius: 4px; }
        #daily-task .plan-link:hover { background-color: #3498db; }

        #plan-progress h3, #quick-stats h3, #calendar-view h3, #competition-section h3, #badges-section h3, #streak-level h3 { font-size: 1.15em; }
        #plan-progress .progress-bar-container { background-color: #e9ecef; border-radius: 0.25rem; height: 25px; overflow: hidden; margin-top: 10px; border: 1px solid #ccc; }
        #plan-progress .progress-bar-value { background-color: #28a745; height: 100%; width: 0%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.9em; font-weight: bold; transition: width 0.6s ease-in-out; }
        #quick-stats ul { list-style: none; padding: 0; margin-top: 15px;}
        #quick-stats ul li { margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px dotted #eee; font-size: 0.95em;}
        #quick-stats ul li strong { margin-left: 5px; color: #1a5276; min-width: 110px; display: inline-block;}
        #quick-stats ul li span { color: #1e8449; font-weight: bold;}

        /* --- Streak & Level Styles --- */
        #streak-level .streak-info { display: flex; justify-content: space-around; text-align: center; margin: 15px 0; }
        #streak-level .streak-info div { background-color: #eaf2f8; padding: 10px 15px; border-radius: 6px; border: 1px solid #d4e6f1; }
        #streak-level .streak-info strong { display: block; font-size: 1.5em; color: #1e8449; }
        #streak-level .level-title-container { text-align: center; margin-top: 15px; }
        #streak-level #level-title { font-size: 1.2em; color: #2c3e50; font-weight: bold; }
        #streak-level #level-icon { font-size: 1.5em; margin-left: 10px; }

        /* --- Calendar Styles --- */
        #calendar-view { min-height: 320px; /* Adjusted min-height */ }
        #calendar-container { margin-top: 15px; direction: ltr; }
        /* Default library styles might need minor overrides */
        .vcal-header { background-color: #aed6f1 !important; }
        .vcal-day__btn_today { /* Style for today's button (library might use this) */
             background-color: #e3f2fd !important; /* Light blue background */
             border: 1px solid #aed6f1 !important;
             font-weight: bold;
             color: #1a5276 !important;
        }
        /* Remove old rules targeting .vcal-date__day */
        /* .day-completed .vcal-date__day { ... } */
        /* .day-excused .vcal-date__day { ... } */

        /* --- تلوين التقويم (الطريقة اليدوية - يستهدف الزر مباشرة) --- */
        .vanilla-calendar-day__btn.day-completed {
            background-color: #abebc6 !important; /* أخضر فاتح */
            color: #186a3b !important; /* نص أخضر أغمق */
            /* border-radius is on the button by default */
        }
        .vanilla-calendar-day__btn.day-excused {
            background-color: #fadbd8 !important; /* أحمر فاتح */
            color: #922b21 !important; /* نص أحمر أغمق */
        }
        /* اختياري: تنسيق عند مرور الفأرة فوق الأيام الملونة */
        .vanilla-calendar-day__btn.day-completed:hover {
            background-color: #82e0aa !important;
        }
        .vanilla-calendar-day__btn.day-excused:hover {
            background-color: #f5b7b1 !important;
        }
        /* --- نهاية تلوين التقويم --- */

        /* Adjust font size if needed */
        .vcal-body, .vcal-header__label, .vcal-week span { font-size: 0.9em; }
        /* .vcal-date { height: 35px; } */ /* Maybe remove fixed height */
        /* .vcal-date__day { line-height: 35px; } */

        /* Placeholder Styles */
        .placeholder-box { min-height: 150px; background-color: #f0f4f8; border: 1px dashed #ccc; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #777; border-radius: 5px; padding: 15px; text-align: center; }
        .placeholder-box .icon { font-size: 3em; margin-bottom: 10px; opacity: 0.5; }
        .placeholder-box .text { font-style: italic; font-size: 0.9em; }

        /* Footer */
        .main-footer { text-align: center; padding: 20px; margin-top: 40px; background-color: #2c3e50; color: #ecf0f1; font-size: 0.9em; }
        .main-footer a { color: #3498db; }

        /* Action Buttons Hidden */
        .action-buttons { display: none; }

        /* Loading Indicator */
        #loading-indicator { text-align: center; padding: 50px; font-size: 1.3em; color: #1a5276; display: block; }

        /* Responsive Adjustments */
        @media (max-width: 992px) {
             .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
             #daily-task { grid-column: span 2; }
             #plan-progress, #quick-stats { grid-column: span 1; grid-row: auto; }
             #streak-level, #calendar-view { grid-column: span 1; grid-row: auto; }
        }
        @media (max-width: 768px) {
             #streak-level .streak-info { flex-direction: column; gap: 10px; }
             #streak-level .streak-info div { width: 80%; margin: 0 auto; }
        }
        @media (max-width: 600px) {
             .dashboard-header .logo h1 { font-size: 1.5em;}
             .dashboard-grid { grid-template-columns: 1fr; }
             #daily-task, #plan-progress, #quick-stats, #calendar-view, #streak-level, #competition-section, #badges-section { grid-column: span 1; }
             .card { padding: 15px; }
             h2 { font-size: 1.4em; }
             h3 { font-size: 1.1em; }
        }
    </style>
</head>
<body>

    <div class="container">

        <header class="dashboard-header">
            <div class="logo"><h1>خطة حفظ القرآن الكريم</h1></div>
        </header>

        <div id="loading-indicator">جاري التحميل...</div>

        <main id="dashboard-content" style="display: none;">

            <div class="dashboard-grid">

                <section id="daily-task" class="card">
                    <h3>🌟 واجب اليوم (<span id="today-date-display">...</span>)</h3>
                    <div id="daily-task-content">
                        <p><i>يتم تحديد الواجب...</i></p>
                    </div>
                    <a href="plangen2.html" class="plan-link">الذهاب إلى جدول الخطة التفصيلي &raquo;</a>
                </section>

                <section id="plan-progress" class="card">
                    <h3>الخطة والتقدم العام</h3>
                    <p><strong>خطتك الحالية:</strong> <span id="current-plan-name">-</span></p>
                    <p><strong>التقدم الكلي:</strong></p>
                    <div class="progress-bar-container">
                        <div id="progress-bar-value" style="width: 0%; background-color: #28a745;">0%</div>
                    </div>
                    <p style="font-size: 0.9em; text-align: center; margin-top: 5px;">
                        <span id="completed-pages-progress">0</span> / 604 صفحة
                    </p>
                </section>

                <section id="quick-stats" class="card">
                    <h3>إحصائيات سريعة</h3>
                    <ul>
                         <li><strong>الصفحات المحفوظة:</strong> <span id="stat-memorized">0</span></li>
                         <li><strong>الصفحات المتقنة:</strong> <span id="stat-perfected">0</span></li>
                         <li><strong>الصفحات المربوطة:</strong> <span id="stat-linked">0</span></li>
                         <li><strong>أيام الأعذار:</strong> <span id="stat-excuses">0</span></li>
                    </ul>
                </section>

                <section id="streak-level" class="card">
                     <h3> همة نحو القمة: الإنجاز المتتالي</h3>
                     <div class="streak-info">
                         <div>أيام الإنجاز الحالية<strong id="current-streak">0</strong></div>
                         <div> أطول سلسلة أيام حققتها<strong id="longest-streak">0</strong></div>
                     </div>
                     <div class="level-title-container">
                         <h4>لقبك الحالي: <span id="level-title">ابدأ رحلتك!</span> <span id="level-icon"></span></h4>
                     </div>
                </section>
                <section id="calendar-view" class="card">
                    <h3>التقويم والتتبع المرئي</h3>
                    <div id="calendar-container">
                        <p class="text" style="text-align: center; margin-top: 20px;">(جاري تحميل التقويم...)</p>
                    </div>
                </section>

                <section id="competition-section" class="card" style="display: none;"> <h3>المنافسة</h3>
                     <div class="placeholder-box">
                         <div class="icon">🏆</div>
                         <div class="text">(قريباً: لوحة الصدارة)</div>
                     </div>
                </section>
                <section id="badges-section" class="card" style="display: none;"> <h3>الأوسمة</h3>
                     <div class="placeholder-box">
                          <div class="icon">🏅</div>
                          <div class="text">(قريباً: نظام الأوسمة والحوافز)</div>
                     </div>
                </section>

            </div>
        </main>

        <footer class="main-footer">
             <p>&copy; 2025 خطة حفظ القرآن الكريم. جميع الحقوق محفوظة.</p>
        </footer>

    </div>

    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDuUebu7Qzz3JnTfa-58EIPZjOcrkmdGHU", // WARNING: Exposing API keys client-side is risky. Consider security rules.
            authDomain: "quranplan2.firebaseapp.com",
            projectId: "quranplan2",
            storageBucket: "quranplan2.appspot.com",
            messagingSenderId: "1098692856811",
            appId: "1:1098692856811:web:923bca3a54fd78b1b267ae"
        };

        // --- Initialize Firebase ---
         try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Firebase initialization error:", e); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM References ---
        const loadingIndicator = document.getElementById('loading-indicator');
        const dashboardContent = document.getElementById('dashboard-content');
        const dailyTaskContent = document.getElementById('daily-task-content');
        const currentPlanNameSpan = document.getElementById('current-plan-name');
        const progressBarValue = document.getElementById('progress-bar-value');
        const completedPagesProgressSpan = document.getElementById('completed-pages-progress');
        const statMemorized = document.getElementById('stat-memorized');
        const statPerfected = document.getElementById('stat-perfected');
        const statLinked = document.getElementById('stat-linked');
        const statExcuses = document.getElementById('stat-excuses');
        const todayDateSpan = document.getElementById('today-date-display');
        const calendarContainer = document.getElementById('calendar-container');
        const currentStreakSpan = document.getElementById('current-streak');
        const longestStreakSpan = document.getElementById('longest-streak');
        const levelTitleSpan = document.getElementById('level-title');
        const levelIconSpan = document.getElementById('level-icon');

        // --- Constants ---
        const totalQuranPages = 604;
        const initialTotalRows = 320;

        // --- Global State ---
        let currentUser = null;
        let currentPlanData = null;
        let calendarInstance = null;

        // --- Data Arrays & Helper Functions ---
        const surahs = ['الفاتحة والبقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة', 'البقرة وآل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'آل عمران', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء', 'النساء والمائدة', 'المائدة', 'المائدة', 'المائدة', 'المائدة', 'المائدة', 'المائدة', 'المائدة', 'المائدة', 'المائدة', 'المائدة', 'المائدة والأنعام', 'الأنعام', 'الأنعام', 'الأنعام', 'الأنعام', 'الأنعام', 'الأنعام', 'الأنعام', 'الأنعام', 'الأنعام', 'الأنعام', 'الأنعام', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأعراف', 'الأنفال', 'الأنفال', 'الأنفال', 'الأنفال', 'الأنفال', 'التوبة', 'التوبة', 'التوبة', 'التوبة', 'التوبة', 'التوبة', 'التوبة', 'التوبة', 'التوبة', 'التوبة', 'التوبة ويونس', 'يونس', 'يونس', 'يونس', 'يونس', 'يونس', 'يونس', 'يونس وهود', 'هود', 'هود', 'هود', 'هود', 'هود', 'هود', 'هود ويوسف', 'يوسف', 'يوسف', 'يوسف', 'يوسف', 'يوسف', 'يوسف', 'الرعد', 'الرعد', 'الرعد', 'إبراهيم', 'إبراهيم', 'إبراهيم', 'إبراهيم والحجر', 'الحجر', 'الحجر', 'الحجر والنحل', 'النحل', 'النحل', 'النحل', 'النحل', 'النحل', 'النحل', 'النحل والإسراء', 'الإسراء', 'الإسراء', 'الإسراء', 'الإسراء', 'الإسراء', 'الإسراء والكهف', 'الكهف', 'الكهف', 'الكهف', 'الكهف', 'الكهف', 'مريم', 'مريم', 'مريم', 'مريم وطه', 'طه', 'طه', 'طه', 'طه', 'طه والأنبياء', 'الأنبياء', 'الأنبياء', 'الأنبياء', 'الأنبياء', 'الأنبياء والحج', 'الحج', 'الحج', 'الحج', 'الحج', 'الحج والمؤمنون', 'المؤمنون', 'المؤمنون', 'المؤمنون', 'المؤمنون والنور', 'النور', 'النور', 'النور', 'النور', 'النور والفرقان', 'الفرقان', 'الفرقان', 'الفرقان', 'الشعراء', 'الشعراء', 'الشعراء', 'الشعراء', 'الشعراء', 'النمل', 'النمل', 'النمل', 'النمل', 'النمل والقصص', 'القصص', 'القصص', 'القصص', 'القصص', 'القصص والعنكبوت', 'العنكبوت', 'العنكبوت', 'العنكبوت', 'العنكبوت والروم', 'الروم', 'الروم', 'الروم', 'لقمان', 'لقمان', 'السجدة', 'السجدة والأحزاب', 'الأحزاب', 'الأحزاب', 'الأحزاب', 'الأحزاب', 'الأحزاب وسبأ', 'سبأ', 'سبأ', 'سبأ وفاطر', 'فاطر', 'فاطر', 'فاطر ويس', 'يس', 'يس', 'يس والصافات', 'الصافات', 'الصافات', 'الصافات', 'ص', 'ص', 'ص والزمر', 'الزمر', 'الزمر', 'الزمر', 'الزمر', 'غافر', 'غافر', 'غافر', 'غافر', 'غافر', 'فصلت', 'فصلت', 'فصلت', 'الشورى', 'الشورى', 'الشورى', 'الشورى والزخرف', 'الزخرف', 'الزخرف', 'الزخرف والدخان', 'الدخان', 'الجاثية', 'الجاثية والأحقاف', 'الأحقاف', 'الأحقاف', 'محمد', 'محمد', 'الفتح', 'الفتح', 'الفتح والحجرات', 'الحجرات و ق', 'ق', 'الذاريات', 'الذاريات والطور', 'الطور والنجم', 'النجم والقمر', 'القمر', 'القمر والرحمن', 'الرحمن والواقعة', 'الواقعة', 'الواقعة والحديد', 'الحديد', 'الحديد والمجادلة', 'المجادلة', 'المجادلة والحشر', 'الحشر', 'الممتحنة', 'الممتحنة والصف', 'الجمعة والمنافقون', 'المنافقون والتغابن', 'التغابن والطلاق', 'الطلاق والتحريم', 'التحريم والملك', 'الملك والقلم', 'القلم والحاقة', 'الحاقة والمعارج', 'المعارج ونوح', 'نوح والجن', 'الجن والمزمل', 'المزمل والمدثر', 'المدثر والقيامة والإنسان', 'الإنسان والمرسلات', 'المرسلات والنبأ', 'النبأ والنازعات', 'عبس والتكوير', 'الإنفطار والمطففين', 'الإنشقاق والبروج', 'الطارق والأعلى والغاشية', 'الفجر والبلد', 'الشمس والليل', 'الضحى إلى الناس', 'ختم القرآن'];
        const linkFromData = ['', '', 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 13, 13, 13, 13, 13, 13, 25, 25, 25, 25, 25, 25, 37, 37, 37, 37, 37, 37, 49, 49, 49, 49, 49, 49, 61, 61, 61, 61, 61, 61, 73, 73, 73, 73, 73, 73, 85, 85, 85, 85, 85, 85, 97, 97, 97, 97, 97, 97, 109, 109, 109, 109, 109, 109, 121, 121, 121, 121, 121, 121, 133, 133, 133, 133, 133, 133, 145, 145, 145, 145, 145, 145, 157, 157, 157, 157, 157, 157, 169, 169, 169, 169, 169, 169, 181, 181, 181, 181, 181, 181, 193, 193, 193, 193, 193, 193, 205, 205, 205, 205, 205, 205, 217, 217, 217, 217, 217, 217, 229, 229, 229, 229, 229, 229, 241, 241, 241, 241, 241, 241, 253, 253, 253, 253, 253, 253, 265, 265, 265, 265, 265, 265, 277, 277, 277, 277, 277, 277, 289, 289, 289, 289, 289, 289, 301, 301, 301, 301, 301, 301, 313, 313, 313, 313, 313, 313, 325, 325, 325, 325, 325, 325, 337, 337, 337, 337, 337, 337, 349, 349, 349, 349, 349, 349, 361, 361, 361, 361, 361, 361, 373, 373, 373, 373, 373, 373, 385, 385, 385, 385, 385, 385, 397, 397, 397, 397, 397, 397, 409, 409, 409, 409, 409, 409, 421, 421, 421, 421, 421, 421, 433, 433, 433, 433, 433, 433, 445, 445, 445, 445, 445, 445, 457, 457, 457, 457, 457, 457, 469, 469, 469, 469, 469, 469, 481, 481, 481, 481, 481, 481, 493, 493, 493, 493, 493, 493, 505, 505, 505, 505, 505, 505, 517, 517, 517, 517, 517, 517, 529, 529, 529, 529, 529, 529, 541, 541, 541, 541, 541, 541, 553, 553, 553, 553, 553, 553, 565, 565, 565, 565, 565, 565, 577, 577, 577, 577, 577, 577];
        const linkToData = ['', '', 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32, 34, 36, 38, 40, 42, 44, 46, 48, 50, 52, 54, 56, 58, 60, 62, 64, 66, 68, 70, 72, 74, 76, 78, 80, 82, 84, 86, 88, 90, 92, 94, 96, 98, 100, 102, 104, 106, 108, 110, 112, 114, 116, 118, 120, 122, 124, 126, 128, 130, 132, 134, 136, 138, 140, 142, 144, 146, 148, 150, 152, 154, 156, 158, 160, 162, 164, 166, 168, 170, 172, 174, 176, 178, 180, 182, 184, 186, 188, 190, 192, 194, 196, 198, 200, 202, 204, 206, 208, 210, 212, 214, 216, 218, 220, 222, 224, 226, 228, 230, 232, 234, 236, 238, 240, 242, 244, 246, 248, 250, 252, 254, 256, 258, 260, 262, 264, 266, 268, 270, 272, 274, 276, 278, 280, 282, 284, 286, 288, 290, 292, 294, 296, 298, 300, 302, 304, 306, 308, 310, 312, 314, 316, 318, 320, 322, 324, 326, 328, 330, 332, 334, 336, 338, 340, 342, 344, 346, 348, 350, 352, 354, 356, 358, 360, 362, 364, 366, 368, 370, 372, 374, 376, 378, 380, 382, 384, 386, 388, 390, 392, 394, 396, 398, 400, 402, 404, 406, 408, 410, 412, 414, 416, 418, 420, 422, 424, 426, 428, 430, 432, 434, 436, 438, 440, 442, 444, 446, 448, 450, 452, 454, 456, 458, 460, 462, 464, 466, 468, 470, 472, 474, 476, 478, 480, 482, 484, 486, 488, 490, 492, 494, 496, 498, 500, 502, 504, 506, 508, 510, 512, 514, 516, 518, 520, 522, 524, 526, 528, 530, 532, 534, 536, 538, 540, 542, 544, 546, 548, 550, 552, 554, 556, 558, 560, 562, 564, 566, 568, 570, 572, 574, 576, 578, 580, 582, 584, 586, 588, 590, 592, 594, 597, 600, 604];
        const reviewFromData = [...Array(32).fill(''), 1, 3, 5, 7, 9, 11, 1, 5, 9, 13, 17, 21, 1, 7, 13, 19, 25, 31, 1, 9, 17, 25, 33, 41, 1, 11, 21, 31, 41, 51, 1, 13, 25, 37, 49, 61, 1, 15, 29, 43, 57, 71, 1, 17, 33, 49, 65, 81, 1, 19, 37, 55, 73, 91, 1, 21, 41, 61, 81, 101, 1, 23, 45, 67, 89, 111, 1, 25, 49, 73, 97, 121, 1, 27, 53, 79, 105, 131, 1, 29, 57, 85, 113, 141, 1, 31, 61, 91, 121, 151, 1, 33, 65, 97, 129, 161, 1, 35, 69, 103, 137, 171, 1, 37, 73, 109, 145, 181, 1, 39, 77, 115, 153, 191, 1, 41, 81, 121, 161, 201, 1, 43, 85, 127, 169, 211, 1, 45, 89, 133, 177, 221, 1, 47, 93, 139, 185, 231, 1, 49, 97, 145, 193, 241, 1, 51, 101, 151, 201, 251, 1, 53, 105, 157, 209, 261, 1, 55, 109, 163, 217, 271, 1, 57, 113, 169, 225, 281, 1, 59, 117, 175, 233, 291, 1, 61, 121, 181, 241, 301, 1, 63, 125, 187, 249, 311, 1, 65, 129, 193, 257, 321, 1, 67, 133, 199, 265, 331, 1, 69, 137, 205, 273, 341, 1, 71, 141, 211, 281, 351, 1, 73, 145, 217, 289, 361, 1, 75, 149, 223, 297, 371, 1, 77, 153, 229, 305, 381, 1, 79, 157, 235, 313, 391, 1, 81, 161, 241, 321, 401, 1, 83, 165, 247, 329, 411, 1, 85, 169, 253, 337, 421, 1, 87, 173, 259, 345, 431, 1, 89, 177, 265, 353, 441, 1, 91, 181, 271, 361, 451, 1, 93, 185, 277, 369, 461, 1, 95, 189, 283, 377, 471, 1, 97, 193, 289, 385, 481];
        const reviewToData = [...Array(32).fill(''), 2, 4, 6, 8, 10, 12, 4, 8, 12, 16, 20, 24, 6, 12, 18, 24, 30, 36, 8, 16, 24, 32, 40, 48, 10, 20, 30, 40, 50, 60, 12, 24, 36, 48, 60, 72, 14, 28, 42, 56, 70, 84, 16, 32, 48, 64, 80, 96, 18, 36, 54, 72, 90, 108, 20, 40, 60, 80, 100, 120, 22, 44, 66, 88, 110, 132, 24, 48, 72, 96, 120, 144, 26, 52, 78, 104, 130, 156, 28, 56, 84, 112, 140, 168, 30, 60, 90, 120, 150, 180, 32, 64, 96, 128, 160, 192, 34, 68, 102, 136, 170, 204, 36, 72, 108, 144, 180, 216, 38, 76, 114, 152, 190, 228, 40, 80, 120, 160, 200, 240, 42, 84, 126, 168, 210, 252, 44, 88, 132, 176, 220, 264, 46, 92, 138, 184, 230, 276, 48, 96, 144, 192, 240, 288, 50, 100, 150, 200, 250, 300, 52, 104, 156, 208, 260, 312, 54, 108, 162, 216, 270, 324, 56, 112, 168, 224, 280, 336, 58, 116, 174, 232, 290, 348, 60, 120, 180, 240, 300, 360, 62, 124, 186, 248, 310, 372, 64, 128, 192, 256, 320, 384, 66, 132, 198, 264, 330, 396, 68, 136, 204, 272, 340, 408, 70, 140, 210, 280, 350, 420, 72, 144, 216, 288, 360, 432, 74, 148, 222, 296, 370, 444, 76, 152, 228, 304, 380, 456, 78, 156, 234, 312, 390, 468, 80, 160, 240, 320, 400, 480, 82, 164, 246, 328, 410, 492, 84, 168, 252, 336, 420, 504, 86, 172, 258, 344, 430, 516, 88, 176, 264, 352, 440, 528, 90, 180, 270, 360, 450, 540, 92, 184, 276, 368, 460, 552, 94, 188, 282, 376, 470, 564, 96, 192, 288, 384, 480, 576];

        // --- UI Update Functions ---
        function showLoading(message = "جاري التحميل...") { if(loadingIndicator){ loadingIndicator.textContent = message; loadingIndicator.style.display = 'block';} if(dashboardContent) dashboardContent.style.display = 'none'; }
        function hideLoading() { if(loadingIndicator) loadingIndicator.style.display = 'none'; }
        function displayDashboard() { hideLoading(); if(dashboardContent) dashboardContent.style.display = 'block'; }

        // --- Functions to Calculate Stats from tableRows (Keep as is) ---
        function calculateDashboardStats(tableRows) {
            let lastCompletedPage = 0; let linkedTasks = 0; let perfectedTasks = 0; let excuseCount = 0;
            if (!tableRows) return { memorizedPages: 0, linkedTasks: 0, perfectedTasks: 0, excuseCount: 0 };
            tableRows.forEach(row => {
                if (row.type === 'excuse') { excuseCount++; }
                else if (row.type === 'plan' && row.state?.completed) {
                    const planInfo = getPlanData(row.originalSequence);
                    if (planInfo && planInfo.toPage) { const pageNum = parseInt(planInfo.toPage); if (!isNaN(pageNum)) { lastCompletedPage = Math.max(lastCompletedPage, pageNum); } }
                    if (planInfo && planInfo.linkTo !== '' && row.state?.linked) { linkedTasks++; }
                    if (planInfo && planInfo.reviewTo !== '' && row.state?.reviewed) { perfectedTasks++; }
                }
            });
            const memorizedPages = Math.min(lastCompletedPage, totalQuranPages);
            return { memorizedPages: memorizedPages, linkedTasks: linkedTasks, perfectedTasks: perfectedTasks, excuseCount: excuseCount };
        }

        // --- Streak, Level, and Calendar Functions ---

        // Level Titles (Keep as is or customize)
        const levelTitles = [ "ابدأ رحلتك!", "🌱 غرسة الإيمان", "✨ بادرة أمل", "🏃 ساعٍ للعلا", "⭐ نجم صاعد", "💪 مثابر مجتهد", "🧭 على الدرب", "💯 صاحب السبعين", "🚀 انطلاقة قوية", "💎 جوهرة مصقولة", "👑 صاحب المئة يوم", "📖 رفيق القرآن", "🕯️ منارة هدى", "🏔️ قمة شامخة", "🌳 شجرة طيبة", "⏳ عابر منتصف الطريق", "🎯 دقة والتزام", "🌊 بحر زاخر", "🌟 كوكب دري", "🧭 بوصلة الحق", "💯💯 المئتان لا تقفان!", "🤲 قلب خاشع", "🕊️ روح مطمئنة", "💖 محب للرحمن", "🙏 عبد شكور", "💡 بصيرة نافذة", "🕌 معمّر بيوت الله", "🌙 هلال الكمال", "✨ نور على نور", "🏁 قاب قوسين أو أدنى", "🏆 فارس الثلاثمائة", "🎉 مقترب من الختام", "🎊 خاتم مبارك" ];
        const levelIcons = { 10: '👑', 20: '💯', 30: '🏆', 32: '🎊' };

        // calculateStreaksAndLevel function (Keep as is)
        function calculateStreaksAndLevel(tableRows) {
            if (!tableRows || tableRows.length === 0) { return { currentStreak: 0, longestStreak: 0, currentLevel: 0, currentTitle: levelTitles[0], currentIcon: '' }; }
            const sortedRows = [...tableRows].sort((a, b) => new Date(a.displayDate) - new Date(b.displayDate));
            let currentStreak = 0; let longestStreak = 0; let currentRun = 0; const todayStr = formatDate(new Date()); let isStreakActiveToday = false;
            for (const row of sortedRows) { if (row.displayDate > todayStr) break; if (row.type === 'plan' && row.state?.completed) { currentRun++; if(row.displayDate === todayStr) { isStreakActiveToday = true; } } else if (row.type === 'excuse') { if (currentRun > longestStreak) { longestStreak = currentRun; } if(row.displayDate === todayStr){ isStreakActiveToday = false; } } else { if (currentRun > longestStreak) { longestStreak = currentRun; } currentRun = 0; isStreakActiveToday = false; } }
            if (currentRun > longestStreak) { longestStreak = currentRun; }
            if (isStreakActiveToday || (sortedRows.length > 0 && sortedRows[sortedRows.length-1].type === 'plan' && sortedRows[sortedRows.length-1].state?.completed && sortedRows[sortedRows.length-1].displayDate < todayStr)) { let tempCurrentStreak = 0; for (let i = sortedRows.length - 1; i >= 0; i--) { const row = sortedRows[i]; if (row.displayDate > todayStr) continue; if (row.type === 'plan' && row.state?.completed) { tempCurrentStreak++; } else if (row.type === 'excuse') { continue; } else { break; } } currentStreak = tempCurrentStreak; } else { currentStreak = 0; }
            const levelIndex = Math.min(Math.floor(currentStreak / 10), levelTitles.length - 1); const currentTitle = levelTitles[levelIndex] || levelTitles[0]; const currentIcon = levelIcons[levelIndex] || '';
            return { currentStreak: currentStreak, longestStreak: longestStreak, currentLevel: levelIndex, currentTitle: currentTitle, currentIcon: currentIcon };
        }

        // --- >>> START: CODE TO BE REPLACED/ADDED <<< ---

        // --- دالة جديدة لتطبيق التلوين يدويًا بعد إنشاء التقويم ---
        function applyCustomHighlights(tableRows) {
            console.log("Applying custom highlights manually...");
            const calendarContainer = document.getElementById('calendar-container'); // نحتاج للوصول للحاوية هنا أيضًا
            if (!calendarContainer || !tableRows) {
                console.log("Cannot apply highlights: Missing container or tableRows.");
                return;
            }

            // --- تحضير بيانات حالة الأيام لتسهيل البحث (نفس الكود السابق) ---
            const dayStatus = {};
            tableRows.forEach(row => {
                if (row.displayDate) {
                    if (row.type === 'plan' && row.state?.completed) { dayStatus[row.displayDate] = 'completed'; }
                    else if (row.type === 'excuse') { dayStatus[row.displayDate] = 'excused'; }
                }
            });
            // console.log("Manual highlight lookup data:", dayStatus); // يمكنك إلغاء التعليق للتحقق

            // --- العثور على جميع أزرار الأيام داخل التقويم ---
            // تأكد من أن هذا الكلاس '.vanilla-calendar-day__btn' هو الكلاس الصحيح لزر اليوم في إصدارك
            const dayButtons = calendarContainer.querySelectorAll('.vanilla-calendar-day__btn');
            console.log(`Found ${dayButtons.length} day buttons to check for manual highlighting.`);

            dayButtons.forEach(button => {
                const date = button.dataset.calendarDay; // الحصول على التاريخ 'YYYY-MM-DD'
                // --- إزالة الكلاسات القديمة أولاً لضمان عدم التراكم ---
                button.classList.remove('day-completed', 'day-excused');
                // --- إضافة الكلاس المناسب بناءً على الحالة ---
                if (date && dayStatus[date]) { // إذا كان للتاريخ حالة مسجلة لدينا
                    const status = dayStatus[date];
                    if (status === 'completed') {
                        button.classList.add('day-completed'); // أضف كلاس الإنجاز
                    } else if (status === 'excused') {
                        button.classList.add('day-excused'); // أضف كلاس العذر
                    }
                }
            });
            console.log("Finished applying manual highlights.");
            // تذكير بالتحقق من CSS إذا لم تظهر الألوان
            console.warn("If colors don't appear, ensure CSS rules target the button directly, e.g., .vanilla-calendar-day__btn.day-completed");
        }

        // --- دالة تهيئة التقويم المعدلة (لاستخدام التلوين اليدوي) ---
        function initializeCalendar(tableRows) {
            console.log("Initializing calendar, highlights will be applied AFTER init manually...");
            const calendarContainer = document.getElementById('calendar-container'); // الحصول على الحاوية
            if (!calendarContainer) {
                console.error("Calendar container element not found!");
                return;
            }

            const today = new Date();

            // --- خيارات أساسية فقط (بدون أي محاولة لتمرير خيارات التلوين للمكتبة) ---
            const options = {
                date: {
                    month: today.getMonth(), // الشهر الحالي (0-11)
                    year: today.getFullYear(), // السنة الحالية
                },
                settings: {
                    type: 'month', // عرض شهري
                    lang: 'ar', // لغة عربية
                    iso8601: false, // الأحد أولاً
                    selection: { day: false }, // تعطيل الاختيار
                    visibility: {
                        theme: 'light', // مظهر فاتح
                        weekend: false, // نهاية الأسبوع
                        today: true, // تظليل اليوم
                        monthShort: false, // اسم الشهر كامل
                    },
                },
                // --- تأكد من إزالة/تعليق كل خيارات التلوين السابقة هنا ---
                // popups: {},
                // markup: {},
                // dates: {},
                // actions: {},
            };

            calendarContainer.innerHTML = ''; // مسح المحتوى المؤقت

            try {
                console.log("Initializing VanillaCalendar with basic options (for manual highlight):", options);
                calendarInstance = new VanillaCalendar(calendarContainer, options);
                calendarInstance.init(); // تهيئة التقويم الأساسي
                console.log("Calendar initialized successfully (basic).");

                // --- استدعاء دالة التلوين اليدوي بعد التهيئة مع تأخير بسيط ---
                // نستخدم تأخيرًا بسيطًا (مثل 150 ميلي ثانية) للتأكد من أن المكتبة انتهت تمامًا من رسم التقويم في الصفحة
                setTimeout(() => {
                    // نمرر tableRows للدالة الجديدة لتعرف حالة الأيام
                    applyCustomHighlights(tableRows);
                }, 150); // يمكنك زيادة هذا الرقم قليلاً إذا لم تظهر الألوان فورًا

            } catch (error) {
                console.error("Error initializing calendar:", error);
                calendarContainer.innerHTML = `<p class="text" style="color:red;">Error loading calendar. (${error.message})</p>`;
                console.log("Full error object:", error);
            }
        }

        // --- >>> END: CODE TO BE REPLACED/ADDED <<< ---

        // --- Helper function applyDateModifiers (Keep or remove, not used by new method) ---
        /*
        function applyDateModifiers(daysToHighlight) {
             if (!calendarInstance || !daysToHighlight) return;
             daysToHighlight.forEach(highlight => {
                  const dateElement = calendarContainer.querySelector(`[data-calendar-date="${highlight.date}"]`);
                  if (dateElement) {
                     const dayButton = dateElement.closest('.vcal-day__btn');
                     if(dayButton){ dayButton.classList.add(highlight.modifier); }
                     else { dateElement.classList.add(highlight.modifier); }
                  }
             });
        }
        */

        // --- MODIFIED Functions to Update Dashboard Sections (Keep as is) ---
        function displayDailyTask() { /* ... */ }
        function displayProgress(stats) { /* ... */ }
        function displayStats(stats) { /* ... */ }
        function displayStreakAndLevel(streakData) { /* ... */ }


        // --- Main Data Loading Function (Keep as is, calls initializeCalendar) ---
        function loadDashboardData(user) {
            if (!user) return;
            const uid = user.uid;
            const planRef = db.collection("quranPlans").doc(uid);
            console.log("Dashboard: Checking Firestore for plan:", uid);
            showLoading("جاري تحميل بيانات خطتك...");

            planRef.get().then((doc) => {
                hideLoading();
                if (doc.exists) {
                    console.log("Dashboard: Plan data found.");
                    currentPlanData = doc.data(); // Store FULL data globally

                    if (!currentPlanData.startDate || !currentPlanData.planType || !currentPlanData.tableRows || !Array.isArray(currentPlanData.tableRows) || !currentPlanData.repetitionMax) {
                         console.error("Loaded data missing required fields (startDate, planType, tableRows array, or repetitionMax).", currentPlanData);
                         /* ... error handling ... */
                         return;
                     }

                    // Process Data & Update UI
                    const stats = calculateDashboardStats(currentPlanData.tableRows);
                    const streakData = calculateStreaksAndLevel(currentPlanData.tableRows);
                    displayDailyTask();
                    displayProgress(stats);
                    displayStats(stats);
                    displayStreakAndLevel(streakData);
                    initializeCalendar(currentPlanData.tableRows); // Initialize calendar
                    displayDashboard();

                } else {
                     /* ... No plan found logic ... */
                 }
            }).catch((error) => {
                 /* ... Error handling ... */
            });
        }

        // --- Authentication Listener (Keep as is) ---
        auth.onAuthStateChanged(user => { /* ... */ });

        // --- Initial Load (Keep as is) ---
        document.addEventListener('DOMContentLoaded', () => { /* ... */ });

         // --- Print Function (Keep as is) ---
         function printData() { console.log("Initiating browser print..."); window.print(); }

    </script>

</body>
</html>